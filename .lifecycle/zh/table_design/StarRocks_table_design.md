---
displayed_sidebar: English
---

# 了解表格设计

## 列式存储

![Columnar Storage](../assets/3.1-1.png)

与其他关系型数据库一样，StarRocks 中的表格由行和列构成。每一行保存着一条用户数据记录，而每一列中的数据类型相同。表中的所有行都有相同数量的列。您可以动态地向表中添加或删除列。表的列分为维度列和指标列。维度列也被称作键列，指标列也被称作值列。维度列中的值用于数据的分组和排序，而指标列中的值可以通过诸如 sum、count、min、max、hll_union_agg 和 bitmap_union 等函数进行累积。

StarRocks 使用列式存储方式来存储表格。在物理层面上，列中的数据被划分为数据块，经过编码和压缩后持久化存储在磁盘上。在逻辑层面上，列中的数据可以看作由同一数据类型元素组成的数组。在行中保留的列值，以列顺序排列成为各自数组中的元素。这意味着行中保存的列值拥有相同的数组索引。数组索引是隐式的，无需存储。表中的所有行都按照一个或多个维度列指定的顺序进行排序。排序表中行的位置，由该行的序号来表示。

对于对表的查询，如果您在能够构成维度列前缀的特定维度列上指定等值或范围条件，StarRocks 能够运行二分查找，快速定位已排序数据中的目标行。例如，您想要查询名为 table1 的表中的数据，该表包含四列：event_day、siteid、citycode 和 username，其中 event_day 和 siteid 是维度列。如果您的查询条件是 event_day = 2020-09-18 和 siteid = 2，StarRocks 可以执行二分查找，只处理指定范围内的数据，因为 event_day 和 siteid 可以构成维度列前缀。如果您的查询条件是 citycode = 4 和 username = Andy，StarRocks 不能执行二分查找，需要处理整个表的数据，因为 citycode 和 username 不能构成维度列前缀。

## 索引

StarRocks 利用前缀索引和列级索引来快速定位目标行所在数据块的起始行。

下图展示了 StarRocks 的表设计如何加快对表的查询速度。

![Indexing Overview](../assets/3.1-2.png)

StarRocks 中一张表的数据被组织为以下三个部分：

- 前缀索引

  StarRocks 将每 1024 行数据存储为一个数据块，并为其在前缀索引表中维护一个条目。每个数据块的前缀索引条目包含数据块起始行的维度列组成的前缀，长度不超过 36 字节。前缀索引是一种稀疏索引。当您查询某行数据时，StarRocks 会查找前缀索引表以检索由该行的维度列构成的前缀。然后，StarRocks 能够迅速定位到目标行所在数据块的起始行序号。

- 列级数据块

  StarRocks 将每列数据分割成多个 64 KB 的数据块。每个数据块作为最小的 I/O 单元，独立进行编码和压缩，并作为一个整体进行磁盘读写。

- 列级索引

  StarRocks 为每列维护一个行号索引。在行号索引表中，列的数据块按顺序映射到列中存储的行的序号。此外，行号索引表中的每个条目包括映射到特定行号的数据块的起始行号、地址和长度。当您查询某行数据时，StarRocks 会查找行号索引表以检索映射到该行序号的数据块地址。然后，StarRocks 读取数据块以定位该行。

总结来说，StarRocks 使用由行的维度列构成的前缀来定位表中的行，执行以下五个步骤：

1. 查找前缀索引表，确定目标行所在数据块的起始行序号。

2. 查找各维度列的行号索引表，定位该维度列的数据块。

3. 读取数据块。

4. 解压和解码数据块。

5. 在数据块中查找映射到维度列索引的行。

## 加速处理

本节介绍帮助 StarRocks 更快处理数据的机制。

### 预聚合

StarRocks 提供了聚合表。对于聚合表，具有相同维度列值的行可以被聚合成单一行。在聚合生成的新行中，每个维度列的值保持不变，而每个指标列中的值则通过您指定的聚合函数进行聚合，以生成新行中指标列的结果值。预聚合有助于加快聚合操作的速度。

### 分区和分桶

StarRocks 中的每个表都被划分成多个分片。每个分片在后端服务器（BE）上存储有多个副本。随着计算资源和数据规模的变化，BE 的数量和分片的数量可以灵活扩展。当您发起查询时，多个 BE 可以并行搜索分片，以快速定位到所需的数据。此外，分片副本可以进行复制和迁移，这提高了数据的可靠性并防止数据偏斜。分区和分桶确保了数据检索的效率和稳定性。

### 物化视图

表的前缀索引有助于加快查询速度，但这依赖于表的维度列的顺序。如果您使用的查询条件中的维度列没有包含在维度列前缀中，前缀索引就无法发挥作用。在这种情况下，您可以为表创建一个物化视图。物化视图的数据组织和存储方式与原始表相同。然而，物化视图可以拥有自己的前缀索引。在为物化视图创建前缀索引时，您可以指定合适的聚合粒度、列数和维度列排序，确保常用的查询条件能够命中物化视图的前缀索引表中的预期条目。

### 列级索引

StarRocks 支持诸如布隆过滤器、区域映射和位图索引等列级索引：

- 布隆过滤器用于判断数据块中是否包含您要查询的值。

- 区域映射用于确定指定范围内的值。

- 位图索引用于在 ENUM 数据类型的列中定位满足特定查询条件的行。
