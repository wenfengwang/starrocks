---
displayed_sidebar: English
---

# 磁盘溢出

本主题描述了如何将大型操作符的中间计算结果溢出到磁盘。

## 概览

对于那些依赖内存计算来执行查询的数据库系统，例如StarRocks，在处理包含聚合、排序和连接操作符的大型数据集查询时，可能会消耗大量的内存资源。当内存限制达到时，这些查询可能会因为内存溢出（OOM）而被强制终止。

然而，在某些情况下，您可能仍希望某些内存密集型任务能够稳定完成，即使性能不是首要考虑的因素，例如构建物化视图或执行带有INSERT INTO SELECT的轻量级ETL。这些任务可能会轻易耗尽内存资源，从而阻塞集群中的其他查询。通常，要解决这个问题，您只能对这些任务进行个别微调，依赖于资源隔离策略来控制查询的并发。这在某些极端情况下可能特别不便，并且容易失败。

从StarRocks v3.0.1版本开始，StarRocks支持将某些内存密集型操作符的中间结果溢出到磁盘。通过这项功能，您可以接受一定程度的性能下降，以换取显著减少的内存使用，从而提高系统的可用性。

目前，StarRocks的溢出功能支持以下操作符：

- - 聚合操作符
- - 排序操作符
- - 哈希连接操作符（包括LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN和INNER JOIN）

## 启用中间结果溢出

按照以下步骤启用中间结果溢出：

1. 在BE配置文件**be.conf**中指定存储溢出中间结果的目录`spill_local_storage_dir`，并重启集群以使更改生效。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

      > **注意**
   - 您可以通过使用分号（;）分隔来指定多个spill_local_storage_dir。
   - 在生产环境中，我们强烈建议您为数据存储和溢出使用不同的磁盘。当中间结果溢出到磁盘时，可能会导致写入负载和磁盘使用率显著增加。如果使用同一磁盘，这种突增可能会影响集群中其他查询或任务的运行。

2. 2. 执行以下语句以启用中间结果溢出：

   ```SQL
   SET enable_spill = true;
   ```

3. 使用会话变量spill_mode来配置中间结果溢出的模式：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

      > **注意**
      > 每当一个包含**溢出**的查询完成时，StarRocks会自动清除该查询产生的**溢出数据**。如果BE在清除数据之前崩溃，StarRocks会在BE重启时清除这些数据。

   |变量|默认|描述|
|---|---|---|
   |enable_spill|false|是否启用中间结果溢出。如果设置为 true，StarRocks 会将中间结果溢出到磁盘，以减少在查询中处理聚合、排序或连接运算符时的内存使用量。|
   |spill_mode|auto|中间结果溢出的执行模式。有效值：auto：达到内存使用阈值时自动触发溢出。force：无论内存使用情况如何，StarRocks 都会对所有相关算子强制执行溢出。只有当变量enable_spill设置为true时，该变量才生效。|

## 局限性

- 并非所有的OOM问题都能通过溢出来解决。例如，StarRocks无法释放用于表达式计算的内存。
- 通常，在涉及溢出的查询中，查询延迟可能会增加十倍。因此，我们建议您通过设置会话变量query_timeout来延长这些查询的超时时间。
