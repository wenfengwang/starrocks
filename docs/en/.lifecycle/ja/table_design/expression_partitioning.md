---
displayed_sidebar: "Japanese"
---

# 式パーティショニング（推奨）

v3.0以降、StarRocksは式パーティショニング（以前は自動パーティショニングと呼ばれていました）をサポートしており、より柔軟で使いやすくなっています。このパーティショニング方法は、連続した時間範囲や列挙値に基づいてデータをクエリや管理するなど、ほとんどのシナリオに適しています。

テーブル作成時に単純なパーティション式（時間関数式または列式のいずれか）を指定するだけで、データのロード中にStarRocksがデータとパーティション式で定義されたルールに基づいて自動的にパーティションを作成します。テーブル作成時に多数のパーティションを手動で作成する必要はなく、動的なパーティションのプロパティを設定する必要もありません。

## 時間関数式に基づくパーティショニング

連続した時間範囲に基づいて頻繁にデータをクエリや管理する場合、パーティション列として日付型（DATEまたはDATETIME）の列を指定し、時間関数式で年、月、日、または時間をパーティションの粒度として指定するだけで済みます。StarRocksは、データのロードとパーティション式で定義されたルールに基づいて、パーティションを自動的に作成し、パーティションの開始日時と終了日時または日時を設定します。

ただし、月ごとに過去のデータをパーティションに分割し、最新のデータを日ごとにパーティションに分割するなど、特定のシナリオでは[範囲パーティショニング](./Data_distribution.md#range-partitioning)を使用してパーティションを作成する必要があります。

### 構文

```sql
PARTITION BY expression
...
[ PROPERTIES( 'partition_live_number' = 'xxx' ) ]

expression ::=
    { date_trunc ( <time_unit> , <partition_column> ) |
      time_slice ( <partition_column> , INTERVAL <N> <time_unit> [ , boundary ] ) }
```

### パラメータ

| パラメーター              | 必須 | 説明                                                  |
| ----------------------- | -------- | ------------------------------------------------------------ |
| `expression`            |     YES     | 現在、[date_trunc](../sql-reference/sql-functions/date-time-functions/date_trunc.md)関数と[time_slice](../sql-reference/sql-functions/date-time-functions/time_slice.md)関数のみがサポートされています。`time_slice`関数を使用する場合は、`boundary`パラメータを渡す必要はありません。これは、このシナリオでは、このパラメータのデフォルト値である`floor`が有効な値であり、`ceil`にすることはできないためです。 |
| `time_unit`             |       YES   | パーティションの粒度で、`hour`、`day`、`month`、または`year`にすることができます。`week`のパーティションの粒度はサポートされていません。パーティションの粒度が`hour`の場合、パーティション列はDATETIMEデータ型である必要があり、DATEデータ型ではない必要があります。 |
| `partition_column` |     YES     | パーティション列の名前。<br/><ul><li>パーティション列はDATEまたはDATETIMEデータ型のみにすることができます。パーティション列は`NULL`値を許容します。</li><li>パーティション列は、`date_trunc`関数を使用する場合はDATEまたはDATETIMEデータ型にすることができます。`time_slice`関数を使用する場合は、パーティション列はDATETIMEデータ型である必要があります。</li><li>パーティション列がDATEデータ型の場合、サポートされる範囲は[0000-01-01〜9999-12-31]です。パーティション列がDATETIMEデータ型の場合、サポートされる範囲は[0000-01-01 01:01:01〜9999-12-31 23:59:59]です。</li><li>現在、パーティション列は1つのみ指定でき、複数のパーティション列はサポートされていません。</li></ul> |
| `partition_live_number` |      NO    | 保持する最新のパーティションの数です。「最新」とは、パーティションが日付順に並べ替えられ、**現在の日付を基準**として、遡って数えたパーティションの数を指し、それ以前に作成されたパーティションは削除されます。StarRocksは、パーティションの数を管理するためのタスクをスケジュールし、スケジュール間隔はFEの動的パラメータ`dynamic_partition_check_interval_seconds`を介して設定できます。デフォルト値は600秒（10分）です。現在の日付が2023年4月4日であり、`partition_live_number`が`2`に設定されており、パーティションには`p20230401`、`p20230402`、`p20230403`、`p20230404`が含まれている場合、パーティション`p20230403`と`p20230404`が保持され、その他のパーティション（はるかに前に作成されたパーティション）が削除されます。将来の日付である4月5日と4月6日のデータなど、不正なデータがロードされた場合、パーティションには`p20230401`、`p20230402`、`p20230403`、`p20230404`、`p20230405`、`p20230406`が含まれ、`p20230403`、`p20230404`、`p20230405`、`p20230406`が保持され、その他のパーティションが削除されます。 |

### 使用上の注意

- データのロード中、StarRocksはロードされたデータに基づいて自動的にいくつかのパーティションを作成しますが、何らかの理由でロードジョブが失敗した場合、StarRocksによって自動的に作成されたパーティションは自動的に削除されません。
- StarRocksは、自動的に作成されるパーティションの最大数をデフォルトで4096に設定しています。これは、誤って多数のパーティションを作成することを防ぐためのものです。
- パーティションの命名規則は、動的パーティションの命名規則と一致しています。

### **例**

例1：日ごとにデータを頻繁にクエリする場合、パーティション式`date_trunc()`を使用して、パーティション列を`event_day`、パーティションの粒度を`day`としてテーブル作成時に指定することができます。データはロード中に日付に基づいて自動的にパーティション分割されます。同じ日のデータは1つのパーティションに格納され、パーティションプルーニングを使用してクエリの効率を大幅に向上させることができます。

```SQL
CREATE TABLE site_access1 (
    event_day DATETIME NOT NULL,
    site_id INT DEFAULT '10',
    city_code VARCHAR(100),
    user_name VARCHAR(32) DEFAULT '',
    pv BIGINT DEFAULT '0'
)
DUPLICATE KEY(event_day, site_id, city_code, user_name)
PARTITION BY date_trunc('day', event_day)
DISTRIBUTED BY HASH(event_day, site_id);
```

次の2つのデータ行がロードされると、StarRocksはデータに基づいて`p20230226`と`p20230227`の2つのパーティションを自動的に作成し、それぞれのパーティションの開始日時と終了日時を設定します。その後のロードされるデータがこれらの範囲内にある場合、それらは自動的に対応するパーティションにルーティングされます。

```SQL
-- 2つのデータ行を挿入
INSERT INTO site_access1  
    VALUES ("2023-02-26 20:12:04",002,"ニューヨーク","サム・スミス",1),
           ("2023-02-27 21:06:54",001,"ロサンゼルス","テイラー・スウィフト",1);

-- パーティションを表示
mysql > SHOW PARTITIONS FROM site_access1;
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+------------------------------------------------------------------------------------------------------+--------------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
| PartitionId | PartitionName | VisibleVersion | VisibleVersionTime  | VisibleVersionHash | State  | PartitionKey | Range                                                                                                | DistributionKey    | Buckets | ReplicationNum | StorageMedium | CooldownTime        | LastConsistencyCheckTime | DataSize | IsInMemory | RowCount |
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+------------------------------------------------------------------------------------------------------+--------------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
| 17138       | p20230226     | 2              | 2023-07-19 17:53:59 | 0                  | NORMAL | event_day    | [types: [DATETIME]; keys: [2023-02-26 00:00:00]; ..types: [DATETIME]; keys: [2023-02-27 00:00:00]; ) | event_day, site_id | 6       | 3              | HDD           | 9999-12-31 23:59:59 | NULL                     | 0B       | false      | 0        |
| 17113       | p20230227     | 2              | 2023-07-19 17:53:59 | 0                  | NORMAL | event_day    | [types: [DATETIME]; keys: [2023-02-27 00:00:00]; ..types: [DATETIME]; keys: [2023-02-28 00:00:00]; ) | event_day, site_id | 6       | 3              | HDD           | 9999-12-31 23:59:59 | NULL                     | 0B       | false      | 0        |
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+------------------------------------------------------------------------------------------------------+--------------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
2 rows in set (0.00 sec)
```

例2：パーティションのライフサイクル管理を実装する場合、最新の3つのパーティションのみを保持し、過去のパーティションを削除するようにするには、`partition_live_number`プロパティを使用して保持するパーティションの数を指定します。

```SQL
CREATE TABLE site_access2 (
    event_day DATETIME NOT NULL,
    site_id INT DEFAULT '10',
    city_code VARCHAR(100),
    user_name VARCHAR(32) DEFAULT '',
    pv BIGINT DEFAULT '0'
) 
DUPLICATE KEY(event_day, site_id, city_code, user_name)
PARTITION BY date_trunc('month', event_day)
DISTRIBUTED BY HASH(event_day, site_id)
PROPERTIES(
    "partition_live_number" = "3" -- 最新の3つのパーティションのみを保持
);
```

例3：週ごとにデータを頻繁にクエリする場合、パーティション式`time_slice()`を使用して、パーティション列を`event_day`、パーティションの粒度を7日としてテーブル作成時に指定することができます。1週間のデータは1つのパーティションに格納され、パーティションプルーニングを使用してクエリの効率を大幅に向上させることができます。

```SQL
CREATE TABLE site_access(
    event_day DATETIME NOT NULL,
    site_id INT DEFAULT '10',
    city_code VARCHAR(100),
    user_name VARCHAR(32) DEFAULT '',
    pv BIGINT DEFAULT '0'
)
DUPLICATE KEY(event_day, site_id, city_code, user_name)
PARTITION BY time_slice(event_day, INTERVAL 7 day)
DISTRIBUTED BY HASH(event_day, site_id)
```

## 列式に基づくパーティショニング（v3.1以降）

特定のタイプのデータを頻繁にクエリや管理する場合、そのタイプを表す列をパーティション列として指定するだけで済みます。StarRocksは、ロードされたデータのパーティション列の値に基づいて自動的にパーティションを作成します。

ただし、テーブルに`city`という列が含まれ、国と都市に基づいてデータを頻繁にクエリや管理する場合など、特定のシナリオでは、[リストパーティショニング](./list_partitioning.md)を使用して、同じ国内の複数の都市のデータを1つのパーティションに格納する必要があります。

### 構文

```sql
PARTITION BY expression
...
[ PROPERTIES("partition_live_number" = "xxx") ]

expression ::=
    ( partition_columns )
    
partition_columns ::=
    <column>, [ <column> [,...] ]
```

### パラメータ

| **パラメーター**          | **必須** | **説明**                                                  |
| ----------------------- | -------- | ------------------------------------------------------------ |
| `partition_columns`     | YES      | パーティション列の名前。<br/> <ul><li>パーティション列の値は、文字列（BINARYはサポートされていません）、日付または日時、整数、およびブール値にすることができます。パーティション列は`NULL`値を許容します。</li><li> 各パーティションには、パーティション列の値が同じであるデータのみを含めることができます。パーティション列の異なる値を含むデータを1つのパーティションに含めるには、[リストパーティショニング](./list_partitioning.md)を参照してください。</li></ul> |
| `partition_live_number` | No      | 保持するパーティションの数です。パーティション列の値をパーティション間で比較し、パーティション列の値が小さいパーティションを定期的に削除しながら、値が大きいパーティションを保持します。<br/>StarRocksは、パーティションの数を管理するためのタスクをスケジュールし、スケジュール間隔はFEの動的パラメータ`dynamic_partition_check_interval_seconds`を介して設定できます。デフォルト値は600秒（10分）です。<br/>**注意**<br/>パーティション列の値が文字列の場合、StarRocksはパーティション名の辞書順を比較し、後に来るパーティションを定期的に削除しながら、先に来るパーティションを保持します。 |

### 使用上の注意

- データのロード中、StarRocksはロードされたデータに基づいて自動的にいくつかのパーティションを作成しますが、何らかの理由でロードジョブが失敗した場合、StarRocksによって自動的に作成されたパーティションは自動的に削除されません。
- StarRocksは、自動的に作成されるパーティションの最大数をデフォルトで4096に設定しています。これは、誤って多数のパーティションを作成することを防ぐためのものです。
- パーティションの命名規則：複数のパーティション列が指定されている場合、異なるパーティション列の値はパーティション名でアンダースコア `_` で接続され、形式は `p<パーティション列1の値>_<パーティション列2の値>_...` です。 たとえば、パーティション列として2つの列 `dt` と `province` を指定し、どちらも文字列型であり、値が `2022-04-01` と `beijing` のデータ行がロードされた場合、自動的に作成される対応するパーティションの名前は `p20220401_beijing` です。

### 例

例1：時間範囲と特定の都市に基づいてデータセンターの請求の詳細を頻繁にクエリする場合、テーブル作成時にパーティション式を使用して、最初のパーティション列を`dt`と`city`として指定することができます。これにより、同じ日付と都市に属するデータが同じパーティションにルーティングされ、パーティションプルーニングを使用してクエリの効率を大幅に向上させることができます。

```SQL
CREATE TABLE t_recharge_detail1 (
    id bigint,
    user_id bigint,
    recharge_money decimal(32,2), 
    city varchar(20) not null,
    dt varchar(20) not null
)
DUPLICATE KEY(id)
PARTITION BY (dt,city)
DISTRIBUTED BY HASH(`id`);
```

テーブルに単一のデータ行を挿入します。

```SQL
INSERT INTO t_recharge_detail1 
    VALUES (1, 1, 1, 'ヒューストン', '2022-04-01');
```

パーティションを表示します。結果は、StarRocksがロードされたデータに基づいて`p20220401_Houston`というパーティションを自動的に作成したことを示しています。その後のロードでは、`dt`列と`city`列の値が`2022-04-01`と`Houston`であるデータがこのパーティションに自動的に格納されます。

> **注意**
>
> 各パーティションには、パーティション列の指定された1つの値のみを含めることができます。パーティション列の異なる値を含むデータを1つのパーティションに含めるには、[リストパーティション](./list_partitioning.md)を参照してください。

```SQL
MySQL > SHOW PARTITIONS from t_recharge_detail1\G
*************************** 1. row ***************************
             PartitionId: 16890
           PartitionName: p20220401_Houston
          VisibleVersion: 2
      VisibleVersionTime: 2023-07-19 17:24:53
      VisibleVersionHash: 0
                   State: NORMAL
            PartitionKey: dt, city
                    List: (('2022-04-01', 'Houston'))
         DistributionKey: id
                 Buckets: 6
          ReplicationNum: 3
           StorageMedium: HDD
            CooldownTime: 9999-12-31 23:59:59
LastConsistencyCheckTime: NULL
                DataSize: 2.5KB
              IsInMemory: false
                RowCount: 1
1 row in set (0.00 sec)
```

例2：パーティションのライフサイクル管理を実装するために、テーブル作成時に`partition_live_number`プロパティを設定し、最新の3つのパーティションのみを保持するようにします。

```SQL
CREATE TABLE t_recharge_detail2 (
    id bigint,
    user_id bigint,
    recharge_money decimal(32,2), 
    city varchar(20) not null,
    dt varchar(20) not null
)
DUPLICATE KEY(id)
PARTITION BY (dt,city)
DISTRIBUTED BY HASH(`id`) 
PROPERTIES(
    "partition_live_number" = "3" -- 最新の3つのパーティションのみを保持
);
```

## パーティションの管理

### パーティションへのデータのロード

データのロード中、StarRocksはロードされたデータとパーティション式で定義されたパーティションルールに基づいて自動的にパーティションを作成します。

ただし、テーブル作成時に式パーティショニングを使用し、特定のパーティションにデータを上書きするために[INSERT OVERWRITE](../loading/InsertInto.md#overwrite-data-via-insert-overwrite-select)を使用する場合、パーティションが作成されているかどうかに関係なく、現在は`PARTITION()`で明示的にパーティション範囲を指定する必要があります。これは、[範囲パーティショニング](./Data_distribution.md#range-partitioning)または[リストパーティショニング](./list_partitioning.md)とは異なり、`PARTITION (<partition_name>)`の形式でパーティション名のみを指定することができるためです。

テーブル作成時に時間関数式を使用し、特定のパーティションにデータを上書きする場合、そのパーティションの開始日または日時（テーブル作成時に設定したパーティションの粒度）を指定する必要があります。パーティションが存在しない場合、データのロード中に自動的に作成されることがあります。

```SQL
INSERT OVERWRITE site_access1 PARTITION(event_day='2022-06-08 20:12:04')
    SELECT * FROM site_access2 PARTITION(p20220608);
```

テーブル作成時に列式を使用し、特定のパーティションにデータを上書きする場合、そのパーティションに含まれるパーティション列の値を指定する必要があります。パーティションが存在しない場合、データのロード中に自動的に作成されることがあります。

```SQL
INSERT OVERWRITE t_recharge_detail1 PARTITION(dt='2022-04-02',city='texas')
    SELECT * FROM t_recharge_detail2 PARTITION(p20220402_texas);
```

### パーティションの表示

自動的に作成されたパーティションの特定の情報を表示する場合は、`SHOW PARTITIONS FROM <table_name>`ステートメントを使用する必要があります。`SHOW CREATE TABLE <table_name>`ステートメントは、テーブル作成時に設定された式パーティショニングの構文のみを返します。

```SQL
MySQL > SHOW PARTITIONS FROM t_recharge_detail1;
+-------------+-------------------+----------------+---------------------+--------------------+--------+--------------+-----------------------------+-----------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
| PartitionId | PartitionName     | VisibleVersion | VisibleVersionTime  | VisibleVersionHash | State  | PartitionKey | List                        | DistributionKey | Buckets | ReplicationNum | StorageMedium | CooldownTime        | LastConsistencyCheckTime | DataSize | IsInMemory | RowCount |
+-------------+-------------------+----------------+---------------------+--------------------+--------+--------------+-----------------------------+-----------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
| 16890       | p20220401_Houston | 2              | 2023-07-19 17:24:53 | 0                  | NORMAL | dt, city     | (('2022-04-01', 'Houston')) | id              | 6       | 3              | HDD           | 9999-12-31 23:59:59 | NULL                     | 2.5KB    | false      | 1        |
| 17056       | p20220402_texas   | 2              | 2023-07-19 17:27:42 | 0                  | NORMAL | dt, city     | (('2022-04-02', 'texas'))   | id              | 6       | 3              | HDD           | 9999-12-31 23:59:59 | NULL                     | 2.5KB    | false      | 1        |
+-------------+-------------------+----------------+---------------------+--------------------+--------+--------------+-----------------------------+-----------------+---------+----------------+---------------+---------------------+--------------------------+----------+------------+----------+
2 rows in set (0.00 sec)
```

## 制限事項

- v3.1.0以降、StarRocksの[共有データモード](../deployment/shared_data/s3.md)は[時間関数式](#時間関数式に基づくパーティショニング)をサポートしています。また、v3.1.1以降、StarRocksの[共有データモード](../deployment/shared_data/s3.md)は[列式](#列式に基づくパーティショニング（v3.1以降）)をさらにサポートしています。
- 現在、式パーティショニングが設定されたテーブルを作成するためにCTASを使用することはサポートされていません。
- 現在、式パーティショニングを使用しているテーブルにデータをロードするためにSpark Loadを使用することはサポートされていません。
- `ALTER TABLE <table_name> DROP PARTITION <partition_name>`ステートメントを使用して列式によって作成されたパーティションを削除する場合、パーティション内のデータは直接削除され、復元することはできません。
- 式パーティショニングによって作成されたパーティションを[バックアップとリストア](../administration/Backup_and_restore.md)することは現在できません。
