---
displayed_sidebar: "Japanese"
---

# 集約テーブル

集約テーブルを使用してテーブルを作成すると、ソートキーカラムとメトリックカラムを定義し、メトリックカラムに対して集計関数を指定することができます。ロードするレコードが同じソートキーを持つ場合、メトリックカラムは集計されます。集約テーブルは、クエリの処理に必要なデータ量を減らし、クエリの高速化を図るのに役立ちます。

## シナリオ

集約テーブルは、データの統計と分析のシナリオに適しています。以下にいくつかの例を示します：

- ウェブサイトやアプリのプロバイダーが、特定のウェブサイトやアプリにユーザーがどれだけのトラフィックと時間を費やし、ウェブサイトやアプリへの総訪問回数を分析するのを支援します。

- 広告代理店が、顧客に提供する広告の総クリック数、総表示回数、および消費統計を分析するのを支援します。

- 電子商取引会社が、個々の四半期や月ごとの地理的なベストセラーを特定するために、年間の取引データを分析するのを支援します。

前述のシナリオにおけるデータのクエリとインジェスチョンには、次の特徴があります：

- ほとんどのクエリは、SUM、MAX、MINなどの集計クエリです。
- 生の詳細データは取得する必要がありません。
- 過去のデータは頻繁に更新されません。新しいデータのみが追加されます。

## 原理

集約テーブルを使用するテーブルにおいて、データのインジェスチョンからデータのクエリまで、同じソートキーを持つデータは以下のように複数回集計されます：

1. データインジェスチョンフェーズでは、データがテーブルにバッチ単位でロードされる際、各バッチはデータバージョンを構成します。データバージョンが生成された後、StarRocksはデータバージョン内の同じソートキーを持つデータを集計します。
2. バックグラウンドのコンパクションフェーズでは、データインジェスチョンで生成された複数のデータバージョンのファイルが定期的に大きなファイルにコンパクションされる際、StarRocksは大きなファイル内の同じソートキーを持つデータを集計します。
3. データクエリフェーズでは、クエリ結果を返す前に、StarRocksはすべてのデータバージョン内の同じソートキーを持つデータを集計します。

集計操作により、処理する必要のあるデータ量が減少し、クエリの高速化が図られます。

集約テーブルを使用するテーブルに以下の4つの生のレコードをロードしたい場合を想定してください。

| 日付       | 国      | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 1    |
| 2020.05.01 | CHN     | 2    |
| 2020.05.01 | USA     | 3    |
| 2020.05.01 | USA     | 4    |

StarRocksは、データインジェスチョン時に4つの生のレコードを以下の2つのレコードに集計します。

| 日付       | 国      | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 3    |
| 2020.05.01 | USA     | 7    |

## テーブルの作成

異なる都市から異なるウェブページへの訪問回数を分析したい場合を想定してください。この例では、`example_db.aggregate_tbl`という名前のテーブルを作成し、`site_id`、`date`、`city_code`をソートキーカラムとして定義し、`pv`をメトリックカラムとして定義し、`pv`カラムにはSUM関数を指定します。

テーブルの作成文は次のようになります：

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "サイトのID",
    date DATE NOT NULL COMMENT "イベントの時刻",
    city_code VARCHAR(20) COMMENT "ユーザーの都市コード",
    pv BIGINT SUM DEFAULT "0" COMMENT "合計ページビュー数"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **注意**
>
> - テーブルを作成する際は、`DISTRIBUTED BY HASH`句を使用してバケット化カラムを指定する必要があります。詳細については、[バケット化](../Data_distribution.md#design-partitioning-and-bucketing-rules)を参照してください。
> - v2.5.7以降、StarRocksはテーブルの作成またはパーティションの追加時にバケットの数（BUCKETS）を自動的に設定できるようになりました。バケットの数を手動で設定する必要はありません。詳細については、[バケットの数を決定する](../Data_distribution.md#determine-the-number-of-buckets)を参照してください。

## 使用上の注意

- テーブルのソートキーに関しては、以下の点に注意してください：
  - `AGGREGATE KEY`キーワードを使用して、ソートキーに使用される列を明示的に定義することができます。

    - `AGGREGATE KEY`キーワードにすべてのディメンション列が含まれていない場合、テーブルを作成することはできません。
    - デフォルトでは、`AGGREGATE KEY`キーワードを使用して明示的にソートキーカラムを定義しない場合、StarRocksはメトリックカラム以外のすべての列をソートキーカラムとして選択します。

  - ソートキーは、一意制約が適用されている列上に作成する必要があります。名前を変更できないすべてのディメンション列で構成する必要があります。

- 列の名前の後に集計関数を指定することで、列をメトリックカラムとして定義することができます。ほとんどの場合、メトリックカラムには集計および分析が必要なデータが格納されます。

- 集約テーブルでサポートされている集計関数の詳細については、[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md)を参照してください。

- クエリ実行時、ソートキーカラムは複数のデータバージョンの集計の前にフィルタリングされ、メトリックカラムは複数のデータバージョンの集計の後にフィルタリングされます。そのため、頻繁にフィルタ条件として使用される列を特定し、これらの列をソートキーとして定義することをおすすめします。これにより、データのフィルタリングが複数のデータバージョンの集計の前に開始され、クエリのパフォーマンスが向上します。

- テーブルを作成する際、テーブルのメトリックカラムにはBITMAPインデックスやBloom Filterインデックスを作成することはできません。

## 次の手順

テーブルが作成されたら、さまざまなデータインジェスチョン方法を使用してデータをStarRocksにロードすることができます。StarRocksでサポートされているデータインジェスチョン方法の詳細については、[データのインポート](../../loading/Loading_intro.md)を参照してください。

> 注意：集約テーブルを使用するテーブルにデータをロードする際、テーブルのすべての列を更新することができます。例えば、前述の`example_db.aggregate_tbl`テーブルを更新する場合、`site_id`、`date`、`city_code`、`pv`のすべての列を更新する必要があります。
