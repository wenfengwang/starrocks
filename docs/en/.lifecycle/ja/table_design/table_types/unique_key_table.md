---
displayed_sidebar: "Japanese"
---

# ユニークキー表

テーブルを作成する際に、プライマリキーカラムとメトリックカラムを定義することができます。これにより、クエリは同じプライマリキーを持つレコードの中で最新のレコードを返します。重複キー表と比較して、ユニークキー表はリアルタイムで頻繁にデータを更新するためのデータローディングプロセスを簡素化するため、より良いサポートを提供します。

## シナリオ

ユニークキー表は、データをリアルタイムに頻繁に更新する必要があるビジネスシナリオに適しています。たとえば、電子商取引のシナリオでは、1日に数億件の注文が行われ、注文のステータスが頻繁に変更されます。

## 原則

ユニークキー表は、メトリックカラムにREPLACE集計関数が指定された特殊な集計キー表と考えることができます。これにより、同じプライマリキーを持つレコードの中で最新のレコードが返されます。

ユニークキー表を使用するテーブルにデータをロードする場合、データは複数のバッチに分割されます。各バッチにはバージョン番号が割り当てられます。したがって、同じプライマリキーを持つレコードは複数のバージョンで提供される可能性があります。そのうち最新のバージョン（つまり、最大のバージョン番号を持つレコード）がクエリに対して取得されます。

以下の表に示すように、`ID`はプライマリキーカラム、`value`はメトリックカラム、`_version`はStarRocks内で生成されるデータバージョン番号を保持しています。この例では、`ID`が1のレコードはバージョン番号が1と2の2つのバッチでロードされ、`ID`が2のレコードはバージョン番号が3、4、5の3つのバッチでロードされています。

| ID   | value | _version |
| ---- | ----- | -------- |
| 1    | 100   | 1        |
| 1    | 101   | 2        |
| 2    | 100   | 3        |
| 2    | 101   | 4        |
| 2    | 102   | 5        |

`ID`が1のレコードをクエリする場合、この場合は最新のレコードであるバージョン番号2のレコードが返されます。`ID`が2のレコードをクエリする場合、この場合は最新のレコードであるバージョン番号5のレコードが返されます。以下の表は、2つのクエリによって返されるレコードを示しています。

| ID   | value |
| ---- | ----- |
| 1    | 101   |
| 2    | 102   |

## テーブルの作成

電子商取引のシナリオでは、注文のステータスを日付ごとに収集して分析する必要があります。この例では、注文を保持する`orders`という名前のテーブルを作成し、注文をフィルタリングするための頻繁に使用される`create_time`と`order_id`をプライマリキーカラムとして定義し、他の2つのカラム、`order_state`と`total_price`をメトリックカラムとして定義します。これにより、注文はステータスが変更されるたびにリアルタイムに更新され、クエリの高速化のために迅速にフィルタリングされることができます。

テーブルの作成文は次のようになります：

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "注文の作成日時",
    order_id BIGINT NOT NULL COMMENT "注文のID",
    order_state INT COMMENT "注文のステータス",
    total_price BIGINT COMMENT "注文の価格"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注意**
>
> - テーブルを作成する際には、`DISTRIBUTED BY HASH`句を使用してバケット化カラムを指定する必要があります。詳細については、[バケット化](../Data_distribution.md#design-partitioning-and-bucketing-rules)を参照してください。
> - v2.5.7以降、StarRocksはテーブルの作成またはパーティションの追加時にバケットの数（BUCKETS）を自動的に設定することができます。バケットの数を手動で設定する必要はありません。詳細については、[バケットの数を決定する](../Data_distribution.md#determine-the-number-of-buckets)を参照してください。

## 使用上の注意

- テーブルのプライマリキーに関しては、次の点に注意してください：

  - プライマリキーは`UNIQUE KEY`キーワードを使用して定義されます。
  - プライマリキーは、一意制約が適用され、名前を変更できないカラムに作成する必要があります。
  - プライマリキーは適切に設計する必要があります：
    - クエリが実行される際、プライマリキーカラムは複数のデータバージョンの集計の前にフィルタリングされますが、メトリックカラムは複数のデータバージョンの集計の後にフィルタリングされます。そのため、フィルタ条件として頻繁に使用されるカラムを特定し、これらのカラムをプライマリキーカラムとして定義することをおすすめします。これにより、データのフィルタリングが複数のデータバージョンの集計の前に開始され、クエリのパフォーマンスが向上します。
    - 集計プロセス中、StarRocksはすべてのプライマリキーカラムを比較します。これは時間がかかり、クエリのパフォーマンスが低下する可能性があります。したがって、大量のプライマリキーカラムを定義しないでください。クエリのフィルタ条件としてほとんど使用されないカラムの場合は、プライマリキーカラムとして定義しないことをおすすめします。

- テーブルを作成する際、テーブルのメトリックカラムにはBITMAPインデックスやBloom Filterインデックスを作成することはできません。

- ユニークキー表はマテリアライズドビューをサポートしていません。

## 次の手順

テーブルが作成されたら、さまざまなデータインジェクション方法を使用してデータをStarRocksにロードすることができます。StarRocksがサポートするデータインジェクション方法の詳細については、[データのインポート](../../loading/Loading_intro.md)を参照してください。

> - ユニークキー表を使用するテーブルにデータをロードする場合、テーブルのすべてのカラムを更新することしかできません。たとえば、前述の`orders`テーブルを更新する場合、`create_time`、`order_id`、`order_state`、`total_price`のすべてのカラムを更新する必要があります。
> - ユニークキー表を使用するテーブルからデータをクエリする場合、StarRocksは複数のデータバージョンのレコードを集計する必要があります。このような状況では、大量のデータバージョンはクエリのパフォーマンスを低下させます。そのため、リアルタイムデータ分析の要件を満たしながら、大量のデータバージョンを防ぐために適切な頻度でデータをテーブルにロードすることをおすすめします。分単位のデータが必要な場合は、1秒のロード頻度ではなく、1分のロード頻度を指定することができます。
