---
displayed_sidebar: "Japanese"
---

# EXPORTを使用してデータをエクスポートする

このトピックでは、指定したテーブルまたはパーティションのデータをCSVデータファイルとして外部ストレージシステムにエクスポートする方法について説明します。外部ストレージシステムは、分散ファイルシステムHDFSやAWS S3などのクラウドストレージシステムです。

> **注意**
>
> StarRocksテーブルからデータをエクスポートするには、StarRocksテーブルにEXPORT権限を持つユーザーとしてのみエクスポートできます。EXPORT権限がない場合は、[GRANT](../sql-reference/sql-statements/account-management/GRANT.md)の手順に従って、StarRocksクラスターに接続するために使用するユーザーにEXPORT権限を付与してください。

## 背景情報

v2.4以前では、StarRocksはEXPORTステートメントを使用してデータをエクスポートする際に、ブローカーを使用してStarRocksクラスターと外部ストレージシステムの間の接続を設定していました。そのため、EXPORTステートメントで使用するブローカーを指定するために`WITH BROKER "<ブローカー名>"`を入力する必要があります。これは「ブローカーベースのアンローディング」と呼ばれます。ブローカーは、ファイルシステムインターフェースと統合された独立したステートレスサービスであり、StarRocksがデータを外部ストレージシステムにエクスポートするのを支援します。

v2.5以降、StarRocksはEXPORTステートメントを使用してデータをエクスポートする際に、もはやブローカーに依存しません。そのため、EXPORTステートメントでブローカーを指定する必要はありませんが、`WITH BROKER`キーワードは引き続き保持する必要があります。これは「ブローカーフリーアンローディング」と呼ばれます。

ただし、データがHDFSに格納されている場合、ブローカーフリーアンローディングは機能しない場合があります。次の場合には、ブローカーベースのアンローディングに戻ることができます。

- 複数のHDFSクラスターにデータをエクスポートする場合、各HDFSクラスターに独立したブローカーをデプロイして構成する必要があります。
- 単一のHDFSクラスターにデータをエクスポートし、複数のKerberosユーザーを構成している場合、独立したブローカーをデプロイする必要があります。

> **注意**
>
> [SHOW BROKER](../sql-reference/sql-statements/Administration/SHOW_BROKER.md)ステートメントを使用して、StarRocksクラスターにデプロイされているブローカーを確認できます。ブローカーがデプロイされていない場合は、[ブローカーのデプロイ](../deployment/deploy_broker.md)の手順に従ってブローカーをデプロイできます。

## サポートされているストレージシステム

- 分散ファイルシステムHDFS
- AWS S3などのクラウドストレージシステム

## 注意事項

- 一度にエクスポートするデータ量が数十GBを超えないように推奨します。一度に非常に大量のデータをエクスポートすると、エクスポートが失敗し、エクスポートの再試行のコストが増加します。

- ソースのStarRocksテーブルに大量のデータが含まれている場合、テーブルのすべてのデータがエクスポートされるまで、テーブルの一部のパーティションからのみデータをエクスポートすることをお勧めします。

- StarRocksクラスターのFEが再起動されるか、エクスポートジョブが実行中の新しいリーダーFEが選出されると、エクスポートジョブは失敗します。この状況では、エクスポートジョブを再度送信する必要があります。

- StarRocksクラスターのFEが再起動されるか、エクスポートジョブが終了した後に新しいリーダーFEが選出されると、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)ステートメントによって返されるジョブ情報の一部が失われる場合があります。

- StarRocksはベーステーブルのデータのみをエクスポートします。StarRocksは、ベーステーブル上に作成されたマテリアライズドビューのデータはエクスポートしません。

- エクスポートジョブにはデータスキャンが必要であり、I/Oリソースを占有し、クエリのレイテンシを増加させます。

## ワークフロー

エクスポートジョブを送信すると、StarRocksはエクスポートジョブに関与するすべてのタブレットを特定します。次に、StarRocksは関与するタブレットをグループに分割し、クエリプランを生成します。クエリプランは、関与するタブレットからデータを読み取り、データを宛先ストレージシステムの指定パスに書き込むために使用されます。

以下の図は、一般的なワークフローを示しています。

![img](../assets/5.3.1-1.png)

一般的なワークフローは、次の3つのステップで構成されています。

1. ユーザーはエクスポートジョブをリーダーFEに送信します。

2. リーダーFEはStarRocksクラスターのすべてのBEに`snapshot`命令を発行し、BEが関与するタブレットのスナップショットを取得してエクスポートするデータの一貫性を確保します。リーダーFEはまた、複数のエクスポートタスクを生成します。各エクスポートタスクはクエリプランであり、各クエリプランは関与するタブレットの一部を処理するために使用されます。

3. リーダーFEはエクスポートタスクをBEに配布します。

## 原則

StarRocksがクエリプランを実行する際、まず指定された宛先ストレージシステムの指定パスに`__starrocks_export_tmp_xxx`という名前の一時フォルダを作成します。一時フォルダの名前では、`xxx`はエクスポートジョブのIDを表します。一時フォルダの例としては、`__starrocks_export_tmp_921d8f80-7c9d-11eb-9342-acde48001122`という名前があります。StarRocksがクエリプランを正常に実行すると、一時フォルダに一時ファイルが生成され、エクスポートされたデータが生成された一時ファイルに書き込まれます。

すべてのデータがエクスポートされた後、StarRocksはRENAMEステートメントを使用して生成された一時ファイルを指定されたパスに保存します。

## 関連するパラメータ

このセクションでは、StarRocksクラスターのFEで設定できるいくつかのエクスポート関連のパラメータについて説明します。

- `export_checker_interval_second`：エクスポートジョブのスケジュール間隔です。デフォルトの間隔は5秒です。このパラメータをFEで再構成した後は、新しいパラメータ設定が有効になるようにFEを再起動する必要があります。

- `export_running_job_num_limit`：許可される実行中のエクスポートジョブの最大数です。実行中のエクスポートジョブの数がこの制限を超えると、余分なエクスポートジョブは`snapshot`の実行後に待機状態に入ります。デフォルトの最大数は5です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_task_default_timeout_second`：エクスポートジョブのタイムアウト期間です。デフォルトのタイムアウト期間は2時間です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_max_bytes_per_be_per_task`：各BEからエクスポートタスクごとにエクスポートできる圧縮されたデータの最大量です。このパラメータは、StarRocksが同時に実行できるエクスポートタスクにエクスポートジョブを分割する基準を提供します。デフォルトの最大量は256 MBです。

- `export_task_pool_size`：スレッドプールで同時に実行できるエクスポートタスクの最大数です。デフォルトの最大数は5です。

## 基本的な操作

### エクスポートジョブの送信

StarRocksデータベース`db1`に`tbl1`という名前のテーブルが含まれているとします。`tbl1`のパーティション`p1`と`p2`から列`col1`と`col3`のデータをHDFSクラスターの`export`パスにエクスポートするには、次のコマンドを実行します。

```SQL
EXPORT TABLE db1.tbl1 
PARTITION (p1,p2)
(col1, col3)
TO "hdfs://HDFS_IP:HDFS_Port/export/lineorder_" 
PROPERTIES
(
    "column_separator"=",",
    "load_mem_limit"="2147483648",
    "timeout" = "3600"
)
WITH BROKER
(
    "username" = "user",
    "password" = "passwd"
);
```

詳細な構文とパラメータの説明、およびデータをAWS S3にエクスポートするコマンドの例については、[EXPORT](../sql-reference/sql-statements/data-manipulation/EXPORT.md)を参照してください。

### エクスポートジョブのクエリIDの取得

エクスポートジョブを送信した後、SELECT LAST_QUERY_ID()ステートメントを使用してエクスポートジョブのクエリIDをクエリできます。クエリIDを使用して、エクスポートジョブを表示またはキャンセルすることができます。

詳細な構文とパラメータの説明については、[last_query_id](../sql-reference/sql-functions/utility-functions/last_query_id.md)を参照してください。

### エクスポートジョブのステータスの表示

エクスポートジョブを送信した後、SHOW EXPORTステートメントを使用してエクスポートジョブのステータスを表示できます。例：

```SQL
SHOW EXPORT WHERE queryid = "edee47f0-abe1-11ec-b9d1-00163e1e238f";
```

> **注意**
>
> 上記の例では、`queryid`はエクスポートジョブのクエリIDです。

次のような情報が返されます。

```Plain
JobId: 14008
State: FINISHED
Progress: 100%
TaskInfo: {"partitions":["*"],"mem limit":2147483648,"column separator":",","line delimiter":"\n","tablet num":1,"broker":"hdfs","coord num":1,"db":"default_cluster:db1","tbl":"tbl3",columns:["col1", "col3"]}
Path: oss://bj-test/export/
CreateTime: 2019-06-25 17:08:24
StartTime: 2019-06-25 17:08:28
FinishTime: 2019-06-25 17:08:34
Timeout: 3600
ErrorMsg: N/A
```

詳細な構文とパラメータの説明については、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)を参照してください。

### エクスポートジョブのキャンセル

送信したエクスポートジョブをキャンセルするには、CANCEL EXPORTステートメントを使用します。例：

```SQL
CANCEL EXPORT WHERE queryid = "921d8f80-7c9d-11eb-9342-acde48001122";
```

> **注意**
>
> 上記の例では、`queryid`はエクスポートジョブのクエリIDです。

詳細な構文とパラメータの説明については、[CANCEL EXPORT](../sql-reference/sql-statements/data-manipulation/CANCEL_EXPORT.md)を参照してください。

## ベストプラクティス

### クエリプランの分割

エクスポートジョブが分割されるクエリプランの数は、エクスポートジョブに関与するタブレットの数と、クエリプランごとに処理できる最大データ量によって異なります。エクスポートジョブはクエリプランとして再試行されます。クエリプランが許可される最大量を超えるデータ量がクエリプランで処理されると、クエリプランはリモートストレージのジッタなどのエラーに遭遇します。その結果、クエリプランの再試行のコストが増加します。各BEごとにクエリプランで処理できる最大データ量は、`export_max_bytes_per_be_per_task`パラメータで指定され、デフォルトでは256 MBです。クエリプランでは、各BEに少なくとも1つのタブレットが割り当てられ、`export_max_bytes_per_be_per_task`パラメータで指定された制限を超えないデータ量をエクスポートできます。

エクスポートジョブの複数のクエリプランは同時に実行されます。FEパラメータ`export_task_pool_size`を使用して、スレッドプールで同時に実行できるエクスポートタスクの最大数を指定できます。このパラメータのデフォルト値は`5`です。

通常、エクスポートジョブのクエリプランはスキャンとエクスポートの2つのパートのみで構成されます。クエリプランによって必要とされる計算を実行するためのロジックは、メモリを多く消費しません。したがって、2 GBのデフォルトのメモリ制限は、ほとんどのビジネス要件を満たすことができます。ただし、特定の状況では、クエリプランが多くのタブレットをスキャンする必要がある場合や、タブレットに多くのバージョンがある場合など、2 GBのメモリ容量では不十分な場合があります。このような場合は、`load_mem_limit`パラメータを使用して、4 GBや8 GBなどのより高いメモリ容量制限を指定する必要があります。
