---
displayed_sidebar: "Japanese"
---

# ディスクへのスピル

このトピックでは、大規模な演算子の中間計算結果をディスクにスピルする方法について説明します。

## 概要

StarRocksのようなクエリ実行にインメモリコンピューティングを依存するデータベースシステムでは、集計、ソート、結合演算子を使用したクエリの処理時に大量のメモリリソースを消費することがあります。メモリ制限に達すると、これらのクエリはメモリ不足により強制的に終了されます。

ただし、特定のメモリ集約型のタスクを安定して完了させ、パフォーマンスが最優先ではない場合（例：マテリアライズドビューの構築、INSERT INTO SELECTを使用した軽量なETLの実行など）、メモリリソースが容易に枯渇し、クラスタ内で実行中の他のクエリがブロックされる可能性があります。通常、この問題に対処するためには、これらのタスクを個別に微調整することしかできず、クエリの同時実行を制御するためにリソースの分離戦略に依存する必要があります。これは特にいくつかの極端なシナリオでは不便であり、失敗する可能性があります。

StarRocks v3.0.1以降、StarRocksは一部のメモリ集約型演算子の中間結果をディスクにスピルする機能をサポートしています。この機能により、パフォーマンスのわずかな低下と引き換えに、メモリ使用量を大幅に削減し、システムの可用性を向上させることができます。

現在、StarRocksのスピル機能は以下の演算子をサポートしています：

- 集計演算子
- ソート演算子
- ハッシュ結合（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN、INNER JOIN）演算子

## 中間結果スピルの有効化

中間結果スピルを有効にするには、次の手順に従ってください：

1. BEの設定ファイル**be.conf**で、スピルされた中間結果を保存するスピルディレクトリ`spill_local_storage_dir`を指定し、変更を有効にするためにクラスタを再起動します。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **注意**
   >
   > - `spill_local_storage_dir`はセミコロン（`;`）で区切って複数指定することができます。
   > - 本番環境では、データストレージとスピルには異なるディスクを使用することを強くお勧めします。中間結果がディスクにスピルされると、書き込み負荷とディスク使用量が大幅に増加する可能性があります。同じディスクを使用すると、この急増がクラスタ内で実行中の他のクエリやタスクに影響を与える可能性があります。

2. 中間結果スピルを有効にするために、次のステートメントを実行します：

   ```SQL
   SET enable_spill = true;
   ```

3. セッション変数`spill_mode`を使用して中間結果スピルのモードを設定します：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **注意**
   >
   > スピルを含むクエリが完了するたびに、StarRocksは自動的にクエリが生成するスピルデータをクリアします。BEがデータをクリアする前にクラッシュした場合、StarRocksはBEが再起動されるとデータをクリアします。

   | **変数**       | **デフォルト** | **説明**                                                     |
   | -------------- | -------------- | ------------------------------------------------------------ |
   | enable_spill   | false          | 中間結果スピルを有効にするかどうか。`true`に設定すると、StarRocksはクエリの集計、ソート、結合演算子の処理時にメモリ使用量を削減するために中間結果をディスクにスピルします。 |
   | spill_mode     | auto           | 中間結果スピルの実行モード。有効な値：<ul><li>`auto`：メモリ使用量の閾値に達したときに自動的にスピルがトリガされます。</li><li>`force`：メモリ使用量に関係なく、StarRocksは関連するすべての演算子に対して強制的にスピルを実行します。</li></ul>この変数は、変数`enable_spill`が`true`に設定されている場合にのみ有効です。 |

## 制限事項

- スピルによって解決できるOOMの問題はすべてではありません。たとえば、StarRocksは式の評価に使用されるメモリを解放することはできません。
- 通常、スピルを含むクエリのレイテンシは10倍増加します。これらのクエリのクエリタイムアウトをセッション変数`query_timeout`を設定することで延長することをおすすめします。
