---
displayed_sidebar: "Japanese"
---

# クエリキュー

このトピックでは、StarRocksでクエリキューを管理する方法について説明します。

v2.5以降、StarRocksはクエリキューをサポートしています。クエリキューが有効になっている場合、StarRocksは並行性の閾値やリソース制限に達した場合に、クエリを自動的にキューに入れ、過負荷の悪化を回避します。保留中のクエリは、実行を開始するのに十分な計算リソースが利用可能になるまでキューで待機します。v3.1.4以降、StarRocksはリソースグループレベルでのクエリキューの設定をサポートしています。

クエリキューをトリガーするために、CPU使用率、メモリ使用率、およびクエリの並行性に対する閾値を設定できます。

**ロードマップ**：

| バージョン | グローバルクエリキュー | リソースグループレベルのクエリキュー | 集合的な並行管理 | 動的な並行調整 |
| ------  | ------------------ | -------------------------------- | --------------------------------- | ------------------------------- |
| v2.5    | ✅                 | ❌                                | ❌                                | ❌                              |
| v3.1.4  | ✅                 | ✅                                | ✅                                | ✅                              |

## クエリキューの有効化

クエリキューはデフォルトで無効になっています。対応するグローバルセッション変数を設定することで、INSERTロード、SELECTクエリ、および統計クエリのためのグローバルまたはリソースグループレベルのクエリキューを有効にすることができます。

### グローバルクエリキューの有効化

- ロードタスクのためのクエリキューを有効にする場合:

```SQL
SET GLOBAL enable_query_queue_load = true;
```

- SELECTクエリのためのクエリキューを有効にする場合:

```SQL
SET GLOBAL enable_query_queue_select = true;
```

- 統計クエリのためのクエリキューを有効にする場合:

```SQL
SET GLOBAL enable_query_queue_statistic = true;
```

### リソースグループレベルのクエリキューの有効化

v3.1.4以降、StarRocksはリソースグループレベルでのクエリキューの設定をサポートしています。

リソースグループレベルのクエリキューを有効にするには、グローバルセッション変数に加えて `enable_group_level_query_queue` を設定する必要があります。

```SQL
SET GLOBAL enable_group_level_query_queue = true;
```

## リソースの閾値の指定

### グローバルクエリキューのリソース閾値の指定

以下のグローバルセッション変数を使用して、クエリキューをトリガーする閾値を設定できます。

| **変数**                              | **デフォルト** | **説明**                                                     |
| ----------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_concurrency_limit       | 0           | BE上の同時クエリの上限です。`0` より大きい値に設定された場合にのみ効果があります。 |
| query_queue_mem_used_pct_limit      | 0           | BE上のメモリ使用率の上限です。`0` より大きい値に設定された場合にのみ効果があります。範囲: [0, 1] |
| query_queue_cpu_used_permille_limit | 0           | BE上のCPU使用率パーミルの上限です（CPU使用率 * 1000）。`0` より大きい値に設定された場合にのみ効果があります。範囲: [0, 1000] |

> **注意**
>
> デフォルトでは、BEは1秒ごとにFEにリソース使用状況を報告します。BEの設定項目 `report_resource_usage_interval_ms` を設定することで、このインターバルを変更できます。

### リソースグループレベルのクエリキューのリソース閾値の指定

v3.1.4以降、リソースグループを作成する際に個別の並行性制限 (`concurrency_limit`) とCPUコア制限 (`max_cpu_cores`) を設定できます。クエリが開始されると、グローバルまたはリソースグループレベルのいずれかのリソース消費が閾値を超える場合、クエリはリソース消費が閾値内に収まるまでキューに入れられます。

| **変数**        | **デフォルト** | **説明**                                                     |
| ------------------- | ----------- | ------------------------------------------------------------ |
| concurrency_limit   | 0           | 単一のBEノード上のリソースグループの並行性制限です。`0` より大きい値に設定された場合にのみ効果があります。 |
| max_cpu_cores       | 0           | 単一のBEノード上のこのリソースグループのCPUコア制限です。`0` より大きい値に設定された場合にのみ効果があります。範囲: [0, `avg_be_cpu_cores`]（`avg_be_cpu_cores` はすべてのBEノードのCPUコア数の平均値を表します）。 |

[SHOW USAGE RESOURCE GROUPS](./resource_group.md#view-resource-group-usage-information) を使用して、各BEノードの各リソースグループのリソース使用状況情報を表示できます。

### クエリの並行性の管理

実行中のクエリ数 (`num_running_queries`) がグローバルまたはリソースグループの `concurrency_limit` を超えると、入力されたクエリはキューに入れられます。`num_running_queries` を取得する方法は、バージョン &lt; v3.1.4 と &ge; v3.1.4 で異なります。

- バージョン &lt; v3.1.4 の場合、`num_running_queries` は `report_resource_usage_interval_ms` で指定された間隔でBEによって報告されます。そのため、`num_running_queries` がBEによって報告された時点でグローバルまたはリソースグループの `concurrency_limit` を超えていない場合でも、次の報告までに入力されたクエリが到着し、`concurrency_limit` を超える場合、これらの入力されたクエリはキューで待機せずに実行されます。

- バージョン &ge; v3.1.4 の場合、すべての実行中のクエリはリーダーFEによって集中的に管理されます。各フォロワーFEはクエリの開始または終了時にリーダーFEに通知し、`concurrency_limit` を超えるクエリの急増が発生した場合にもStarRocksが対応できるようにします。

## クエリキューの設定

以下のグローバルセッション変数を使用して、クエリキューの容量とキュー内のクエリの最大タイムアウトを設定できます。

| **変数**                       | **デフォルト** | **説明**                                                     |
| ---------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_max_queued_queries     | 1024        | キュー内のクエリの上限です。この閾値に達すると、入力されたクエリは拒否されます。`0` より大きい値に設定された場合にのみ効果があります。 |
| query_queue_pending_timeout_second | 300         | キュー内の保留中のクエリの最大タイムアウトです。この閾値に達すると、対応するクエリは拒否されます。単位: 秒。 |

## クエリの並行調整の動的な設定

v3.1.4以降、クエリキューによって管理され、パイプラインエンジンによって実行されるクエリについて、StarRocksは現在の実行中のクエリ数 `num_running_queries`、フラグメント数 `num_fragments`、およびクエリの並行性 `pipeline_dop` に基づいて、クエリの並行性 `pipeline_dop` を動的に調整することができます。これにより、スケジューリングのオーバーヘッドを最小限に抑えながら、クエリの並行性を動的に制御し、最適なBEリソースの利用を確保することができます。フラグメントとクエリの並行性 `pipeline_dop` についての詳細は、[クエリ管理 - クエリの並行性の調整](./Query_management.md) を参照してください。

クエリキューの下にある各クエリに対して、StarRocksはドライバという概念を維持しています。ドライバは、単一のBE上のクエリの並行フラグメントを表します。論理的な値である `num_drivers` は、単一のBE上のそのクエリのすべてのフラグメントの総並行性を表し、`num_fragments * pipeline_dop` と等しくなります。新しいクエリが到着すると、StarRocksは次のルールに基づいてクエリの並行性 `pipeline_dop` を調整します。

- 実行中のドライバ数 `num_drivers` が並行ドライバの低水位制限 `query_queue_driver_low_water` を超えるほど、クエリの並行性 `pipeline_dop` は低く調整されます。
- StarRocksは、クエリの並行ドライバの高水位制限 `query_queue_driver_high_water` を超えないように実行中のドライバ数 `num_drivers` を制限します。

以下のグローバルセッション変数を使用して、クエリの並行性 `pipeline_dop` の動的な調整を設定できます。

| **変数**                  | **デフォルト** | **説明**                                             |
| ----------------------------- | ----------- | ----------------------------------------------------------- |
| query_queue_driver_high_water | -1          | クエリの並行ドライバの高水位制限です。非負の値に設定された場合にのみ効果があります。`0` の場合、`avg_be_cpu_cores * 16` と等価です（`avg_be_cpu_cores` はすべてのBEノードのCPUコア数の平均値を表します）。`0` より大きい値に設定された場合、その値が直接使用されます。 |
| query_queue_driver_low_water  | -1          | クエリの低水位制限の並行ドライバです。非負の値に設定された場合にのみ効果があります。`0` の場合、`avg_be_cpu_cores * 8` と等価です。`0` より大きい値に設定された場合、その値が直接使用されます。 |

## クエリキューのモニタリング

以下の方法を使用して、クエリキューに関連する情報を表示できます。

### SHOW PROC

[SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md) を使用して、BEノードで実行中のクエリの数、メモリ使用率、およびCPU使用率を確認できます。

```Plain
mysql> SHOW PROC '/backends'\G
*************************** 1. row ***************************
...
    NumRunningQueries: 0
           MemUsedPct: 0.79 %
           CpuUsedPct: 0.0 %
```

### SHOW PROCESSLIST

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md) を使用して、クエリがキューにあるかどうか（`IsPending` が `true` の場合）を確認できます。

```Plain
mysql> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| Id   | User | Host                | Db    | Command | ConnectionStartTime | Time | State | Info              | IsPending |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
|    2 | root | xxx.xx.xxx.xx:xxxxx |       | Query   | 2022-11-24 18:08:29 |    0 | OK    | SHOW PROCESSLIST  | false     |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
```

### FE監査ログ

FE監査ログファイル **fe.audit.log** を確認できます。`PendingTimeMs` フィールドは、クエリがキューで待機していた時間を示し、単位はミリ秒です。

### FEメトリクス

以下のFEメトリクスは、各FEノードの統計データから派生しています。

| メトリクス                                          | 単位 | タイプ    | 説明                                                    |
| ----------------------------------------------- | ---- | ------- | -------------------------------------------------------------- |
| starrocks_fe_query_queue_pending                | カウント | 瞬時 | キュー内の現在のクエリ数。                  |
| starrocks_fe_query_queue_total                  | カウント | 瞬時 | キューに入ったクエリの合計数（現在実行中のものも含む）。 |
| starrocks_fe_query_queue_timeout                | カウント | 瞬時 | キュー内でタイムアウトしたクエリの合計数。 |
| starrocks_fe_resource_group_query_queue_total   | カウント | 瞬時 | このリソースグループにキューに入ったクエリの合計数（現在実行中のものも含む）。`name` ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |
| starrocks_fe_resource_group_query_queue_pending | カウント | 瞬時 | このリソースグループのキュー内の現在のクエリ数。`name` ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |
| starrocks_fe_resource_group_query_queue_timeout | カウント | 瞬時 | このリソースグループのキュー内でタイムアウトしたクエリの数。`name` ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |

### SHOW RUNNING QUERIES

v3.1.4以降、StarRocksはSQLステートメント `SHOW RUNNING QUERIES` をサポートしており、各クエリのキュー情報を表示するために使用されます。各フィールドの意味は次のとおりです。

- `QueryId`: クエリのID。
- `ResourceGroupId`: クエリがヒットしたリソースグループのID。ユーザー定義のリソースグループにヒットしない場合、`-` と表示されます。
- `StartTime`: クエリの開始時刻。
- `PendingTimeout`: キュー内のPENDINGクエリのタイムアウト時刻。
- `QueryTimeout`: クエリのタイムアウト時刻。
- `State`: クエリのキューの状態。"PENDING" はキューにあることを示し、"RUNNING" は現在実行中であることを示します。
- `Slots`: クエリが要求する論理リソースの数量で、現在は `1` に固定されています。
- `Frontend`: クエリを開始したFEノード。
- `FeStartTime`: クエリを開始したFEノードの開始時刻。

例:

```Plain
MySQL [(none)]> SHOW RUNNING QUERIES;
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| QueryId                              | ResourceGroupId | StartTime           | PendingTimeout      | QueryTimeout        |   State   | Slots | Frontend                        | FeStartTime         |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| a46f68c6-3b49-11ee-8b43-00163e10863a | -               | 2023-08-15 16:56:37 | 2023-08-15 17:01:37 | 2023-08-15 17:01:37 |  RUNNING  | 1     | 127.00.00.01_9010_1692069711535 | 2023-08-15 16:37:03 |
| a6935989-3b49-11ee-935a-00163e13bca3 | 12003           | 2023-08-15 16:56:40 | 2023-08-15 17:01:40 | 2023-08-15 17:01:40 |  RUNNING  | 1     | 127.00.00.02_9010_1692069658426 | 2023-08-15 16:37:03 |
| a7b5e137-3b49-11ee-8b43-00163e10863a | 12003           | 2023-08-15 16:56:42 | 2023-08-15 17:01:42 | 2023-08-15 17:01:42 |  PENDING  | 1     | 127.00.00.03_9010_1692069711535 | 2023-08-15 16:37:03 |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
```
