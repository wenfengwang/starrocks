---
displayed_sidebar: "Japanese"
---

# FQDNアクセスの有効化

このトピックでは、完全修飾ドメイン名（FQDN）を使用してクラスタへのアクセスを有効にする方法について説明します。FQDNは、インターネット経由でアクセスできる特定のエンティティの完全なドメイン名です。FQDNは、ホスト名とドメイン名の2つの部分で構成されています。

2.4以前のバージョンでは、StarRocksはIPアドレスのみを使用してFEおよびBEへのアクセスをサポートしています。StarRocksクラスタにノードを追加する際にFQDNを使用しても、最終的にはIPアドレスに変換されます。これにより、特定のノードのIPアドレスを変更すると、StarRocksクラスタへのアクセスが失敗する可能性があり、DBAにとって非常に不便です。バージョン2.4では、StarRocksは各ノードをそのIPアドレスから切り離します。これにより、StarRocksでノードをFQDNのみで管理できるようになります。

## 前提条件

StarRocksクラスタでFQDNアクセスを有効にするには、次の要件を満たしていることを確認してください。

- クラスタ内の各マシンにはホスト名がある必要があります。

- 各マシンの**/etc/hosts**ファイルには、クラスタ内の他のマシンの対応するIPアドレスとFQDNが指定されている必要があります。

- **/etc/hosts**ファイルのIPアドレスは一意である必要があります。

## FQDNアクセスを有効にする新しいクラスタのセットアップ

デフォルトでは、新しいクラスタのFEノードはIPアドレスアクセスで起動されます。FQDNアクセスを有効にする新しいクラスタを開始するには、最初に次のコマンドを実行してFEノードを起動する必要があります。

```Shell
./bin/start_fe.sh --host_type FQDN --daemon
```

プロパティ`--host_type`は、ノードを起動するために使用されるアクセス方法を指定します。有効な値には、`FQDN`および`IP`が含まれます。このプロパティは、ノードを初めて起動するときにのみ指定する必要があります。

StarRocksのインストール手順の詳細については、[StarRocksのデプロイ](../deployment/deploy_manually.md)を参照してください。

各BEノードは、FEメタデータで定義された「BEアドレス」によって自身を識別します。したがって、BEノードを起動する際に`--host_type`を指定する必要はありません。`BEアドレス`がFQDNを使用してBEノードを定義している場合、BEノードはこのFQDNを使用して自身を識別します。

## 既存のクラスタでFQDNアクセスを有効にする

以前にIPアドレスを使用して起動された既存のクラスタでFQDNアクセスを有効にするには、まずStarRocksをバージョン2.4.0以降にアップグレードする必要があります。

### FEノードのFQDNアクセスを有効にする

リーダーFEノードのFQDNアクセスを有効にする前に、非リーダーフォロワーFEノードのFQDNアクセスを有効にする必要があります。

> **注意**
>
> FEノードのFQDNアクセスを有効にする前に、クラスタには少なくとも3つのフォロワーFEノードがあることを確認してください。

#### 非リーダーフォロワーFEノードのFQDNアクセスを有効にする

1. FEノードのデプロイディレクトリに移動し、次のコマンドを実行してFEノードを停止します。

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQLクライアントを使用して、次のステートメントを実行して停止したFEノードの`Alive`ステータスを確認します。`Alive`ステータスが`false`になるまで待機します。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

3. 次のステートメントを実行して、IPアドレスをFQDNに置き換えます。

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. 次のコマンドを実行して、FQDNアクセスでFEノードを起動します。

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    プロパティ`--host_type`は、ノードを再起動する際にのみ指定する必要があります。有効な値には、`FQDN`および`IP`が含まれます。

5. FEノードの`Alive`ステータスを確認します。`Alive`ステータスが`true`になるまで待機します。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

6. 現在のFEノードの`Alive`ステータスが`true`の場合、他の非リーダーフォロワーFEノードのFQDNアクセスを有効にする前に、上記の手順を繰り返します。

#### リーダーFEノードのFQDNアクセスを有効にする

すべての非リーダーフォロワーFEノードが正常に変更および再起動された後、リーダーFEノードのFQDNアクセスを有効にすることができます。

> **注意**
>
> リーダーFEノードにFQDNアクセスが有効になる前に、クラスタにノードを追加するために使用されるFQDNは、まだ対応するIPアドレスに変換されます。FQDNアクセスが有効になったリーダーFEノードがクラスタに選出されると、FQDNはIPアドレスに変換されなくなります。

1. リーダーFEノードのデプロイディレクトリに移動し、次のコマンドを実行してリーダーFEノードを停止します。

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQLクライアントを使用して、新しいリーダーFEノードがクラスタに選出されたかどうかを確認するために、次のステートメントを実行します。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

    ステータスが`Alive`であり、`isMaster`が`true`であるFEノードは、実行中のリーダーFEです。

3. 次のステートメントを実行して、IPアドレスをFQDNに置き換えます。

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. 次のコマンドを実行して、FQDNアクセスでFEノードを起動します。

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    プロパティ`--host_type`は、ノードを再起動する際にのみ指定する必要があります。有効な値には、`FQDN`および`IP`が含まれます。

5. FEノードの`Alive`ステータスを確認します。

    ```Plain
    SHOW PROC '/frontends'\G
    ```

  `Alive`ステータスが`true`になると、FEノードは正常に変更され、クラスタにフォロワーFEノードとして追加されます。

### BEノードのFQDNアクセスを有効にする

次のステートメントをMySQLクライアントを使用して実行し、BEノードのIPアドレスをFQDNに置き換えてFQDNアクセスを有効にします。

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_ip>" TO "<be_hostname>";
```

> **注意**
>
> FQDNアクセスが有効になった後、BEノードを再起動する必要はありません。

## ロールバック

FQDNアクセスが有効になったStarRocksクラスタをFQDNアクセスをサポートしていない以前のバージョンにロールバックするには、クラスタ内のすべてのノードでIPアドレスアクセスを有効にする必要があります。一般的な手順については、[既存のクラスタでFQDNアクセスを有効にする](#既存のクラスタでFQDNアクセスを有効にする)を参照してください。ただし、SQLコマンドを次のコマンドに変更する必要があります。

- FEノードのIPアドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY FRONTEND HOST "<fe_hostname>" TO "<fe_ip>";
```

- BEノードのIPアドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_hostname>" TO "<be_ip>";
```

変更は、クラスタが正常に再起動された後に有効になります。

## FAQ

**Q: FEノードのFQDNアクセスを有効にする際にエラーが発生しました。「required 1 replica. But none were active with this master」と表示されます。どうすればよいですか？**

A: FEノードのFQDNアクセスを有効にする前に、クラスタに少なくとも3つのフォロワーFEノードがあることを確認してください。

**Q: FQDNアクセスが有効になったクラスタにIPアドレスを使用して新しいノードを追加できますか？**

A: はい。
