---
displayed_sidebar: "Japanese"
---

# 高可用性を持つFEクラスタのデプロイ

このトピックでは、StarRocksのFEノードの高可用性（HA）デプロイについて説明します。

## FE HAクラスタの理解

StarRocksのFEハイアベイラビリティクラスタは、単一障害点を回避するために、プライマリ-セカンダリレプリケーションアーキテクチャを使用しています。FEは、リーダーの選択、ログのレプリケーション、フェイルオーバーを実現するために、raftのようなBDB JEプロトコルを使用しています。

### FEの役割の理解

FEクラスタでは、ノードは次の2つの役割に分けられます：

- **FEフォロワー**

FEフォロワーは、レプリケーションプロトコルの投票メンバーであり、リーダーFEの選択とログの送信に参加します。FEフォロワーの数は奇数（2n+1）です。確認には過半数（n+1）が必要であり、少数（n）の障害を許容します。

- **FEオブザーバー**

FEオブザーバーは、非投票メンバーであり、非同期でレプリケーションログを購読するために使用されます。クラスタ内でのFEオブザーバーのステータスは、フォロワーのステータスよりも遅れており、他のレプリケーションプロトコルのリーナーの役割に似ています。

FEクラスタは、自動的にリーダーFEをFEフォロワーから選択します。リーダーFEはすべての状態変更を実行します。変更は非リーダーFEノードから開始され、その後リーダーFEに転送されて実行されます。非リーダーFEノードは、レプリケーションログの最新の変更のLSNを記録します。読み取り操作は非リーダーノードで直接実行できますが、非リーダーFEノードの状態が最後の操作のLSNと同期するまで待機します。オブザーバーノードは、FEクラスタ上の読み取り操作の負荷容量を増やすことができます。緊急性の低いユーザーはオブザーバーノードを読み取ることができます。

## FE HAクラスタのデプロイ

高可用性を持つFEクラスタをデプロイするには、次の要件を満たす必要があります：

- FEノード間の時計の差は5秒を超えてはなりません。時刻を合わせるためにNTPプロトコルを使用します。
- 1つのマシンには1つのFEノードのみをデプロイできます。
- すべてのFEノードで同じHTTPポートを割り当てる必要があります。

上記の要件をすべて満たしたら、以下の手順に従ってFEインスタンスを1つずつStarRocksクラスタに追加し、FEノードのHAデプロイを有効にすることができます。

1. バイナリファイルと設定ファイルを配布します（単一のインスタンスと同じ）。
2. MySQLクライアントを既存のFEに接続し、新しいインスタンスの情報（役割、IP、ポート）を追加します：

   ```sql
   mysql> ALTER SYSTEM ADD FOLLOWER "host:port";
   ```

   または

   ```sql
   mysql> ALTER SYSTEM ADD OBSERVER "host:port";
   ```

   ホストはマシンのIPです。マシンに複数のIPがある場合は、`priority_networks`でIPを選択します。たとえば、通信にサブネット`192.168.1.x`を使用するために、`priority_networks=192.168.1.0/24`と設定することができます。ポートは`edit_log_port`で、デフォルトは`9010`です。

   > 注意：セキュリティの観点から、StarRocksのFEとBEは通信のために1つのIPのみをリッスンすることができます。マシンに複数のネットワークカードがある場合、StarRocksは正しいIPを自動的に見つけることができない場合があります。たとえば、`ifconfig`コマンドを実行して`eth0 IP`が`192.168.1.1`、`docker0 : 172.17.0.1`であることを確認します。`priority_networks=10.1.3.0/24`のように、IPが存在するサブネット範囲を指定するために、[CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)表記を使用します。これにより、すべてのBEとFEで使用できます。`priority_networks`は`fe.conf`と`be.conf`の両方に記述されます。この属性は、FEまたはBEが起動されるときに使用するIPを示します。例は次のとおりです：`priority_networks=10.1.3.0/24`。

   エラーが発生した場合は、次のコマンドを使用してFEを削除します：

   ```sql
   alter system drop follower "fe_host:edit_log_port";
   alter system drop observer "fe_host:edit_log_port";
   ```

3. FEノードはペアで相互接続する必要があり、マスターの選択、投票、ログの送信、レプリケーションを完了するために。FEノードが最初に初期化されるとき、既存のクラスタのノードの1つをヘルパーとして指定する必要があります。ヘルパーノードは、クラスタ内のすべてのFEノードの設定情報を取得して接続を確立します。したがって、初期化時に`--helper`パラメータを指定します：

   ```shell
   ./bin/start_fe.sh --helper host:port --daemon
   ```

   ホストはヘルパーノードのIPです。複数のIPがある場合は、`priority_networks`でIPを選択します。ポートは`edit_log_port`で、デフォルトは`9010`です。

   将来の起動では、`--helper`パラメータを指定する必要はありません。FEは他のFEの設定情報をローカルディレクトリに保存します。直接起動するには：

   ```shell
   ./bin/start_fe.sh --daemon
   ```

4. クラスタの状態を確認し、デプロイが成功したことを確認します。

  ```Plain Text
  mysql> SHOW PROC '/frontends'\G

  ***1\. 行***

  名前：172.26.x.x_9010_1584965098874

  IP：172.26.x.x

  ホスト名：sr-test1

  ......

  役割：FOLLOWER

  マスター：true

  ......

  生存：true

  ......

  ***2\. 行***

  名前：172.26.x.x_9010_1584965098874

  IP：172.26.x.x

  ホスト名：sr-test2

  ......

  役割：FOLLOWER

  マスター：false

  ......

  生存：true

  ......

  ***3\. 行***

  名前：172.26.x.x_9010_1584965098874

  IP：172.26.x.x

  ホスト名：sr-test3

  ......

  役割：FOLLOWER

  マスター：false

  ......

  生存：true

  ......

  3 行が返されました (0.05 秒)
  ```

`Alive`が`true`の場合、ノードはクラスタに正常に追加されました。上記の例では、`172.26.x.x_9010_1584965098874`がリーダーFEノードです。
