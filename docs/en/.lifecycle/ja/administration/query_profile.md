---
displayed_sidebar: "Japanese"
---

# クエリプロファイルの分析

このトピックでは、クエリプロファイルのチェック方法について説明します。クエリプロファイルは、クエリに関与するすべてのワーカーノードの実行情報を記録します。クエリプロファイルを使用すると、StarRocksクラスタのクエリパフォーマンスに影響を与えるボトルネックを迅速に特定することができます。

## クエリプロファイルの有効化

StarRocksのバージョン2.5より前では、変数`is_report_success`を`true`に設定することでクエリプロファイルを有効にすることができます。

```SQL
SET is_report_success = true;
```

StarRocksのバージョン2.5以降では、変数`enable_profile`を`true`に設定することでクエリプロファイルを有効にすることができます。

```SQL
SET enable_profile = true;
```

### ランタイムプロファイル

StarRocksのバージョン3.1以降では、ランタイムプロファイル機能がサポートされており、クエリが完了する前にクエリプロファイルにアクセスすることができます。

この機能を使用するには、`enable_profile`を`true`に設定するだけでなく、セッション変数`runtime_profile_report_interval`を設定する必要があります。`runtime_profile_report_interval`（単位：秒、デフォルト：`10`）は、プロファイルレポートの間隔を制御します。デフォルトでは、クエリが10秒以上かかる場合、ランタイムプロファイル機能が自動的に有効になります。

```SQL
SET runtime_profile_report_interval = 10;
```

ランタイムプロファイルは、通常のクエリプロファイルと同じ情報を表示します。実行中のクエリのパフォーマンスを分析するために、通常のクエリプロファイルと同様に分析することができます。

ただし、ランタイムプロファイルは不完全な場合があります。実行計画の一部のオペレータは他のオペレータに依存する場合があります。実行中のオペレータと完了したオペレータを簡単に区別するために、実行中のオペレータは「ステータス：実行中」とマークされます。

## クエリプロファイルへのアクセス

> **注意**
>
> StarRocksのエンタープライズエディションを使用している場合、StarRocks Managerを使用してクエリプロファイルにアクセスして表示することができます。

StarRocksのコミュニティエディションを使用している場合は、次の手順に従ってクエリプロファイルにアクセスできます。

1. ブラウザで`http://<fe_ip>:<fe_http_port>`を入力します。
2. 表示されるページで、上部のナビゲーションペインで**queries**をクリックします。
3. **Finished Queries**リストから確認したいクエリを選択し、**Profile**列のリンクをクリックします。

![img](../assets/profile-1.png)

ブラウザは、対応するクエリプロファイルが含まれる新しいページにリダイレクトされます。

![img](../assets/profile-2.png)

## クエリプロファイルの解釈

### クエリプロファイルの構造

以下はクエリプロファイルの例です。

```SQL
Query:
  Summary:
  Planner:
  Execution Profile 7de16a85-761c-11ed-917d-00163e14d435:
    Fragment 0:
      Pipeline (id=2):
        EXCHANGE_SINK (plan_node_id=18):
        LOCAL_MERGE_SOURCE (plan_node_id=17):
      Pipeline (id=1):
        LOCAL_SORT_SINK (plan_node_id=17):
        AGGREGATE_BLOCKING_SOURCE (plan_node_id=16):
      Pipeline (id=0):
        AGGREGATE_BLOCKING_SINK (plan_node_id=16):
        EXCHANGE_SOURCE (plan_node_id=15):
    Fragment 1:
       ...
    Fragment 2:
       ...
```

クエリプロファイルは次の3つのセクションで構成されています。

- Fragment：実行ツリー。1つのクエリは1つ以上のフラグメントに分割できます。
- Pipeline：実行チェーン。実行チェーンにはブランチがありません。フラグメントは複数のパイプラインに分割できます。
- Operator：パイプラインは複数のオペレータで構成されます。

![img](../assets/profile-3.png)

*フラグメントは複数のパイプラインで構成されます。*

### 主要なメトリクス

クエリプロファイルには、クエリの実行の詳細が表示される多くのメトリクスが含まれています。ほとんどの場合、オペレータの実行時間と処理されたデータのサイズを観察するだけで十分です。ボトルネックを見つけたら、それに応じて解決策を見つけることができます。

#### 概要

| メトリクス       | 説明                                                         |
| -------------- | ------------------------------------------------------------ |
| Total          | クエリにかかる合計時間（計画、実行、プロファイリングにかかる時間を含む） |
| QueryCpuCost   | クエリの合計CPU時間。CPU時間のコストは並行プロセスで集約されます。そのため、このメトリクスの値はクエリの実行時間よりも大きくなる場合があります。 |
| QueryMemCost   | クエリの合計メモリコスト。                                          |

#### オペレータの一般的なメトリクス

| メトリクス            | 説明                                                         |
| ----------------- | ------------------------------------------------------------ |
| OperatorTotalTime | オペレータの合計CPU時間。                                      |
| PushRowNum        | オペレータがプッシュしたデータの合計行数。                                |
| PullRowNum        | オペレータがプルしたデータの合計行数。                                  |

#### 固有のメトリクス

| メトリクス            | 説明                                                         |
| ----------------- | ------------------------------------------------------------ |
| IOTaskExecTime    | すべてのI/Oタスクの合計実行時間。                                        |
| IOTaskWaitTime    | すべてのI/Oタスクの合計待機時間。                                        |
| MorselsCount      | I/Oタスクの総数。                                                |

#### スキャンオペレータ

| メトリクス                          | 説明                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| Table                               | テーブル名。                                                     |
| ScanTime                            | スキャンの合計時間。スキャンは非同期のI/Oスレッドプールで実行されます。 |
| TabletCount                         | タブレットの数。                                                   |
| PushdownPredicates                  | プッシュダウンされた述語の数。                                           |
| BytesRead                           | StarRocksが読み取ったデータのサイズ。                                  |
| CompressedBytesRead                 | StarRocksが読み取った圧縮データのサイズ。                                |
| IOTime                              | I/Oの合計時間。                                                  |
| BitmapIndexFilterRows               | Bitmapインデックスによってフィルタリングされたデータの行数。                       |
| BloomFilterFilterRows               | Bloomフィルタによってフィルタリングされたデータの行数。                           |
| SegmentRuntimeZoneMapFilterRows     | ランタイムゾーンマップによってフィルタリングされたデータの行数。                       |
| SegmentZoneMapFilterRows            | ゾーンマップによってフィルタリングされたデータの行数。                             |
| ShortKeyFilterRows                  | ショートキーによってフィルタリングされたデータの行数。                             |
| ZoneMapIndexFilterRows              | ゾーンマップインデックスによってフィルタリングされたデータの行数。                     |

#### エクスチェンジオペレータ

| メトリクス            | 説明                                                         |
| ----------------- | ------------------------------------------------------------ |
| PartType          | データの分散タイプ。有効な値：`UNPARTITIONED`、`RANDOM`、`HASH_PARTITIONED`、`BUCKET_SHUFFLE_HASH_PARTITIONED` |
| BytesSent         | 送信されたデータのサイズ。                                           |
| OverallThroughput | 全体のスループット。                                                |
| NetworkTime       | データパッケージの送信時間（ポスト受信処理の時間を除く）。このメトリクスの計算方法と例外が発生する場合の詳細については、以下のFAQを参照してください。 |
| WaitTime          | 送信側のキューがいっぱいになったための待機時間。                               |

#### 集約オペレータ

| メトリクス             | 説明                                                         |
| ------------------ | ------------------------------------------------------------ |
| GroupingKeys       | グループ化キー（GROUP BY列）の名前。                                          |
| AggregateFunctions | 集約関数。                                                      |
| AggComputeTime     | 集約関数の計算時間。                                                |
| ExprComputeTime    | 式の計算時間。                                                    |
| HashTableSize      | ハッシュテーブルのサイズ。                                             |

#### 結合オペレータ

| メトリクス                    | 説明                                                         |
| ------------------------- | ------------------------------------------------------------ |
| JoinPredicates            | JOIN操作の述語。                                                |
| JoinType                  | JOINのタイプ。                                                 |
| BuildBuckets              | ハッシュテーブルのバケット数。                                          |
| BuildHashTableTime        | ハッシュテーブルの構築にかかる時間。                                       |
| ProbeConjunctEvaluateTime | Probe Conjunctにかかる時間。                                      |
| SearchHashTableTimer      | ハッシュテーブルの検索にかかる時間。                                     |

#### ウィンドウ関数オペレータ

| メトリクス             | 説明                                                         |
| ------------------ | ------------------------------------------------------------ |
| ComputeTime        | ウィンドウ関数の計算時間。                                              |
| PartitionKeys      | パーティションキー（PARTITION BY列）の名前。                                 |
| AggregateFunctions | 集約関数。                                                      |

#### ソートオペレータ

| メトリクス   | 説明                                                         |
| -------- | ------------------------------------------------------------ |
| SortKeys | ソートキー（ORDER BY列）の名前。                                          |
| SortType | 結果のソートタイプ：すべての結果をリストアップするか、上位n件の結果をリストアップするか。 |

#### テーブル関数オペレータ

| メトリクス                 | 説明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| TableFunctionExecTime  | テーブル関数の計算時間。                                              |
| TableFunctionExecCount | テーブル関数が実行された回数。                                            |

#### プロジェクトオペレータ

| メトリクス                   | 説明                                                         |
| ------------------------ | ------------------------------------------------------------ |
| ExprComputeTime          | 式の計算時間。                                                    |
| CommonSubExprComputeTime | 共通のサブ式の計算時間。                                               |

#### ローカルエクスチェンジオペレータ

| メトリクス     | 説明                                                         |
| ---------- | ------------------------------------------------------------ |
| Type       | ローカルエクスチェンジのタイプ。有効な値：`Passthrough`、`Partition`、`Broadcast` |
| ShuffleNum | シャッフルの数。このメトリクスは、`Type`が`Partition`の場合にのみ有効です。 |

#### Hiveコネクタ

| メトリクス                      | 説明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| ScanRanges                  | スキャンされるタブレットの数。                                            |
| ReaderInit                  | Readerの初期化時間。                                           |
| ColumnReadTime              | Readerがデータを読み取り、解析するためにかかる時間。                            |
| ExprFilterTime              | 式のフィルタリングにかかる時間。                                          |
| RowsRead                    | 読み取られるデータの行数。                                              |

#### 入力ストリーム

| メトリクス                    | 説明                                                               |
| ------------------------- | ----------------------------------------------------------------- |
| AppIOBytesRead            | アプリケーションレイヤからのI/Oタスクによって読み取られたデータのサイズ。            |
| AppIOCounter              | アプリケーションレイヤからのI/Oタスクの数。                           |
| AppIOTime                 | アプリケーションレイヤからのI/Oタスクによってデータを読み取るためにかかる合計時間。 |
| FSBytesRead               | ストレージシステムによって読み取られたデータのサイズ。                           |
| FSIOCounter               | ストレージレイヤからのI/Oタスクの数。                                    |
| FSIOTime                  | ストレージレイヤがデータを読み取るためにかかる合計時間。                         |

### オペレータの実行時間

- OlapScanオペレータとConnectorScanオペレータの実行時間は、`OperatorTotalTime + ScanTime`と同等です。スキャンオペレータは非同期のI/O操作を実行するため、ScanTimeは非同期のI/O時間を表します。
- エクスチェンジオペレータの実行時間は、`OperatorTotalTime + NetworkTime`と同等です。エクスチェンジオペレータはbRPCスレッドプールでデータパッケージの送受信を行うため、NetworkTimeはネットワーク転送にかかる時間を表します。
- その他のすべてのオペレータの実行時間は、`OperatorTotalTime`です。

### メトリクスのマージとMIN/MAX

パイプラインエンジンは並列計算エンジンです。各フラグメントは複数のマシンに分散して並列処理され、各マシンのパイプラインは複数の同時インスタンスとして並列に実行されます。したがって、プロファイリング中には、StarRocksは同じメトリクスをマージし、すべての同時インスタンスの中での各メトリクスの最小値と最大値を記録します。

異なるメトリクスのタイプに対して異なるマージ戦略が採用されています。

- 時間メトリクスは平均値です。例：
  - `OperatorTotalTime`は、すべての同時インスタンスの平均時間コストを表します。
  - `__MAX_OF_OperatorTotalTime`は、すべての同時インスタンスの中での最大時間コストを表します。
  - `__MIN_OF_OperatorTotalTime`は、すべての同時インスタンスの中での最小時間コストを表します。

```SQL
             - OperatorTotalTime: 2.192us
               - __MAX_OF_OperatorTotalTime: 2.502us
               - __MIN_OF_OperatorTotalTime: 1.882us
```

- 時間メトリクス以外のメトリクスは合計されます。例：
  - `PullChunkNum`は、すべての同時インスタンスの合計値を表します。
  - `__MAX_OF_PullChunkNum`は、すべての同時インスタンスの中での最大値を表します。
  - `__MIN_OF_PullChunkNum`は、すべての同時インスタンスの中での最小値を表します。

  ```SQL
                 - PullChunkNum: 146.66K (146660)
                   - __MAX_OF_PullChunkNum: 24.45K (24450)
                   - __MIN_OF_PullChunkNum: 24.435K (24435)
  ```

- 最小値と最大値を持たない特殊なメトリクスもあります。これらのメトリクスは、すべての同時インスタンスの間で同じ値を持ちます（例：`DegreeOfParallelism`）。

#### MINとMAXの間の大きな差異

通常、MINとMAXの間に顕著な差異がある場合、データがスキューしていることを示しています。これは、集約やJOIN操作中に発生する可能性があります。

```SQL
             - OperatorTotalTime: 2m48s
               - __MAX_OF_OperatorTotalTime: 10m30s
               - __MIN_OF_OperatorTotalTime: 279.170us
```

## テキストベースのプロファイル分析を実行する

StarRocksのバージョン3.1以降では、テキストベースのプロファイル分析機能が提供されています。この機能を使用すると、ボトルネックやクエリの最適化の機会を効率的に特定することができます。

### 既存のクエリの分析

クエリの`QueryID`を使用して、実行中のクエリや完了したクエリのプロファイルを分析することができます。

#### プロファイルの一覧表示

次のSQLステートメントを実行して、既存のプロファイルの一覧を表示します。

```sql
SHOW PROFILELIST;
```

例：

```sql
MySQL > show profilelist;
+--------------------------------------+---------------------+-------+----------+--------------------------------------------------------------------------------------------------------------------------------------+
| QueryId                              | StartTime           | Time  | State    | Statement                                                                                                                            |
+--------------------------------------+---------------------+-------+----------+--------------------------------------------------------------------------------------------------------------------------------------+
| b8289ffc-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:27 | 86ms  | Finished | SELECT o_orderpriority, COUNT(*) AS order_count\nFROM orders\nWHERE o_orderdate >= DATE '1993-07-01'\n    AND o_orderdate < DAT ...  |
| b5be2fa8-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:23 | 67ms  | Finished | SELECT COUNT(*)\nFROM (\n    SELECT l_orderkey, SUM(l_extendedprice * (1 - l_discount)) AS revenue\n        , o_orderdate, o_sh ...  |
| b36ac9c6-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:19 | 320ms | Finished | SELECT COUNT(*)\nFROM (\n    SELECT s_acctbal, s_name, n_name, p_partkey, p_mfgr\n        , s_address, s_phone, s_comment\n    F ... |
| b037b245-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:14 | 175ms | Finished | SELECT l_returnflag, l_linestatus, SUM(l_quantity) AS sum_qty\n    , SUM(l_extendedprice) AS sum_base_price\n    , SUM(l_exten ...   |
| a9543cf4-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:02 | 40ms  | Finished | select count(*) from lineitem                                                                                                        |
+--------------------------------------+---------------------+-------+----------+--------------------------------------------------------------------------------------------------------------------------------------+
5 rows in set
Time: 0.006s


MySQL > show profilelist limit 1;
+--------------------------------------+---------------------+------+----------+-------------------------------------------------------------------------------------------------------------------------------------+
| QueryId                              | StartTime           | Time | State    | Statement                                                                                                                           |
+--------------------------------------+---------------------+------+----------+-------------------------------------------------------------------------------------------------------------------------------------+
| b8289ffc-3049-11ee-838f-00163e0a894b | 2023-08-01 16:59:27 | 86ms | Finished | SELECT o_orderpriority, COUNT(*) AS order_count\nFROM orders\nWHERE o_orderdate >= DATE '1993-07-01'\n    AND o_orderdate < DAT ... |
+--------------------------------------+---------------------+------+----------+-------------------------------------------------------------------------------------------------------------------------------------+
1 row in set
Time: 0.005s
```

このSQLステートメントにより、各クエリに関連付けられた`QueryId`を簡単に取得することができます。`QueryId`は、さらなるプロファイル分析や調査のための重要な識別子として機能します。

#### プロファイルの分析

`QueryId`を取得したら、ANALYZE PROFILEステートメントを使用して特定のクエリの詳細な分析を実行することができます。このSQLステートメントにより、クエリのパフォーマンス特性や最適化のための包括的な調査が容易になります。

```sql
ANALYZE PROFILE FROM '<QueryId>' [, <plan_node_id>, ...]
```

デフォルトでは、分析結果には各オペレータの最も重要なメトリクスのみが表示されます。ただし、1つ以上のプランノードのIDを指定することで、対応するメトリクスを表示することができます。この機能により、クエリのパフォーマンスの包括的な調査が可能となり、対象となる最適化が容易になります。

例1：プランノードIDを指定せずにプロファイルを分析する：

![img](../assets/profile-16.png)

例2：プランノードIDを指定してプロファイルを分析する：

![img](../assets/profile-17.png)

ANALYZE PROFILEステートメントにより、ランタイムプロファイルの分析と理解が向上します。異なるステータス（ブロックされている、実行中、完了など）を持つオペレータを区別することができます。また、処理された行数に基づいて全体の進行状況と個々のオペレータの進行状況を包括的に表示することができるため、クエリの実行とパフォーマンスの理解が深まります。これにより、StarRocksでのクエリのプロファイリングと最適化が容易になります。

例3：実行中のクエリのランタイムプロファイルを分析する：

![img](../assets/profile-20.png)

### シミュレートされたクエリの分析

EXPLAIN ANALYZEステートメントを使用して、指定されたクエリをシミュレートし、そのプロファイルを分析することもできます。

```sql
EXPLAIN ANALYZE <sql>
```

現在、EXPLAIN ANALYZEは2つのタイプのSQLステートメントをサポートしています：クエリ（SELECT）ステートメントとINSERT INTOステートメント。INSERT INTOステートメントをシミュレートし、そのプロファイルを分析することができますが、実際にデータが挿入されるわけではありません。デフォルトでは、トランザクションが中止され、プロファイル分析の過程でデータに意図しない変更が加えられないようになっています。

例1：指定されたクエリのプロファイルを分析する：

![img](../assets/profile-18.png)

例2：INSERT INTO操作のプロファイルを分析する：

![img](../assets/profile-19.png)

## クエリプロファイルの可視化

StarRocksエンタープライズエディションのユーザーの場合、StarRocks Managerを使用してクエリプロファイルを可視化することができます。

**プロファイルの概要**ページには、合計実行時間`ExecutionWallTime`、I/Oメトリクス、ネットワーク転送サイズ、CPU時間とI/O時間の割合など、いくつかのサマリーメトリクスが表示されます。

![img](../assets/profile-4.jpeg)

オペレータ（ノード）のカードをクリックすると、ページの右側のペインに詳細情報が表示されます。3つのタブがあります。

- **Node**：このオペレータの主要なメトリクス。
- **Node Detail**：このオペレータのすべてのメトリクス。
- **Pipeline**：オペレータが所属するパイプラインのメトリクス。スケジューリングに関連するため、このタブにはあまり注意を払う必要はありません。

![img](../assets/profile-5.jpeg)

### ボトルネックの特定

オペレータの実行時間の割合が大きいほど、カードの色が濃くなります。これにより、クエリのボトルネックを簡単に特定することができます。

![img](../assets/profile-6.jpeg)

### データがスキューしているかどうかの確認

実行時間の割合が大きいオペレータのカードをクリックし、その`MaxTime`と`MinTime`を確認します。`MaxTime`と`MinTime`の間に顕著な差がある場合、通常はデータがスキューしていることを示しています。

![img](../assets/profile-7.jpeg)

次に、**Node Detail**タブをクリックし、メトリクスに例外が表示されているかどうかを確認します。この例では、集約オペレータの`PushRowNum`メトリクスがデータスキューを示しています。

![img](../assets/profile-8.jpeg)

### パーティショニングやバケット化の戦略が効果を発揮しているかどうかの確認

`EXPLAIN <sql_statement>`を使用して、対応するクエリプランを表示して、パーティショニングやバケット化の戦略が効果を発揮しているかどうかを確認することができます。

![img](../assets/profile-9.png)

### 正しいマテリアライズドビューが使用されているかどうかの確認

対応するスキャンオペレータをクリックし、**Node Detail**タブで`Rollup`フィールドを確認します。

![img](../assets/profile-10.jpeg)

### JOINプランが左テーブルと右テーブルに適切に適用されているかどうかの確認

通常、StarRocksは右テーブルを小さいテーブルとして選択します。クエリプロファイルがそれ以外を示している場合は例外です。

![img](../assets/profile-11.jpeg)

### JOINの分散タイプが正しいかどうかの確認

エクスチェンジオペレータは、データの分散タイプに応じて3つのタイプに分類されます。

- `UNPARTITIONED`：ブロードキャスト。データは複数のBEにコピーされて配布されます。
- `RANDOM`：ラウンドロビン。
- `HASH_PARTITIONED`および`BUCKET_SHUFFLE_HASH_PARTITIONED`：シャッフル。`HASH_PARTITIONED`と`BUCKET_SHUFFLE_HASH_PARTITIONED`の違いは、ハッシュコードの計算に使用されるハッシュ関数です。

Inner Joinの場合、右テーブルは`HASH_PARTITIONED`および`BUCKET_SHUFFLE_HASH_PARTITIONED`タイプまたは`UNPARTITIONED`タイプにすることができます。通常、右テーブルが100K行未満の場合にのみ`UNPARTITIONED`タイプが採用されます。

次の例では、エクスチェンジオペレータのタイプがブロードキャストですが、オペレータによって送信されるデータのサイズが大幅に閾値を超えています。

![img](../assets/profile-12.jpeg)

### JoinRuntimeFilterが効果を発揮しているかどうかの確認

Joinの右側の子ツリーがハッシュテーブルを構築している場合、ランタイムフィルタが作成されます。このランタイムフィルタは、左側の子ツリーに送信され、可能であればスキャンオペレータにプッシュダウンされます。スキャンオペレータの**Node Detail**タブで`JoinRuntimeFilter`に関連するメトリクスを確認することができます。

![img](../assets/profile-13.jpeg)

## FAQ

### エクスチェンジオペレータの時間コストが異常なのはなぜですか？

![img](../assets/profile-14.jpeg)

エクスチェンジオペレータの時間コストは、CPU時間とネットワーク時間の2つの部分で構成されます。ネットワーク時間はシステムクロックに依存します。ネットワーク時間は次のように計算されます。

1. 送信側は、パッケージを送信するためのbRPCインターフェースを呼び出す前に`send_timestamp`を記録します。
2. 受信側は、bRPCインターフェースからパッケージを受信した後（ポスト受信処理の時間を除く）、`receive_timestamp`を記録します。
3. 処理が完了した後、受信側は応答を送信し、ネットワークの待ち時間を計算します。パッケージの送信時間は`receive_timestamp` - `send_timestamp`となります。

マシン間のシステムクロックが一貫していない場合、エクスチェンジオペレータの時間コストが異常になることがあります。

### すべてのオペレータの合計時間コストがクエリの実行時間よりもかなり短いのはなぜですか？

原因として考えられるのは、高並行のシナリオでは、いくつかのパイプラインドライバはスケジュール可能ですが、キューに入っているために処理されない場合があります。待機時間はオペレータのメトリクスではなく、`PendingTime`、`ScheduleTime`、`IOTaskWaitTime`に記録されます。

例：

プロファイルからわかるように、`ExecutionWallTime`は約55msです。しかし、すべてのオペレータの合計時間コストは10ms未満であり、`ExecutionWallTime`よりもかなり短いです。

![img](../assets/profile-15.jpeg)
