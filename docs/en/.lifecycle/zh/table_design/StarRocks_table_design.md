---
displayed_sidebar: English
---

# 了解表设计

## 列式存储

![Columnar Storage](../assets/3.1-1.png)

与其他关系型数据库一样，StarRocks 中的表由行和列组成。每一行保存一条用户数据记录，每一列中的数据类型相同。表中的所有行都具有相同数量的列。您可以动态地向表中添加列或从表中删除列。表的列可以分为维度列和度量列。维度列也称为键列，度量列也称为值列。维度列中的值用于对数据进行分组和排序，而度量列中的值可以使用 sum、count、min、max、hll_union_agg、bitmap_union 等函数进行聚合。

StarRocks 使用列式存储来存储表数据。在物理层面上，列中的数据被分割成数据块，进行编码、压缩，然后持久化存储在磁盘上。在逻辑层面上，列中的数据可以比作由相同数据类型元素组成的数组。在一行中保留的列值作为元素按照列的顺序列在各自的数组中。这意味着一行中保留的列值具有相同的数组索引。数组索引是隐式的，无需存储。表中的所有行都按照一个或多个维度列指定的顺序进行排序。一行在排序后的表中的位置由该行的序号表示。

对于对表的查询，如果您在可以构成维度列前缀的特定维度列上指定等值或范围条件，StarRocks 可以执行二分搜索快速定位排序数据中的目标行。例如，您想查询名为 `table1` 的表的数据，该表包含四列：`event_day`、`siteid`、`citycode` 和 `username`，其中 `event_day` 和 `siteid` 是维度列。如果您指定 `event_day = 2020-09-18` 和 `siteid = 2` 作为查询条件，StarRocks 可以执行二分搜索，只需处理指定范围内的数据，因为 `event_day` 和 `siteid` 可以构成维度列前缀。如果您指定 `citycode = 4` 和 `username = Andy` 作为查询条件，StarRocks 不能执行二分搜索，需要处理整个表的数据，因为 `citycode` 和 `username` 不能构成维度列前缀。

## 索引

StarRocks 使用前缀索引和列索引来快速定位目标行所在数据块的起始行。

下图展示了 StarRocks 表设计如何加速对 StarRocks 表的查询。

![Indexing Overview](../assets/3.1-2.png)

StarRocks 中表的数据被组织成以下三个部分：

- 前缀索引

  StarRocks 将每 1024 行数据存储为一个数据块，并在前缀索引表中为每个数据块维护一个条目。每个数据块的前缀索引条目内容是由数据块起始行的维度列组成的前缀，长度不得超过 36 字节。前缀索引是一种稀疏索引。当您查询某行数据时，StarRocks 搜索前缀索引表以检索由该行的维度列组成的前缀。然后，StarRocks 可以快速定位到目标行所在数据块的起始行序号。

- 列数据块

  StarRocks 将每列的数据分割成多个 64 KB 的数据块。每个数据块作为最小 I/O 单元独立编码和压缩，并作为整体从磁盘读取或写入。

- 列索引

  StarRocks 为每列维护一个行号索引。在行号索引表中，列的数据块一一映射到列中包含的行的序号。此外，行号索引表中的每个条目包括映射到特定行号的数据块的起始行号、地址和长度。当您查询某行数据时，StarRocks 搜索行号索引表以检索映射到该行序号的数据块地址。然后，StarRocks 读取数据块以定位该行。

总结来说，StarRocks 使用由行的维度列组成的前缀来定位表中的行，执行以下五个步骤：

1. 搜索前缀索引表，定位目标行所在数据块的起始行序号。

2. 搜索各维度列的行号索引表，定位到对应维度列的数据块。

3. 读取数据块。

4. 解压缩并解码数据块。

5. 搜索数据块以定位映射到维度列索引的行。

## 加速处理

本节介绍帮助 StarRocks 加快数据处理的机制。

### 预聚合

StarRocks 提供聚合表。对于聚合表，具有相同维度列值的行可以被聚合成单一行。在聚合生成的新行中，每个维度列的值保持不变，而每个度量列中的值通过您指定的聚合函数进行聚合，以产生新行中度量列的结果值。预聚合有助于加快聚合操作的速度。

### 分区和分桶

StarRocks 中的每个表都被划分为多个分片（tablets）。每个分片存储在多个后端（BEs）上的多个副本中。BE 的数量和分片的数量可以根据计算资源和数据规模的变化灵活扩展。当您发起查询时，多个 BE 可以并行搜索分片，以快速定位到所需数据。此外，分片副本可以进行复制和迁移，这提高了数据的可靠性并防止数据偏斜。分区和分桶有助于确保数据检索的效率和稳定性。

### 物化视图

表的前缀索引有助于加速对表的查询，但依赖于表的维度列的顺序。如果您使用不包含在维度列前缀中的维度列来构造查询条件，则前缀索引不起作用。在这种情况下，您可以为表创建一个物化视图。物化视图的数据组织和存储方式与表的数据相同。然而，物化视图可以拥有自己的前缀索引。创建物化视图的前缀索引时，您可以指定适当的聚合粒度、列数量和维度列排序，以确保频繁使用的查询条件能够命中物化视图的前缀索引表中的预期条目。

### 列索引

StarRocks 支持列索引，如 Bloom Filter、Zone Map 和 Bitmap Index：

- Bloom Filter 用于判断数据块是否包含您要查询的值。

- Zone Map 用于定位指定范围内的值。

- Bitmap Index 用于在 ENUM 数据类型的列中定位满足特定查询条件的行。