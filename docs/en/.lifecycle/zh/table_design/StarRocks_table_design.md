---
displayed_sidebar: English
---

# 了解表格设计

## 列存储

![列存储](../assets/3.1-1.png)

与其他关系型数据库一样，StarRocks 中的表由行和列组成。每行保存用户数据的记录，每列中的数据具有相同的类型。表中的所有行都具有相同数量的列。您可以动态地向表中添加列或从表中删除列。表的列可以分为维度列和度量列。维度列也称为键列，度量列也称为值列。维度列中的值用于对数据进行分组和排序，度量列中的值可以通过 sum、count、min、max、hll_union_agg 和 bitmap_union 等函数进行累积。

StarRocks 使用列存储来存储表。从物理上讲，列中的数据被隔离到数据块中，经过编码、压缩，然后持久存储在磁盘上。从逻辑上讲，可以将列中的数据与由相同数据类型的元素组成的数组进行比较。行中保存的列值按列顺序列出，就像数组中的元素一样。这意味着一行中保存的列值具有相同的数组索引。数组索引是隐式的，不需要存储。表中的所有行都按照一个或多个维度列指定的顺序进行排序。行在排序表中的位置由该行的序列号表示。

对于表的查询，如果在可以包含维度列前缀的特定维度列上指定了相等或范围条件，StarRocks 可以进行二进制搜索，以快速定位排序数据中感兴趣的行。例如，您要从名为 `table1` 的表中查询数据，该表由四列组成：`event_day`、`siteid`、`citycode`和`username`，其中`event_day`和`siteid`是维度列。如果指定 `event_day = 2020-09-18` 和 `siteid = 2` 作为查询条件，StarRocks 可以进行二进制搜索，只需要处理指定范围内的数据，因为`event_day`和`siteid`可以包含维度列前缀。如果指定 `citycode = 4` 和 `username = Andy` 作为查询条件，StarRocks 无法进行二进制搜索，需要对整张表的数据进行处理，因为`citycode`和`username`不能包含维度列前缀。

## 索引

StarRocks 使用前缀索引和每列索引来快速定位感兴趣的行所获取的数据块的起始行。

下图展示了 StarRocks 表设计如何加速 StarRocks 表的查询。

![索引概述](../assets/3.1-2.png)

StarRocks 中表的数据分为以下三个部分：

- 前缀索引
  
  StarRocks 将每 1024 行的数据存储为一个数据块，并在前缀索引表中保留一个条目。每个数据块的前缀索引条目的内容是由数据块中起始行的维度列组成的前缀，长度不能超过 36 个字节。前缀索引是稀疏索引。当您查询某行时，StarRocks 会搜索前缀索引表，检索该行的维度列所构成的前缀。然后，StarRocks 可以在感兴趣的行所获取的数据块中快速定位起始行的序列号。

- 每列数据块
  
  StarRocks 将每列的数据分离为多个 64 KB 的数据块。每个数据块都作为最小的 I/O 单元进行独立编码和压缩，并作为一个整体从磁盘读取或写入磁盘。

- 每列索引
  
  StarRocks 为每列维护一个行号索引。在行号索引表中，列的数据块将逐个映射到列中所保存的行的序列号上。此外，行号索引表中的每个条目都由映射到特定行号的数据块的起始行号、地址和长度组成。当您查询某行时，StarRocks 会搜索行号索引表，获取该行序列号对应的数据块地址。然后，StarRocks 读取数据块以定位该行。

总而言之，StarRocks 通过以下 5 个步骤，使用由该行的维度列组成的前缀来定位表的行：

1. 搜索前缀索引表，以查找感兴趣行所获取的数据块中起始行的序列号。

2. 搜索各维度列的行号索引表，找到该维度列的数据块。

3. 读取数据块。

4. 解压缩和解码数据块。

5. 搜索数据块以找到维度列索引映射到的行。

## 加速处理

本节介绍帮助 StarRocks 更快速地处理数据的机制。

### 预聚合

StarRocks 提供了聚合表。对于聚合表，可以将表中具有相同值的行聚合为一行。对于从聚合生成的新行，每个维度列中的值保持不变，并且每个度量列中的值由您指定的聚合函数聚合，以生成度量列中新行的结果值。预聚合有助于加速聚合操作。

### 分区和分桶

StarRocks 中的每张表都分为多个 Tablet。每个 Tablet 都存储在多个 BE 上的副本中。BE 的数量和 Tablet 的数量可以根据计算资源和数据大小的变化灵活扩展。当您发起查询时，多个 BE 可以并行搜索 Tablet，以快速定位感兴趣的数据。此外，还可以复制和迁移 Tablet 的副本，从而提高数据可靠性并防止数据倾斜。分区和分桶有助于确保数据检索的效率和稳定性。

### 物化视图

表的前缀索引有助于加快对表的查询，但依赖于表的维度列的顺序。如果使用维度列前缀中未包含的维度列构造查询谓词，则前缀索引不起作用。在这种情况下，您可以为表创建物化视图。物化视图的数据的组织和存储方式与表的数据相同。但是，物化视图可以有自己的前缀索引。在为物化视图创建前缀索引时，可以指定适当的聚合粒度、列数和维度列顺序，以确保常用的查询条件可以命中物化视图的前缀索引表中的预期条目。

### 每列索引

StarRocks 支持如 Bloom 过滤器、区域图和位图索引等每列索引：

- Bloom 过滤器用于确定数据块是否包含要查询的值。

- 区域图用于定位指定范围内的值。

- 位图索引用于在 ENUM 数据类型的列中查找满足指定查询条件的行。
