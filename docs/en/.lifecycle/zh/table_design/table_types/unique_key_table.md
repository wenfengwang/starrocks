---
displayed_sidebar: English
---

# 唯一键表

在创建表时，您可以定义主键列和度量列。这样，查询将返回具有相同主键的一组记录中的最新记录。与重复键表相比，唯一键表简化了数据加载过程，更好地支持实时、频繁的数据更新。

## 场景

唯一键表适用于需要频繁实时更新数据的业务场景。例如，在电子商务场景中，每天可以下数亿个订单，并且订单的状态经常变化。

## 原则

唯一键表可以被视为一个特殊的聚合键表，其中为度量列指定了 REPLACE 聚合函数，以返回具有相同主键的一组记录中的最新记录。

将数据加载到使用唯一键表的表中时，数据将拆分为多个批次。每个批次都分配有一个版本号。因此，具有相同主键的记录可能有多个版本，其中检索最新版本（即版本号最大的记录）进行查询。

如下表所示，`ID` 是主键列，`value` 是度量列，`_version` 保存了 StarRocks 中生成的数据版本号。在此示例中，具有 `ID` 1 的记录由两个批次加载，版本号分别为 `1` 和 `2`；而具有 `ID` 2 的记录由三个批次加载，版本号分别为 `3`、`4` 和 `5`。

| ID   | value | _version |
| ---- | ----- | -------- |
| 1    | 100   | 1        |
| 1    | 101   | 2        |
| 2    | 100   | 3        |
| 2    | 101   | 4        |
| 2    | 102   | 5        |

当您查询具有 `ID` 1 的记录时，将返回具有最大版本号的最新记录，本例中为 `2`。当您查询具有 `ID` 2 的记录时，将返回具有最大版本号的最新记录，本例中为 `5`。下表显示了两个查询返回的记录：

| ID   | value |
| ---- | ----- |
| 1    | 101   |
| 2    | 102   |

## 创建表

在电子商务场景中，您经常需要按日期收集和分析订单的状态。在此示例中，创建一个名为 `orders` 的表来保存订单，定义 `create_time` 和 `order_id` 作为主键列，这两列经常用作筛选订单的条件，并将 `order_state` 和 `total_price` 定义为度量列。这样，订单可以在状态变化时实时更新，并且可以快速过滤以加速查询。

创建表的语句如下：

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "订单创建时间",
    order_id BIGINT NOT NULL COMMENT "订单ID",
    order_state INT COMMENT "订单状态",
    total_price BIGINT COMMENT "订单价格"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注意**
>
> - 创建表时，必须使用 `DISTRIBUTED BY HASH` 子句指定存储桶列。有关详细信息，请参阅 [存储桶](../Data_distribution.md#design-partitioning-and-bucketing-rules)。
> - 从 v2.5.7 开始，StarRocks 可以在您创建表或添加分区时自动设置存储桶数量（BUCKETS）。您不再需要手动设置存储桶数量。有关详细信息，请参阅 [确定存储桶数量](../Data_distribution.md#determine-the-number-of-buckets)。

## 使用说明

- 关于表的主键，请注意以下几点：

  - 主键是使用 `UNIQUE KEY` 关键字定义的。
  - 主键必须在强制实施唯一约束且无法更改其名称的列上创建。
  - 主键必须正确设计：
    - 运行查询时，主键列在聚合多个数据版本之前进行过滤，而度量列在聚合多个数据版本后过滤。因此，建议您确定经常用作筛选条件的列，并将这些列定义为主键列。这样，数据筛选可以在聚合多个数据版本之前开始，以提高查询性能。
    - 在聚合过程中，StarRocks 会比较所有主键列。这很耗时，并且可能会降低查询性能。因此，不要定义大量的主键列。如果某列很少用作查询的筛选条件，建议不要将该列定义为主键列。

- 创建表时，不能对表的度量列创建 BITMAP 索引或 Bloom Filter 索引。

- 唯一键表不支持物化视图。

## 下一步做什么

表创建成功后，您可以使用多种数据引入方式将数据加载到 StarRocks 中。有关 StarRocks 支持的数据引入方式的信息，请参见 [数据导入](../../loading/Loading_intro.md)。

> - 将数据加载到使用唯一键表的表中时，只能更新表的所有列。例如，更新上述 `orders` 表时，必须更新其所有列，即 `create_time`、`order_id`、`order_state` 和 `total_price`。
> - 当您从使用唯一键表的表中查询数据时，StarRocks 需要聚合多个数据版本的记录。在此情况下，大量数据版本会降低查询性能。因此，建议您指定适当的数据加载频率，以满足您对实时数据分析的需求，同时防止数据版本过多。如果需要分钟级数据，可以指定加载频率为 1 分钟，而不是加载频率为 1 秒。
