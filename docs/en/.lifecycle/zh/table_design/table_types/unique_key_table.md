---
displayed_sidebar: English
---

# 唯一键表

创建表时，您可以定义主键列和度量列。这样，查询将返回一组具有相同主键的记录中的最新记录。与重复键表相比，唯一键表简化了数据加载过程，更好地支持实时和频繁的数据更新。

## 应用场景

唯一键表适用于数据需要频繁实时更新的业务场景。例如，在电商场景中，每天可以下达数亿订单，订单状态的变化也非常频繁。

## 原理

唯一键表可以被视为一种特殊的聚合键表，在该表中为度量列指定了REPLACE聚合函数，以返回具有相同主键的记录组中的最新记录。

当您向使用唯一键表的表中加载数据时，数据会被分成多个批次。每个批次都会被分配一个版本号。因此，具有相同主键的记录可能会有多个版本，查询时会检索最新的版本（即具有最大版本号的记录）。

如下表所示，`ID` 是主键列，`value` 是度量列，`_version` 保存了 StarRocks 内部生成的数据版本号。在此示例中，具有 `ID` 为 1 的记录通过两个批次加载，其版本号分别为 `1` 和 `2`，具有 `ID` 为 `2` 的记录通过三个批次加载，其版本号分别为 `3`、`4` 和 `5`。

|ID|value|_version|
|---|---|---|
|1|100|1|
|1|101|2|
|2|100|3|
|2|101|4|
|2|102|5|

当您查询 `ID` 为 `1` 的记录时，会返回版本号最大的最新记录，此例中为 `2`。当您查询 `ID` 为 `2` 的记录时，会返回版本号最大的最新记录，此例中为 `5`。下表显示了两次查询返回的记录：

|ID|value|
|---|---|
|1|101|
|2|102|

## 创建表

在电商场景中，您经常需要按日期收集和分析订单状态。在此示例中，创建一个名为 `orders` 的表来保存订单，将 `create_time` 和 `order_id` 定义为常用于过滤订单的条件的主键列，并将另外两列 `order_state` 和 `total_price` 定义为度量列。这样，订单可以随着状态的变化实时更新，并且可以快速过滤以加快查询速度。

创建表的语句如下：

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "订单的创建时间",
    order_id BIGINT NOT NULL COMMENT "订单的ID",
    order_state INT COMMENT "订单的状态",
    total_price BIGINT COMMENT "订单的总价"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注意**
- 创建表时，必须使用 `DISTRIBUTED BY HASH` 子句指定分桶列。有关详细信息，请参阅[bucketing](../Data_distribution.md#design-partitioning-and-bucketing-rules)。
- 从 v2.5.7 版本开始，StarRocks 在创建表或添加分区时可以自动设置桶（BUCKETS）的数量。您不再需要手动设置桶的数量。有关详细信息，请参阅[determine the number of buckets](../Data_distribution.md#determine-the-number-of-buckets)。

## 使用说明

- 关于表的主键，请注意以下几点：

  - 主键是使用 `UNIQUE KEY` 关键字定义的。
  - 主键必须创建在强制执行唯一约束且名称不能更改的列上。
  - 主键设计必须合理：
    - 在查询时，主键列在多个数据版本聚合之前进行过滤，而度量列在多个数据版本聚合之后进行过滤。因此，我们建议您识别出经常用作过滤条件的列，并将这些列定义为主键列。这样，可以在多个数据版本聚合之前开始数据过滤，以提升查询性能。
    - 在聚合过程中，StarRocks 会比较所有主键列。这个过程非常耗时并可能会降低查询性能。因此，不要定义过多的主键列。如果某列很少用作查询的过滤条件，我们建议您不要将该列定义为主键列。

- 创建表时，不能在表的度量列上创建 BITMAP 索引或 Bloom Filter 索引。

- 唯一键表不支持物化视图。

## 下一步

创建表后，您可以使用多种数据摄取方法将数据加载到 StarRocks 中。有关 StarRocks 支持的数据摄取方法的信息，请参阅[数据导入](../../loading/Loading_intro.md)。

- 当您向使用唯一键表的表中加载数据时，您只能更新表的所有列。例如，当您更新前面的 `orders` 表时，您必须更新其所有列，包括 `create_time`、`order_id`、`order_state` 和 `total_price`。
- 当您从使用唯一键表的表中查询数据时，StarRocks 需要聚合多个数据版本的记录。在这种情况下，大量的数据版本会降低查询性能。因此，我们建议您指定适当的数据加载频率，以满足您对实时数据分析的需求，同时避免产生大量的数据版本。如果您需要分钟级别的数据，可以指定加载频率为1分钟，而不是1秒的加载频率。