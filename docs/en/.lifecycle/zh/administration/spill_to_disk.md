---
displayed_sidebar: English
---

# 将溢出到磁盘

本主题描述了如何将大型算子的中间计算结果溢出到磁盘。

## 概述

对于依赖内存计算执行查询的数据库系统，例如 StarRocks，当处理大数据集上的聚合、排序和连接算子的查询时，可能会消耗大量内存资源。当内存限制达到时，由于内存不足（OOM），这些查询将被强制终止。

然而，仍然有可能希望稳定地完成某些内存密集型任务，并且性能不是首要任务，例如构建一个具体化视图，或者执行一个轻量级的 INSERT INTO SELECT 的 ETL。这些任务很容易耗尽内存资源，从而阻塞集群中运行的其他查询。通常情况下，要解决这个问题，只能单独微调这些任务，并依靠资源隔离策略来控制查询并发。这可能特别不方便，并且在一些极端情况下可能会失败。

从 StarRocks v3.0.1 开始，StarRocks 支持将一些内存密集型算子的中间结果溢出到磁盘。有了这个功能，您可以在一定程度上牺牲性能来显著减少内存使用，从而提高系统的可用性。

目前，StarRocks 的溢出功能支持以下算子：

- 聚合算子
- 排序算子
- 哈希连接（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN 和 INNER JOIN）算子

## 启用中间结果溢出

按照以下步骤启用中间结果溢出：

1. 在 BE 配置文件 **be.conf** 中指定存储溢出中间结果的 **spill 目录** `spill_local_storage_dir`，并重新启动集群以使修改生效。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **注意**
   >
   > - 您可以用分号 (`;`) 将多个 `spill_local_storage_dir` 分隔开。
   > - 在生产环境中，强烈建议您使用不同的磁盘进行数据存储和溢出。当中间结果溢出到磁盘时，写入负载和磁盘使用率可能会显著增加。如果使用相同的磁盘，这种激增可能会影响集群中运行的其他查询或任务。

2. 执行以下语句以启用中间结果溢出：

   ```SQL
   SET enable_spill = true;
   ```

3. 使用会话变量 `spill_mode` 配置中间结果溢出的模式：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **注意**
   >
   > 每次带有溢出的查询完成时，StarRocks 都会自动清除查询产生的溢出数据。如果 BE 在清除数据之前崩溃，StarRocks 将在 BE 重新启动时清除数据。

   | **变量** | **默认** | **描述**                                              |
   | ------------ | ----------- | ------------------------------------------------------------ |
   | enable_spill | false       | 是否启用中间结果溢出。如果设置为 `true`，StarRocks 会将查询中处理聚合、排序或连接算子时的中间结果溢出到磁盘，以减少内存使用。 |
   | spill_mode   | auto        | 中间结果溢出的执行模式。有效值：<ul><li>`auto`：当达到内存使用阈值时，会自动触发溢出。</li><li>`force`：StarRocks 强制对所有相关算子执行溢出，无论内存使用情况如何。</li></ul>此变量仅在变量 `enable_spill` 设置为 `true` 时生效。 |

## 限制

- 并非所有的 OOM 问题都可以通过溢出来解决。例如，StarRocks 无法释放用于表达式计算的内存。
- 通常情况下，涉及溢出的查询会导致查询延迟增加十倍。我们建议您通过设置会话变量 `query_timeout` 来延长这些查询的超时时间。
