---
displayed_sidebar: English
---

# 溢写到磁盘

本主题介绍如何将大型运算符的中间计算结果溢写到磁盘。

## 概述

对于依赖内存计算执行查询的数据库系统，如 StarRocks，在处理大数据集上的聚合、排序和连接运算符查询时，可能会消耗大量内存资源。当达到内存限制时，这些查询会因内存不足 (OOM) 而被强制终止。

然而，您可能仍希望某些内存密集型任务能够稳定完成，即使性能不是首要考虑因素，例如构建物化视图，或执行轻量级 ETL 操作，如 INSERT INTO SELECT。这些任务可能会迅速耗尽内存资源，从而阻塞集群中其他查询的执行。通常，要解决此问题，您只能对这些任务进行单独的微调，并依赖资源隔离策略来控制查询并发。这可能特别不便，且在某些极端情况下容易失败。

从 StarRocks v3.0.1 版本开始，StarRocks 支持将某些内存密集型运算符的中间结果溢写到磁盘。通过这项功能，您可以接受一定程度的性能下降，以换取显著降低的内存使用量，从而提高系统的可用性。

目前，StarRocks 的溢写功能支持以下运算符：

- 聚合运算符
- 排序运算符
- 哈希连接（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN 和 INNER JOIN）运算符

## 启用中间结果溢写

按照以下步骤启用中间结果溢写：

1. 在 BE 配置文件 **be.conf** 中指定存放溢写中间结果的目录 `spill_local_storage_dir`，并重启集群以使修改生效。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

      > **注意**
   - 您可以通过用分号（;）分隔来指定多个 `spill_local_storage_dir`。
   - 在生产环境中，我们强烈建议您为数据存储和溢写使用不同的磁盘。当中间结果溢写到磁盘时，可能会导致写入负载和磁盘使用率显著增加。如果使用相同的磁盘，这种激增可能会影响集群中其他查询或任务的运行。

2. 执行以下语句以启用中间结果溢写：

   ```SQL
   SET enable_spill = true;
   ```

3. 使用会话变量 `spill_mode` 配置中间结果溢写的模式：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

      > **注意**
      > 每次带溢写的查询完成后，StarRocks 会自动清除该查询产生的溢写数据。如果 BE 在清除数据之前崩溃，StarRocks 会在 BE 重启时进行清理。

   |变量|默认值|描述|
|---|---|---|
   |enable_spill|false|是否启用中间结果溢写。如果设置为 `true`，StarRocks 会将中间结果溢写到磁盘，以减少在处理查询中的聚合、排序或连接运算符时的内存使用。|
   |spill_mode|auto|中间结果溢写的执行模式。有效值：<ul><li>`auto`：当内存使用达到阈值时自动触发溢写。</li><li>`force`：无论内存使用情况如何，StarRocks 都会强制对所有相关运算符执行溢写。</li></ul>此变量仅在 `enable_spill` 设置为 `true` 时生效。|

## 局限性

- 并非所有 OOM 问题都可以通过溢写解决。例如，StarRocks 无法释放用于表达式计算的内存。
- 通常，涉及溢写的查询会导致查询延迟增加十倍。我们建议您通过设置会话变量 `query_timeout` 来延长这些查询的超时时间。