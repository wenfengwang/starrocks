---
displayed_sidebar: English
---

# 副本管理

## 术语

* Tablet：表的逻辑分片，一个表有多个Tablet。
* Replica：Tablet的副本，每个Tablet默认有3个副本。
* 健康副本：后端存活且版本完整的副本。
* TabletChecker（TC）：常驻后台线程，定期扫描所有Tablet，并根据Tablet的状态决定是否将其发送到TabletScheduler。
* TabletScheduler（TS）：常驻后台线程，处理TabletChecker发送的Tablet，并执行集群副本平衡。
* TabletSchedCtx（TSC）：Tablet的封装。当Tablet被TC选中时，它被封装为TSC并发送给TS。
* 存储介质：StarRocks支持不同存储介质的分区粒度，包括SSD和HDD。不同存储介质的副本调度各不相同。

## 状态

### 副本状态

副本的健康状态如下。

* **BAD**

副本已损坏。包括但不限于由磁盘故障、bug等引起的副本不可恢复的损坏。

* **VERSION_MISSING**

每批量导入对应一个数据版本。在一个副本中应该看到几个连续的版本。由于导入错误，某些副本可能具有不完整的数据版本。

* **HEALTHY**

副本数据正确，所在BE节点状态正常（心跳正常，未处于下线过程中）。

### Tablet状态

Tablet的健康状态由其所有副本的状态决定：

* **REPLICA_MISSING**

副本缺失。即，幸存副本的数量小于预期副本的数量。

* **VERSION_INCOMPLETE**

幸存副本数量大于或等于预期数量，但健康副本数量小于预期数量。

* **REPLICA_RELOCATING**

具有完整版本的幸存副本数量等于`replication num`。但是，一些副本所在的BE节点不可用（例如，处于退役状态）。

* **REPLICA_MISSING_IN_CLUSTER**

使用多个集群时，健康副本数量大于或等于预期数量，但相应集群内的副本数量小于预期数量。

* **REDUNDANT**

副本冗余。所有健康副本都在相应集群中，但由于不可用副本的冗余，总副本数量大于预期数量。

* **FORCE_REDUNDANT**

这是一种特殊状态。仅当预期副本数量大于或等于可用节点数，且Tablet处于副本缺失状态时，才会发生。此时，需要先删除一个副本，以确保有可用节点来创建新副本。

* **COLOCATE_MISMATCH**

Colocation属性的Tablet状态，表示分片副本与Colocation Group指定的分布不匹配。

* **COLOCATE_REDUNDANT**

Colocation属性的Tablet状态，表示Colocation表的Tablet副本是多余的。

* **HEALTHY**

健康的Tablet。

## 副本修复

TabletChecker定期检查所有Tablet的状态。不健康的Tablet交由TabletScheduler进行调度和修复。修复在BE上以克隆任务的形式完成。FE负责生成克隆任务。

> 注意1：副本修复的主要思路是首先创建或补充新副本以达到所需数量，然后删除任何多余的副本。
> 注意2：克隆任务是将目标数据从远程BE复制到目的BE。

针对不同状态，我们采用不同的修复方法。

1. REPLICA_MISSING/REPLICA_RELOCATING
选择一个可用的BE节点作为目的BE。选择一个健康副本作为源。克隆任务将从源复制完整副本到目的BE。对于副本补充，无论存储介质如何，都会选择可用的BE节点。
2. VERSION_INCOMPLETE
选择一个相对完整的副本作为目的副本。选择一个健康副本作为源。克隆任务将从源复制缺失的版本到目的副本。
3. REPLICA_MISSING_IN_CLUSTER
此状态的处理与REPLICA_MISSING相同。
4. REDUNDANT
通常在副本修复后，Tablet会有多余的副本。选择一个多余的副本并删除。多余副本的选择顺序如下：

   * 副本所在的BE已经离线
   * 副本已损坏
   * 副本所在的BE失去连接或正在下线
   * 副本处于CLONE状态（克隆任务执行期间的中间状态）
   * 副本缺少版本
   * 副本所在的集群不正确
   * 副本所在的BE节点负载过重

5. FORCE_REDUNDANT
尽管Tablet缺少副本，但没有可用节点来创建新副本。在这种情况下，必须先删除一个副本以释放节点，以便创建新副本。删除副本的顺序与REDUNDANT相同。
6. COLOCATE_MISMATCH
选择Colocation Group中指定的一个BE节点作为副本补充的目的节点。
7. COLOCATE_REDUNDANT
删除不在Colocation Group中指定的BE节点上的副本。

StarRocks不会在同一主机的不同BE上部署同一个Tablet的副本，这确保了即使同一主机的所有BE都失败，仍有一些副本存活。

## 副本调度

### 调度优先级

TabletScheduler中等待调度的Tablet根据其状态被赋予不同的优先级。优先级较高的Tablet将优先被调度。优先级如下：

* VERY_HIGH

* 处于`REDUNDANT`状态。具有多余副本的Tablet被赋予非常高的优先级。尽管副本冗余是最不紧迫的问题，但它是处理和释放资源（如磁盘空间）最快的。
* 处于`FORCE_REDUNDANT`状态。同上。

* HIGH

* 处于`REPLICA_MISSING`状态，且大多数副本丢失（例如，3个副本中有2个丢失）
* 处于`VERSION_INCOMPLETE`状态，且大多数副本缺少版本
* 处于`COLOCATE_MISMATCH`状态。与Colocation表关联的Tablet将尽快修复。
* 处于`COLOCATE_REDUNDANT`状态。

* NORMAL

* 处于`REPLICA_MISSING`状态，但大多数副本仍然存在（例如，3个副本中有1个丢失）
* 处于`VERSION_INCOMPLETE`状态，但大多数副本版本完整
* 处于`REPLICA_RELOCATING`状态，且大多数副本需要重新定位（例如，3份副本中有2份）

* LOW

* 处于`REPLICA_MISSING_IN_CLUSTER`状态
* 处于`REPLICA_RELOCATING`状态，但大多数副本稳定

### 手动确定优先级

系统将自动确定调度优先级。然而，有时用户希望某些Tablet能够更快地修复。因此，我们提供了一个命令，用户可以指定首先修复某个表或分区的Tablet。

ADMIN REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

此命令告诉TC为有问题的Tablet提供`VERY_HIGH`优先级，以便可以首先修复它。

> 注意：此命令不保证修复成功，优先级会随着TS的调度而变化。当领导FE更改或重新启动时，此信息将丢失。

可以使用以下命令取消优先级。

ADMIN CANCEL REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

### 优先级调度

优先级确保首先修复严重损坏的Tablet。但是，如果高优先级的修复任务持续失败，将导致低优先级任务无法安排。因此，我们根据每个任务的状态动态调整优先级，以确保所有任务都有机会被调度。

```
* 如果调度连续5次失败（例如无法获取资源、无法找到合适的源或目的地等），则该任务的优先级将被降低。
* 如果任务在30分钟内未被调度，则会提升其优先级。
* 任务的优先级在五分钟内不能调整两次。

为了确保初始优先级有权重，`VERY_HIGH`任务的优先级最多只能降至`NORMAL`，而`LOW`任务的优先级最多只能提升至`HIGH`。用户手动设置的任务优先级也适用这种优先级调整。

## 副本平衡

StarRocks自动在集群内执行副本平衡。平衡的主要思想是在低负载节点上创建副本，在高负载节点上删除副本。同一集群内不同BE节点可能存在多种存储介质。为了在平衡后保持tablet在原有的存储介质上，BE节点会根据存储介质进行分类，以便智能地调度负载平衡。

同样，副本平衡确保同一主机的不同BE上不部署同一Tablet的副本。

### BE节点负载

ClusterLoadStatistics（CLS）显示集群中每个Backend的负载均衡情况，并触发TabletScheduler来平衡集群。目前，我们使用**磁盘利用率**和**副本数量**来计算每个BE的`loadScore`。分数越高，BE的负担越重。

`capacityCoefficient`和`replicaNumCoefficient`（总和为1）分别是磁盘利用率和副本数量的权重因子。`capacityCoefficient`根据实际磁盘使用情况动态调整。当BE整体磁盘利用率低于50%时，`capacityCoefficient`值为0.5。当磁盘利用率高于75%（可通过FE配置项`capacity_used_percent_high_water`配置），该值为1。如果利用率在50%到75%之间，则权重因子根据以下公式平滑增加：

`capacityCoefficient = 2 * 磁盘利用率 - 0.5`

这个权重因子确保了当磁盘使用率过高时，该Backend的负载分数会更高，迫使尽快降低该BE上的负载。

TabletScheduler每1分钟更新一次CLS。

### 平衡策略

TabletScheduler在每轮调度中通过LoadBalancer选择一定数量的健康tablet作为平衡候选，并根据这些候选tablet调整未来的调度。

## 资源控制

副本修复和平衡都是通过跨BE复制来完成的。在同一个BE上同时执行过多任务会导致IO压力增加。因此，StarRocks在调度时控制了每个节点上可以执行的任务数量。资源控制的最小单位是磁盘（即`be.conf`中指定的数据路径）。默认情况下，为每个磁盘分配两个插槽用于副本修复。克隆任务在源BE和目标BE上各占用一个插槽。如果磁盘的插槽数为零，则不会再为其分配任务。这个插槽数可以通过FE的`schedule_slot_num_per_path`参数配置。

此外，默认情况下，每个磁盘分配两个插槽用于副本平衡。目的是防止负载较重的节点被修复任务占用，无法通过平衡释放空间。

## 查看副本状态

副本状态**仅存在于领导FE节点**中。因此，以下命令需要通过直接连接到**领导FE**来执行。

### 查看副本状态

1. 全局状态检查  
   `SHOW PROC '/statistic';`命令允许您查看整个集群的副本状态。

   ```plaintext
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | DbId     | DbName                      | TableNum | PartitionNum | IndexNum | TabletNum | ReplicaNum | UnhealthyTabletNum | InconsistentTabletNum |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | 35153636 | default_cluster:DF_Newrisk  | 3        | 3            | 3        | 96        | 288        | 0                  | 0                     |
   | 48297972 | default_cluster:PaperData   | 0        | 0            | 0        | 0         | 0          | 0                  | 0                     |
   | 5909381  | default_cluster:UM_TEST     | 7        | 7            | 10       | 320       | 960        | 1                  | 0                     |
   | Total    | 240                         | 10       | 10           | 13       | 416       | 1248       | 1                  | 0                     |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   ```

   `UnhealthyTabletNum`列显示相应数据库中有多少个不健康的Tablet。`InconsistentTabletNum`列显示相应数据库中有多少Tablet处于副本不一致状态。最后`Total`行给出了整个集群的统计信息。通常`UnhealthyTabletNum`和`InconsistentTabletNum`应为零。如果不为零，您可以进一步检查tablet的信息。如上所示，`UM_TEST`数据库中有一个tablet处于不健康状态，那么可以使用以下命令查看是哪一个tablet。

   `SHOW PROC '/statistic/5909381';`  
   其中`5909381`是相应的DbId。

   ```plaintext
   +------------------+---------------------+
   | UnhealthyTablets | InconsistentTablets |
   +------------------+---------------------+
   | [40467980]       | []                  |
   +------------------+---------------------+
   ```

   上面的结果显示了特定的不健康Tablet ID（40467980）。接下来，我们将描述如何检查特定Tablet的每个副本的状态。

2. 表（分区）级别状态检查  
   用户可以使用以下命令检查特定表或分区的副本状态，并可以通过WHERE语句过滤状态。例如，要查看`tbl1`中`p1`和`p2`的`NORMAL`副本的状态。  
   `ADMIN SHOW REPLICA STATUS FROM tbl1 PARTITION (p1, p2) WHERE STATUS = "OK";`

   ```plaintext
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | TabletId | ReplicaId | BackendId | Version | LastFailedVersion | LastSuccessVersion | CommittedVersion | SchemaHash | VersionNum | IsBad | State  | Status |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | 29502429 | 29502432  | 10006     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 36885996  | 10002     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 48100551  | 10007     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 29502434  | 10001     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 44900737  | 10004     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 48369135  | 10006     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   ```

   如果`IsBad = true`，则意味着副本已损坏。`Status`列显示附加信息。`ADMIN SHOW REPLICA STATUS`命令主要用于查看副本的健康状态。用户还可以使用以下命令查看其他信息。

   `SHOW TABLET FROM tbl1;`

   ```plaintext
   +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
   ```
```plaintext
   | TabletId | ReplicaId | BackendId | SchemaHash | Version | VersionHash | LastSuccessVersion | LastSuccessVersionHash | LastFailedVersion | LastFailedVersionHash | LastFailedTime | DataSize | RowCount | State  | LastConsistencyCheckTime | CheckVersion | CheckVersionHash | VersionCount | PathHash             | MetaUrl              | CompactionStatus     |
   +----------+-----------+-----------+------------+---------+-------------+--------------------+------------------------+-------------------+-----------------------+----------------+----------+----------+--------+--------------------------+--------------+------------------+--------------+----------------------+----------------------+----------------------+
   | 29502429 | 29502432  | 10006     | 1421156361 | 2       | 0           | 2                  | 0                      | -1                | 0                     | N/A            | 784      | 0        | NORMAL | N/A                      | -1           | -1               | 2            | -5822326203532286804 | url                  | url                  |
   | 29502429 | 36885996  | 10002     | 1421156361 | 2       | 0           | -1                 | 0                      | -1                | 0                     | N/A            | 784      | 0        | NORMAL | N/A                      | -1           | -1               | 2            | -1441285706148429853 | url                  | url                  |
   | 29502429 | 48100551  | 10007     | 1421156361 | 2       | 0           | -1                 | 0                      | -1                | 0                     | N/A            | 784      | 0        | NORMAL | N/A                      | -1           | -1               | 2            | -4784691547051455525 | url                  | url                  |
   +----------+-----------+-----------+------------+---------+-------------+--------------------+------------------------+-------------------+-----------------------+----------------+----------+----------+--------+--------------------------+--------------+------------------+--------------+----------------------+----------------------+----------------------+
   ```

附加信息包括副本大小、行数、版本数、所在数据路径等。

> 注意：`State` 列并不代表副本本身的健康状态，而是代表副本在某些任务（例如 `CLONE`、`SCHEMA_CHANGE`、`ROLLUP` 等）下的状态。

另外，用户可以通过以下命令检查副本是否均匀分布：`ADMIN SHOW REPLICA DISTRIBUTION FROM tbl1;`

```plaintext
+-----------+------------+-------+---------+
| BackendId | ReplicaNum | Graph | Percent |
+-----------+------------+-------+---------+
| 10000     | 7          |       | 7.29 %  |
| 10001     | 9          |       | 9.38 %  |
| 10002     | 7          |       | 7.29 %  |
| 10003     | 7          |       | 7.29 %  |
| 10004     | 9          |       | 9.38 %  |
| 10005     | 11         | >     | 11.46 % |
| 10006     | 18         | >     | 18.75 % |
| 10007     | 15         | >     | 15.62 % |
| 10008     | 13         | >     | 13.54 % |
+-----------+------------+-------+---------+
```

信息包括每个BE节点上的副本数量、百分比，简单的图形显示如上所示。

平板电脑级别状态检查

用户可以使用以下命令来检查特定平板电脑的状态。例如，查看ID为29502553的平板电脑的状态。

`SHOW TABLET 29502553;`

```plaintext
+------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
| DbName                 | TableName | PartitionName | IndexName | DbId     | TableId  | PartitionId | IndexId  | IsSync | DetailCmd                                                                 |
+------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
| default_cluster:test   | test      | test          | test      | 29502391 | 29502428 | 29502427    | 29502428 | true   | SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553'; |
+------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
```

上面显示了tablet对应的数据库、表、分区、索引等信息。用户可以复制`DetailCmd`中的命令来查看详细信息。`SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553';`

```plaintext
+-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
| ReplicaId | BackendId | Version | VersionHash | LastSuccessVersion | LastSuccessVersionHash | LastFailedVersion | LastFailedVersionHash | LastFailedTime | SchemaHash | DataSize | RowCount | State  | IsBad | VersionCount | PathHash             | MetaUrl  | CompactionStatus |
+-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
| 43734060  | 10004     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | -8566523878520798656 | url      | url              |
| 29502555  | 10002     | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1885826196444191611  | url      | url              |
| 39279319  | 10007     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1656508631294397870  | url      | url              |
+-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
```

上面显示了相应 Tablet 的所有副本。这里显示的内容与`SHOW TABLET FROM tbl1;`相同。但在这里你可以清楚地看到特定Tablet的所有副本的状态。

### 副本的调度任务

1. 使用 `SHOW PROC '/cluster_balance/pending_tablets'` 查看等待调度的任务；

   ```plaintext
   +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
   | TabletId | Type   | Status          | State   | OrigPrio | DynmPrio | SrcBe | SrcPath | DestBe | DestPath | Timeout | Create              | LastSched           | LastVisit           | Finished | Rate | FailedSched | FailedRunning | LastAdjPrio         | VisibleVer | VisibleVerHash      | CmtVer | CmtVerHash          | ErrMsg                        |
   +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
   | 4203036  | REPAIR | REPLICA_MISSING | PENDING | HIGH     | LOW      | -1    | -1      | -1     | -1       | 0       | 2019-02-21 15:00:20 | 2019-02-24 11:18:41 | 2019-02-24 11:18:41 | N/A      | N/A  | 2           | 0             | 2019-02-21 15:00:43 | 1          | 0                   | 2      | 0                   | unable to find source replica |
   +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
   ```

   |字段|描述|
   |---|---|
   |TabletId|等待调度的平板电脑的 ID。|
   |Type|任务类型，REPAIR 或 BALANCE。|
   |Status|平板电脑的当前状态，例如 `REPLICA_MISSING`。|
   |State|此调度任务的状态。值：PENDING/ RUNNING/ FINISHED/ CANCELLED/ TIMEOUT/ UNEXPECTED。|
   |OrigPrio|初始优先级。|
   |DynmPrio|动态优先级。|
   |SrcBe|源 BE 节点 ID。|
   |SrcPath|源 BE 节点的路径。|
   |DestBe|目的 BE 节点的 ID。|
   |DestPath|目标 BE 节点的路径。|
   |Timeout|任务调度成功后，此处会显示任务的超时时间（以秒为单位）。|
   |Create|创建任务的时间。|
   |LastSched|上次安排任务的时间。|
   |LastVisit|上次访问任务的时间。“访问”是指调度、任务执行报告。|
   |Finished|任务完成的时间。|
   |Rate|克隆任务的数据复制速率。|
   |FailedSched|任务调度失败的次数。|
   |FailedRunning|任务执行失败的次数。|
   |LastAdjPrio|上次调整任务优先级的时间。|
   |VisibleVer/VisibleVerHash/CmtVer/CmtVerHash|执行克隆任务时使用的版本信息。|
   |ErrMsg|任务调度和运行时的错误信息。|
```
```markdown
   |LstAdjPrio|上次调整任务优先级的时间|
   |CmtVer/CmtVerHash/VisibleVer/VisibleVerHash|执行克隆任务时使用的版本信息|
   |ErrMsg|任务调度和运行时的错误信息|

2. 使用 `SHOW PROC '/cluster_balance/running_tablets';` 查看正在运行的任务。这里使用的属性与之前相同。详细信息请参见“待处理的平板电脑”。

3. 使用 `SHOW PROC '/cluster_balance/history_tablets';` 查看已完成的任务。默认情况下，我们只保留最近的1000个已完成任务的记录。这里使用的属性与之前相同。详细信息请参见“待处理的平板电脑”。如果 `State` 为 `FINISHED`，则表示任务已经正确完成。否则，请检查 `ErrMsg` 了解任务失败的原因。