---
displayed_sidebar: English
---

# 副本管理

## 术语

* 平板电脑：表的逻辑切片，一个表有多个平板电脑。
* 副本：平板电脑的拷贝，默认情况下每个平板电脑有 3 个副本。
* 健康副本：后端存活且版本完整的副本。
* TabletChecker（TC）：一个常驻后台线程，定期扫描所有平板电脑，并根据它们的状态决定是否将平板电脑发送到TabletScheduler。
* TabletScheduler（TS）：一个常驻后台线程，用于处理TabletChecker发送的平板电脑，并执行集群副本平衡。
* TabletSchedCtx（TSC）：平板电脑的包装。当TC选择平板电脑时，它会被封装为TSC并发送到TS。
* 存储介质：StarRocks支持不同的存储介质进行分区粒度的存储，包括SSD和HDD。不同存储介质的副本调度方式也不同。

## 状态

### 副本状态

副本的健康状态如下。

* **坏**

副本已损坏。这包括但不限于由磁盘故障、错误等造成的副本无法恢复的损坏。

* **VERSION_MISSING**

每次批量导入对应一个数据版本。您应该在一个副本中看到连续的多个版本。由于导入错误，一些副本可能有不完整的数据版本。

* **健康**

副本的数据正确，且所在的BE节点处于正常状态（正常心跳且未处于下线过程中）。

### 平板电脑状态

平板电脑的健康状态由其所有副本的状态决定：

* **REPLICA_MISSING**

副本缺失。即幸存的副本数少于预期的副本数。

* **VERSION_INCOMPLETE**

幸存副本数大于或等于预期数，但正常副本数少于预期数。

* **REPLICA_RELOCATING**

具有完整版本的幸存副本数等于`replication num`。但一些副本所在的BE节点不可用（例如，处于停用状态）。

* **REPLICA_MISSING_IN_CLUSTER**

使用多个集群时，正常副本数大于或等于预期数，但对应集群内的副本数少于预期数。

* **冗余**

副本冗余。所有正常副本都位于相应的集群中，但由于冗余的不可用副本，副本总数大于预期数量。

* **FORCE_REDUNDANT**

这是一种特殊状态。仅当预期的副本数大于或等于可用节点数，并且平板电脑处于副本缺失状态时才会出现。在这种情况下，需要首先删除一个副本，以确保有可用节点创建新副本。

* **COLOCATE_MISMATCH**

Colocation属性的平板电脑状态，指示分片副本与Colocation Group指定的分布不匹配。

* **COLOCATE_REDUNDANT**

Colocation属性的平板电脑状态，指示Colocation表的平板电脑副本是冗余的。

* **健康**

健康的平板电脑。

## 副本修复

TabletChecker定期检查所有平板电脑的状态。不健康的平板电脑将移交给TabletScheduler进行调度和修复。修复在BE上作为克隆任务完成。FE负责生成克隆任务。

> 注 1：副本修复的主要思想是首先创建或修补新副本以达到所需值，然后删除任何冗余副本。
> 注 2：克隆任务是将目标数据从远程BE复制到目标BE。

对于不同的状态，我们使用不同的方法来修复。

1. REPLICA_MISSING/REPLICA_RELOCATING
   选择可用的BE节点作为目标BE。选择正常运行的副本作为源。克隆任务会将完整副本从源复制到目标BE。对于副本补充，无论存储介质如何，都将选择可用的BE节点。
2. VERSION_INCOMPLETE
   选择一个相对完整的副本作为目标。选择正常运行的副本作为源。克隆任务会将缺少的版本从源复制到目标。
3. REPLICA_MISSING_IN_CLUSTER
   此状态的处理方式与REPLICA_MISSING相同。
4. 冗余
  通常在副本修复后，平板电脑将具有冗余副本。选择冗余副本并将其删除。冗余副本的选择遵循以下顺序：

   * 副本所在的BE已下线
   * 副本已损坏
   * 副本所在的BE已断开连接或正在下线
   * 副本处于克隆状态（克隆任务执行期间的中间状态）
   * 副本缺少版本
   * 副本所在的集群不正确
   * 副本所在的BE节点负载过重

5. FORCE_REDUNDANT
   尽管平板电脑缺少副本，但没有可用于创建新副本的节点。在这种情况下，必须首先删除副本，以释放节点以创建新副本。删除副本的顺序与冗余相同。
6. COLOCATE_MISMATCH
   选择Colocation Group指定的一个BE节点作为副本补充的目标节点。
7. COLOCATE_REDUNDANT
   删除未在Colocation Group指定的BE节点上的副本。

StarRocks不会在同一主机的不同BE上部署同一平板电脑的副本，这样可以保证即使同一主机的所有BE都发生故障，部分副本仍然有效。

## 副本调度

### 调度优先级

等待在TabletScheduler中调度的平板电脑会根据其状态获得不同的优先级。优先级较高的平板电脑将首先被安排。优先级如下：

* VERY_HIGH

* 处于`REDUNDANT`状态。具有冗余副本的平板电脑具有非常高的优先级。虽然副本冗余是最不紧急的，但它是处理和释放资源（如磁盘空间）的最快方式。
* 处于`FORCE_REDUNDANT`状态。同上。

* 高

* 处于`REPLICA_MISSING`状态，且大多数副本丢失（例如，3个副本中的2个丢失）
* 处于`VERSION_INCOMPLETE`状态，且大多数副本缺少版本
* 处于`COLOCATE_MISMATCH`状态。与Colocation表关联的平板电脑将尽快修复。
* 处于`COLOCATE_REDUNDANT`状态。

* 正常

* 处于`REPLICA_MISSING`状态，但大多数副本仍然存在（例如，3个副本中的1个丢失）
* 处于`VERSION_INCOMPLETE`状态，但大多数副本都有完整的版本
* 处于`REPLICA_RELOCATING`状态，大多数副本需要重新定位（例如，3个副本中的2个）

* 低

* 处于`REPLICA_MISSING_IN_CLUSTER`状态
* 处于`REPLICA_RELOCATING`状态，但大多数副本是稳定的

### 手动确定优先级

系统将自动确定调度优先级。但是，有时用户希望更快地修复某些平板电脑。因此，我们提供了一个命令，用户可以在其中指定要首先修复的某个表或分区的平板电脑。

ADMIN REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

此命令告诉TC首先处理有问题的平板电脑，以便可以首先修复它。

> 注意：此命令不能保证成功修复，优先级将随着TS的调度而变化。当主FE被更改或重新启动时，此信息将丢失。

可以使用以下命令取消优先级。

ADMIN CANCEL REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

### 优先级调度

优先级确保严重损坏的平板电脑首先得到修复。但是，如果高优先级的修复任务一直失败，将导致低优先级的任务仍然未被安排。因此，我们根据每个任务的状态动态调整优先级，以确保所有任务都有机会被安排。

* 如果连续 5 次调度失败（例如，无法获取资源、无法找到合适的源或目标等），则任务将被降低优先级。
* 如果任务在 30 分钟内未被安排，则该任务将被提高优先级。
* 任务的优先级在五分钟内不能调整两次。

为了确保初始优先级水平加权，`VERY_HIGH` 任务最多只能被降低到 `NORMAL`，而 `LOW` 任务最多只能被提升到 `HIGH`。优先级调整也适用于用户手动设置的任务优先级。

## 副本平衡

StarRocks 会自动在集群内执行副本平衡。平衡的主要思想是在负载较低的节点上创建副本，在负载较高的节点上删除副本。同一集群内的不同 BE 节点上可能存在多个存储介质。为了在平衡后将平板电脑保留在原始存储介质中，BE 节点根据存储介质进行划分，从而可以明智地安排负载均衡。

同样，副本平衡确保同一平板电脑的副本不会部署在同一主机的 BE 上。

### BE 节点负载

ClusterLoadStatistics（CLS）显示集群中每个后端的负载均衡情况，并触发 TabletScheduler 来均衡集群。目前，我们使用`**磁盘利用率**`和`**副本数量**`来计算每个 BE 的`loadScore`。分数越高，BE 的负载越重。

`capacityCoefficient` 和 `replicaNumCoefficient`（总和为 1）分别是`磁盘利用率`和`副本数量`的加权因子。根据`capacityCoefficient`实际磁盘使用情况动态调整。当 BE 的整体磁盘利用率低于 50% 时，该`capacityCoefficient`值为 0.5。当磁盘利用率高于 75%（可通过 FE 配置项`capacity_used_percent_high_water`配置），该值为 1。如果利用率介于 50% 和 75% 之间，则根据以下公式，权重因子会平滑增加：

`capacityCoefficient= 2 * 磁盘利用率 - 0.5`

这个加权系数保证了当磁盘使用率过高时，这个后端的负载分数会更高，迫使这个 BE 尽快减少负载。

TabletScheduler 每 1 分钟更新一次 CLS。

### 平衡策略

TabletScheduler 在每轮调度中选择一定数量的健康平板电脑作为通过 LoadBalancer 进行平衡的候选，并根据这些候选切片调整未来的调度。

## 资源控制

副本修复和平衡都是通过跨 BE 复制来完成的。在同一 BE 上同时执行的任务过多会导致 IO 压力增加。因此，StarRocks 在调度时控制着每个节点上可以执行的任务数量。资源控制的最小单位是磁盘（即在`be.conf`中指定的数据路径）。默认情况下，为每个磁盘分配两个插槽用于复制副本修复。克隆任务在源端占用一个槽位，在目标端占用一个槽位。如果磁盘的插槽为零，则不会再为其分配任务。这个插槽数量可以用 FE 参数`schedule_slot_num_per_path`来配置。

此外，默认情况下，为每个磁盘分配两个插槽用于副本平衡。目的是防止负载过重的节点被修复任务占用，无法通过平衡释放空间。

## 查看副本状态

副本状态**仅存在于 leader FE 节点中**。因此，需要通过直接连接到 leader FE 来执行以下命令。

### 查看副本状态

1. 全局状态检查
   通过`SHOW PROC '/statistic';`命令可以查看整个集群的副本状态。

   ```plaintext
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | DbId     | DbName                      | TableNum | PartitionNum | IndexNum | TabletNum | ReplicaNum | UnhealthyTabletNum | InconsistentTabletNum |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | 35153636 | default_cluster:DF_Newrisk  | 3        | 3            | 3        | 96        | 288        | 0                  | 0                     |
   | 48297972 | default_cluster:PaperData   | 0        | 0            | 0        | 0         | 0          | 0                  | 0                     |
   | 5909381  | default_cluster:UM_TEST     | 7        | 7            | 10       | 320       | 960        | 1                  | 0                     |
   | Total    | 240                         | 10       | 10           | 13       | 416       | 1248       | 1                  | 0                     |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   ```

   `UnhealthyTabletNum` 列显示相应数据库中有多少个不健康的平板电脑。`InconsistentTabletNum` 列显示相应数据库中有多少个平板电脑处于副本不一致状态。最后一行`Total`给出了整个集群的统计信息。通常`UnhealthyTabletNum`和`InconsistentTabletNum`应该为零。如果它们不为零，您可以进一步检查平板电脑的信息。如上图所示，`UM_TEST`数据库中有一台不健康的平板电脑，您可以使用以下命令查看它是哪个平板电脑。

   `SHOW PROC '/statistic/5909381';`  
   其中`5909381`是相应的 DbId。

   ```plaintext
   +------------------+---------------------+
   | UnhealthyTablets | InconsistentTablets |
   +------------------+---------------------+
   | [40467980]       | []                  |
   +------------------+---------------------+
   ```

   上面的结果显示了特定不健康平板电脑的 ID（40467980）。接下来，我们将描述如何检查特定平板电脑的每个副本的状态。

2. 表（分区）级别状态检查
   用户可以使用以下命令查看特定表或分区的副本状态，并可以通过 WHERE 语句过滤状态。例如，要查看`tbl1`中`p1`和`p2`的`NORMAL`副本的状态。

   `ADMIN SHOW REPLICA STATUS FROM tbl1 PARTITION (p1, p2) WHERE STATUS = "OK";`

   ```plaintext
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | TabletId | ReplicaId | BackendId | Version | LastFailedVersion | LastSuccessVersion | CommittedVersion | SchemaHash | VersionNum | IsBad | State  | Status |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | 29502429 | 29502432  | 10006     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 36885996  | 10002     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 48100551  | 10007     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 29502434  | 10001     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 44900737  | 10004     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 48369135  | 10006     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   ```

   如果`IsBad = true`，表示副本已损坏。`Status`列显示额外信息。
   `ADMIN SHOW REPLICA STATUS`命令主要用于查看副本的健康状态。用户还可以使用以下命令查看其他信息。

   `SHOW TABLET FROM tbl1;`

   ```plaintext
   +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    | 平板电脑ID | 副本ID | 后端ID | 模式哈希 | 版本 | 版本哈希 | 最后成功版本 | 最后成功版本哈希 | 最后失败版本 | 最后失败版本哈希 | 最后失败时间 | 数据大小 | 行数 | 状态  | 最后一致性检查时间 | 检查版本 |     检查版本哈希 | 版本计数 | 路径哈希             | 元数据URL              | 压实状态     |
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    | 29502429 | 29502432  | 10006     | 1421156361 | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | 784      | 0        | 正常 | N/A                     | -1           |     -1               | 2            | -5822326203532286804 | url                  | url                  |
    | 29502429 | 36885996  | 10002     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | 正常 | N/A                     | -1           |     -1               | 2            | -1441285706148429853 | url                  | url                  |
    | 29502429 | 48100551  | 10007     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | 正常 | N/A                     | -1           |     -1               | 2            | -4784691547051455525 | url                  | url                  |
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    ```

其他信息包括副本大小、行数、版本数、数据路径等。

> 注意：`State` 列不表示副本本身的健康状态，而是表示副本在某些任务（例如 `CLONE`、`SCHEMA_CHANGE`、`ROLLUP` 等）下的状态。

此外，用户可以使用以下命令检查副本是否均匀分布：`ADMIN SHOW REPLICA DISTRIBUTION FROM tbl1;`

  ```plaintext
  +-----------+------------+-------+---------+
  | 后端ID | 副本数 | 图形 | 百分比 |
  +-----------+------------+-------+---------+
  | 10000     | 7          |       | 7.29 %  |
  | 10001     | 9          |       | 9.38 %  |
  | 10002     | 7          |       | 7.29 %  |
  | 10003     | 7          |       | 7.29 %  |
  | 10004     | 9          |       | 9.38 %  |
  | 10005     | 11         | >     | 11.46 % |
  | 10006     | 18         | >     | 18.75 % |
  | 10007     | 15         | >     | 15.62 % |
  | 10008     | 13         | >     | 13.54 % |
  +-----------+------------+-------+---------+
  ```

信息包括每个后端节点上的副本数量、百分比，上面显示了简单的图形显示。

平板电脑级别状态检查  

用户可以使用以下命令检查特定平板电脑的状态。例如，要检查 ID 为 29502553 的平板电脑的状态，请使用以下命令：`SHOW TABLET 29502553;`

  ```plaintext
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  | 数据库名                 | 表名 | 分区名 | 索引名 | 数据库ID     | 表ID  | 分区ID | 索引ID  | 是否同步 | 详细命令                                                                 |
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  | default_cluster:test   | test      | test          | test      | 29502391 | 29502428 | 29502427    | 29502428 | true   | SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553'; |
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  ```

上面显示了与平板电脑对应的数据库、表、分区、索引等信息。用户可以复制 `DetailCmd` 中的命令以查看详细信息。
    `SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553';`

  ```plaintext
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  | 副本ID | 后端ID | 版本 | 版本哈希 | 最后成功版本 | 最后成功版本哈希 | 最后失败版本 | 最后失败版本哈希 | 最后失败时间 | 模式哈希 | 数据大小 | 行数 | 状态  | 是否有问题 | 版本计数 | 路径哈希             | 元数据URL  | 压实状态 |
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  | 43734060  | 10004     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | 正常 | false | 2            | -8566523878520798656 | url      | url              |
  | 29502555  | 10002     | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | 正常 | false | 2            | 1885826196444191611  | url      | url              |
  | 39279319  | 10007     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | 正常 | false | 2            | 1656508631294397870  | url      | url              |
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  ```

上面显示了相应平板电脑的所有副本。此处显示的内容与 `SHOW TABLET FROM tbl1;` 相同。但在这里，您可以清楚地看到特定平板电脑的所有副本的状态。

### 为副本安排任务

1. 使用 `SHOW PROC '/cluster_balance/pending_tablets';` 命令查看等待安排的任务。

     ```plaintext
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     | 平板电脑ID | 类型   | 状态          | 状态   | 初始优先级 | 动态优先级 | 源BE | 源路径 | 目的BE | 目的路径 | 超时 | 创建时间              | 最后安排时间            | 最后访问时间            | 完成时间 | 速率 | 失败安排次数 | 失败运行次数 | 最后调整优先级          | 可见版本 | 可见版本哈希      | 提交版本 | 提交版本哈希          | 错误消息                        |
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     | 4203036  | 修复 | 缺少副本 | 待定 | 高     | 低      | -1    | -1      | -1     | -1       | 0       | 2019-02-21 15:00:20 | 2019-02-24 11:18:41 | 2019-02-24 11:18:41 | N/A      | N/A  | 2           | 0             | 2019-02-21 15:00:43 | 1          | 0                   | 2      | 0                   | 无法找到源副本 |
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     ```

      |   字段   | 描述   |
      |-----------|---------------|
      | 平板电脑ID  | 等待安排的平板电脑的ID。 |
      | 类型      | 任务类型，可以是 `修复` 或 `平衡`。 |
      |  状态   | 平板电脑的当前状态，例如 `缺少副本`。 |
      |  状态    |  此调度任务的状态。值：`待定`/`运行中`/`已完成`/`已取消`/`超时`/`意外`。 |
      | 初始优先级  | 初始优先级。 |
      | 动态优先级  | 动态优先级。 |
      | 源BE     | 源BE节点的ID。|
      | 源路径   |  源BE节点的路径。|
      |  目的BE   | 目的BE节点的ID。|
      | 目的路径  | 目的BE节点的路径。|
      | 超时   | 任务成功安排后，任务的超时时间以秒为单位显示在此处。|
      | 创建时间    | 任务创建时间。|
      | 最后安排时间  | 任务最后一次安排的时间。|
      | 最后访问时间   | 任务最后一次访问的时间。“访问”指的是调度、任务执行报告。|
      | 完成时间  | 任务完成时间。|
      | 速率   |克隆任务的数据复制速率|
      | 失败安排次数 |  任务安排失败的次数|
      | 失败运行次数| 任务执行失败的次数|
      | 最后调整优先级 | 任务优先级上次调整的时间 |

      | CmtVer/CmtVerHash/VisibleVer/VisibleVerHash| 用于执行克隆任务的版本信息 |
      | ErrMsg | 任务计划和运行时的错误消息 |

2. 使用 `SHOW PROC '/cluster_balance/running_tablets';` 查看正在运行的任务。
   这里使用相同的属性。有关详细信息，请参阅 `pending tablets` 。

3. 使用 `SHOW PROC '/cluster_balance/history_tablets';` 查看已完成的任务。
   默认情况下，我们只保留最后完成的 1000 个任务。这里使用相同的属性。有关详细信息，请参阅 `pending tablets` 。如果 `State` 是 `FINISHED`，则表示任务已正确完成。否则，请检查 `ErrMsg` 了解任务失败的原因。