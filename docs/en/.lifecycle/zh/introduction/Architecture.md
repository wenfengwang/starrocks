---
displayed_sidebar: English
---

# 架构

StarRocks 拥有简单的架构。整个系统仅由两种类型的组件构成：前端（FE）和后端（BE）或计算节点（CN）。StarRocks 不依赖任何外部组件，简化了部署和维护。节点可以水平扩展，无需服务停机。此外，StarRocks 还具有元数据和服务数据的副本机制，提高了数据可靠性，有效防止单点故障（SPOF）。

StarRocks 兼容 MySQL 协议并支持标准 SQL。用户可以轻松地从 MySQL 客户端连接到 StarRocks，以获得即时且有价值的洞察。

## 架构演进

随着 StarRocks 的不断发展，系统架构已经从原来的存储-计算耦合架构（无共享）过渡到存储-计算分离架构（共享数据）。

- 在 3.0 版本之前，StarRocks 使用存储-计算耦合架构。BE 负责数据存储和计算。数据访问和计算在本地节点上执行，以最大限度地减少数据移动并减少查询延迟，从而提供超快速的查询和分析体验。

- 从 3.0 版本开始，StarRocks 引入了存储-计算分离架构。数据存储与 BE 分离，BE 升级为无状态 CN 节点。数据持久存储在远程对象存储或 HDFS 中，而 CN 本地磁盘用于缓存热数据以加速查询。存储-计算分离架构支持动态添加和移除计算节点，实现按需扩展。

下图说明了架构的演进。

![Architecture evolution](../assets/architecture_evolution.png)

## 存储-计算耦合

作为一个典型的大规模并行处理（MPP）数据库，StarRocks 在 3.0 版本之前采用存储-计算耦合架构。在这个架构中，BE 同时负责数据存储和计算。直接访问 BE 上的本地数据允许进行本地计算，避免了数据传输和复制，从而提供了超快的查询和分析性能。该架构支持多副本数据存储，增强了集群处理高并发查询的能力，并确保了数据可靠性。它非常适合追求最佳查询性能的场景。

### 节点

在存储-计算耦合架构中，StarRocks 由两类节点组成：FE 和 BE。

- FE 负责元数据管理和构建执行计划。
- BE 执行查询计划并存储数据。BE 利用本地存储加速查询，并通过多副本机制确保数据高可用性。

### FE

FE 负责元数据管理、客户端连接管理、查询规划和查询调度。每个 FE 在其内存中存储并维护一份完整的元数据副本，这保证了 FE 之间的服务一致性。FE 可以作为领导者、追随者和观察者。追随者可以根据类似 Paxos 的 BDB JE 协议选举出领导者。BDB JE 是 Berkeley DB Java Edition 的缩写。

|**FE 角色**|**元数据管理**|**领导者选举**|
|---|---|---|
|领导者 FE|领导者 FE 读写元数据。追随者和观察者 FE 只能读取元数据。它们将元数据写入请求路由到领导者 FE。领导者 FE 更新元数据后，使用 BDB JE 将元数据更改同步到追随者和观察者 FE。数据写入只有在元数据更改同步到超过一半的追随者 FE 后才被视为成功。|领导者 FE 由追随者 FE 中选举产生。要进行领导者选举，集群中超过一半的追随者 FE 必须处于活动状态。当领导者 FE 失败时，追随者 FE 将启动新一轮的领导者选举。|
|追随者 FE|追随者只能读取元数据。它们同步并重放来自领导者 FE 的日志以更新元数据。|追随者参与领导者选举，要求集群中超过一半的追随者处于活跃状态。|
|观察者 FE|观察者同步并重放来自领导者 FE 的日志以更新元数据。|观察者主要用于提高集群的查询并发能力。观察者不参与领导者选举，因此不会给集群增加领导者选择的压力。|

### BE

BE 负责数据存储和 SQL 执行。

- 数据存储：BE 具有等同的数据存储能力。FE 根据预定义规则将数据分配给 BE。BE 转换摄入的数据，将数据写入所需格式，并为数据生成索引。

- SQL 执行：当 SQL 查询到达时，FE 根据查询的语义解析成逻辑执行计划，然后将逻辑计划转换为可在 BE 上执行的物理执行计划。存储目标数据的 BE 执行查询。这避免了数据传输和复制，从而实现了高查询性能。

### 数据管理

StarRocks 是一个面向列的数据库系统。它采用分区和分桶机制来管理数据。表中的数据首先被划分为多个分区，然后划分为多个分片。分片是 StarRocks 中数据管理的基本逻辑单元。每个分片可以有多个副本，分布在不同的 BE 上。您可以指定分片数量，由 StarRocks 负责分片管理。

分区和分片减少了表扫描并提高了查询并发性。副本有助于数据备份和恢复，防止数据丢失。

下图中，表根据时间分为四个分区。第一个分区中的数据进一步分为四个分片。每个分片有三个副本，分别存储在三个不同的 BE 上。

![Data management](../assets/data_manage.png)

由于一张表被拆分为多个分片，StarRocks 可以将一条 SQL 语句调度到所有分片上并行处理，充分利用多个物理机和核心的计算能力。这也有助于将查询压力分散到多个节点，提高服务可用性。您可以根据需要添加物理机来实现高并发。

分片的分布不受物理节点的限制。如果 BE 数量发生变化（例如添加或删除 BE），正在进行的服务可以继续进行，不会受到任何中断。节点变化将触发分片的自动迁移。如果添加 BE，一些分片将自动迁移到新的 BE 上，以实现更均匀的数据分布。如果 BE 被移除，这些 BE 上的分片将自动迁移到其他 BE 上，确保副本数量不变。自动分片迁移有助于轻松实现 StarRocks 集群的自动扩展，无需手动数据重新分配。

StarRocks 对分片使用多副本机制（默认为 3 个）。副本确保了数据的高可靠性和服务的高可用性。单个节点的故障不会影响整体服务的可用性。您还可以增加副本数量以提高查询并发性。

### 局限性

这种架构有其自身的局限性：

- 成本增长：用户必须同时扩展存储和计算，增加了不必要的存储成本。随着数据量的增长，对存储和计算资源的需求不成比例地增加，导致资源效率低下。
- 架构复杂：维护多副本之间的数据一致性增加了系统的复杂性，提高了故障风险。
- 弹性有限：扩缩操作会导致数据重新平衡，影响用户体验。

## 存储-计算分离

在新的存储-计算分离架构中，数据存储功能与 BE 解耦。BE，现在称为“计算节点（CN）”，仅负责数据计算，并且只缓存热数据。数据存储在低成本、可靠的远程存储系统中，例如 Amazon S3、GCP、Azure Blob Storage，以及其他 S3 兼容存储如 MinIO。当缓存命中时，查询性能可与存储-计算耦合架构相媲美。CN 节点可以在几秒钟内按需添加或删除。这种架构降低了存储成本，确保了更好的资源隔离，以及高弹性和可扩展性。

存储-计算分离架构保持了与存储-计算耦合架构一样的简单架构。它仅由两种类型的节点组成：FE 和 CN。唯一的区别是用户必须配置后端对象存储。

![shared-data-arch](../assets/architecture_shared_data.png)

### 节点

存储-计算分离架构中的 FE 提供与存储-计算耦合架构中相同的功能。

BE 的存储功能已分离。本地存储转变为共享存储。BE 节点升级为无状态 CN 节点，负责任务如数据加载、查询计算和缓存管理。

### 存储

目前，StarRocks 共享数据集群支持两种存储解决方案：对象存储（例如 AWS S3、Google GCS、Azure Blob Storage、MinIO）和部署在传统数据中心的 HDFS。这项技术统一了指定存储桶或 HDFS 目录中的数据存储。

在共享数据集群中，数据文件格式与存储-计算耦合集群（具有耦合存储和计算）保持一致。数据被组织成段文件，并在云原生表中重用了各种索引技术，这些表专门用于共享数据集群。

### 缓存

StarRocks 共享数据集群将数据存储和计算解耦，允许各自独立扩展，从而降低成本并增强弹性。但是，这种架构可能会影响查询性能。

为了缓解这一影响，StarRocks 建立了一个包括内存、本地磁盘和远程存储的多层数据访问系统，以更好地满足各种业务需求。

对热数据的查询直接扫描缓存，然后是本地磁盘，而冷数据需要从对象存储加载到本地缓存以加速后续查询。通过将热数据保持在计算单元附近，StarRocks 实现了真正的高性能计算和成本效益高的存储。此外，通过数据预取策略优化了对冷数据的访问，有效消除了查询性能的限制。

用户可以在创建表时决定是否启用缓存。如果启用缓存，数据将同时写入本地磁盘和后端对象存储。在查询过程中，CN 节点首先从本地磁盘读取数据。如果数据未找到，它将从后端对象存储检索并同时缓存在本地磁盘上。