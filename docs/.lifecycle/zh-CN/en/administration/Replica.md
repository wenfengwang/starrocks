---
displayed_sidebar: "Chinese"
---

# 复制品管理

## 术语

* Tablet: 表的逻辑切片，一张表有多个Tablet。
* Replica: Tablet的副本，默认情况下每个Tablet有3个副本。
* 正常的Replica: 一个Replica的后端是存活的，版本是完整的。
* TabletChecker (TC): 一个常驻的后台线程，周期性扫描所有Tablet，并根据它们的状态决定是否将Tablet发送到TabletScheduler。
* TabletScheduler (TS): 一个常驻的后台线程，处理TabletChecker发送的Tablet，并进行集群复制平衡。
* TabletSchedCtx (TSC): Tablet的封装类。当TC选择了一个Tablet，它会封装成TSC并发送给TS。
* 存储介质: StarRocks支持不同的存储介质进行分区粒度的存储，包括SSD和HDD。不同存储介质的副本调度也是不同的。

## 状态

### 副本状态

一个Replica的健康状态如下。

* **BAD**

Replica已损坏。这包括但不限于由磁盘故障、bug等导致的无法恢复的Replica损坏。

* **VERSION_MISSING**

每次导入数据对应一个版本。您应该在一个Replica中看到若干连续的版本。由于导入错误，一些Replica可能具有缺失版本。

* **HEALTHY**

Replica具有正确的数据，并且它所在的BE节点处于正常状态（正常心跳，没有处于正在被下线的过程中）。

### Tablet状态

一个Tablet的健康状态取决于其所有Replica的状态：

* **REPLICA_MISSING**

Replica缺失。也就是说，幸存的Replica数量少于期望的Replica数量。

* **VERSION_INCOMPLETE**

幸存的Replica数量大于或等于期望的数量，但是健康的Replica数量小于期望的数量。

* **REPLICA_RELOCATING**

幸存的具有完整版本的Replica数量等于`复制数`。但是一些Replica所在的BE节点不可用（例如，处于退役状态）。

* **REPLICA_MISSING_IN_CLUSTER**

当使用多个集群时，健康的Replica数量大于或等于期望的数量，但是相应集群内的Replica数量小于期望的数量。

* **REDUNDANT**

Replica冗余。所有健康的Replica都在相应的集群内，但是由于冗余不可用的Replica，总Replica数量大于期望的数量。

* **FORCE_REDUNDANT**

这是一种特殊状态。当期望的Replica数量大于或等于可用节点数量，并且Tablet处于Replica缺失状态时，首先需要删除一个Replica以确保有可用节点创建新的Replica。

* **COLOCATE_MISMATCH**

Colocation属性的Tablet状态，指示散列副本不符合Colocation组指定的分布。

* **COLOCATE_REDUNDANT**

Colocation属性的Tablet状态，指示Colocation表的Tablet副本是多余的。

* **HEALTHY**

健康的Tablet。

## Replica修复

TabletChecker周期性地检查所有Tablet的状态。不健康的Tablet会被交给TabletScheduler进行调度和修复。修复是在BE上作为克隆任务进行的。FE负责生成克隆任务。

> 注意1：Replica修复的主要思想是优先创建或修补新的Replica以达到期望值，然后删除多余的Replica。
> 注意2：克隆任务是从远程BE复制目标数据到目的地BE。

对于不同的状态，我们使用不同的方法进行修复。

1. REPLICA_MISSING/REPLICA_RELOCATING
   选择一个可用的BE节点作为目的地BE。选择一个健康的Replica作为源。克隆任务将从源复制完整的Replica到目的地BE。对于Replica补充，会选择一个可用的BE节点，无论存储介质如何。
2. VERSION_INCOMPLETE
   选择一个相对完整的Replica作为目的地。选择一个健康的Replica作为源。克隆任务将从源复制缺失的版本到目的地。
3. REPLICA_MISSING_IN_CLUSTER
   这种状态的处理方式与REPLICA_MISSING相同。
4. REDUNDANT
   通常在修复Replica后，Tablet会有多余的Replica。选择一个多余的Replica并将其删除。多余的Replica选择遵循以下顺序：

   * Replica所在的BE已经下线
   * Replica已损坏
   * Replica所在的BE已经断开连接或者处于正在被下线的过程中
   * Replica处于CLONE状态（在克隆任务执行期间的中间状态）
   * Replica缺失版本
   * Replica所在的集群不正确
   * Replica所在的BE节点负载较重

5. FORCE_REDUNDANT
   尽管Tablet缺少一个Replica，但没有可用节点创建新的Replica。在这种情况下，首先必须删除一个Replica来释放一个节点用来创建新的Replica。删除Replica的顺序与REDUNDANT相同。
6. COLOCATE_MISMATCH
   选择Colocation组指定的BE节点之一作为Replica补充的目的节点。
7. COLOCATE_REDUNDANT
   删除指定的Colocation组中未指定的BE节点上的Replica。

StarRocks不会在同一主机的不同BE上部署同一Tablet的Replica，这样即使同一主机的所有BE都失败了，仍然会有一些Replica是活动的。

## Replica调度

### 调度优先级

等待在TabletScheduler中调度的Tablet根据它们的状态分配不同的优先级。优先级较高的Tablet将首先被调度。优先级级别如下：

* VERY_HIGH

* 处于`REDUNDANT`状态的Tablet。有冗余Replica的Tablet被赋予非常高的优先级。尽管Replica冗余不是最迫切的，但是它的处理速度快，可以释放资源（例如磁盘空间）。
* 处于`FORCE_REDUNDANT`状态的Tablet。与上述状态相同。

* HIGH

* 处于`REPLICA_MISSING`状态，大部分Replica缺失（例如，3个Replica中有2个缺失）
* 处于`VERSION_INCOMPLETE`状态，大部分Replica的版本缺失
* 处于`COLOCATE_MISMATCH`状态。与Colocation表相关的Tablet将尽快被修复。
* 处于`COLOCATE_REDUNDANT`状态。

* NORMAL

* 处于`REPLICA_MISSING`状态，但是大部分Replica幸存（例如，3个Replica中有1个缺失）
* 处于`VERSION_INCOMPLETE`状态，但是大部分Replica有完整的版本
* 处于`REPLICA_RELOCATING`状态，且多数Replica需要重新定位（例如，3个副本中的2个需要重新定位）

* LOW

* 处于`REPLICA_MISSING_IN_CLUSTER`状态
* 处于`REPLICA_RELOCATING`状态，但是大部分Replica是稳定的

### 手动确定的优先级

系统将自动确定调度优先级。但是，有时用户希望某些Tablet更快地被修复。因此，我们提供了一条命令，用户可以指定某个表或分区的Tablet优先被修复。

ADMIN REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

这个命令告诉TC给存在问题的Tablet赋予`VERY_HIGH`优先级，以便它可以被优先修复。

> 注意：这个命令不能保证成功修复，并且优先级随着TS的调度而变化。当领导FE发生变化或重启时，这些信息将丢失。

采用以下命令可以取消优先级赋予。

ADMIN CANCEL REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

### 优先级调度

优先级保证了严重受损的Tablet被优先修复。但是，如果一个高优先级的修复任务一直失败，将导致低优先级的任务无法被调度。因此，我们根据每个任务的状态动态调整优先级，以确保所有任务都有被调度的机会。

* 如果5次连续调度失败（例如，无法获取资源，无法找到合适的源或目的地等），任务将被降低优先级。
* 如果一个任务已经有30分钟没有被调度，它将被提高优先级。
* 一个任务的优先级在5分钟内只能调整一次。

为了确保初始优先级水平加权，`VERY_HIGH`任务至多只能被调整为`NORMAL`，`LOW`任务至多只能被调整为`HIGH`。用户手动设置优先级的任务也遵循这一规则。

## Replica平衡

StarRocks会自动在集群内进行Replica平衡。平衡的主要思想是在负载较低的节点上创建Replica，并在负载较高的节点上删除Replica。在同一个集群的不同BE节点上可能存在多个存储介质。为了在平衡后保持Tablet在原始存储介质中，BE节点会根据存储介质进行划分，使负载平衡得以智能调度。

同样，Replica平衡也保证了不在同一主机的BE上部署同一Tablet的Replica。

### BE节点负载

`ClusterLoadStatistics` (CLS)显示了集群中每个后端的负载平衡，并触发`TabletScheduler`来平衡集群。目前，我们使用`**磁盘利用率**`和`**副本数量**`来计算每个BE的`负载分数`。分数越高，BE上的负载越重。

`capacityCoefficient`和`replicaNumCoefficient`（加总为1）分别是`磁盘利用率`和`副本数量`的权重系数。`capacityCoefficient`根据实际磁盘使用情况动态调整。当BE的整体磁盘利用率低于50%时，`capacityCoefficient`的值为0.5。当磁盘利用率超过75%（可通过FE配置项`capacity_used_percent_high_water`进行配置）时，该值为1。如果利用率在50%和75%之间，则权重系数根据以下公式平滑增加：

`capacityCoefficient = 2 * 磁盘利用率 - 0.5`

这个权重系数确保了当磁盘使用率过高时，该后端的负载分数将更高，迫使尽快减轻该BE的负载。

`TabletScheduler`将每分钟更新一次CLS。

### 平衡策略

`TabletScheduler`在每轮调度中通过`LoadBalancer`选择一定数量的健康Tablet作为平衡的候选，并根据这些候选片调整未来的调度。

## 资源控制

副本修复和平衡都是通过在BE之间进行复制来完成的。在同一BE上同时执行太多任务会导致IO压力增加。因此，StarRocks在调度过程中控制每个节点上可以执行的任务数量。资源控制的最小单位是磁盘（即在`be.conf`指定的数据路径）。默认情况下，为每个磁盘分配两个插槽用于副本修复。克隆任务在源和目的地各占用一个插槽。如果磁盘没有插槽，则不会分配更多任务。这个插槽数量可以通过FE的`schedule_slot_num_per_path`参数进行配置。

此外，默认情况下，为每个磁盘分配两个插槽用于副本平衡。目的是防止负载过重的节点被修复任务占用，并且无法通过平衡来释放空间。

## 查看副本状态

副本状态**仅存在于领导FE节点**。因此，需要直接连接到领导FE来执行以下命令。

### 查看副本状态

1. 全局状态检查  
   `SHOW PROC '/statistic';`命令允许您查看整个集群的副本状态。

   ```plaintext
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | DbId     | DbName                      | TableNum | PartitionNum | IndexNum | TabletNum | ReplicaNum | UnhealthyTabletNum | InconsistentTabletNum |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   | 35153636 | default_cluster:DF_Newrisk  | 3        | 3            | 3        | 96        | 288        | 0                  | 0                     |
   | 48297972 | default_cluster:PaperData   | 0        | 0            | 0        | 0         | 0          | 0                  | 0                     |
   | 5909381  | default_cluster:UM_TEST     | 7        | 7            | 10       | 320       | 960        | 1                  | 0                     |
   | Total    | 240                         | 10       | 10           | 13       | 416       | 1248       | 1                  | 0                     |
   +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
   ```

   `UnhealthyTabletNum`列显示了对应数据库中有多少个不健康的Tablet。`InconsistentTabletNum`列显示了对应数据库中有多少个处于副本不一致状态的Tablet。最后的`Total`行给出了整个集群的统计信息。通常`UnhealthyTabletNum`和`InconsistentTabletNum`应该为零。如果它们不为零，您可以进一步检查Tablet的信息。如上所示，`UM_TEST`数据库中有一个处于不健康状态的Tablet，然后您可以使用以下命令查看它是哪个Tablet。

   `SHOW PROC '/statistic/5909381';`  
   其中`5909381`是相应的DbId。

   ```plaintext
   +------------------+---------------------+
   | UnhealthyTablets | InconsistentTablets |
   +------------------+---------------------+
   | [40467980]       | []                  |
   +------------------+---------------------+
   ```

   上述结果显示了具体的不健康Tablet ID（40467980）。接下来，我们将描述如何检查特定Tablet的每个副本的状态。

2. 表（分区）级别状态检查  
   用户可以使用以下命令检查特定表或分区的副本状态，并且可以通过WHERE语句筛选状态。例如，要查看`tbl1`中`p1`和`p2`的NORMAL副本的状态。  
   `ADMIN SHOW REPLICA STATUS FROM tbl1 PARTITION (p1, p2) WHERE STATUS = "OK";`

   ```plaintext
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | TabletId | ReplicaId | BackendId | Version | LastFailedVersion | LastSuccessVersion | CommittedVersion | SchemaHash | VersionNum | IsBad | State  | Status |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   | 29502429 | 29502432  | 10006     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 36885996  | 10002     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502429 | 48100551  | 10007     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 29502434  | 10001     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 44900737  | 10004     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   | 29502433 | 48369135  | 10006     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
   +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
   ```

   如果`IsBad = true`，那意味着该副本已损坏。`Status`列显示了额外信息。  
   `ADMIN SHOW REPLICA STATUS`命令主要用于查看副本的健康状态。用户还可以使用以下命令查看额外信息。

   `SHOW TABLET FROM tbl1;`

   ```plaintext
   +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
   | TabletId | ReplicaId | BackendId | SchemaHash | Version | VersionHash | LstSuccessVersion | LstSuccessVersionHash | LstFailedVersion | LstFailedVersionHash | LstFailedTime | DataSize | RowCount | State  | LstConsistencyCheckTime | CheckVersion |     CheckVersionHash | VersionCount | PathHash             | MetaUrl              | CompactionStatus     |
   +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
   | 29502429 | 29502432  | 10006     | 1421156361 | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           |     -1               | 2            | -5822326203532286804 | url                  | url                  |
   | 29502429 | 36885996  | 10002     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           |     -1               | 2            | -1441285706148429853 | url                  | url                  |
   | 29502433 | 48369135  | 10006     | 1421156361 | 2      | 0            | -1                | 0                     | -1                | 0                     | N/A         | 784       | 0         | NORMAL | N/A                      | -1           | -1                   | 1196           | 387274364748044224  | url                  | url     |
   +----------+-----------+-----------+------------+----------+-----------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+------------+--------------------------+--------------+--------------------+--------------+----------------------+----------------------+-----------------------+
   ```


    | 29502429 | 48100551  | 10007     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           |     -1               | 2            | -4784691547051455525 | url                  | url                  |
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    ```

附加信息包括复制大小、行数、版本数、数据所在的位置等。

> 注意: `State` 列并不代表复制件本身的健康状态，而是代表在特定任务（例如 `CLONE`、`SCHEMA_CHANGE`、`ROLLUP` 等）下复制件的状态。

此外，用户可以通过以下命令检查复制件是否均匀分布  
`ADMIN SHOW REPLICA DISTRIBUTION FROM tbl1;`

  ```plaintext
  +-----------+------------+-------+---------+
  | BackendId | ReplicaNum | Graph | Percent |
  +-----------+------------+-------+---------+
  | 10000     | 7          |       | 7.29 %  |
  | 10001     | 9          |       | 9.38 %  |
  | 10002     | 7          |       | 7.29 %  |
  | 10003     | 7          |       | 7.29 %  |
  | 10004     | 9          |       | 9.38 %  |
  | 10005     | 11         | >     | 11.46 % |
  | 10006     | 18         | >     | 18.75 % |
  | 10007     | 15         | >     | 15.62 % |
  | 10008     | 13         | >     | 13.54 % |
  +-----------+------------+-------+---------+
  ```

信息包括每个 BE 节点上的复制件数量、百分比以及简单的图形显示如上所示。

Tablet 级别状态检查  

用户可以使用以下命令检查特定 Tablet 的状态。例如，要检查具有 ID 29502553 的 tablet 的状态。

`SHOW TABLET 29502553;`

  ```plaintext
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  | DbName                 | TableName | PartitionName | IndexName | DbId     | TableId  | PartitionId | IndexId  | IsSync | DetailCmd                                                                 |
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  | default_cluster:test   | test      | test          | test      | 29502391 | 29502428 | 29502427    | 29502428 | true   | SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553'; |
  +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
  ```

上面显示了与 tablet 对应的数据库、表、分区、索引等信息。用户可以复制 `DetailCmd` 中的命令以查看详细信息。
    `SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553';`

  ```plaintext
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  | ReplicaId | BackendId | Version | VersionHash | LstSuccessVersion | LstSuccessVersionHash | LstFailedVersion | LstFailedVersionHash | LstFailedTime | SchemaHash | DataSize | RowCount | State  | IsBad | VersionCount | PathHash             | MetaUrl  | CompactionStatus |
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  | 43734060  | 10004     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | -8566523878520798656 | url      | url              |
  | 29502555  | 10002     | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1885826196444191611  | url      | url              |
  | 39279319  | 10007     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1656508631294397870  | url      | url              |
  +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
  ```

上面显示了对应 Tablet 的所有复制件。此处显示的内容与 `SHOW TABLET FROM tbl1;` 相同。但在这里，您可以清楚地查看特定 Tablet 的所有复制件的状态。

### 为复制件安排任务

1. 使用 `SHOW PROC '/cluster_balance/pending_tablets';` 查看等待调度的任务。

     ```plaintext
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     | TabletId | Type   | Status          | State   | OrigPrio | DynmPrio | SrcBe | SrcPath | DestBe | DestPath | Timeout | Create              | LstSched            | LstVisit            | Finished | Rate | FailedSched | FailedRunning | LstAdjPrio          | VisibleVer | VisibleVerHash      | CmtVer | CmtVerHash          | ErrMsg                        |
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     | 4203036  | REPAIR | REPLICA_MISSING | PENDING | HIGH     | LOW      | -1    | -1      | -1     | -1       | 0       | 2019-02-21 15:00:20 | 2019-02-24 11:18:41 | 2019-02-24 11:18:41 | N/A      | N/A  | 2           | 0             | 2019-02-21 15:00:43 | 1          | 0                   | 2      | 0                   | unable to find source replica |
     +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
     ```

      |   字段   | 描述   |
      |-----------|---------------|
      | TabletId  | 正在等待调度的 tablet 的 ID。 |
      | Type      | 任务类型，可以是 REPAIR 或 BALANCE。 |
      |  Status   | Tablet 的当前状态，如 `REPLICA_MISSING`。 |
      |  State    | 此调度任务的状态。值：`PENDING`/`RUNNING`/`FINISHED`/`CANCELLED`/`TIMEOUT`/`UNEXPECTED`。 |
      | OrigPrio  | 初始优先级。 |
      | DynmPrio  | 动态优先级。 |
      | SrcBe     | 源 BE 节点的 ID。|
      | SrcPath   | 源 BE 节点的路径。|
      |  DestBe   | 目标 BE 节点的 ID。|
      | DestPath  | 目标 BE 节点的路径。|
      | Timeout   | 任务成功调度时，此处显示任务的超时时间（以秒为单位）。|
      | Create    | 任务创建时间。|
      | LstSched  | 上次调度任务的时间。|
      | LstVisit   | 上次访问任务的时间。“访问”指的是调度、任务执行报告的时间。|
      | Finished  | 任务完成时间。|
      | Rate   |克隆任务的数据复制速率|
      | FailedSched | 任务调度失败次数|

      | FailedRunning| 任务失败执行的次数|
      | LstAdjPrio | 任务优先级上次调整的时间|
      | CmtVer/CmtVerHash/VisibleVer/VisibleVerHash| 用于执行克隆任务的版本信息|
      | ErrMsg |任务调度和运行时的错误消息|

2. 使用 `SHOW PROC '/cluster_balance/running_tablets';` 查看运行中的任务。
   这里使用相同的属性。有关详细信息，请参阅`待处理的tablet`。

3. 使用 `SHOW PROC '/cluster_balance/history_tablets';` 查看已完成的任务。
   默认情况下，我们仅保留最后1000个已完成的任务。这里使用相同的属性。有关详细信息，请参阅`待处理的tablet`。如果`State`为`FINISHED`，则表示任务已正确完成。否则，请检查`ErrMsg`以了解任务失败的原因。