---
displayed_sidebar: "中文"
---

# 溢出到磁盘

本主题介绍如何将大型操作符的中间计算结果溢出到磁盘。

## 概述

对于依赖于内存计算进行查询执行的数据库系统（例如 StarRocks），在处理大型数据集上的聚合、排序和连接操作时，可能会消耗大量内存资源。当达到内存限制时，这些查询会因内存耗尽（OOM）而被强制终止。

然而，仍然存在一些你希望某些消耗大量内存的任务能够稳定完成，而且性能并非首要考虑因素的情况，例如构建物化视图或执行轻量级的 INSERT INTO SELECT 的 ETL。这些任务可能会轻松耗尽你的内存资源，从而阻塞集群中正在运行的其他查询。通常情况下，为了解决这个问题，你只能单独微调这些任务，并依赖于你的资源隔离策略来控制查询并发。这可能特别不方便，而且在某些极端情况下可能会失败。

从 StarRocks v3.0.1 开始，StarRocks 支持将一些消耗大量内存的操作符的中间结果溢出到磁盘。有了这个功能，你可以在性能出现可接受的下降的情况下，明显减少内存使用，从而提高系统的可用性。

目前，StarRocks 的溢出功能支持以下操作符：

- 聚合操作符
- 排序操作符
- 哈希连接（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN 和 INNER JOIN）操作符

## 启用中间结果溢出

请按照以下步骤启用中间结果溢出：

1. 在 BE 配置文件 **be.conf** 中指定存储溢出的中间结果的溢出目录 `spill_local_storage_dir`，并重新启动集群以使修改生效。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **说明**
   >
   > - 你可以使用分号（`;`）将多个 `spill_local_storage_dir` 分隔开，以指定多个目录。
   > - 在生产环境中，我们强烈建议你使用不同的磁盘用于数据存储和溢出。当中间结果溢出到磁盘时，写入负载和磁盘使用量可能会显著增加。如果使用相同的磁盘，这种激增可能会影响集群中运行的其他查询或任务。

2. 执行以下语句以启用中间结果溢出：

   ```SQL
   SET enable_spill = true;
   ```

3. 使用会话变量 `spill_mode` 配置中间结果溢出的模式：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **说明**
   >
   > 每当涉及溢出的查询完成时，StarRocks 会自动清除查询产生的溢出数据。如果 BE 在清除数据之前崩溃，StarRocks 会在 BE 重新启动时清除数据。

   | **变量**      | **默认值** | **说明**                                                     |
   | ------------ | ----------- | ------------------------------------------------------------ |
   | enable_spill | false       | 是否启用中间结果溢出。如果设置为 `true`，StarRocks 会将中间结果溢出到磁盘，以减少处理查询中的聚合、排序或连接操作时的内存使用。 |
   | spill_mode   | auto        | 中间结果溢出的执行模式。有效值：<ul><li>`auto`：当达到内存使用阈值时，会自动触发溢出。</li><li>`force`：StarRocks 强制对所有相关操作符执行溢出，无论内存使用情况。</li></ul>此变量仅在变量 `enable_spill` 设置为 `true` 时生效。 |

## 限制

- 并非所有的 OOM 问题都可以通过溢出解决。例如，StarRocks 无法释放用于表达式计算的内存。
- 通常情况下，涉及溢出的查询表明查询延迟增加了十倍。我们建议你通过设置会话变量 `query_timeout` 来为这些查询延长查询超时时间。