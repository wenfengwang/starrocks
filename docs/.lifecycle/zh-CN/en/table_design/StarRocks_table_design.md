---
displayed_sidebar: "English"
---

# 理解表设计

## 列存储

![列存储](../assets/3.1-1.png)

与其他关系型数据库一样，StarRocks中的表由行和列组成。每行保存用户数据的记录，每个列的数据类型相同。表中所有行都具有相同数量的列。您可以动态向表中添加列或删除列。表的列可以分为维度列和度量列。维度列也称为键列，度量列也称为值列。维度列中的值用于对数据进行分组和排序，度量列中的值可以通过诸如sum、count、min、max、hll_union_agg和bitmap_union等函数进行累积。

StarRocks使用列存储来存储表格的数据。从物理上讲，列中的数据被分隔成数据块，进行编码、压缩，然后持久存储在磁盘上。从逻辑上讲，列中的数据可以与包含相同数据类型元素的数组进行比较。行中保存的列值按其各自数组中的顺序列出作为元素。这意味着行中保存的列值具有相同的数组索引。数组索引是隐式的，不需要被存储。表中的所有行按照一个或多个维度列指定的顺序排序。在排序后的表中，行的位置由该行的序列号表示。

对于对表的查询，如果您在特定的维度列上指定相等或范围条件，这些条件可以构成维度列前缀，则StarRocks可以运行二进制搜索，快速定位感兴趣的数据行。例如，您想查询名为`table1`的表中的数据，并且该表由四个列组成：`event_day`、`siteid`、`citycode`和`username`，其中`event_day`和`siteid`是维度列。如果您指定`event_day = 2020-09-18`和`siteid = 2`作为查询条件，StarRocks可以运行二进制搜索，并且仅需要处理指定范围内的数据，因为`event_day`和`siteid`可以构成维度列前缀。如果您指定`citycode = 4`和`username = Andy`作为查询条件，则StarRocks无法运行二进制搜索，需要处理整个表的数据，因为citycode`和`username`无法构成维度列前缀。

## 索引

StarRocks使用前缀索引和列索引来快速定位感兴趣的数据块的起始行。

下图展示了StarRocks表设计如何加速对表中数据的查询。

![索引概览](../assets/3.1-2.png)

StarRocks中的表数据组织为以下三部分：

- 前缀索引

  StarRocks将每1024行的数据组成一个数据块，并在前缀索引表中维护一个条目。每个数据块的前缀索引条目的内容是由该数据块中起始行的维度列组成的前缀，并且长度不能超过36字节。前缀索引是一种稀疏索引。当您查询一行时，StarRocks搜索前缀索引表以检索由该行的维度列组成的前缀。然后，StarRocks可以快速定位数据块中由感兴趣的行占据的起始行的序号。

- 每列的数据块

  StarRocks将每个列的数据分隔成多个64KB的数据块。每个数据块都是独立编码和压缩的最小I/O单元，并且作为一个整体从磁盘中读取或写入。

- 每列的索引

  StarRocks为每列维护了行号索引。在行号索引表中，列的数据块逐个映射到该列所包含的行的序号上。此外，行号索引表中的每个条目由映射到特定行号的数据块的起始行号、地址和长度组成。当您查询一行时，StarRocks搜索行号索引表以检索映射到该行的序号的数据块的地址。然后，StarRocks读取数据块以定位行。

综上所述，StarRocks执行以下五个步骤来通过使用由该行的维度列组成的前缀来定位表中的一行：

1. 搜索前缀索引表以定位由感兴趣的行占据的数据块的起始行的序号。

2. 搜索每个维度列的行号索引表以定位维度列的数据块。

3. 读取数据块。

4. 解压和解码数据块。

5. 搜索数据块以定位维度列索引所映射到的行。

## 加速处理

本节介绍了帮助StarRocks以更高速度处理数据的机制。

### 预聚合

StarRocks提供聚合表。对于聚合表，表中具有相同值的行可以聚合成一行。为了生成从聚合中产生的新行，表中每个维度列中的值保持不变，每个度量列中的值通过您指定的聚合函数进行聚合，生成度量列中的新行的结果值。预聚合有助于加速聚合操作。

### 分区和桶

StarRocks中的每个表都被分成多个tablet。每个tablet在BE上被存储为多个副本。BE的数量和tablet的数量可以根据计算资源和数据大小的变化灵活扩展。当您发起查询时，多个BE可以并行搜索tablet，快速定位感兴趣的数据。此外，tablet副本可以被复制和迁移，这增加了数据的可靠性并防止了数据偏移。分区和桶有助于确保数据检索的效率和稳定性。

### 材化视图

表的前缀索引有助于加速对该表的查询，但是依赖于表的维度列的顺序。如果您通过使用未包含在维度列前缀中的维度列构造查询谓词，则前缀索引将不起作用。在这种情况下，您可以为表创建材化视图。材化视图的数据组织和存储方式与表的数据相同。然而，材化视图可以拥有自己的前缀索引。当您为材化视图创建前缀索引时，您可以指定适当的聚合粒度、列数和维度列顺序，以确保经常使用的查询条件可以命中材化视图前缀索引表中的期望条目。

### 每列索引

StarRocks支持Bloom过滤器、区域图和位图索引等每列索引：

- Bloom过滤器用于确定数据块是否包含您想要查询的值。

- 区域图用于定位指定范围内的值。

- 位图索引用于定位ENUM数据类型列中满足指定查询条件的行。