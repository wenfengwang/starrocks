---
displayed_sidebar: "Chinese"
---

# Unique Key table

当您创建表时，可以定义主键列和度量列。通过这种方式，查询会返回具有相同主键的一组记录中的最新记录。与重复键表相比，唯一键表简化了数据加载流程，以更好地支持实时和频繁的数据更新。

## 场景

唯一键表适用于需要实时频繁更新数据的业务场景。例如，在电子商务场景中，每天可能会产生数亿订单，订单状态经常变化。

## 原理

唯一键表可以被视为具有指定用于度量列的 REPLACE 聚合函数的特殊的聚合键表，以返回一组具有相同主键的记录中的最新记录。

当您将数据加载到使用唯一键表的表中时，数据被拆分为多个批次。每个批次被分配一个版本号。因此，具有相同主键的记录可能有多个版本，其中最新版本（即具有最大版本号的记录）将被用于查询。

如下表所示，`ID` 是主键列，`value` 是度量列，`_version` 存储在StarRocks内生成的数据版本号。在此示例中，具有 `ID` 为 1 的记录被加载了两个版本号分别为 `1` 和 `2` 的批次，`ID` 为 `2` 的记录被加载了三个版本号分别为 `3`, `4` 和 `5` 的批次。

| ID   | value | _version |
| ---- | ----- | -------- |
| 1    | 100   | 1        |
| 1    | 101   | 2        |
| 2    | 100   | 3        |
| 2    | 101   | 4        |
| 2    | 102   | 5        |

当您查询具有 `ID` 为 `1` 的记录时，将返回具有最大版本号的最新记录，即此处的 `2`。当您查询具有 `ID` 为 `2` 的记录时，将返回具有最大版本号的最新记录，即此处的 `5`。下表显示了这两次查询返回的记录：

| ID   | value |
| ---- | ----- |
| 1    | 101   |
| 2    | 102   |

## 创建表

在电子商务场景中，您通常需要按日期收集和分析订单的状态。在本示例中，创建名为 `orders` 的表来存储订单，定义经常用作过滤订单条件的 `create_time` 和 `order_id` 为主键列，并将另外两列 `order_state` 和 `total_price` 定义为度量列。通过这种方式，订单可以在其状态更改时进行实时更新，并且可以快速进行过滤以加速查询。

创建表的语句如下：

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "创建订单的时间",
    order_id BIGINT NOT NULL COMMENT "订单ID",
    order_state INT COMMENT "订单状态",
    total_price BIGINT COMMENT "订单价格"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注意**
>
> - 创建表时，必须使用 `DISTRIBUTED BY HASH` 子句指定分桶列。详细信息，请参见[分桶](../Data_distribution.md#design-partitioning-and-bucketing-rules)。
> - 从 v2.5.7 版本开始，StarRocks 在创建表或添加分区时可以自动设置分桶数（BUCKETS）。不再需要手动设置分桶数。详细信息，请参见[确定分桶数](../Data_distribution.md#determine-the-number-of-buckets)。

## 使用注意事项

- 请注意以下关于表的主键的重点：

  - 主键是通过使用 `UNIQUE KEY` 关键字来定义的。
  - 主键必须在强制执行唯一约束并且其名称不能更改的列上创建。
  - 主键必须合理设计：
    - 在运行查询时，主键列会在多个数据版本聚合之前进行过滤，而度量列会在多个数据版本聚合之后进行过滤。因此，我们建议您确定频繁用作过滤条件的列，并将这些列定义为主键列。这样，数据过滤可以在多个数据版本聚合之前开始，以改善查询性能。
    - 在聚合过程中，StarRocks会比较所有主键列。这需要耗费时间，并可能降低查询性能。因此，请不要定义大量的主键列。如果某列在查询中很少用作过滤条件，我们建议您不要将该列定义为主键列。

- 创建表时，不能在表的度量列上创建位图索引或布隆过滤器索引。

- 唯一键表不支持物化视图。

## 下一步操作

创建表后，您可以使用各种数据摄入方法将数据加载到StarRocks中。有关StarRocks支持的数据摄入方法的信息，请参见 [数据导入](../../loading/Loading_intro.md)。

> - 当您将数据加载到使用唯一键表的表中时，只能更新表的所有列。例如，当您更新上述的 `orders` 表时，必须更新其所有列，即 `create_time`、`order_id`、`order_state` 和 `total_price`。
> - 当您从使用唯一键表的表中查询数据时，StarRocks需要对多个数据版本的记录进行聚合。在这种情况下，大量的数据版本会降低查询性能。因此，我们建议您指定适当的数据加载频率以满足对实时数据分析的要求，同时防止大量数据版本的出现。如果您需要分钟级数据，可以指定 1 分钟的加载频率，而不是 1 秒。