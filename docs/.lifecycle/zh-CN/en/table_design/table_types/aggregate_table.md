---
displayed_sidebar: "Chinese"
---

# 聚合表

创建使用聚合表的表时，您可以定义排序键列和度量列，并且可以为度量列指定聚合函数。如果要加载的记录具有相同的排序键，则度量列将被聚合。聚合表有助于减少需要处理的查询数据量，从而加快查询速度。

## 场景

聚合表非常适用于数据统计和分析场景。以下是一些示例：

- 帮助网站或应用提供商分析其用户在特定网站或应用上的流量和停留时间以及对该网站或应用的总访问次数。

- 帮助广告代理商分析他们为客户提供的广告的总点击次数、总浏览次数和消费统计。

- 帮助电商公司分析其年度交易数据，以确定各个季度或月份内的地理畅销产品。

前述场景中的数据查询和摄入具有以下特点：

- 大多数查询为聚合查询，如SUM、MAX和MIN等。
- 不需要检索原始详细数据。
- 历史数据不经常更新，只会追加新数据。

## 原理

从数据摄入到数据查询，使用聚合表的表中具有相同排序键的数据将被多次聚合，具体如下：

1. 在数据摄入阶段，当数据作为批量加载到表中时，每个批次包含一个数据版本。生成数据版本后，StarRocks会聚合具有相同排序键的数据版本中的数据。
2. 在后台压缩阶段，定期将数据摄入生成的多个数据版本的文件压缩成一个大文件时，StarRocks会聚合大文件中具有相同排序键的数据。
3. 在数据查询阶段，StarRocks会在返回查询结果之前聚合所有数据版本中具有相同排序键的数据。

聚合操作有助于减少需要处理的数据量，从而加速查询。

假设您有一个使用聚合表的表，并且希望将以下四条原始记录加载到表中。

| 日期       | 国家   | PV   |
| ---------- | ------ | ---- |
| 2020.05.01 | 中国   | 1    |
| 2020.05.01 | 中国   | 2    |
| 2020.05.01 | 美国   | 3    |
| 2020.05.01 | 美国   | 4    |

StarRocks会在数据摄入时将这四条原始记录聚合成以下两条记录：

| 日期       | 国家   | PV   |
| ---------- | ------ | ---- |
| 2020.05.01 | 中国   | 3    |
| 2020.05.01 | 美国   | 7    |

## 创建表

假设您想要分析用户从不同城市访问不同网页的访问次数。在本示例中，创建一个名为`example_db.aggregate_tbl`的表，定义`site_id`、`date`和`city_code`为排序键列，定义`pv`为度量列，并为`pv`列指定SUM函数。

创建表的语句如下：

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "网站ID",
    date DATE NOT NULL COMMENT "事件时间",
    city_code VARCHAR(20) COMMENT "用户的城市代码",
    pv BIGINT SUM DEFAULT "0" COMMENT "总页面访问量"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **注意**
>
> - 创建表时必须使用`DISTRIBUTED BY HASH`子句指定分桶列。有关详细信息，请参见[分桶](../Data_distribution.md#design-partitioning-and-bucketing-rules)。
> - 自v2.5.7起，StarRocks可以在创建表或添加分区时自动设置分桶数（BUCKETS）。不再需要手动设置分桶数。有关详细信息，请参见[确定分桶数](../Data_distribution.md#determine-the-number-of-buckets)。

## 使用说明

- 关于表的排序键，请注意以下几点：
  - 您可以使用`AGGREGATE KEY`关键字明确定义排序键中使用的列。

    - 如果`AGGREGATE KEY`关键字中未包含所有维度列，则无法创建表。
    - 默认情况下，如果不使用`AGGREGATE KEY`关键字显式定义排序键列，则StarRocks会选择除度量列以外的所有列作为排序键列。

  - 排序键必须在强制执行唯一约束的列上创建。它必须由所有不可更改名称的维度列组成。

- 您可以在列名后面指定聚合函数来定义该列为度量列。在大多数情况下，度量列包含需要进行聚合和分析的数据。

- 有关聚合表支持的聚合函数的信息，请参见[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md)。

- 在运行查询时，排序键列会在多个数据版本聚合之前进行筛选，而度量列会在多个数据版本聚合之后进行筛选。因此，我们建议您识别频繁用作筛选条件的列，并将这些列定义为排序键。这样，数据筛选可以在多个数据版本聚合之前开始，以提高查询性能。

- 创建表时，不能在表的度量列上创建位图索引或布隆过滤器索引。

## 下一步操作

创建表后，可以使用各种数据摄入方法将数据加载到StarRocks中。有关StarRocks支持的数据摄入方法的信息，请参见[数据导入](../../loading/Loading_intro.md)。

> 注意：当从使用聚合表的表中加载数据时，只能更新表的所有列。例如，在更新上述的`example_db.aggregate_tbl`表时，必须更新所有列，即`site_id`、`date`、`city_code`和`pv`。