---
displayed_sidebar: Chinese
---

# AWS S3 をベースにしたデプロイメント

import SharedDataIntro from '../../assets/commonMarkdown/sharedDataIntro.md'
import SharedDataCNconf from '../../assets/commonMarkdown/sharedDataCNconf.md'
import SharedDataUseIntro from '../../assets/commonMarkdown/sharedDataUseIntro.md'
import SharedDataUse from '../../assets/commonMarkdown/sharedDataUse.md'

<SharedDataIntro />

## システムアーキテクチャ

![共有データアーキテクチャ](../../assets/share_data_arch.png)

## StarRocks ストレージとコンピューティングの分離クラスターをデプロイする

StarRocks のストレージとコンピューティングの分離クラスターのデプロイ方法は、ストレージとコンピューティングが統合されたクラスターのデプロイ方法と似ていますが、ストレージとコンピューティングの分離クラスターでは、BE ノードではなく CN ノードをデプロイする必要があります。このセクションでは、StarRocks のストレージとコンピューティングの分離クラスターをデプロイする際に、FE と CN の設定ファイル **fe.conf** と **cn.conf** に追加する必要がある追加の設定項目のみをリストしています。StarRocks クラスターのデプロイに関する詳細な説明については、[StarRocks のデプロイ](../deploy_manually.md)を参照してください。

> **注意**
>
> クラスターの設定が完了する前にクラスターを起動しないでください。

## ストレージとコンピューティングの分離デプロイメントのための FE 設定

### FE 設定例

異なる認証方法には異なる FE パラメーターが必要です。ビジネスニーズに応じて、以下の各セクションの例を参考にしてください。

クラスターを作成した後にデフォルトのストレージボリュームを手動で作成する場合は、以下の設定項目のみを追加する必要があります：

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
enable_load_volume_from_conf = false
```

#### デフォルトの認証方法

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_aws_sdk_default_behavior = true
```

#### IAM User 認証方法

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

aws_s3_access_key = <access_key>
aws_s3_secret_key = <secret_key>
```

#### Instance Profile 認証方法

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
```

#### Assumed Role 認証方法

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>
```

#### 外部アカウント Assumed Role 認証

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>
aws_s3_external_id = <external_id>
```

### FE 設定説明

#### run_mode

StarRocks クラスターの実行モード。有効な値：

- `shared_data`：ストレージとコンピューティングの分離モードで StarRocks を実行します。
- `shared_nothing`（デフォルト）：ストレージとコンピューティングが統合されたモードで StarRocks を実行します。

> **説明**
>
> - StarRocks クラスターは、ストレージとコンピューティングの分離モードと統合モードを混在させてデプロイすることはできません。
> - クラスターのデプロイが完了した後に `run_mode` を変更しないでください。そうすると、クラスターを再起動できなくなります。ストレージとコンピューティングが統合されたクラスターから分離モードへの変更、またはその逆はサポートされていません。

#### cloud_native_meta_port

クラウドネイティブのメタデータサービスがリッスンするポート。

- デフォルト値：`6090`

#### enable_load_volume_from_conf

StarRocks が FE の設定ファイルに指定されたストレージ関連のプロパティを使用してデフォルトのストレージボリュームを作成することを許可するかどうか。バージョン 3.1.0 からサポートされています。有効な値：

- `true`（デフォルト）：新しいストレージとコンピューティングの分離クラスターを作成する際にこの項目を `true` に設定すると、StarRocks は FE の設定ファイルに指定されたストレージ関連のプロパティを使用して組み込みのストレージボリューム `builtin_storage_volume` を作成し、それをデフォルトのストレージボリュームとして設定します。ただし、ストレージ関連のプロパティを指定していない場合、StarRocks は起動できません。
- `false`：新しいストレージとコンピューティングの分離クラスターを作成する際にこの項目を `false` に設定すると、StarRocks は直接起動し、組み込みのストレージボリュームは作成されません。StarRocks でオブジェクトを作成する前に、手動でストレージボリュームを作成し、それをデフォルトのストレージボリュームとして設定する必要があります。詳細については、[デフォルトのストレージボリュームを作成する](#using-starrocks-storage-and-computing-separated-cluster)を参照してください。

> **注意**
>
> 既存のバージョン 3.0 のストレージとコンピューティングの分離クラスターをアップグレードする際には、この項目をデフォルトの設定 `true` のままにしておくことをお勧めします。この項目を `false` に変更すると、アップグレード前に作成されたデータベースとテーブルは読み取り専用になり、データをインポートすることができなくなります。

#### cloud_native_storage_type

使用するストレージタイプ。ストレージとコンピューティングの分離モードでは、StarRocks は HDFS、Azure Blob（バージョン 3.1.1 からサポート）、および S3 プロトコルと互換性のあるオブジェクトストレージ（AWS S3、Google GCP、Alibaba Cloud OSS、MinIO など）にデータを保存することをサポートしています。有効な値：

- `S3`（デフォルト値）
- `AZBLOB`
- `HDFS`

> **説明**
>
> - この項目を `S3` に設定する場合は、`aws_s3` をプレフィックスとする設定項目を追加する必要があります。
> - この項目を `AZBLOB` に設定する場合は、`azure_blob` をプレフィックスとする設定項目を追加する必要があります。
> - この項目を `HDFS` に設定する場合は、`cloud_native_hdfs_url` のみを指定する必要があります。

#### aws_s3_path

データを保存するための S3 ストレージパス。S3 バケット名とその下のサブパス（存在する場合）で構成されます。例：`testbucket/subpath`。

#### aws_s3_endpoint

S3 ストレージにアクセスするためのエンドポイント。例：`https://s3.us-west-2.amazonaws.com`。

#### aws_s3_region

アクセスする S3 ストレージのリージョン。例：`us-west-2`。

#### aws_s3_use_aws_sdk_default_behavior

AWS SDK のデフォルトの認証資格情報を使用するかどうか。有効な値：

- `true`
- `false`（デフォルト）

#### aws_s3_use_instance_profile

Instance Profile または Assumed Role を使用して S3 に安全にアクセスするかどうか。有効な値：

- `true`
- `false`（デフォルト）

IAM ユーザーの資格情報（Access Key と Secret Key）を使用して S3 にアクセスする場合は、この項目を `false` に設定し、`aws_s3_access_key` と `aws_s3_secret_key` を指定する必要があります。

Instance Profile を使用して S3 にアクセスする場合は、この項目を `true` に設定する必要があります。

Assumed Role を使用して S3 にアクセスする場合は、この項目を `true` に設定し、`aws_s3_iam_role_arn` を指定する必要があります。

外部 AWS アカウントを使用して Assumed Role で S3 にアクセスする場合は、`aws_s3_external_id` を追加で指定する必要があります。

#### aws_s3_access_key

S3 ストレージにアクセスするための Access Key。

#### aws_s3_secret_key

S3 ストレージにアクセスするための Secret Key。

#### aws_s3_iam_role_arn

S3 ストレージにアクセスする権限を持つ IAM Role の ARN。

#### aws_s3_external_id

外部 AWS アカウントを使用して S3 ストレージにアクセスするための外部 ID。

> **注意**
>
> ストレージとコンピューティングの分離クラスターを正常に作成した後、セキュリティ資格情報に関連する設定項目のみを変更することができます。元のストレージパスに関連する設定項目を変更した場合、それ以前に作成されたデータベースとテーブルは読み取り専用になり、データをインポートすることができなくなります。

## ストレージとコンピューティングの分離デプロイメントのための CN 設定

<SharedDataCNconf />

## StarRocks ストレージとコンピューティングの分離クラスターの使用

<SharedDataUseIntro />

以下の例では、IAM User 認証を使用して AWS S3 ストレージスペース `defaultbucket` にストレージボリューム `def_volume` を作成し、それをアクティブにしてデフォルトのストレージボリュームとして設定します：

```SQL
CREATE STORAGE VOLUME def_volume
TYPE = S3
LOCATIONS = ("s3://defaultbucket/test/")
PROPERTIES
(
    "enabled" = "true",
    "aws.s3.region" = "us-west-2",
    "aws.s3.endpoint" = "https://s3.us-west-2.amazonaws.com",
    "aws.s3.use_aws_sdk_default_behavior" = "false",
    "aws.s3.use_instance_profile" = "false",
    "aws.s3.access_key" = "xxxxxxxxxx",
    "aws.s3.secret_key" = "yyyyyyyyyy"
);

SET def_volume AS DEFAULT STORAGE VOLUME;
```

<SharedDataUse />
