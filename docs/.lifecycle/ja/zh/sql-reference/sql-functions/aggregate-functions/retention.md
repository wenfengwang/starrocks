---
displayed_sidebar: Chinese
---

# retention

## 機能

retention（留存関数）は、一定期間内のユーザー留存状況を計算するために使用されます。この関数は1から31の条件を受け取り、最初の条件からイベントが条件を満たしているかどうかを判断します。条件を満たしていれば1を出力し、満たしていなければ0を出力し、最終的に0と1の配列を返します。結果が1のデータを集計して、ユーザー留存率を計算します。

## 文法

```Haskell
retention(array)
```

## パラメータ説明

`array`：条件式のシリーズから成る配列で、型はARRAYです。配列内では最大31の条件を入力でき、複数の条件はコンマで区切ります。

## 戻り値の説明

0と1を含む配列を返します。配列内の0と1の数は、入力された条件の数と一致します。

配列の最初の条件から順に判断します：

- イベントが現在の条件を満たしていれば、1を出力します。

- イベントが現在の条件を満たしていなければ、現在の位置以降のすべての位置は0になります。

## 例

1. テーブル `test` を作成し、データを挿入します。

    ```SQL
    CREATE TABLE test(
        id TINYINT,
        action STRING,
        time DATETIME
    )
    ENGINE=olap
    DUPLICATE KEY(id)
    DISTRIBUTED BY HASH(id);

    INSERT INTO test VALUES 
    (1,'pv','2022-01-01 08:00:05'),
    (2,'pv','2022-01-01 10:20:08'),
    (1,'buy','2022-01-02 15:30:10'),
    (2,'pv','2022-01-02 17:30:05'),
    (3,'buy','2022-01-01 05:30:09'),
    (3,'buy','2022-01-02 08:10:15'),
    (4,'pv','2022-01-02 21:09:15'),
    (5,'pv','2022-01-01 22:10:53'),
    (5,'pv','2022-01-02 19:10:52'),
    (5,'buy','2022-01-02 20:00:50');
    ```

2. `test` テーブルのデータを照会します。

    ```Plain Text
    MySQL > select * from test order by id;
    +------+--------+---------------------+
    | id   | action | time                |
    +------+--------+---------------------+
    |    1 | pv     | 2022-01-01 08:00:05 |
    |    1 | buy    | 2022-01-02 15:30:10 |
    |    2 | pv     | 2022-01-01 10:20:08 |
    |    2 | pv     | 2022-01-02 17:30:05 |
    |    3 | buy    | 2022-01-01 05:30:09 |
    |    3 | buy    | 2022-01-02 08:10:15 |
    |    4 | pv     | 2022-01-02 21:09:15 |
    |    5 | pv     | 2022-01-01 22:10:53 |
    |    5 | pv     | 2022-01-02 19:10:52 |
    |    5 | buy    | 2022-01-02 20:00:50 |
    +------+--------+---------------------+
    10 rows in set (0.01 sec)
    ```

3. `retention` 関数を使用してユーザー留存率を計算します。

    例1：2022年1月1日に商品ページを閲覧（action='pv'）し、2022年1月2日に注文した（action='buy'）ユーザーの状況を計算します。

    ```Plain Text
    MySQL > select id, retention([action='pv' and to_date(time)='2022-01-01',
                                  action='buy' and to_date(time)='2022-01-02']) as retention 
    from test 
    group by id
    order by id;
    
    +------+-----------+
    | id   | retention |
    +------+-----------+
    |    1 | [1,1]     |
    |    2 | [1,0]     |
    |    3 | [0,0]     |
    |    4 | [0,0]     |
    |    5 | [1,1]     |
    +------+-----------+
    5 rows in set (0.01 sec)
    ```

    見ての通り：

    - ユーザー1とユーザー5は2日間で指定された条件を満たしているため、配列[1,1]を返します。

    - ユーザー2は2日目に指定された条件を満たしていないため、配列[1,0]を返します。

    - ユーザー3は2日目に指定された条件を満たしていたとしても、1日目に満たしていなかったため、配列[0,0]を返します。

    - ユーザー4は2日間で指定された条件を満たしていないため、配列[0,0]を返します。

    例2：2022年1月1日に商品ページを閲覧（action='pv'）し、2022年1月2日に注文した（action='buy'）ユーザーの比率を計算します。

    ```Plain Text
    MySQL > select sum(r[1]),sum(r[2])/sum(r[1])
    from (select id, retention([action='pv' and to_date(time)='2022-01-01',
                                action='buy' and to_date(time)='2022-01-02']) as r 
    from test 
    group by id 
    order by id) t;
    
    +-----------+---------------------------+
    | sum(r[1]) | (sum(r[2])) / (sum(r[1])) |
    +-----------+---------------------------+
    |         3 |        0.6666666666666666 |
    +-----------+---------------------------+
    1 row in set (0.02 sec)
    ```

    戻り値は2022年1月2日のユーザー留存率です。

## キーワード

retention、留存、留存率
