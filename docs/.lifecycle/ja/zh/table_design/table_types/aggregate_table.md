---
displayed_sidebar: Chinese
---

# 聚合モデル

テーブル作成時には、ソートキーと指標列を定義し、指標列に集約関数を指定することができます。複数のデータが同じソートキーを持つ場合、指標列は集約されます。分析統計とデータ集計において、聚合モデルはクエリ時に処理する必要のあるデータ量を減らし、クエリの効率を向上させることができます。

## 適用シナリオ

分析統計とデータ集計に適用されます。例えば：

- ウェブサイトやアプリのアクセス流量を分析し、ユーザーの総訪問時間や総訪問回数を統計します。

- 広告会社が広告主に提供する広告の総クリック数、総表示数、消費統計など。

- 電子商取引の年間取引データを分析し、特定の四半期や月における各種消費者グループのヒット商品を把握します。

これらのシナリオでは、データのクエリとインポートには以下の特徴があります：

- 主に集約型のクエリであり、SUM、MAX、MINなどのタイプのクエリが多いです。

- 原始データのクエリは必要ありません。

- 既存のデータの更新は頻繁ではなく、新しいデータの追加のみが行われます。

## 原理

データのインポートからクエリの段階まで、聚合モデル内で同一ソートキーのデータは複数回にわたって集約されます。集約の具体的なタイミングとメカニズムは以下の通りです：

1. データインポート段階：データがバッチで聚合モデルにインポートされると、各バッチのデータが一つのバージョンを形成します。一つのバージョン内で、同一ソートキーのデータは一度集約されます。

2. バックグラウンドファイルのマージ段階（Compaction）：データがバッチで複数回にわたって聚合モデルにインポートされると、複数のバージョンのファイルが生成されます。これらのファイルが定期的に一つの大きなバージョンのファイルにマージされる際、同一ソートキーのデータは再度集約されます。

3. クエリ段階：すべてのバージョンで同一ソートキーのデータが集約され、その後クエリ結果が返されます。

したがって、聚合モデル内でのデータの複数回の集約により、クエリ時に処理する必要のあるデータ量が減少し、クエリの効率が向上します。

例えば、以下のデータを聚合モデルにインポートする場合、ソートキーは Date、Country です：

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 1    |
| 2020.05.01 | CHN     | 2    |
| 2020.05.01 | USA     | 3    |
| 2020.05.01 | USA     | 4    |

聚合モデルでは、上記の4つのデータが2つのデータに集約されます。これにより、後続のクエリ処理時に処理するデータ量が大幅に削減されます。

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 3    |
| 2020.05.01 | USA     | 7    |

## テーブル作成

例えば、特定の期間に異なる都市からのユーザーが異なるウェブページにアクセスした総回数を分析する必要がある場合、ウェブページのアドレス `site_id`、日付 `date`、都市コード `city_code` をソートキーとし、訪問回数 `pv` を指標列として、指標列 `pv` に集約関数 SUM を指定します。

このビジネスシナリオでは、テーブル作成のSQL文は以下の通りです：

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "id of site",
    date DATE NOT NULL COMMENT "time of event",
    city_code VARCHAR(20) COMMENT "city_code of user",
    pv BIGINT SUM DEFAULT "0" COMMENT "total page views"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **注意**
>
> - テーブル作成時には `DISTRIBUTED BY HASH` 句を使用してバケットキーを指定する必要があります。バケットキーの詳細については、[バケット](../Data_distribution.md#分桶)を参照してください。
> - バージョン2.5.7以降、StarRocksはテーブル作成とパーティション追加時に自動的にバケット数（BUCKETS）を設定する機能をサポートしています。手動でバケット数を設定する必要はありません。詳細は[バケット数の決定](../Data_distribution.md#确定分桶数量)を参照してください。

## 使用説明

- ソートキーに関する説明：
  - テーブル作成文では、**ソートキーは他の列の前に定義する必要があります**。
  - ソートキーは `AGGREGATE KEY` を使用して明示的に定義することができます。

    > - `AGGREGATE KEY` がすべての次元列（指標列を除く列）を含んでいない場合、テーブル作成は失敗します。
    > - `AGGREGATE KEY` を使用してソートキーを明示的に定義しない場合、デフォルトでは指標列を除くすべての列がソートキーとなります。

  - ソートキーは一意性の制約を満たす必要があり、すべての次元列を含み、列の値は更新されません。

- 指標列：列名の後に集約関数を指定することで、その列を指標列として定義します。通常は集計統計が必要なデータです。

- 集約関数：指標列で使用される集約関数。聚合モデルがサポートする集約関数については、[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md)を参照してください。

- クエリ時には、ソートキーは複数バージョンの集約前にフィルタリングが可能ですが、指標列のフィルタリングは複数バージョンの集約後に行われます。そのため、頻繁に使用されるフィルタリングフィールドをソートキーとして設定し、集約前にデータをフィルタリングすることで、クエリのパフォーマンスを向上させることを推奨します。

- テーブル作成時には、指標列に対してBITMAP、Bloom Filterなどのインデックスを作成することはサポートされていません。

## 次のステップ

テーブル作成が完了したら、さまざまなインポートジョブを作成してデータをテーブルにインポートすることができます。具体的なインポート方法については、[インポート概要](../../loading/Loading_intro.md)を参照してください。

> インポート時には、すべてのフィールドを含むインポートのみがサポートされています。つまり、インポートタスクはテーブルのすべての列をカバーする必要があります。例えば、`site_id`、`date`、`city_code`、`pv` の4つの列です。
