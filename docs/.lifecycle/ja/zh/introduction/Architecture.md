---
displayed_sidebar: Chinese
---

# システムアーキテクチャ

StarRocksのアーキテクチャはシンプルで、システム全体の中核はFE（フロントエンド）、BE（バックエンド）、またはCN（コンピュートノード）の2つのプロセスのみです。これにより、デプロイとメンテナンスが容易になり、ノードはオンラインで水平にスケーリングでき、メタデータとビジネスデータの両方に冗長性のメカニズムがあり、システム全体がシングルポイントを持たないようになっています。StarRocksはMySQLプロトコルインターフェースを提供し、標準のSQL構文をサポートしています。ユーザーはMySQLクライアントを使用して、StarRocksのデータを簡単にクエリや分析することができます。

StarRocksの製品の進化に伴い、システムアーキテクチャも元の共有なし（shared-nothing）から共有データ（shared-data）へと進化しました。

- バージョン3.0以前は、共有なしのアーキテクチャを使用し、BEはデータのストレージと計算を同時に担当し、データのアクセスと分析はすべてローカルで行われ、高速なクエリ分析体験を提供していました。
- バージョン3.0からは、共有データのアーキテクチャが導入され、データのストレージ機能がBEから分離され、BEノードはステートレスのCNノードにアップグレードされました。データはリモートオブジェクトストレージまたはHDFSに永続的に保存され、CNのローカルディスクはクエリの高速化のためにホットデータのキャッシュにのみ使用されます。共有データのアーキテクチャでは、動的な計算ノードの追加と削除がサポートされ、秒単位のスケーリング能力が実現されます。

以下の図は、共有なしから共有データへのアーキテクチャの進化を示しています。

![進化](../assets/architecture_evolution.png)

## 共有なし

MPPデータベースの典型的な代表であるStarRocksは、3.0バージョン以前では共有なし（shared-nothing）のアーキテクチャを使用しており、BEはデータのストレージと計算を同時に担当しています。クエリ時には、BEのローカルデータに直接アクセスしてローカルで計算を行い、データの転送やコピーを回避することで、高速なクエリ分析パフォーマンスを実現しています。共有なしのアーキテクチャは、データの複数のコピーのストレージをサポートし、クラスタの高並行クエリ能力とデータの信頼性を向上させます。共有なしのアーキテクチャは、極速のクエリパフォーマンスを求めるシナリオに適しています。

### ノードの紹介

共有なしのアーキテクチャでは、StarRocksはFEとBEで構成されています。FEはメタデータの管理と実行計画の構築を担当し、BEは実際の実行とデータのストレージ管理を担当します。BEはローカルストレージを使用し、複数のコピーのメカニズムにより高可用性を保証します。

#### FE

FEはStarRocksのフロントエンドノードであり、メタデータの管理、クライアント接続の管理、クエリのプランニング、クエリのスケジューリングなどを担当します。各FEノードはメモリに完全なメタデータのコピーを保持しており、それにより各FEノードが同じサービスを提供できるようになっています。

FEには3つの役割があります：リーダーFE、フォロワーFE、オブザーバーFEです。それぞれの違いは以下の通りです。

| **FEの役割** | **メタデータの読み書き**                                               | **リーダー選出**                                          |
| --------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| リーダー          | リーダーFEはメタデータの読み書きサービスを提供し、フォロワーとオブザーバーは読み取り権限のみを持ち、書き込み権限はありません。フォロワーとオブザーバーはメタデータの書き込みリクエストをリーダーにルーティングし、リーダーがメタデータを更新した後、BDB JE（Berkeley DB Java Edition）を介してフォロワーとオブザーバーに同期します。フォロワーの半数以上が正常に同期するまで、メタデータの書き込みは成功と見なされません。 | フォロワーから自動的にリーダーを選出します。現在のリーダーノードが失敗した場合、フォロワーは新しい選挙を開始します。 |
| フォロワー        | 書き込み権限はなく、読み取り権限のみを持ちます。リーダーのメタデータログを再生してデータを非同期に同期します。 | フォロワーはリーダー選出に参加し、BDBJEプロトコルのようなPaxosのようなプロトコルを使用して自動的にリーダーを選出します。選出には、半数以上のフォロワーノードが生存している必要があります。 |
| オブザーバー        | フォロワーと同じです。                                                | オブザーバーはクエリの並行性を拡張するために使用され、オプションでデプロイされます。オブザーバーはリーダー選出に参加せず、クラスタのリーダー選出に負荷をかけません。 |

#### BE

BEはStarRocksのバックエンドノードであり、データのストレージとSQLの計算などを担当します。

- データのストレージに関しては、BEノードは完全に対等です。FEは一定の戦略に従ってデータを対応するBEノードに割り当て、BEはインポートデータを対応する形式に書き込んでストレージし、関連するインデックスを生成します。
- SQLの計算を実行する際には、まずSQL文を意味に従って論理実行単位に計画し、その後データの分布に応じて具体的な物理実行単位に分割します。物理実行単位は対応するBEノードで実行され、これによりローカル計算が実現され、データの転送やコピーを回避することで高速なクエリパフォーマンスが得られます。

### データ管理

StarRocksは列指向のストレージを使用し、パーティションとバケット分割メカニズムを使用してデータを管理します。テーブルは複数のパーティションに分割でき、パーティション内のデータは1つまたは複数の列に基づいてバケット分割され、データは複数のタブレットに分割されます。タブレットはStarRocksの最小のデータ管理単位です。各タブレットは異なるBEノードに複数のレプリカとして保存されます。ユーザーはタブレットの数とサイズを指定することができ、StarRocksは各タブレットのレプリカの分布情報を管理します。

以下の図は、StarRocksのデータの分割とタブレットの複数のレプリカのメカニズムを示しています。テーブルは日付に基づいて4つのパーティションに分割され、最初のパーティションは4つのタブレットにさらに分割されます。各タブレットは3つのレプリカを使用してバックアップされ、3つの異なるBEノードに分散して配置されます。

![データ管理](../assets/data_manage.png)

SQL文の実行時、StarRocksはすべてのタブレットを並行して処理することができ、複数のマシンやコアが提供する計算能力を最大限に活用することができます。ユーザーは高並行のリクエスト負荷を複数の物理ノードに分散させることで、システムの高並行性を拡張することもできます。

StarRocksはタブレットの複数のレプリカストレージ（デフォルトは3つ）をサポートしており、複数のレプリカはデータのストレージの高い信頼性とサービスの高い可用性を保証します。3つのレプリカの場合、1つのノードの障害はサービスの可用性に影響せず、クラスタの読み書きサービスは正常に継続されます。レプリカ数を増やすことは、システムの高並行クエリ能力を向上させるのにも役立ちます。

BEノードの数が変化する場合（スケーリングなど）、StarRocksはサービスの停止なしでノードの追加と削除を自動的に完了することができます。ノードの変更はタブレットの自動移動をトリガーします。ノードが増えると、一部のタブレットは自動的に新しいノードに均等にバランスされ、データがクラスタ内でより均等に分散されるようになります。ノードが減ると、オフラインになるマシン上のタブレットは自動的に他のノードに均等にバランスされ、データのレプリカ数が変わらないように自動的に保証されます。管理者はデータの再分散を手動で行う必要なく、簡単に弾力的なスケーリングを実現することができます。

共有なしのアーキテクチャの利点は、高速なクエリパフォーマンスですが、いくつかの制約も存在します：

- コストが高い：データの信頼性を確保するために3つのレプリカが必要です。ユーザーのデータストレージ量が増えるにつれて、ストレージリソースを拡張する必要があり、計算リソースの浪費につながります。
- 複雑なアーキテクチャ：共有なしのアーキテクチャでは、複数のデータレプリカの整合性を維持する必要があり、システムの複雑さが増します。
- 弾力性が不十分：共有なしモードでは、スケーリングの増減によりデータの再バランスが発生し、弾力性の体験が向上しません。

## 共有データ

StarRocksの共有データアーキテクチャは、既存の共有なしアーキテクチャに基づいて計算とストレージを分離します。共有データの新しいアーキテクチャでは、データはより信頼性の高い廉価なリモートオブジェクトストレージ（例：S3）またはHDFSに永続的に保存されます。CNのローカルディスクはクエリの高速化のためにホットデータのキャッシュにのみ使用されます。ローカルキャッシュがヒットする場合、共有データアーキテクチャは共有なしアーキテクチャと同じクエリパフォーマンスを実現することができます。共有データアーキテクチャでは、ユーザーは動的に計算ノードを追加および削除することができ、秒単位のスケーリングを実現することができます。共有データはデータのストレージコストとスケーリングコストを大幅に削減し、リソースの分離と計算リソースの弾力的なスケーリングを実現するのに役立ちます。

共有データアーキテクチャは、同様にシンプルなアーキテクチャを持ち、システム全体には引き続きFEとCNの2つのサービスプロセスしかありません。ユーザーが追加で提供する必要があるのは、バックエンドオブジェクトストレージだけです。

![画像](../assets/architecture_shared_data.png)

### ノードの紹介

共有データアーキテクチャでは、FEの機能は変わりません。BEのストレージ機能は分離され、ローカルストレージ（local storage）から共有ストレージ（shared storage）にアップグレードされます。BEノードはステートレスのCNノードにアップグレードされ、ホットデータのキャッシュのみを保持します。CNはデータのインポート、クエリの計算、キャッシュデータの管理などのタスクを実行します。

### ストレージ

現在、StarRocksの共有データアーキテクチャは、以下のようなバックエンドストレージオプションをサポートしており、ユーザーは必要に応じて自由に選択できます：

- AWS S3互換のオブジェクトストレージシステム（AWS S3、Google GCP、阿里云 OSS、腾讯云 COS、百度云 BOS、华为云 OBS、MinIOなどの主要なオブジェクトストレージシステムをサポート）
- Azure Blob Storage
- 伝統的なデータセンターに展開されたHDFS

データの形式に関しては、StarRocksの共有データファイルは共有なしと同じ形式を保持しており、さまざまなインデックス技術も共有データテーブルで同様に適用されます。異なるのは、データファイルのメタデータ（TabletMetaなど）がオブジェクトストレージに適応するために再設計されたことです。

### キャッシュ

共有データアーキテクチャのクエリパフォーマンスを向上させるために、StarRocksは階層化されたデータキャッシュシステムを構築しています。最もホットなデータはメモリにキャッシュされ、計算に最も近い位置にあり、次にホットなデータはローカルディスクにキャッシュされ、冷たいデータはオブジェクトストレージにあります。データはアクセス頻度に基づいて3つのストレージレベル間で自由に移動します。

クエリ時には、ホットなデータは通常キャッシュから直接ヒットし、冷たいデータはオブジェクトストレージから読み取り、ローカルディスクにフィルされて後続のアクセスを高速化します。StarRocksの共有データアーキテクチャは、メモリ、ローカルディスク、リモートストレージを使用して、多層のデータアクセスシステムを構築し、ユーザーはビジネス要件に応じてデータのホット/コールドルールを指定し、ホットデータを計算に近づけ、高性能な計算と低コストなストレージを実現することができます。

StarRocksの共有データアーキテクチャでは、テーブル作成時にキャッシュの有効化を決定することができます。有効にする場合、データの書き込み時にはローカルディスクとバックエンドオブジェクトストレージの両方に同期して書き込まれ、クエリ時にはCNノードがまずローカルディスクからデータを読み取ります。ヒットしない場合は、バックエンドオブジェクトストレージから元のデータを読み取り、同時にローカルディスクにキャッシュします。

また、キャッシュされていない冷たいデータに対しても、StarRocksはアクセスパターンに応じて最適化を行っており、データのプリフェッチ技術や並列スキャン技術などを使用してバックエンドオブジェクトストレージへのアクセス頻度を減らし、クエリパフォーマンスを向上させています。
