---
displayed_sidebar: Chinese
---
# クエリ関連の問題

## マテリアライズドビューの構築に失敗：メモリの割り当てに失敗しました

`be.conf`の`memory_limitation_per_thread_for_schema_change`を変更してください。

このパラメータは、単一のスキーマ変更タスクが使用できる最大メモリを表します。デフォルトのサイズは2Gです。変更後は、BEを再起動して設定を有効にする必要があります。

## StarRocksはクエリ結果をキャッシュしますか？

StarRocksは直接最終的なクエリ結果をキャッシュしません。2.5バージョン以降、StarRocksは多段階の集計クエリの最初の段階の集計結果をQuery Cacheにキャッシュし、後続のクエリで以前にキャッシュされた結果を再利用して計算を高速化します。Query CacheはBEのメモリを使用します。詳細については、[Query Cache](../using_starrocks/query_cache.md)を参照してください。
<!-- StarRocksは直接クエリ結果をキャッシュしません。代わりに、Page Cacheを使用して元のデータをページ単位でBEのメモリにキャッシュし、後続のクエリで同じページを使用することができます。2.4バージョン以降、Page Cacheはデフォルトで有効になっています。Page Cacheのサイズを制限するには、`be.conf`の`storage_page_cache_limit`を設定します。デフォルトでは、システムメモリの20％です。変更後は、BEを再起動して設定を有効にする必要があります。-->

## フィールドがNULLの場合、is null以外のすべての計算結果はfalseです

標準のSQLでは、nullと他の式の計算結果はどちらもnullです。

## [BIGINTの等値クエリで引用符を追加すると余分なデータが表示されます

```sql
select cust_id,idno 
from llyt_dev.dwd_mbr_custinfo_dd 
where Pt= ‘2021-06-30’ 
and cust_id = ‘20210129005809043707’ 
limit 10 offset 0;
```

```plain text
+---------------------+-----------------------------------------+
|   cust_id           |      idno                               |
+---------------------+-----------------------------------------+
|  20210129005809436  | yjdgjwsnfmdhjw294F93kmHCNMX39dw=        |
|  20210129005809436  | sdhnswjwijeifme3kmHCNMX39gfgrdw=        |
|  20210129005809436  | Tjoedk3js82nswndrf43X39hbggggbw=        |
|  20210129005809436  | denuwjaxh73e39592jwshbnjdi22ogw=        |
|  20210129005809436  | ckxwmsd2mei3nrunjrihj93dm3ijin2=        |
|  20210129005809436  | djm2emdi3mfi3mfu4jro2ji2ndimi3n=        |
+---------------------+-----------------------------------------+
```

```sql
select cust_id,idno 
from llyt_dev.dwd_mbr_custinfo_dd 
where Pt= ‘2021-06-30’ 
and cust_id = 20210129005809043707 
limit 10 offset 0;
```

```plain text
+---------------------+-----------------------------------------+
|   cust_id           |      idno                               |
+---------------------+-----------------------------------------+
|  20210189979989976  | xuywehuhfuhruehfurhghcfCNMX39dw=        |
+---------------------+-----------------------------------------+
```

**問題の説明**

BIGINT型を使用してWHERE句でクエリを実行する際に、引用符を追加すると関係のないデータが多く表示されます。

**解決策**

文字列とINTの比較は、DOUBLEにキャストされるとみなされます。INTを比較する場合は、引用符を付けないでください。引用符を付けると、インデックスがヒットしない問題が発生します。

## StarRocksにはdecode関数はありますか？

StarRocksはOracleのdecode関数をサポートしていませんが、StarRocksの構文はMySQLと互換性があり、case whenを使用することができます。

## StarRocksのプライマリキーのカバリングは即座に有効ですか？それともバックグラウンドでデータがマージされるまで待つ必要がありますか？

StarRocksのバックグラウンドマージはGoogleのMESAモデルを参考にしており、2つのコンパクションレベルがあり、バックグラウンドポリシーでマージがトリガーされます。マージが完了していない場合、クエリ実行時にマージが行われますが、読み取り結果には最新のバージョンのみが含まれ、[データのインポート後に最新バージョンのデータが読み取れない](https://www.starrocks.com/docs-cn/administration/faq.html#%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%85%A5%E5%90%8E%E3%81%AB%E6%9C%80%E6%96%B0%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%8C%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8C%E3%81%AA%E3%81%84)状況は発生しません。

## StarRocksはutf8mb4の文字を格納すると、切り捨てられたり文字化けしたりしますか？

MySQLの"utf8mb4"は標準の"UTF-8"です。StarRocksは完全に互換性があります。

## [スキーマ変更] alter table で「テーブルの状態が正常ではありません」と表示される

ALTER TABLEは非同期操作です。以前のALTER TABLE操作がまだ完了していない場合は、次のステートメントを使用してALTERの状態を確認できます。

```sql
show tablet from lineitem where State="ALTER"; 
```

実行時間はデータ量に依存しますが、通常は数分です。ALTERのプロセス中にデータのインポートを停止することをお勧めします。インポートはALTERの速度を低下させる可能性があります。

## [Hive外部テーブルのクエリの問題] Hive外部テーブルのクエリでパーティションの取得に失敗する

**問題の説明**

Hive外部テーブルのクエリを実行する際に、次のエラーメッセージが表示されます：`get partition detail failed: com.starrocks.common.DdlException: get hive partition meta data failed: java.net.UnknownHostException:hadooptest（具体的なhdfs-haの名前）`

**解決策**

`core-site.xml`と`hdfs-site.xml`ファイルを`fe/conf`と`be/conf`にコピーし、FEとBEを再起動してください。

**問題の原因**

設定ユニットのパーティションメタデータの取得に失敗しました。

## 大きなテーブルのクエリ結果が遅い、プレディケートプッシュダウンがない

複数の大きなテーブルを結合する場合、古いプランナーでは自動的にプレディケートプッシュダウンが行われないことがあります。例えば：

```sql
A JOIN B ON A.col1=B.col1 JOIN C on B.col1=C.col1 where A.col1='北京'，
```

次のように変更できます：

```sql
A JOIN B ON A.col1=B.col1 JOIN C on A.col1=C.col1 where A.col1='北京'，
```

または、より新しいバージョンにアップグレードし、CBO機能を有効にすると、このようなプレディケートプッシュダウン操作が行われ、クエリのパフォーマンスが最適化されます。

## クエリエラー：プランナーが長時間3000の残りタスク番号1を使用しています

**解決策**

`fe.gc`ログを確認して、この問題が複数の並行して実行されるフルGCによって引き起こされているかどうかを確認してください。

バックグラウンドモニタリングとログの初期判断によると、頻繁なGCが発生している場合は、次の2つの解決策を検討してください：

1. SQLクライアントが複数のFEに同時にアクセスして負荷分散を行うようにします。
2. `fe.conf`の`jvm8g`を16gに変更します（より大きなメモリでフルGCの影響を減らします）。変更後は、FEを再起動する必要があります。

## Aの基数が小さい場合、select B from tbl order by A limit 10のクエリ結果が毎回異なります

**解決策：**

`select B from tbl order by A,B limit 10`を使用すると、Bもソートされて結果が一貫性が保たれます。

**問題の原因**

上記のSQLでは、Aがソートされていることは保証されますが、クエリ結果のBの順序が一貫しているわけではありません。MySQLは単一のマシンデータベースであるため、この点を保証できますが、StarRocksは分散データベースであり、テーブルデータのストレージはシャーディングされています。Aのデータは複数のマシンに分散しており、複数のマシンからのクエリ結果の順序は異なる場合があります。そのため、Bの順序が毎回一貫しない可能性があります。

## select * と select の列の効率の差が大きい

select * と select の列の効率には大きな差があります。この場合、プロファイルを調査し、MERGEの詳細情報を確認する必要があります。

* ストレージレベルの集計にかかる時間が長いかどうかを確認してください。
* メトリック列が多く、数百万行の数百列を集計する必要があるかどうかを確認してください。

```plain text
MERGE:
    - aggr: 26s270ms
    - sort: 15s551ms
```

## ネストされた関数はDELETEでサポートされていません

現在、ネストされた関数（例：`DELETE from test_new WHERE to_days(now())-to_days(publish_time) >7;`）はサポートされていません。ここでの`to_days(now())`はネストされたものです。

## データベースに数百のテーブルがある場合、use databaseが非常に遅いです

クライアント接続時に`-A`オプションを追加してください。例：`mysql -uroot -h127.0.0.1 -P8867 -A`。`-A`を使用すると、データベース情報をプリフェッチしないため、データベースの切り替えが高速になります。

## BEとFEのログファイルが多すぎる場合、どのように処理しますか？

ログレベルとパラメータサイズを調整してください。詳細については、ログ関連のパラメータのデフォルト値と説明を参照してください：[パラメータの設定](../administration/FE_configuration.md)。

## レプリケーション数の変更に失敗しました：テーブルlineorderはコロケートテーブルであり、レプリケーション番号を変更できません

コロケートテーブルにはグループ（group）があります。1つのグループには複数のテーブルが含まれており、単一のテーブルのレプリケーション数を変更することはサポートされていません。すべてのテーブルの`group_with`プロパティを空に設定し、すべてのテーブルに`replication_num`を設定し、すべてのテーブルの`group_with`プロパティを元に戻してください。

## varcharを最大値に設定すると、ストレージに影響がありますか？

VARCHARは可変長のストレージです。ストレージはデータの実際の長さに依存します。異なるVARCHARの長さを指定しても、同じデータのクエリパフォーマンスへの影響は非常に小さいです。

## truncate tableが失敗し、create partititon timeoutのエラーが表示されます

現在、TRUNCATEは対応する空のパーティションを作成してからスワップします。大量のパーティション作成タスクが存在する場合、タイムアウトが発生し、コンパクション中に長時間ロックが保持され、テーブルの作成がロックを取得できなくなる場合があります。クラスタに大量のインポートがある場合は、`be.conf`の`tablet_map_shard_size=512`を設定して、ロックの競合を減らすことができます。パラメータを変更した後は、FEを再起動する必要があります。

## Hive外部テーブルのアクセスエラー：Failed to specify server's Kerberos principal name

`fe.conf`および`be.conf`の`hdfs-site.xml`に次の情報を追加してください。

```plain text
<property>
<name>dfs.namenode.kerberos.principal.pattern</name>
<value>*</value>
</property>
```

## 2021-10はStarRocksで有効な日付形式ですか？パーティションフィールドとして使用できますか？

2021-10は有効な日付形式ではありません。パーティションフィールドとして使用するためには、`2021-10-01`のように調整する必要があります。

## StarRocks on ESでElasticsearch外部テーブルを作成する際、関連する文字列の長さが256を超える場合、同じ列をクエリで検索できなくなります

Elasticsearchの動的マッピングを使用している場合、次のようなデータ型があります。

```json
          "k4": {
                "type": "text",
                "fields": {
                   "keyword": {
                      "type": "keyword",
                      "ignore_above": 256
                   }
                }
             }
```

StarRocksはこのクエリ文をキーワードデータ型に変換します。したがって、この列のデータが256を超える場合、クエリでその列を検索できなくなります。

解決策：このフィールドマッピングから次の部分を削除してください。

```json
            "fields": {
                   "keyword": {
                      "type": "keyword",
                      "ignore_above": 256
                   }
                }
```

これにより、テキストタイプが使用されるようになります。

## StarRocksのデータベースやテーブルのサイズ、ディスクリソースの割合を素早く統計する方法はありますか？

データベースやテーブルのストレージサイズを確認するには、[SHOW DATA](../sql-reference/sql-statements/data-manipulation/SHOW_DATA.md)コマンドを使用できます。

`SHOW DATA;`は現在のデータベース内のすべてのテーブルのデータ量とレプリケーション数を表示します。

`SHOW DATA FROM <db_name>.<table_name>;`は指定したデータベース内の特定のテーブルのデータ量、レプリケーション数、および統計行数を表示します。

```