---
displayed_sidebar: Chinese
---

# FE高可用クラスターのデプロイ

この文書では、StarRocksクラスターのFEノードの高可用性クラスターをデプロイする方法について説明します。

FEの高可用性クラスターはマスター-スレーブレプリケーションアーキテクチャを採用し、FEのシングルポイント障害を回避します。FEはPaxosに似たBerkeley DB Java Edition（BDBJE）プロトコルを使用してリーダー選出、ログレプリケーション、およびフェイルオーバーを完了します。FEクラスターでは、複数のインスタンスがFollowerとObserverの2つの役割に分けられます。前者はレプリケーションプロトコルの投票可能なメンバーであり、リーダー選出とログのコミットに参加し、通常は奇数（2n+1）であり、多数決（n+1）で確認し、少数派（n）の障害を許容します。後者は非投票メンバーであり、レプリケーションログの非同期サブスクリプションに使用され、Observerの状態はFollowerより遅れ、他のレプリケーションプロトコルのLearner役割に似ています。

FEクラスターはFollowerから自動的にLeaderノードを選出し、すべての状態変更操作はLeaderノードによって実行されます。最新の状態はLeader FEノードから読み取ることができます。状態変更操作は非Leaderノードから開始され、Leaderノードに転送されて実行されます。非LeaderノードはレプリケーションログのLSNに最新の変更操作を記録します。読み取り操作は非Leaderノードで直接実行できますが、非Leaderノードの状態が最新の変更操作のLSNに同期されるまで待つ必要があります。したがって、非Leaderノードの読み書き操作は順序一貫性を満たします。ObserverノードはFEクラスターの読み込み負荷能力を向上させることができ、時效性の要求が緩い非緊急ユーザーはObserverノードを読むことを選択できます。

> 注意
>
> * FEノード間の時計のずれは**5秒を超えてはいけません**。ノード間に大きな時差がある場合は、NTPプロトコルを使用して時刻を同期してください。
> * すべてのFEノードの`http_port`は同じでなければならず、したがって、1台のマシンで複数のFEノードを異なるポートでデプロイすることはできません。

## 新しいFEノードのダウンロードと設定

詳細な操作は[StarRocks FEノードの手動デプロイ](../deployment/deploy_manually.md)を参照してください。

## 新しいFEノードの追加

MySQLクライアントを使用して既存のFEノードに接続し、新しいFEノードの情報を追加します。これには、役割、IPアドレス、およびポートが含まれます。

* Follower FEノードを追加します。

```sql
ALTER SYSTEM ADD FOLLOWER "host:port";
```

* Observer FEノードを追加します。

```sql
ALTER SYSTEM ADD OBSERVER "host:port";
```

パラメータ：

* `host`：マシンのIPアドレス。マシンに複数のIPアドレスがある場合、この項目は`priority_networks`設定項目で指定されたユニークな通信IPアドレスです。
* `port`：`edit_log_port`設定項目で指定されたポートで、デフォルトは`9010`です。

セキュリティ上の理由から、StarRocksのFEノードとBEノードは通信のために1つのIPアドレスのみをリッスンします。マシンに複数のネットワークカードがある場合、StarRocksは自動的に正しいIPアドレスを見つけることができない場合があります。たとえば、`ifconfig`コマンドで`eth0`のIPアドレスが`192.168.1.1`、`docker0`のIPアドレスが`172.17.0.1`であることがわかった場合、`192.168.1.0/24`サブネットを設定して`eth0`を通信IPとして使用するように指定できます。ここでは[CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)表記法を使用してIPのサブネット範囲を指定し、すべてのBEおよびFEノードで同じ設定を使用できるようにします。

エラーが発生した場合は、コマンドを使用して該当するFEノードを削除できます。

* Follower FEノードを削除します。

```sql
ALTER SYSTEM DROP FOLLOWER "host:port";
```

* Observer FEノードを削除します。

```sql
ALTER SYSTEM DROP OBSERVER "host:port";
```

具体的な操作は[スケールアップ/ダウン](../administration/Scale_up_down.md)を参照してください。

## FEノードの接続

FEノードは互いに通信接続を確立する必要があり、リーダー選出、投票、ログのコミット、レプリケーションなどのレプリケーションプロトコル機能を実現できます。新しいFEノードが**初めて**既存のクラスターに追加され、起動されたとき、クラスター内の既存のノードの1つをヘルパーノードとして指定し、そのノードからクラスター内のすべてのFEノードの設定情報を取得して通信接続を確立する必要があります。したがって、新しいFEノードを初めて起動するときは、コマンドラインで`--helper`パラメータを指定する必要があります。

```shell
./bin/start_fe.sh --helper host:port --daemon
```

パラメータ：

* `host`：マシンのIPアドレス。マシンに複数のIPアドレスがある場合、この項目は`priority_networks`設定項目で指定されたユニークな通信IPアドレスです。
* `port`：`edit_log_port`設定項目で指定されたポートで、デフォルトは`9010`です。

## FEクラスターのデプロイが成功したことを確認

クラスターの状態を確認し、デプロイが成功したことを確認します。

```sql
SHOW PROC '/frontends'\G
```

以下の例では、`172.26.108.172_9010_1584965098874`がリーダーFEノードです。

```Plain Text
mysql> SHOW PROC '/frontends'\G

********************* 1. row **********************
    Name: 172.26.108.172_9010_1584965098874
      IP: 172.26.108.172
HostName: starrocks-sandbox01
......
    Role: LEADER
......
   Alive: true
......
********************* 2. row **********************
    Name: 172.26.108.174_9010_1584965098874
      IP: 172.26.108.174
HostName: starrocks-sandbox02
......
    Role: FOLLOWER
......
   Alive: true
......
********************* 3. row **********************
    Name: 172.26.108.175_9010_1584965098874
      IP: 172.26.108.175
HostName: starrocks-sandbox03
......
    Role: FOLLOWER
......
   Alive: true
......
3 rows in set (0.05 sec)
```

ノードの`Alive`項目が`true`の場合、ノードの追加に成功しています。
