---
displayed_sidebar: Chinese
---

# 大規模クエリの監視と管理

この文書では、StarRocks クラスター内の大規模クエリを監視し、管理する方法について説明します。

大規模クエリには、大量のデータをスキャンするか、多くの CPU とメモリリソースを消費するクエリが含まれます。制限を設けない場合、大規模クエリは簡単にクラスタリソースを使い果たし、システムの過負荷を引き起こす可能性があります。この問題を解決するために、StarRocks は大規模クエリを監視し、管理するための一連の措置を提供し、大規模クエリがクラスタリソースを独占するのを防ぎます。

StarRocks の大規模クエリを処理するための全体的なアプローチは以下の通りです：

1. リソースグループとクエリキューを使用して、大規模クエリに対する自動的な予防措置を設定します。
2. 大規模クエリをリアルタイムで監視し、予防措置を回避する大規模クエリをタイムリーに終了させます。
3. 監査ログと大規模クエリログを分析し、大規模クエリのパターンを研究し、以前に設定した予防メカニズムのパラメータを最適化します。

この機能はバージョン 3.0 からサポートされています。

## 大規模クエリの防御メカニズムの設定

StarRocks は、大規模クエリを処理するための2つの予防ツール、リソースグループとクエリキューを提供しています。リソースグループを使用して大規模クエリをフィルタリングし、シャットダウンすることができます。一方、クエリキューは、システムが並行しきい値またはリソース制限に達したときに新しいクエリリクエストをキューに入れるのに役立ち、システムの過負荷を防ぎます。

### リソースグループを通じて大規模クエリを除外する

リソースグループは、大規模クエリを自動的に識別し、終了させることができます。リソースグループを作成する際には、個々のクエリが使用できる CPU 時間、メモリ使用量、またはスキャン行数の上限を指定できます。リソースグループにヒットしたすべてのクエリの中で、より多くのリソースを要求するクエリは実行を拒否され、エラーが返されます。詳細については、[リソース隔離](../administration/resource_group.md)を参照してください。

リソースグループを作成する前に、以下のステートメントを実行して、リソースグループ機能が依存する Pipeline エンジン機能を有効にします：

```SQL
SET GLOBAL enable_pipeline_engine = true;
```

以下の例では、`bigQuery` という名前のリソースグループを作成し、CPU 時間の上限を `100` 秒、スキャン行数の上限を `100000` 行、メモリ使用量の上限を `1073741824` バイト（1 GB）に制限しています：

```SQL
CREATE RESOURCE GROUP bigQuery
TO 
    (db='sr_hub')
WITH (
    'cpu_core_limit' = '10',
    'mem_limit' = '20%',
    'big_query_cpu_second_limit' = '100',
    'big_query_scan_rows_limit' = '100000',
    'big_query_mem_limit' = '1073741824'
);
```

クエリが上記のいずれかの制限を超える必要がある場合、StarRocks はそのクエリを実行せず、エラーを返します。以下の例は、クエリがスキャン行数の制限を超えた場合に返されるエラーメッセージを示しています：

```Plain
ERROR 1064 (HY000): exceed big query scan_rows limit: current is 4 but limit is 1
```

これがリソースグループを設定する初めての場合は、通常のクエリを妨げないように、比較的高い制限を設定することをお勧めします。クラスタ内の大規模クエリのパターンをよりよく理解した後で、これらの制限をさらに最適化することができます。

### クエリキューを通じてシステムの過負荷を緩和する

クエリキューは、クラスタリソースの使用が予定されたしきい値を超えた場合に、システムの過負荷が悪化するのを防ぐために使用されます。最大並行数、メモリ使用率、および CPU 使用率のしきい値を設定できます。システムリソースの使用がこれらのしきい値のいずれかに達すると、StarRocks は自動的に新しいクエリをキューに入れます。処理待ちのクエリはキューで実行を待つか、リソースのしきい値に達した場合にキャンセルされます。詳細については、[クエリキュー](../administration/query_queues.md)を参照してください。

以下のステートメントを実行して、SELECT クエリに対するクエリキュー機能を有効にします：

```SQL
SET GLOBAL enable_query_queue_select = true;
```

クエリキュー機能を有効にした後、クエリキューをトリガーするルールを定義できます。

- クエリキューをトリガーするクエリの並行しきい値を指定します。

  以下の例では、並行しきい値を `100` に設定しています：

  ```SQL
  SET GLOBAL query_queue_concurrency_limit = 100;
  ```

- クエリキューをトリガーするメモリ使用率のしきい値を指定します。

  以下の例では、メモリ使用率のしきい値を `0.9` に設定しています：

  ```SQL
  SET GLOBAL query_queue_mem_used_pct_limit = 0.9;
  ```

- クエリキューをトリガーする CPU 使用率のしきい値を指定します。

  以下の例では、CPU 使用率の千分率（CPU 使用率 * 1000）のしきい値を `800` に設定しています：

  ```SQL
  SET GLOBAL query_queue_cpu_used_permille_limit = 800;
  ```

また、最大キュー長とキュー内の各処理待ちクエリのタイムアウト時間を設定することで、キュー内のクエリをどのように処理するかを決定できます。

- 最大クエリキュー長を指定します。キューの長さがこのしきい値に達すると、新しいクエリは実行を拒否されます。

  以下の例では、クエリキューの長さを `100` に設定しています：

  ```SQL
  SET GLOBAL query_queue_max_queued_queries = 100;
  ```

- キュー内で処理待ちのクエリの最大タイムアウト時間を指定します。このしきい値に達すると、そのクエリは実行を拒否されます。

  以下の例では、最大タイムアウト時間を `480` 秒に設定しています：

  ```SQL
  SET GLOBAL query_queue_pending_timeout_second = 480;
  ```

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md) を使用して、クエリが処理待ち（Pending）状態かどうかを確認できます。

```Plain
mysql> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| Id   | User | Host                | Db    | Command | ConnectionStartTime | Time | State | Info              | IsPending |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
|    2 | root | xxx.xx.xxx.xx:xxxxx |       | Query   | 2022-11-24 18:08:29 |    0 | OK    | SHOW PROCESSLIST  | false     |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
```

`IsPending` が `true` の場合、該当するクエリはクエリキュー内で処理待ち状態です。

## 大規模クエリのリアルタイム監視

バージョン 3.0 から、StarRocks はクラスタ内で現在処理中のクエリとそのリソース使用状況を確認する機能をサポートしています。リアルタイムでクラスタを監視し、大規模なクエリが予防策を回避してシステムの過負荷を引き起こすのを防ぐことができます。

### MySQL クライアントを通じて監視する

1. [SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md) を使用して、現在処理中のクエリ `current_queries` を確認できます。

   ```SQL
   SHOW PROC '/current_queries';
   ```

   StarRocks は、各クエリの ID（`QueryId`）、対応する接続 ID（`ConnectionId`）、およびリソース消費量を返します。これには、スキャンしたデータのサイズ（`ScanBytes`）、処理した行数（`ProcessRows`）、CPU 時間（`CPUCostSeconds`）、メモリ使用量（`MemoryUsageBytes`）、実行時間（`ExecTime`）が含まれます。

   ```Plain
   mysql> SHOW PROC '/current_queries';
   +--------------------------------------+--------------+------------+------+-----------+----------------+----------------+------------------+----------+
   | QueryId                              | ConnectionId | Database   | User | ScanBytes | ProcessRows    | CPUCostSeconds | MemoryUsageBytes | ExecTime |
   +--------------------------------------+--------------+------------+------+-----------+----------------+----------------+------------------+----------+
   | 7c56495f-ae8b-11ed-8ebf-00163e00accc | 4            | tpcds_100g | root | 37.88 MB  | 1075769 Rows   | 11.13 Seconds  | 146.70 MB        | 3804     |
   | 7d543160-ae8b-11ed-8ebf-00163e00accc | 6            | tpcds_100g | root | 13.02 GB  | 487873176 Rows | 81.23 Seconds  | 6.37 GB          | 2090     |
   +--------------------------------------+--------------+------------+------+-----------+----------------+----------------+------------------+----------+
   2 rows in set (0.01 sec)
   ```

2. クエリ ID を指定して、各 BE ノードでのそのクエリのリソース消費をさらに詳しく確認できます。

   ```SQL
   SHOW PROC '/current_queries/<QueryId>/hosts';
   ```

   StarRocks は、各 BE ノードでのクエリのスキャンデータサイズ（`ScanBytes`）、スキャンした行数（`ScanRows`）、CPU 時間（`CPUCostSeconds`）、およびメモリ使用量（`MemUsageBytes`）を返します。

   ```Plain
   mysql> show proc '/current_queries/7c56495f-ae8b-11ed-8ebf-00163e00accc/hosts';
   +--------------------+-----------+-------------+----------------+---------------+
   | Host               | ScanBytes | ScanRows    | CpuCostSeconds | MemUsageBytes |
   +--------------------+-----------+-------------+----------------+---------------+
   | 172.26.34.185:8060 | 11.61 MB  | 356252 Rows | 52.93 Seconds  | 51.14 MB      |
   | 172.26.34.186:8060 | 14.66 MB  | 362646 Rows | 52.89 Seconds  | 50.44 MB      |
   | 172.26.34.187:8060 | 11.60 MB  | 356871 Rows | 52.91 Seconds  | 48.95 MB      |
   +--------------------+-----------+-------------+----------------+---------------+
   3 rows in set (0.00 sec)
   ```

### FE コンソールを通じて監視する

MySQL クライアントの他に、FE コンソールを使用して視覚的かつインタラクティブに監視することもできます。

1. ブラウザで以下の URL を入力して FE コンソールにアクセスします：

   ```Bash
   http://<fe_IP>:<fe_http_port>/system?path=//current_queries
   ```

   ![FE console 1](../assets/console_1.png)

   **System Info** ページで、現在処理中のクエリとそのリソース消費を確認できます。

2. 対応するクエリの **QueryID** をクリックします。

   ![FE console 2](../assets/console_2.png)

   新しいページで、各ノードでのクエリのリソース消費情報を確認できます。

### 大規模クエリを手動で終了する

大規模なクエリが設定した予防策を回避し、システムの可用性を脅かしている場合、[KILL](../sql-reference/sql-statements/Administration/KILL.md) ステートメントを使用して、クエリに対応する接続 ID を指定して手動でクエリを終了できます：

```SQL
KILL QUERY <ConnectionId>;
```

## 大規模クエリログの分析

バージョン 3.0 から、StarRocks は大規模クエリログをサポートし、**fe/log/fe.big_query.log** ファイルに保存されます。StarRocks の監査ログと比較して、大規模クエリログは以下の三つのフィールドを追加で出力します：

- `bigQueryLogCPUSecondThreshold`
- `bigQueryLogScanBytesThreshold`
- `bigQueryLogScanRowsThreshold`

これらのフィールドは、設定したリソース消費の閾値に対応し、クエリが大規模クエリかどうかを判断するために使用されます。

大規模クエリログを有効にするには、以下のステートメントを実行します：

```SQL
SET GLOBAL enable_big_query_log = true;
```

大規模クエリログを有効にした後、大規模クエリログの出力をトリガーするルールを定義できます。

- Big Query Logs のトリガーとなる CPU 時間の閾値を指定します。

  以下の例では、CPU 時間の閾値を `600` 秒に設定します：

  ```SQL
  SET GLOBAL big_query_log_cpu_second_threshold = 600;
  ```

- 大規模クエリログのトリガーとなるスキャンデータサイズの閾値を指定します。

  以下の例では、スキャンデータサイズの閾値を `10737418240` バイト（10 GB）に設定します：

  ```SQL
  SET GLOBAL big_query_log_scan_bytes_threshold = 10737418240;
  ```

- 大規模クエリログのトリガーとなるスキャンした行数の閾値を指定します。

  以下の例では、スキャンした行数の閾値を `1500000000` に設定します：

  ```SQL
  SET GLOBAL big_query_log_scan_rows_threshold = 1500000000;
  ```

## 防御メカニズムの微調整

リアルタイム監視と大規模クエリログから得られた統計データをもとに、クラスタ内で見過ごされた大規模クエリ（または誤って大規模クエリと判断された通常のクエリ）のパターンを理解し、リソースグループとクエリキューの設定を最適化できます。


もし多くの大規模クエリが特定の SQL パターンに一致し、その SQL パターンを永久に禁止したい場合は、そのパターンを SQL ブラックリストに追加することができます。StarRocks は SQL ブラックリストにある任意のパターンに一致するクエリを実行せず、エラーを返します。詳細は [SQL ブラックリストの管理](../administration/Blacklist.md) を参照してください。

以下のステートメントを実行して SQL ブラックリストを有効にします:

```SQL
ADMIN SET FRONTEND CONFIG ("enable_sql_blacklist" = "true");
```

その後、[ADD SQLBLACKLIST](../sql-reference/sql-statements/Administration/ADD_SQLBLACKLIST.md) ステートメントを使用して、その SQL パターンを表す正規表現を SQL ブラックリストに追加できます。

以下の例では `COUNT(DISTINCT)` を SQL ブラックリストに追加します:

```SQL
ADD SQLBLACKLIST "SELECT COUNT(DISTINCT .+) FROM .+";
```

