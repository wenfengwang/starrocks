---
displayed_sidebar: Chinese
---

# クエリキュー

このドキュメントでは、StarRocksでクエリキューを管理する方法について説明します。

v2.5バージョンから、StarRocksはクエリキュー機能をサポートしています。クエリキューを有効にすると、StarRocksは並行クエリの数またはリソース使用率が一定の閾値に達したときに自動的にクエリをキューに入れ、過負荷の悪化を防ぎます。実行待ちのクエリはキューで待機し、十分な計算リソースが利用可能になると実行が開始されます。v3.1.4バージョンから、StarRocksはリソースグループの粒度でクエリキュー機能を設定することをサポートしています。

CPU使用率、メモリ使用率、およびクエリの並行度の閾値を設定してクエリキューをトリガーできます。

**ロードマップ**:

| バージョン | グローバルクエリキュー | リソースグループ粒度のクエリキュー | 並行数の集中管理 | 並行度の動的調整 |
| ------ | -------------- | ---------------------- | -------------- | -------------- |
| v2.5   | ✅             | ❌                     | ❌             | ❌             |
| v3.1.4 | ✅             | ✅                     | ✅             | ✅             |

## クエリキューを有効にする

StarRocksはデフォルトでクエリキューを無効にしています。グローバルセッション変数（Global session variable）を設定することで、INSERTインポート、SELECTクエリ、および統計情報クエリに対してグローバルまたはリソースグループ粒度のクエリキューを有効にできます。

### グローバルクエリキューを有効にする

以下のグローバルセッション変数を設定して、インポートタスク、SELECTクエリ、または統計情報クエリに対してグローバルクエリキュー管理を有効にします。

- インポートタスクにクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_load = true;
```

- SELECTクエリにクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_select = true;
```

- 統計情報クエリにクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_statistic = true;
```

### リソースグループ粒度のクエリキューを有効にする

v3.1.4から、StarRocksはリソースグループ粒度のクエリキューをサポートしています。

リソースグループ粒度のクエリキューを有効にするには、上記のグローバルセッション変数に加えて、`enable_group_level_query_queue`を追加で設定する必要があります。

```SQL
SET GLOBAL enable_group_level_query_queue = true;
```

## リソース閾値を指定する

### グローバル粒度のリソース閾値

以下のグローバルセッション変数を設定して、クエリキューをトリガーする閾値を設定できます：

| **変数**                            | **デフォルト値** | **説明**                                                     |
| ----------------------------------- | -------------- | ------------------------------------------------------------ |
| query_queue_concurrency_limit       | 0              | 単一のBEノードでの並行クエリの上限。`0`より大きい値を設定した後にのみ有効になります。 |
| query_queue_mem_used_pct_limit      | 0              | 単一のBEノードでのメモリ使用率の上限。`0`より大きい値を設定した後にのみ有効になります。範囲：[0, 1] |
| query_queue_cpu_used_permille_limit | 0              | 単一のBEノードでのCPU使用率のパーミル上限（CPU使用率 * 1000）。`0`より大きい値を設定した後にのみ有効になります。範囲：[0, 1000] |

> **注記**
>
> デフォルト設定では、BEは1秒ごとにFEにリソース使用状況を報告します。BEの設定項目`report_resource_usage_interval_ms`を設定することで、この間隔を変更できます。

### リソースグループ粒度のリソース閾値

v3.1.4から、リソースグループを作成する際に、それぞれの並行クエリ上限`concurrency_limit`とCPUコア数上限`max_cpu_cores`を設定できます。クエリを開始するとき、任意のリソースがグローバル粒度またはリソースグループ粒度のリソース閾値を超えている場合、クエリはキューに入れられ、すべてのリソースが閾値を超えなくなるまで待機し、その後クエリが実行されます。

| **属性**          | **デフォルト値** | **説明**                                                     |
| ----------------- | -------------- | ------------------------------------------------------------ |
| concurrency_limit | 0              | そのリソースグループの単一のBEノードでの並行クエリの上限。`0`より大きい値を設定した後にのみ有効になります。 |
| max_cpu_cores     | 0              | そのリソースグループの単一のBEノードで使用可能なCPUコア数の上限。`0`より大きい値を設定した後にのみ有効になります。範囲：[0, `avg_be_cpu_cores`]、ここで`avg_be_cpu_cores`はすべてのBEのCPUコア数の平均値を表します。 |

リソースグループの使用情報を確認するには、SHOW USAGE RESOURCE GROUPSを使用できます。詳細は[リソースグループの使用情報を見る](./resource_group.md#リソースグループの使用情報を見る)を参照してください。

### クエリの並行数を管理する

実行中のクエリ数`num_running_queries`がグローバル粒度またはリソースグループ粒度の`concurrency_limit`を超えると、新たに到着したクエリはキューに入れられます。v3.1.4より前とv3.1.4以降のバージョンでは、`num_running_queries`の取得方法が異なります。

- v3.1.4より前のバージョンでは、`num_running_queries`はBEが定期的に報告する実行中のクエリ数から得られ、報告周期は`report_resource_usage_interval_ms`です。したがって、システムが`num_running_queries`の変化を感知するにはある程度の遅延があります。例えば、現在のBEが報告する`num_running_queries`がグローバル粒度およびリソースグループ粒度の`concurrency_limit`を超えていない場合でも、次の報告前に多数のクエリが開始されて`concurrency_limit`を超えた場合、これらの新しいクエリは実行され、キューに入れられません。

- v3.1.4以降のバージョンでは、すべてのFEで実行中のクエリ数`num_running_queries`はLeader FEによって集中管理されます。各Follower FEはクエリを開始および終了する際にLeader FEに通知するため、短時間にクエリが急増して`concurrency_limit`を超えるシナリオに対応できます。

## クエリキューを設定する

以下のグローバルセッション変数を設定して、クエリキューの容量とキュー内のクエリの最大タイムアウト時間を設定できます：

| **変数**                           | **デフォルト値** | **説明**                                                     |
| ---------------------------------- | -------------- | ------------------------------------------------------------ |
| query_queue_max_queued_queries     | 1024           | キュー内のクエリ数の上限。この閾値に達すると、新しいクエリは実行を拒否されます。`0`より大きい値を設定した後にのみ有効になります。 |
| query_queue_pending_timeout_second | 300            | キュー内の単一クエリの最大タイムアウト時間。この閾値に達すると、そのクエリは実行を拒否されます。単位は秒です。 |

## クエリの並行数に基づいて並行度を動的に調整する


v3.1.4 版以降、Pipeline Engine によって実行されるクエリについて、StarRocks は現在実行中のクエリ数 `num_running_queries`、Fragment 数 `num_fragments`、およびクエリの並行度 `pipeline_dop` に基づいて、新たに到着したクエリの並行度 `pipeline_dop` を動的に調整することができます。この方法により、BE リソースの完全な利用を保証しつつ、スケジューリングのオーバーヘッドを低減することができます。Fragment とクエリの並行度 `pipeline_dop` については、[クエリ管理 - クエリの並行度を調整する](./Query_management.md#クエリの並行度を調整する)を参照してください。

各クエリキューに対して、StarRocks は論理的な Driver 数 `num_drivers` を維持し、これは単一の BE 上でのそのクエリのすべての Fragment の合計並行数を表します。`num_drivers` の値は `num_fragments*pipeline_dop` に等しいです。新しいクエリが到着すると、StarRocks は以下のロジックに従ってクエリの並行度 `pipeline_dop` を調整します：

- 実行中の Driver 数 `num_drivers` がクエリ並行 Driver の下限 `query_queue_driver_low_water` を超えるほど、クエリの並行度 `pipeline_dop` は小さくなります。
- StarRocks は、実行中の Driver 数 `num_drivers` がクエリ並行 Driver の上限 `query_queue_driver_high_water` を超えないように努めます。

以下のグローバルセッション変数を通じて、クエリの並行度 `pipeline_dop` の動的調整を制御できます：

| **変数**                        | **デフォルト値** | **説明**                                                     |
| ------------------------------- | ---------------- | ------------------------------------------------------------ |
| query_queue_driver_high_water   | -1               | クエリ並行 Driver の上限。`0` より大きい値に設定された場合のみ有効。`0` に等しい場合は、`avg_be_cpu_cores*16` に設定されます。ここで `avg_be_cpu_cores` はすべての BE の CPU コア数の平均値を指します。`0` より大きい場合は、その値が直接使用されます。 |
| query_queue_driver_low_water    | -1               | クエリ並行 Driver の下限。`0` より大きい値に設定された場合のみ有効。`0` に等しい場合は、`avg_be_cpu_cores*8` に設定されます。`0` より大きい場合は、その値が直接使用されます。 |

## クエリキューの監視

以下の方法でクエリキューに関連する情報を確認できます。

### SHOW PROC

[SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md) を使用して、BE ノードが実行しているクエリの数、メモリ使用量、および CPU 使用率を確認します：

```Plain
mysql> SHOW PROC '/backends'\G
*************************** 1. row ***************************
...
    NumRunningQueries: 0
           MemUsedPct: 0.79 %
           CpuUsedPct: 0.0 %
```

### SHOW PROCESSLIST

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md) を使用して、クエリがキューに入っているかどうか（つまり `IsPending` が `true` の場合）を確認します：

```Plain
MySQL [(none)]> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| Id   | User | Host                | Db    | Command | ConnectionStartTime | Time | State | Info              | IsPending |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
|    2 | root | xxx.xx.xxx.xx:xxxxx |       | Query   | 2022-11-24 18:08:29 |    0 | OK    | SHOW PROCESSLIST  | false     |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
```

### FE 監査ログ

FE 監査ログファイル **fe.audit.log** を確認します。`PendingTimeMs` フィールドは、クエリがキューで待機している時間をミリ秒単位で示します。

### FE メトリクス

以下の FE メトリクスは、各 FE ノードが自身の統計データに基づいて算出したものです。

| メトリクス                                          | 単位 | タイプ   | 説明                                                         |
| --------------------------------------------------- | ---- | -------- | ------------------------------------------------------------ |
| starrocks_fe_query_queue_pending                    | 件   | インスタント値 | 現在キューにあるクエリの数。                                   |
| starrocks_fe_query_queue_total                      | 件   | インスタント値 | 過去にキューに入ったクエリの数（実行中のクエリを含む）。         |
| starrocks_fe_query_queue_timeout                    | 件   | インスタント値 | キューでタイムアウトしたクエリの総数。                           |
| starrocks_fe_resource_group_query_queue_total       | 件   | インスタント値 | そのリソースグループで過去にキューに入ったクエリの数（実行中のクエリを含む）。ラベル `name` はリソースグループの名前を示します。v3.1.4 から StarRocks はこのメトリクスをサポートしています。 |
| starrocks_fe_resource_group_query_queue_pending     | 件   | インスタント値 | そのリソースグループで現在キューにあるクエリの数。ラベル `name` はリソースグループの名前を示します。v3.1.4 から StarRocks はこのメトリクスをサポートしています。 |
| starrocks_fe_resource_group_query_queue_timeout     | 件   | インスタント値 | そのリソースグループでキューでタイムアウトしたクエリの総数。ラベル `name` はリソースグループの名前を示します。v3.1.4 から StarRocks はこのメトリクスをサポートしています。 |

### SHOW RUNNING QUERIES

v3.1.4 から、StarRocks は SQL ステートメント SHOW RUNNING QUERIES をサポートし、各クエリのキュー情報を表示するために使用されます。各フィールドの意味は以下の通りです：

- `QueryId`：クエリの Query ID。
- `ResourceGroupId`：クエリがヒットしたリソースグループ ID。ユーザー定義のリソースグループにヒットしなかった場合は "-" と表示されます。
- `StartTime`：クエリの開始時間。
- `PendingTimeout`：PENDING 状態でクエリがキューでタイムアウトする時間。
- `QueryTimeout`：クエリのタイムアウト時間。
- `State`：クエリのキュー状態。PENDING はキュー中を意味し、RUNNING は実行中を意味します。
- `Slots`：クエリが要求する論理リソースの数で、現在は `1` に固定されています。
- `Frontend`：クエリを発行した FE ノード。
- `FeStartTime`：クエリを発行した FE ノードの起動時間。

例：

```Plain
MySQL [(none)]> SHOW RUNNING QUERIES;
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| QueryId                              | ResourceGroupId | StartTime           | PendingTimeout      | QueryTimeout        |   State   | Slots | Frontend                        | FeStartTime         |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| a46f68c6-3b49-11ee-8b43-00163e10863a | -               | 2023-08-15 16:56:37 | 2023-08-15 17:01:37 | 2023-08-15 17:01:37 |  RUNNING  | 1     | 127.00.00.01_9010_1692069711535 | 2023-08-15 16:37:03 |
| a6935989-3b49-11ee-935a-00163e13bca3 | 12003           | 2023-08-15 16:56:40 | 2023-08-15 17:01:40 | 2023-08-15 17:01:40 |  RUNNING  | 1     | 127.00.00.02_9010_1692069658426 | 2023-08-15 16:37:03 |
| a7b5e137-3b49-11ee-8b43-00163e10863a | 12003           | 2023-08-15 16:56:42 | 2023-08-15 17:01:42 | 2023-08-15 17:01:42 |  PENDING  | 1     | 127.00.00.03_9010_1692069711535 | 2023-08-15 16:37:03 |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+