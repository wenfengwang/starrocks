---
displayed_sidebar: Chinese
---

# 管理レプリカ

本文では、StarRocks 中のデータレプリカ (replica) の管理方法について説明します。

> **注意**
>
> メタデータの一貫性を保証するために、Leader FE ノードでレプリカ管理操作を行う必要があります。

## レプリカの修復

TabletChecker は常駐するバックグラウンドプロセスで、定期的にすべてのシャードの状態をチェックします。健全でない状態のシャードは、TabletScheduler によってスケジューリングされ、修復されます。実際の修復操作は、BE ノード上の Clone タスクによって完了されます。FE ノードはこれらの Clone タスクを生成するだけです。

> 注意：
>
> * レプリカの修復の主な考え方は、まずシャードのレプリカ数を期待値に達するように作成または補完し、その後で余分なレプリカを削除することです。
> * Clone タスクとは、特定のリモート BE から指定されたデータを目的の BE にコピーするプロセスを完了することです。

### レプリカの状態を確認する

レプリカの健康状態を確認することができます。

1. **クラスタ内のすべてのレプリカの状態をチェックします。**

    ```sql
    SHOW PROC '/statistic';
    ```

    例：

    ```plain text
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    | DbId     | DbName                      | TableNum | PartitionNum | IndexNum | TabletNum | ReplicaNum | UnhealthyTabletNum | InconsistentTabletNum |
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    | 35153636 | default_cluster:DF_Newrisk  | 3        | 3            | 3        | 96        | 288        | 0                  | 0                     |
    | 48297972 | default_cluster:PaperData   | 0        | 0            | 0        | 0         | 0          | 0                  | 0                     |
    | 5909381  | default_cluster:UM_TEST     | 7        | 7            | 10       | 320       | 960        | 1                  | 0                     |
    | Total    |                             | 10       | 10           | 13       | 416       | 1248       | 1                  | 0                     |
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    ```

    * `UnhealthyTabletNum` 列は、対応するデータベース内で健康でない状態の Tablet がいくつあるかを示しています。
    * `InconsistentTabletNum` 列は、対応するデータベース内でレプリカが一致していない状態の Tablet がいくつあるかを示しています。

    `Total` 行はクラスタ全体を集計しています。通常、`UnhealthyTabletNum` と `InconsistentTabletNum` は 0 であるべきです。0 でない場合は、具体的にどの Tablet があるかをさらに確認することができます。上の例では、UM_TEST データベースに 1 つの Tablet が健康でない状態です。

    健康でない状態の Tablet を調べるには、以下のコマンドを使用します。

    ```sql
    SHOW PROC '/statistic/DbId';
    ```

    `DbId` はデータベースに対応する ID です。

    例：

    ```plain text
    +------------------+---------------------+
    | UnhealthyTablets | InconsistentTablets |
    +------------------+---------------------+
    | [40467980]       | []                  |
    +------------------+---------------------+
    ```

    健康でない状態の Tablet の ID は 40467980 です。
2. **テーブルまたはパーティション内のレプリカの状態をチェックします。**
    指定されたテーブルまたはパーティションのレプリカの状態を確認するには、以下のコマンドを使用し、WHERE 句で状態をフィルタリングすることができます。

    ```sql
    ADMIN SHOW REPLICA STATUS FROM tbl PARTITION (p1, p2, ...) WHERE STATUS = "STATUS";
    ```

    例：

    ```plain text
    mysql> ADMIN SHOW REPLICA STATUS FROM tbl PARTITION (p1, p2) WHERE STATUS = "OK";
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    | TabletId | ReplicaId | BackendId | Version | LastFailedVersion | LastSuccessVersion | CommittedVersion | SchemaHash | VersionNum | IsBad | State  | Status |
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    | 29502429 | 29502432  | 10006     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
    | 29502429 | 36885996  | 10002     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
    | 29502429 | 48100551  | 10007     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
    | 29502433 | 29502434  | 10001     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
    | 29502433 | 44900737  | 10004     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
    | 29502433 | 48369135  | 10006     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    ```

    結果はすべてのレプリカの状態を示しています。`IsBad` 列が `true` の場合、レプリカは破損していることを意味します。`Status` 列は他の異なる状態を表示します。詳細については、[ADMIN SHOW REPLICA STATUS](../sql-reference/sql-statements/Administration/ADMIN_SHOW_REPLICA_STATUS.md) を参照してください。

    指定されたテーブルのレプリカに関する追加情報を表示するには、以下のコマンドを使用します。

    ```sql
    SHOW TABLET FROM tbl1;
    ```

    例：

    ```plain text
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    | TabletId | ReplicaId | BackendId | SchemaHash | Version | VersionHash | LastSuccessVersion | LastSuccessVersionHash | LastFailedVersion | LastFailedVersionHash | LastFailedTime | DataSize | RowCount | State  | LastConsistencyCheckTime | CheckVersion | CheckVersionHash     | VersionCount | PathHash             | MetaUrl              | CompactionStatus     |
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    | 29502429 | 29502432  | 10006     | 1421156361 | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           | -1                   | 2            | -5822326203532286804 | url                  | url                  |
    | 29502429 | 36885996  | 10002     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           | -1                   | 2            | -1441285706148429853 | url                  | url                  |
    | 29502429 | 48100551  | 10007     | 1421156361 | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | 784      | 0        | NORMAL | N/A                     | -1           | -1                   | 2            | -4784691547051455525 | url                  | url                  |
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+----------+--------+-------------------------+--------------+----------------------+--------------+----------------------+----------------------+----------------------+
    ```

    結果には、レプリカのサイズ、行数、バージョン数、データパスなどの追加情報が含まれています。

    > 注意：ここで表示される `State` 列の内容は、レプリカの健康状態を表すものではなく、CLONE、SCHEMA_CHANGE、ROLLUP などの特定のタスクの状態を表しています。

    さらに、以下のコマンドを使用して、指定されたテーブルまたはパーティションのレプリカの分布を確認し、レプリカが均等に分布しているかをチェックすることができます。

    ```sql
    ADMIN SHOW REPLICA DISTRIBUTION FROM tbl1;
    ```

    例：

    ```plain text
    +-----------+------------+-------+---------+
    | BackendId | ReplicaNum | Graph | Percent |
    +-----------+------------+-------+---------+
    | 10000     | 7          |       | 7.29 %  |
    | 10001     | 9          |       | 9.38 %  |
    | 10002     | 7          |       | 7.29 %  |
    | 10003     | 7          |       | 7.29 %  |
    | 10004     | 9          |       | 9.38 %  |
    | 10005     | 11         | >     | 11.46 % |
    | 10006     | 18         | >     | 18.75 % |
    | 10007     | 15         | >     | 15.62 % |
    | 10008     | 13         | >     | 13.54 % |
    +-----------+------------+-------+---------+
    ```

    結果は、`tbl1` のレプリカが各 BE ノード上でどのように分布しているか、その数とパーセンテージ、そして簡単なグラフィカル表示を示しています。
3. **Tablet 内のレプリカの状態をチェックします。**
    特定の Tablet を特定した場合、以下のコマンドを使用してその Tablet の状態を確認することができます。

    ```sql
    SHOW TABLET tablet_id;
    ```

    例：

    ```plain text
    mysql> SHOW TABLET 29502553;
    +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
    | DbName                 | TableName | PartitionName | IndexName | DbId     | TableId  | PartitionId | IndexId  | IsSync | DetailCmd                                                                 |
    +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
    | default_cluster:test   | test      | test          | test      | 29502391 | 29502428 | 29502427    | 29502428 | true   | SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553'; |
    +------------------------+-----------+---------------+-----------+----------+----------+-------------+----------+--------+---------------------------------------------------------------------------+
    ```

    結果には、その Tablet に対応するデータベース、テーブル、パーティション、インデックスなどの情報が表示されます。

    詳細情報を表示するには、`DetailCmd` 列にあるコマンドをコピーして実行します。

    ```plain text
    mysql> SHOW PROC '/dbs/29502391/29502428/partitions/29502427/29502428/29502553';
    +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
    | ReplicaId | BackendId | Version | VersionHash | LstSuccessVersion | LstSuccessVersionHash | LstFailedVersion | LstFailedVersionHash | LstFailedTime | SchemaHash | DataSize | RowCount | State  | IsBad | VersionCount | PathHash             | MetaUrl  | CompactionStatus |
    +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
    | 43734060  | 10004     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | -8566523878520798656 | url      | url              |
    | 29502555  | 10002     | 2       | 0           | 2                 | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1885826196444191611  | url      | url              |
    | 39279319  | 10007     | 2       | 0           | -1                | 0                     | -1               | 0                    | N/A           | -1         | 784      | 0        | NORMAL | false | 2            | 1656508631294397870  | url      | url              |
    +-----------+-----------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+------------+----------+----------+--------+-------+--------------+----------------------+----------+------------------+
    ```

    この結果は、対応するTabletのすべてのレプリカの状況を表示しています。

### レプリカのスケジュール優先順位

TabletSchedulerでは、待機中のシャードが状態に応じて異なる優先順位を割り当てられます。

通常、システムは自動的にレプリカの優先順位を判断し、スケジュールします。しかし、特定のテーブルやパーティションのシャードをより迅速に修復したい場合は、レプリカの優先順位を手動でスケジュールすることができます。

以下のコマンドを使用して、優先的に修復が必要なテーブルやパーティション内の問題のあるTabletにVERY_HIGHの優先順位を割り当てます。

```sql
ADMIN REPAIR TABLE tbl [PARTITION (p1, p2, ...)];
```

> 注意：このコマンドはヒントに過ぎず、必ずしも修復が成功するとは限りません。また、レプリカの優先順位はTabletSchedulerのスケジュールによって変更される可能性があります。Leader FEノードが切り替わったり再起動した後は、このコマンドに含まれる情報が失われます。

以下のコマンドで優先順位のスケジュールをキャンセルすることもできます。

```sql
ADMIN CANCEL REPAIR TABLE tbl [PARTITION (p1, p2, ...)];
```

## レプリカのバランス

StarRocksはクラスタ内のレプリカのバランスを自動的に行います。

バランスの主な考え方は、特定のシャードに対して、まず負荷の低いノード上にレプリカを作成し、その後、負荷の高いノード上の該当シャードのレプリカを削除することです。さらに、異なるストレージメディアの存在により、同じクラスタ内の異なるBEノードには1種類または2種類のストレージメディアが存在する可能性があります。StarRocksは、バランス後もストレージメディアAのシャードが可能な限りストレージメディアAに保管されるよう要求しています。そのため、StarRocksはストレージメディアに基づいてクラスタのBEノードを分類し、異なるストレージメディアのBEノード集合に対して負荷バランスのスケジュールを行います。同様に、レプリカのバランスは、同じTabletのレプリカが同じホストのBE上に配置されないように保証します。

### BEノードの負荷

StarRocksはClusterLoadStatistics（CLS）を使用して、クラスタ内の各BEの負荷バランス状況を表します。TabletSchedulerはこの統計値に基づいてクラスタのバランスをトリガーします。StarRocksは現在、**ディスク使用率**と**レプリカ数**の2つの指標を使用して、各BEのloadScoreを計算し、BEの負荷スコアとしています。スコアが高いほど、そのBEの負荷が重いことを意味します。TabletSchedulerはCLSを1分ごとに更新します。

ディスク使用率とレプリカ数にはそれぞれ重み係数があり、`capacityCoefficient`と`replicaNumCoefficient`として別々に設定され、その合計は`1`です。`capacityCoefficient`は実際のディスク使用率に基づいて動的に調整されます。BEの総ディスク使用率が50％以下の場合、`capacityCoefficient`の値は`0.5`となり、ディスク使用率が75％以上の場合は`1`となります（FEの設定項目`capacity_used_percent_high_water`で設定できます）。使用率が50％〜75％の間の場合、この重み係数はスムーズに増加し、式は`capacityCoefficient = 2 * ディスク使用率 - 0.5`となります。この重み係数は、ディスク使用率が高い場合にBEの負荷スコアを高くし、システムがそのBEの負荷を速やかに減らすことを保証します。

### バランス戦略

TabletSchedulerは各スケジュールラウンドで、LoadBalancerを通じて一定数の健康なシャードをバランスの候補として選択します。次のスケジュール時には、これらの候補シャードに基づいてバランスのスケジュールを試みます。

### レプリカスケジュールタスクの確認

以下のレプリカスケジュールタスクを確認できます。

1. 実行待ちのスケジュールタスクを確認します。

    ```sql
    SHOW PROC '/cluster_balance/pending_tablets';
    ```

    例：

    ```plain text
    +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
    | TabletId | Type   | Status          | State   | OrigPrio | DynmPrio | SrcBe | SrcPath | DestBe | DestPath | Timeout | Create              | LstSched            | LstVisit            | Finished | Rate | FailedSched | FailedRunning | LstAdjPrio          | VisibleVer | VisibleVerHash      | CmtVer | CmtVerHash          | ErrMsg                        |
    +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
    | 4203036  | REPAIR | REPLICA_MISSING | PENDING | HIGH     | LOW      | -1    | -1      | -1     | -1       | 0       | 2019-02-21 15:00:20 | 2019-02-24 11:18:41 | 2019-02-24 11:18:41 | N/A      | N/A  | 2           | 0             | 2019-02-21 15:00:43 | 1          | 0                   | 2      | 0                   | unable to find source replica |
    +----------+--------+-----------------+---------+----------+----------+-------+---------+--------+----------+---------+---------------------+---------------------+---------------------+----------+------+-------------+---------------+---------------------+------------+---------------------+--------+---------------------+-------------------------------+
    ```

    各列の具体的な意味は以下の通りです：

    * `TabletId`：スケジュール待ちのTabletのID。スケジュールタスクはTabletごとに1つです。
    * `Type`：タスクのタイプで、REPAIR（修復）またはBALANCE（バランス）があります。
    * `Status`：そのTabletの現在の状態、例えばREPLICA_MISSING（レプリカ不足）など。
    * `State`：そのスケジュールタスクの状態で、PENDING/RUNNING/FINISHED/CANCELLED/TIMEOUT/UNEXPECTEDのいずれかです。
    * `OrigPrio`：初期の優先順位。
    * `DynmPrio`：現在動的に調整された優先順位。
    * `SrcBe`：ソースBEノードのID。
    * `SrcPath`：ソースBEノードのパスのハッシュ値。
    * `DestBe`：宛先BEノードのID。
    * `DestPath`：宛先BEノードのパスのハッシュ値。
    * `Timeout`：タスクがスケジュールされた後、ここにタスクのタイムアウト時間が表示されます。単位は秒です。
    * `Create`：タスクが作成された時間。
    * `LstSched`：最後にタスクがスケジュールされた時間。
    * `LstVisit`：最後にタスクが訪問された時間。「訪問された」とは、スケジュールされたり、タスクの実行報告など、このタスクに関連する処理が行われた時間点を指します。
    * `Finished`：タスクが終了した時間。
    * `Rate`：cloneタスクのデータコピー速度。
    * `FailedSched`：タスクのスケジュールに失敗した回数。
    * `FailedRunning`：タスクの実行に失敗した回数。
    * `LstAdjPrio`：最後に優先順位が調整された時間。
    * `CmtVer/CmtVerHash/VisibleVer/VisibleVerHash`：Cloneタスクを実行するためのバージョン情報。
    * `ErrMsg`：タスクがスケジュールされ、実行される過程で発生したエラーメッセージ。

2. **実行中のスケジュールタスクを確認します。**

    ```sql
    SHOW PROC '/cluster_balance/running_tablets';
    ```

    その結果の各列の意味は`pending_tablets`と同じです。
3. **終了したスケジュールタスクを確認します。**

    StarRocksはデフォルトで最新の1000件の完了したタスクを保持します。

    ```sql
    SHOW PROC '/cluster_balance/history_tablets';
    ```

    その結果の各列の意味は`pending_tablets`と同じです。`State`列が`FINISHED`であれば、タスクが正常に完了したことを意味します。それ以外の場合は、`ErrMsg`列のエラーメッセージに基づいて具体的な原因を確認できます。

## リソースコントロール

レプリカの修復やバランスは、BE間でのレプリカのコピーを通じて行われます。同じBEが同時に多くのタスクを実行すると、大きなIO圧力がかかることになります。したがって、StarRocksはスケジュール時に各ノードで実行できるタスクの数を制御しています。最小のリソースコントロール単位はディスクです（**be.conf**で指定されたデータパス）。StarRocksはデフォルトで各ディスクに2つのスロットを割り当ててレプリカの修復に使用します。1つのcloneタスクはソースと宛先の両方で1つのスロットを使用します。スロットの数がゼロの場合、そのディスクにはこれ以上タスクは割り当てられません。このスロット数はFEの`tablet_sched_slot_num_per_path`パラメータを通じて動的に設定できます。

また、StarRocksはデフォルトで各ディスクに2つの独立したslotを提供し、タスクのバランスを取るためです。これは、slotが修復タスクによって占有されることで、高負荷のノードがバランスを取ってスペースを解放できない状況を防ぐためです。
