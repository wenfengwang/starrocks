---
displayed_sidebar: Chinese
---

# 中間結果のディスクへの書き出し

この文書では、大規模なオペレータの中間計算結果をディスクに書き出す方法について説明します。

## 概要

メモリに依存してクエリを処理するデータベースシステム、例えばStarRocksは、大規模なデータセットで集約、ソート、および結合などの演算を処理する際に、大量のメモリリソースを消費します。メモリの制限に達すると、これらのクエリは強制終了されます。

しかし、一部のシナリオでは、限られたメモリリソースを使用して特定のタスクを安定的に完了させたいと考えるかもしれません。たとえば、マテリアライズドビューの構築や、INSERT INTO SELECTを使用した軽量ETLの実行などです。これらのタスクは大量のメモリリソースを消費し、結果としてクラスタ内で実行されている他のクエリをブロックする可能性があります。通常、この問題を解決するためには、手動でパラメータを調整し、クラスタリソースの隔離戦略に依存してクエリの並行性を制御する必要があります。この方法は不便であり、極端な場合には失敗する可能性があります。

v3.0.1から、StarRocksはいくつかの大規模なオペレータの中間結果をディスクに書き出すことをサポートしています。この機能を使用することで、パフォーマンスをある程度犠牲にしながらも、大規模なデータクエリにおけるメモリ消費を大幅に削減し、システム全体の可用性を向上させることができます。

現在、StarRocksは以下のオペレータの中間結果をディスクに書き出すことをサポートしています：

- 集約オペレータ
- ソートオペレータ
- Hash join（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN、およびINNER JOIN）オペレータ

## 中間結果のディスクへの書き出しを有効にする

以下の手順に従って中間結果のディスクへの書き出しを有効にします：

1. BEの設定ファイル **be.conf** でディスク書き出しパス `spill_local_storage_dir` を指定し、変更を有効にするためにクラスタを再起動します。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **説明**
   >
   > - 複数のディスク書き出しパス `spill_local_storage_dir` を指定することができ、セミコロン(`;`)で区切ります。
   > - 本番環境では、データストレージと中間結果のディスク書き出しに異なるディスクを使用することを強く推奨します。中間結果がディスクに書き出されると、書き込み負荷とディスク使用量が大幅に増加する可能性があります。同じディスクを使用すると、この急増がクラスタ内で実行されている他のクエリやタスクに影響を与える可能性があります。

2. 以下のステートメントを実行して中間結果のディスクへの書き出しを有効にします：

   ```SQL
   SET enable_spill = true;
   ```

3. Session変数 `spill_mode` を使用して中間結果のディスクへの書き出しモードを設定します：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **説明**
   >
   > 中間結果のディスクへの書き出しに関連する各クエリが完了した後、StarRocksは自動的に生成されたディスク書き出しデータをクリアします。BEがデータをクリアする前にクラッシュし、データが残ってしまった場合、StarRocksはBEが再起動されたときにディスク書き出しデータをクリアします。

   | **変数**     | **デフォルト値** | **説明**                                                     |
   | ------------ | ---------- | ------------------------------------------------------------ |
   | enable_spill | false      | 中間結果のディスクへの書き出しを有効にするかどうか。`true`に設定すると、StarRocksは中間結果をディスクに書き出し、クエリで集約、ソート、または結合オペレータを処理する際のメモリ使用量を減らします。|
   | spill_mode   | auto       | 中間結果のディスクへの書き出しの実行方法。有効な値：`auto`：メモリ使用量が閾値に達すると自動的に書き出しがトリガーされます。`force`：メモリ使用状況に関係なく、StarRocksは関連するすべてのオペレータの中間結果を強制的にディスクに書き出します。この変数は、`enable_spill`が`true`に設定されている場合にのみ有効です。|

## 使用上の制限

- 中間結果のディスクへの書き出しは、すべてのメモリ不足の問題を解決するわけではありません。例えば、StarRocksは式の計算に使用されるメモリを解放することはできません。
- 通常、中間結果のディスクへの書き出しを伴うクエリは、クエリの実行時間が桁違いに増加することを示しています。これらのクエリのタイムアウト時間をSession変数 `query_timeout` を設定して適切に延長することをお勧めします。
