---
displayed_sidebar: Chinese
---
# リソースの分離

このドキュメントでは、リソースの分離機能の使用方法について説明します。

StarRocksは2.2以降、リソースグループ管理をサポートしており、クラスタはリソースグループを設定することで、クエリに対するリソースの消費を制限し、テナント間のリソースの分離と適切な利用を実現することができます。2.3では、大規模なクエリの制限もサポートしており、クラスタはリソースの消費をさらに制御し、わずかな大規模なクエリがシステムリソースを使い果たしてシステムの安定性に影響を与えることを防ぐことができます。StarRocks 2.5では、リソースグループを使用してインポートタスクのリソース消費を間接的に制御することができます。

リソースの分離機能を使用すると、BEノードの計算リソースを複数のリソースグループに分割し、各リソースグループに1つ以上の分類器（Classifier）を関連付けることができます。分類器で設定された条件に基づいて、システムはクエリタスクに対応する情報をマッチングします。クエリタスクを実行すると、分類器はクエリタスクの関連情報に基づいてマッチングを行います。最も一致度の高い分類器のみが有効となり、システムは有効な分類器が所属するリソースグループにクエリタスクにリソースを割り当てます。

今後のバージョンでは、リソースの分離機能をさらに強化していく予定です。

リソースの分離機能のサポート計画

|  | 内部テーブル | 外部テーブル | 大規模クエリの分離 | Short query リソースグループ | INSERT INTO、Broker Loadの計算リソースの分離 | ルーチンロード、ストリームロード、スキーマ変更のリソースの分離 |
|---|---|---|---|---|---|---|
| 2.2 | ○ | × | × | × | × | × |
| 2.3 | ○ | ○ | ○ |○ | × | × |
| 2.4 | ○ | ○ | ○ |○ | × | × |
| 2.5 以降 | ○ | ○ | ○ |○ | ○ | × |

## 基本的な概念

このセクションでは、リソースの分離機能に関連する基本的な概念について説明します。

### リソースグループ

BEノードを複数のリソースグループ（リソースグループ）に分割することで、システムは対応するリソースグループに割り当てられたリソースクォータ（CPUおよびメモリ）に基づいてクエリリソースを割り当てます。

リソースグループには以下のリソース制限を設定できます：

- `cpu_core_limit`：現在のBEノードで使用できるCPUコア数の上限。実際に使用されるCPUコア数は、ノードのリソースの空き具合に応じて比例的にスケーリングされます。正の整数の値を取ります。取りうる値の範囲は（1、`avg_be_cpu_cores`]で、`avg_be_cpu_cores`はすべてのBEのCPUコア数の平均値を表します。

  > 注意：例えば、16コアのBEノードでrg1、rg2、rg3の3つのリソースグループを設定し、`cpu_core_limit`をそれぞれ`2`、`6`、`8`に設定した場合、BEノードがフルロードされている場合、rg1、rg2、rg3に割り当てられるCPUコア数は、BEノードの総CPUコア数×（2/16）= 2、BEノードの総CPUコア数×（6/16）= 6、BEノードの総CPUコア数×（8/16）= 8になります。BEノードのリソースがフルロードされていない場合、rg1とrg2に負荷がかかり、rg3に負荷がかかっていない場合、rg1とrg2に割り当てられるCPUコア数は、BEノードの総CPUコア数×（2/8）= 4、BEノードの総CPUコア数×（6/8）= 12になります。

- `mem_limit`：クエリに使用できるメモリ（query_pool）の割合を、現在のBEノードの総メモリに対する割合（%）で設定します。範囲は（0、1）です。
  > 注意：query_poolの表示方法については、[メモリ管理](Memory_management.md)を参照してください。

- `concurrency_limit`：リソースグループ内の同時クエリ数の上限。過剰な並行クエリの提出を防ぐためにのみ有効になります。デフォルト値は0です。
- `max_cpu_cores`：リソースグループが単一のBEノードで使用することができるCPUコア数の上限。`0` より大きい値に設定した場合にのみ有効になります。範囲は[0、`avg_be_cpu_cores`]で、`avg_be_cpu_cores`はすべてのBEのCPUコア数の平均値を表します。デフォルト値は0です。

上記のリソース制限に基づいて、次のようにリソースグループをさらに設定することができます：

- `big_query_cpu_second_limit`：各BEで大規模クエリタスクが使用できるCPUの時間制限。並列タスクのCPUの実際の使用時間が累積されます。単位は秒です。デフォルト値は0です。
- `big_query_scan_rows_limit`：各BEでスキャンできる行数の上限。デフォルト値は0です。
- `big_query_mem_limit`：各BEで使用できるメモリの上限。単位はバイトです。デフォルト値は0です。

> **注意**
>
> リソースグループで実行されるクエリが上記の大規模クエリ制限を超える場合、クエリは中止され、エラーが返されます。エラーメッセージはFEノードの**fe.audit.log**の`ErrorCode`列で確認できます。

リソースグループのタイプ `type` は `short_query` と `normal` をサポートしています。

- デフォルトでは、`normal` リソースグループが使用されます。`type` パラメータを指定する必要はありません。
- `short_query` リソースグループにクエリが実行中の場合、現在のBEノードは `short_query.cpu_core_limit` のCPUリソースを予約します。つまり、すべての `normal` リソースグループの合計CPUコア数の使用上限は、BEノードのコア数 - `short_query.cpu_core_limit` に制限されます。
- `short_query` リソースグループにクエリが実行されていない場合、すべての `normal` リソースグループのCPUコア数にはハード制限はありません。

> **注意**
>
> - `short_query` リソースグループは1つしか作成できません。
> - StarRocksは `short_query` リソースグループのCPUリソースをハード制限しません。

### 分類器

各リソースグループには1つ以上の分類器を関連付けることができます。システムは、すべての分類器の条件に基づいて、クエリタスクに最も一致する分類器を選択し、有効な分類器が所属するリソースグループにクエリタスクにリソースを割り当てます。

分類器には以下の条件を含めることができます：

- `user`：ユーザ名。
- `role`：ユーザが所属するロール。
- `query_type`：クエリのタイプ。現在は `SELECT` と `INSERT`（2.5以降）がサポートされています。`query_type` が `insert` のリソースグループには、INSERT INTOまたはBroker Loadのインポートタスクが実行中の場合、現在のBEノードは対応する計算リソースを予約します。
- `source_ip`：クエリの発行元IPアドレス。CIDR形式のタイプです。
- `db`：クエリがアクセスするデータベース。カンマで区切られた文字列にすることができます。
- `plan_cpu_cost_range`：システムが推定するクエリのCPUコストの範囲。形式は `(DOUBLE, DOUBLE]` です。デフォルトはNULLで、制限はありません。fe.audit.logの`PlanCpuCost`列は、システムが推定するクエリのCPUコストです。v3.1.4以降、StarRocksはこのパラメータをサポートしています。
- `plan_mem_cost_range`：システムが推定するクエリのメモリコストの範囲。形式は `(DOUBLE, DOUBLE]` です。デフォルトはNULLで、制限はありません。fe.audit.logの`PlanMemCost`列は、システムが推定するクエリのメモリコストです。v3.1.4以降、StarRocksはこのパラメータをサポートしています。

システムは、クエリタスクと分類器の条件が完全に一致する場合にのみ、クエリタスクに対して分類器をマッチングと見なします。複数の分類器の条件がクエリタスクと完全に一致する場合、異なる分類器の一致度を計算する必要があります。その中で最も一致度の高い分類器のみが有効となります。

> **注意**
>
> 特定のクエリタスクが最終的にマッチしたリソースグループをFEノードの**fe.audit.log**の`ResourceGroup`列または`EXPLAIN VERBOSE <query>`の`RESOURCE GROUP`列で確認することができます。詳細については、[クエリがマッチしたリソースグループを表示する](#クエリがマッチしたリソースグループを表示する)を参照してください。

一致度は以下のように計算されます：

- `user` が一致する場合、分類器の一致度が1増加します。
- `role` が一致する場合、分類器の一致度が1増加します。
- `query_type` が一致する場合、分類器の一致度が1 + 1/分類器の `query_type` 数に増加します。
- `source_ip` が一致する場合、分類器の一致度が1 + (32 - cidr_prefix)/64増加します。
- クエリの `db` が一致する場合、一致度が10増加します。
- クエリのCPUコストが `plan_cpu_cost_range` の範囲内にある場合、分類器の一致度が1増加します。
- クエリのメモリコストが `plan_mem_cost_range` の範囲内にある場合、分類器の一致度が1増加します。

例えば、クエリタスクに一致する複数の分類器がある場合、分類器の条件の数が多いほど、一致度が高くなります。

```Plain
-- 分類器Bの条件の数がAよりも多いため、分類器Bの一致度がAよりも高くなります。
classifier A (user='Alice')
classifier B (user='Alice', source_ip = '192.168.1.0/24')
```

条件の数が同じ場合、条件の記述がより正確な分類器の一致度が高くなります。

```Plain
-- 分類器Bの制限された `source_ip` の範囲がより小さいため、分類器Bの一致度がAよりも高くなります。
classifier A (user='Alice', source_ip = '192.168.1.0/16')
classifier B (user='Alice', source_ip = '192.168.1.0/24')

-- クエリのタイプの数がより少ない分類器Cの一致度がDよりも高くなります。
classifier C (user='Alice', query_type in ('select'))
classifier D (user='Alice', query_type in ('insert','select')）
```

複数の分類器の一致度が同じ場合、その中からランダムに1つの分類器が選択されます。

```Plain
-- クエリがdb1とdb2の両方をクエリし、一致度が最も高い分類器EとFが一致する場合、EとFの中からランダムに1つが選択されます。
classifier E (db='db1')
classifier F (db='db2')
```

## 計算リソースの分離

リソースグループを作成し、適切な分類器を設定することで、異なるクエリタスクに対して計算リソースを分離することができます。

### リソースグループの有効化

リソースグループを使用するには、対応するセッション変数を設定してパイプラインエンジンを有効にする必要があります。

```sql
-- 現在のセッションでパイプラインエンジンを有効にする。
SET enable_pipeline_engine = true;
-- グローバルでパイプラインエンジンを有効にする。
SET GLOBAL enable_pipeline_engine = true;
```


```
インポートタスクには、FEの設定項目 `enable_pipeline_load` を有効にして、インポートタスクにPipelineエンジンを使用する必要があります。このパラメータはv2.5.0からサポートされています。

```sql
ADMIN SET FRONTEND CONFIG ("enable_pipeline_load" = "true");
```

> **説明**
>
> v3.1.0から、リソースグループ機能がデフォルトで有効になります。セッション変数 `enable_resource_group` は非推奨です。

### リソースグループとクラシファイアの作成

リソースグループを作成し、クラシファイアを関連付けてリソースを割り当てます。

```SQL
CREATE RESOURCE GROUP group_name 
TO (
    user='string', 
    role='string', 
    query_type in ('select'), 
    source_ip='cidr'
) -- クラシファイアを作成します。複数のクラシファイアはカンマ（,）で区切ります。
WITH (
    "cpu_core_limit" = "INT",
    "mem_limit" = "m%",
    "concurrency_limit" = "INT",
    "type" = "str" -- リソースグループのタイプで、normal または short_query のいずれかです。
);
```

例：

```SQL
CREATE RESOURCE GROUP rg1
TO 
    (user='rg1_user1', role='rg1_role1', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user2', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user3', source_ip='192.168.x.x/24'),
    (user='rg1_user4'),
    (db='db1')
WITH (
    'cpu_core_limit' = '10',
    'mem_limit' = '20%',
    'big_query_cpu_second_limit' = '100',
    'big_query_scan_rows_limit' = '100000',
    'big_query_mem_limit' = '1073741824'
);
```

### リソースグループの指定（オプション）

クラシファイアによる自動的なリソースグループの指定の他に、セッション変数を通じて直接リソースグループを指定することもできます。

```sql
SET resource_group = 'group_name';
```

### リソースグループとクラシファイアの確認

すべてのリソースグループとクラシファイアを照会します。

```SQL
SHOW RESOURCE GROUPS ALL;
```

現在のユーザーにマッチするリソースグループとクラシファイアを照会します。

```SQL
SHOW RESOURCE GROUPS;
```

指定したリソースグループとクラシファイアを照会します。

```SQL
SHOW RESOURCE GROUP group_name;
```

例：

```Plain_Text
mysql> SHOW RESOURCE GROUPS ALL;

+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| Name | Id     | CPUCoreLimit | MemLimit | ConcurrencyLimit | Type   | Classifiers                                                                                                            |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300040, weight=4.409375, user=rg1_user1, role=rg1_role1, query_type in (SELECT), source_ip=192.168.2.1/24)         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300041, weight=3.459375, user=rg1_user2, query_type in (SELECT), source_ip=192.168.3.1/24)                         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300042, weight=2.359375, user=rg1_user3, source_ip=192.168.4.1/24)                                                 |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300043, weight=1.0, user=rg1_user4)                                                                                |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
```

> **説明**
>
> `weight` はクラシファイアのマッチング度を表します。

### リソースグループのクォータとクラシファイアの管理

リソースグループのクォータを変更したり、クラシファイアを追加・削除することができます。

既存のリソースグループのリソースクォータを変更します。

```SQL
ALTER RESOURCE GROUP group_name WITH (
    'cpu_core_limit' = 'INT',
    'mem_limit' = 'm%'
);
```

指定したリソースグループを削除します。

```SQL
DROP RESOURCE GROUP <group_name>;
```

新しいクラシファイアを追加します。

```SQL
ALTER RESOURCE GROUP <group_name> ADD (user='string', role='string', query_type in ('select'), source_ip='cidr');
```

指定したクラシファイアを削除します。

```SQL
ALTER RESOURCE GROUP <group_name> DROP (CLASSIFIER_ID_1, CLASSIFIER_ID_2, ...);
```

すべてのクラシファイアを削除します。

```SQL
ALTER RESOURCE GROUP <group_name> DROP ALL;
```

## リソースグループの監視

### クエリがヒットしたリソースグループの確認

FEノードの **fe.audit.log** の `ResourceGroup` 列と `EXPLAIN VERBOSE <query>` の `RESOURCE GROUP` 列は、特定のクエリタスクが最終的にマッチしたリソースグループを示します。

- クエリがリソースグループの管理下にない場合、その列の値は空文字列 `""` です。

- クエリがリソースグループの管理下にあるが、クラシファイアにマッチしなかった場合、その列の値は空文字列 `""` で、デフォルトのリソースグループ `default_wg` を使用することを意味します。

デフォルトのリソースグループ `default_wg` のリソース設定は以下の通りです：

- `cpu_core_limit`：1 (&le;2.3.7 版) または BEのCPUコア数（&gt;2.3.7版）。
- `mem_limit`：100%。
- `concurrency_limit`：0。
- `big_query_cpu_second_limit`：0。
- `big_query_scan_rows_limit`：0。
- `big_query_mem_limit`：0。

### リソースグループのモニタリング

リソースグループに[モニタリングとアラート](Monitor_and_Alert.md)を設定できます。

モニタリング可能なリソースグループ関連のFEとBEのメトリクスは以下の通りです。以下のすべてのメトリクスには `name` ラベルがあり、それぞれのリソースグループに対応しています。

#### FEメトリクス

以下のFEメトリクスは、各FEでそのFE上のクエリ数を個別に統計しています。

| メトリクス                                          | 単位 | タイプ   | 説明                                                         |
| --------------------------------------------------- | ---- | -------- | ------------------------------------------------------------ |
| starrocks_fe_query_resource_group                   | 件   | 瞬時値 | そのリソースグループで過去に実行されたクエリ数（実行中のクエリを含む）。 |
| starrocks_fe_query_resource_group_latency           | ms   | 瞬時値 | そのリソースグループのクエリ遅延のパーセンタイル。`type` ラベルは特定のパーセンタイルを示し、`mean`、`75_quantile`、`95_quantile`、`98_quantile`、`99_quantile`、`999_quantile`を含みます。 |
| starrocks_fe_query_resource_group_err               | 件   | 瞬時値 | そのリソースグループでエラーが発生したクエリタスクの数。   |
| starrocks_fe_resource_group_query_queue_total       | 件   | 瞬時値 | そのリソースグループで過去にキューに入れられたクエリ数（実行中のクエリを含む）。このメトリクスはv3.1.4からサポートされています。クエリキューが有効な場合にのみ意味があります。詳細は[クエリキュー](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_pending     | 件   | 瞬時値 | そのリソースグループでキューに入っているクエリ数。このメトリクスはv3.1.4からサポートされています。クエリキューが有効な場合にのみ意味があります。詳細は[クエリキュー](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_timeout     | 件   | 瞬時値 | そのリソースグループでキュー待ち時間がタイムアウトしたクエリ数。このメトリクスはv3.1.4からサポートされています。クエリキューが有効な場合にのみ意味があります。詳細は[クエリキュー](query_queues.md)を参照してください。 |

#### BEメトリクス

| メトリクス                                      | 単位   | タイプ   | 説明                                                         |
| ----------------------------------------------- | ------ | -------- | ------------------------------------------------------------ |
| resource_group_running_queries                  | 件     | 瞬時値 | そのリソースグループで現在実行中のクエリ数。                 |
| resource_group_total_queries                    | 件     | 瞬時値 | そのリソースグループで過去に実行されたクエリ数（実行中のクエリを含む）。 |
| resource_group_bigquery_count                   | 件     | 瞬時値 | そのリソースグループで大規模クエリ制限をトリガーしたクエリ数。 |
| resource_group_concurrency_overflow_count       | 件     | 瞬時値 | そのリソースグループで `concurrency_limit` 制限をトリガーしたクエリ数。 |
| resource_group_mem_limit_bytes                  | バイト  | 瞬時値 | そのリソースグループのメモリ上限。                           |
| resource_group_mem_inuse_bytes                  | バイト  | 瞬時値 | そのリソースグループが使用中のメモリ。                       |
| resource_group_cpu_limit_ratio                  | パーセント | 瞬時値 | そのリソースグループの `cpu_core_limit` が全リソースグループの `cpu_core_limit` に占める割合。 |
| resource_group_inuse_cpu_cores                  | 件     | 平均値 | そのリソースグループが使用中のCPUコア数。この値は推定値です。2回のメトリクス取得間隔の平均値を統計しています。このメトリクスはv3.1.4からサポートされています。 |
| resource_group_cpu_use_ratio                    | パーセント | 平均値 | **非推奨** そのリソースグループが使用したPipelineスレッドの時間割合が全リソースグループのPipelineスレッドの時間割合に占める割合。2回のメトリクス取得間隔の平均値を統計しています。 |
| resource_group_connector_scan_use_ratio         | パーセント | 平均値 | **非推奨** そのリソースグループが使用した外部テーブルScanスレッドの時間割合が全リソースグループのPipelineスレッドの時間割合に占める割合。2回のメトリクス取得間隔の平均値を統計しています。 |
| resource_group_scan_use_ratio                   | パーセント | 平均値 | **非推奨** そのリソースグループが使用した内部テーブルScanスレッドの時間割合が全リソースグループのPipelineスレッドの時間割合に占める割合。2回のメトリクス取得間隔の平均値を統計しています。 |

### リソースグループの使用情報の確認

v3.1.4から、StarRocksはSQL文 [SHOW USAGE RESOURCE GROUPS](../sql-reference/sql-statements/Administration/SHOW_RUNNING_QUERIES.md) をサポートし、各リソースグループが各BEでどのように使用されているかの情報を表示します。各フィールドの意味は以下の通りです：

- `Name`：リソースグループの名前。
- `Id`：リソースグループのID。
- `Backend`：BEのIPまたはFQDN。
- `BEInUseCpuCores`：そのリソースグループがそのBEで使用中のCPUコア数。この値は推定近似値です。
- `BEInUseMemBytes`：そのリソースグループがそのBEで使用中のメモリバイト数。
- `BERunningQueries`：そのリソースグループがそのBEで未完了のクエリ数。

注意：

- これらのリソース使用情報はBEが周期的にLeader FEに報告し、報告周期は `report_resource_usage_interval_ms` で、デフォルトは1秒です。
- 結果には、BEInUseCpuCores/BEInUseMemBytes/BERunningQueriesの少なくとも1つが正の数値である行のみが表示されます。つまり、リソースグループがBEで何らかのリソースを使用している場合のみ結果に表示されます。

例：

```Plain
MySQL [(none)]> SHOW USAGE RESOURCE GROUPS;
+------------+----+-----------+-----------------+-----------------+------------------+
| Name       | Id | Backend   | BEInUseCpuCores | BEInUseMemBytes | BERunningQueries |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.1 | 0.100           | 1               | 5                |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.2 | 0.200           | 2               | 6                |
+------------+----+-----------+-----------------+-----------------+------------------+

| wg1        | 0  | 127.0.0.1 | 0.300           | 3               | 7                |
+------------+----+-----------+-----------------+-----------------+------------------+
| wg2        | 0  | 127.0.0.1 | 0.400           | 4               | 8                |
+------------+----+-----------+-----------------+-----------------+------------------+
```

## 次のステップ

リソースグループの設定に成功したら、次の操作ができます：

- [メモリ管理](Memory_management.md)
- [クエリ管理](Query_management.md)
