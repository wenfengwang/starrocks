---
displayed_sidebar: English
---

# 集約テーブル

集約テーブルを使用するテーブルを作成する場合、ソートキー列とメトリック列を定義し、メトリック列に対して集約関数を指定できます。ロードされるレコードが同じソートキーを持つ場合、メトリック列は集約されます。集約テーブルは、クエリ処理に必要なデータ量を削減し、クエリの速度を向上させるのに役立ちます。

## シナリオ

集約テーブルは、データ統計と分析シナリオに適しています。以下はいくつかの例です：

- ウェブサイトやアプリの提供者が、ユーザーが特定のウェブサイトやアプリで過ごす時間やトラフィック量、ウェブサイトやアプリへの総訪問回数を分析するのに役立ちます。

- 広告代理店が、顧客向けに提供する広告の総クリック数、総視聴数、消費統計を分析するのに役立ちます。

- eコマース企業が年間の取引データを分析し、四半期ごとや月ごとの地理的なベストセラーを特定するのに役立ちます。

上記のシナリオでのデータクエリと取り込みには、以下の特徴があります：

- 多くのクエリは集約クエリであり、SUM、MAX、MINなどがあります。
- 生の詳細データを取得する必要はありません。
- 履歴データは頻繁に更新されず、新しいデータのみが追加されます。

## 原則

データ取り込みからデータクエリまで、集約テーブルを使用するテーブル内の同じソートキーを持つデータは、以下のように複数回集約されます：

1. データ取り込みフェーズでは、データがバッチでテーブルにロードされる際、各バッチはデータバージョンで構成されます。データバージョンが生成された後、StarRocksはデータバージョン内で同じソートキーを持つデータを集約します。
2. バックグラウンドコンパクションフェーズでは、データ取り込み時に生成された複数のデータバージョンのファイルが定期的に大きなファイルにコンパクトされる際、StarRocksはその大きなファイル内で同じソートキーを持つデータを集約します。
3. データクエリフェーズでは、StarRocksはクエリ結果を返す前に、すべてのデータバージョンにわたって同じソートキーを持つデータを集約します。

これらの集約操作は、処理が必要なデータ量を減少させ、クエリの速度を向上させます。

例えば、集約テーブルを使用するテーブルがあり、以下の4つの生データレコードをテーブルにロードしたいとします。

| 日付       | 国 | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | 中国     | 1    |
| 2020.05.01 | 中国     | 2    |
| 2020.05.01 | 米国     | 3    |
| 2020.05.01 | 米国     | 4    |

StarRocksは、データ取り込み時にこれら4つの生データレコードを以下の2つのレコードに集約します。

| 日付       | 国 | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | 中国     | 3    |
| 2020.05.01 | 米国     | 7    |

## テーブルの作成

たとえば、異なる都市のユーザーが異なるウェブページにアクセスした回数を分析したい場合、`example_db.aggregate_tbl`という名前のテーブルを作成し、`site_id`、`date`、`city_code`をソートキー列として定義し、`pv`をメトリック列として定義し、`pv`列に対してSUM関数を指定します。

テーブルを作成するためのステートメントは次のとおりです：

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "siteのID",
    date DATE NOT NULL COMMENT "イベントの時間",
    city_code VARCHAR(20) COMMENT "ユーザーのcity_code",
    pv BIGINT SUM DEFAULT "0" COMMENT "総ページビュー"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **注意**
>
> - テーブルを作成する際には、`DISTRIBUTED BY HASH`句を使用してバケット列を指定する必要があります。詳細は[バケッティング](../Data_distribution.md#design-partitioning-and-bucketing-rules)を参照してください。
> - v2.5.7以降、StarRocksはテーブルを作成する際やパーティションを追加する際にバケット数（BUCKETS）を自動的に設定することができます。バケット数を手動で設定する必要はもうありません。詳細は[バケット数の決定](../Data_distribution.md#determine-the-number-of-buckets)を参照してください。

## 使用上の注意点

- テーブルのソートキーに関しては、以下の点に注意してください：
  - `AGGREGATE KEY`キーワードを使用して、ソートキーに使用される列を明示的に定義することができます。

    - `AGGREGATE KEY`キーワードにすべてのディメンション列が含まれていない場合、テーブルは作成できません。
    - デフォルトでは、`AGGREGATE KEY`キーワードを使用してソートキー列を明示的に定義しない場合、StarRocksはメトリック列を除くすべての列をソートキー列として選択します。

  - ソートキーは、一意性制約が適用される列に作成する必要があり、名前を変更できないすべてのディメンション列で構成されている必要があります。

- 列名の後に集約関数を指定して、その列をメトリック列として定義することができます。通常、メトリック列は集約および分析が必要なデータを保持します。

- 集約テーブルでサポートされる集約関数については、[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md)を参照してください。

- クエリが実行される際、ソートキー列は複数のデータバージョンの集約前にフィルタリングされるのに対し、メトリック列は複数のデータバージョンの集約後にフィルタリングされます。そのため、フィルタ条件として頻繁に使用される列を特定し、これらの列をソートキーとして定義することを推奨します。これにより、複数のデータバージョンの集約前にデータフィルタリングが開始され、クエリ性能が向上します。

- テーブルを作成する際には、メトリック列にBITMAPインデックスやBloom Filterインデックスを作成することはできません。

## 次に行うこと

テーブルが作成された後、さまざまなデータ取り込み方法を使用してStarRocksにデータをロードできます。StarRocksでサポートされているデータ取り込み方法については、[データインポート](../../loading/Loading_intro.md)を参照してください。

> 注意：集約テーブルを使用するテーブルにデータをロードする場合、テーブルのすべての列を更新することしかできません。たとえば、`example_db.aggregate_tbl`テーブルを更新する場合、`site_id`、`date`、`city_code`、`pv`といったすべての列を更新する必要があります。
