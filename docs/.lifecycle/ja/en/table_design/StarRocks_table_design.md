---
displayed_sidebar: English
---

# テーブル設計について理解する

## カラムストア

![Columnar Storage](../assets/3.1-1.png)

他のリレーショナルデータベースと同じように、StarRocksのテーブルは行と列から構成されています。各行はユーザーデータのレコードを保持し、各列のデータは同じ型です。テーブルの全ての行は同じ数の列を持ちます。テーブルに対して列を動的に追加したり削除したりすることができます。テーブルの列は、ディメンション列とメトリック列に分けられます。ディメンション列はキーカラムとも呼ばれ、メトリック列はバリューカラムとも呼ばれます。ディメンション列の値はデータのグルーピングやソートに使用され、メトリック列の値はsum、count、min、max、hll_union_agg、bitmap_unionなどの関数を使用して集計されます。

StarRocksはテーブルのためにカラムストアを使用します。物理的には、列のデータはデータブロックに分割され、エンコードされ、圧縮された後、ディスクに永続的に保存されます。論理的には、列のデータは同じデータ型の要素からなる配列と見なすことができます。行に保持される列の値は、それぞれの配列において列の順序に従って要素としてリストされます。これは、行に保持される列の値が同じ配列インデックスを持つことを意味します。配列インデックスは暗黙のものであり、保存する必要はありません。テーブルの全行は、一つ以上のディメンション列によって指定された順序でソートされます。ソートされたテーブル内の行の位置は、その行のシーケンス番号によって表されます。

テーブルに対するクエリで、ディメンション列のプレフィックスを構成する特定のディメンション列に対して等価条件または範囲条件を指定すると、StarRocksはバイナリ検索を実行して、ソートされたデータの中から関心のある行を迅速に特定できます。例えば、`table1`という名前のテーブルからデータをクエリする場合、そのテーブルは`event_day`、`siteid`、`citycode`、`username`の4つの列で構成されており、`event_day`と`siteid`はディメンション列です。`event_day = 2020-09-18`と`siteid = 2`をクエリ条件として指定すると、StarRocksはバイナリ検索を実行し、`event_day`と`siteid`がディメンション列のプレフィックスを構成するため、指定された範囲内のデータのみを処理する必要があります。`citycode = 4`と`username = Andy`をクエリ条件として指定した場合、StarRocksはバイナリ検索を実行できず、`citycode`と`username`がディメンション列のプレフィックスを構成しないため、テーブル全体のデータを処理する必要があります。

## インデックス

StarRocksはプレフィックスインデックスと各列のインデックスを使用して、関心のある行のデータブロックの開始行を迅速に特定します。

次の図は、StarRocksのテーブル設計がStarRocks内のテーブルに対するクエリを加速する方法を示しています。

![Indexing Overview](../assets/3.1-2.png)

StarRocksのテーブルのデータは、以下の3つの部分に編成されています：

- プレフィックスインデックス
  
  StarRocksは、1024行ごとのデータをデータブロックとして格納し、それぞれのデータブロックに対してプレフィックスインデックステーブルにエントリを保持します。各データブロックのプレフィックスインデックスエントリの内容は、データブロックの最初の行のディメンション列から構成されるプレフィックスで、長さは36バイトを超えてはなりません。プレフィックスインデックスはスパースインデックスです。行をクエリする際には、StarRocksはプレフィックスインデックステーブルを検索して、行のディメンション列から構成されるプレフィックスを取得し、関心のある行のデータブロックの最初の行のシーケンス番号を迅速に特定できます。

- 各列のデータブロック
  
  StarRocksは、各列のデータを複数の64KBデータブロックに分割します。各データブロックは独立してエンコードされ、圧縮され、最小のI/O単位としてディスクから読み書きされます。

- 各列のインデックス
  
  StarRocksは、各列に対して行番号インデックスを保持します。行番号インデックステーブルでは、列のデータブロックが列に含まれる行のシーケンス番号に1対1でマッピングされます。加えて、行番号インデックステーブルの各エントリには、特定の行番号にマップされたデータブロックの開始行番号、アドレス、および長さが含まれます。行をクエリする際には、StarRocksは行番号インデックステーブルを検索して、行のシーケンス番号にマップされたデータブロックのアドレスを取得し、データブロックを読み取って行を特定します。

要約すると、StarRocksは行のディメンション列から構成されるプレフィックスを使用してテーブルの行を特定するために、以下の5つのステップを実行します：

1. プレフィックスインデックステーブルを検索して、関心のある行のデータブロックの最初の行のシーケンス番号を特定します。

2. 各ディメンション列の行番号インデックステーブルを検索して、ディメンション列のデータブロックを特定します。

3. データブロックを読み取ります。

4. データブロックを解凍し、デコードします。

5. データブロックを検索して、ディメンション列インデックスにマップされた行を特定します。

## 高速処理のためのメカニズム

このセクションでは、StarRocksがデータをより高速に処理するためのメカニズムを紹介します。

### プリアグリゲーション

StarRocksはアグリゲートテーブルを提供します。アグリゲートテーブルでは、テーブルのディメンション列で同じ値を持つ行が単一の行に集約されます。集約から生成された新しい行において、各ディメンション列の値は変わらず、各メトリック列の値は指定された集約関数によって集約され、メトリック列の新しい行の結果値が生成されます。プリアグリゲーションは集約操作を加速するのに役立ちます。

### パーティショニングとバケッティング

StarRocksの各テーブルは複数のタブレットに分割されています。各タブレットはBE上の複数のレプリカに保存されます。BEの数とタブレットの数は、コンピューティングリソースとデータサイズの変化に応じて柔軟にスケールできます。クエリを開始すると、複数のBEが並行してタブレットを検索し、目的のデータを迅速に特定できます。さらに、タブレットレプリカは複製および移行可能であり、データの信頼性を高め、データの偏りを防ぐことができます。パーティショニングとバケッティングは、データの検索効率と安定性を確保するのに役立ちます。

### マテリアライズドビュー

テーブルのプレフィックスインデックスはテーブルのクエリを加速するのに役立ちますが、テーブルのディメンション列の順序に依存しています。ディメンション列プレフィックスに含まれないディメンション列を使用してクエリ述語を構築する場合、プレフィックスインデックスは機能しません。この場合、テーブルに対してマテリアライズドビューを作成できます。マテリアライズドビューのデータはテーブルのデータと同様に編成され、保存されますが、マテリアライズドビューは独自のプレフィックスインデックスを持つことができます。マテリアライズドビューのプレフィックスインデックスを作成する際には、適切な集約粒度、カラム数、ディメンションカラムの順序を指定することで、頻繁に使用されるクエリ条件がマテリアライズドビューのプレフィックスインデックステーブルの期待されるエントリにヒットするようにすることができます。

### 各列のインデックス

StarRocksはブルームフィルター、ゾーンマップ、ビットマップインデックスなどの各列のインデックスをサポートしています：

- ブルームフィルターは、クエリしたい値がデータブロックに含まれているかどうかを判断するために使用されます。

- ゾーンマップは、指定された範囲内の値を特定するために使用されます。

- ビットマップインデックスは、ENUMデータ型の列で指定されたクエリ条件に合致する行を特定するために使用されます。
