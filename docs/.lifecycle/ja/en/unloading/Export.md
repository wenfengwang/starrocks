---
displayed_sidebar: English
---

# EXPORT を使用したデータのエクスポート

このトピックでは、StarRocksクラスタ内の指定されたテーブルやパーティションからCSVデータファイルとして外部ストレージシステムにデータをエクスポートする方法について説明します。外部ストレージシステムには、分散ファイルシステムHDFSやAWS S3などのクラウドストレージシステムが含まれます。

> **注意**
>
> StarRocksテーブルからデータをエクスポートするには、それらのStarRocksテーブルにEXPORT権限を持つユーザーである必要があります。EXPORT権限を持っていない場合は、[GRANT](../sql-reference/sql-statements/account-management/GRANT.md)に記載されている指示に従って、StarRocksクラスタに接続するために使用するユーザーにEXPORT権限を付与してください。

## 背景情報

v2.4以前のStarRocksでは、EXPORT文を使用してデータをエクスポートする際に、StarRocksクラスタと外部ストレージシステム間の接続を設定するためにブローカーに依存していました。そのため、EXPORT文に`WITH BROKER "<broker_name>"`を指定して使用するブローカーを指定する必要がありました。これは「ブローカーベースのアンロード」と呼ばれます。ブローカーは、ファイルシステムインターフェースと統合された独立したステートレスサービスで、StarRocksが外部ストレージシステムにデータをエクスポートするのを支援します。

v2.5以降、StarRocksはEXPORT文を使用してデータをエクスポートする際に、StarRocksクラスタと外部ストレージシステム間の接続を設定するためにブローカーに依存しなくなりました。そのため、EXPORT文でブローカーを指定する必要はなくなりましたが、`WITH BROKER`キーワードは引き続き必要です。これは「ブローカーフリーのアンロード」と呼ばれます。

ただし、データがHDFSに保存されている場合、ブローカーフリーのアンロードは機能しないことがあり、ブローカーベースのアンロードを使用する必要があります：

- 複数のHDFSクラスタにデータをエクスポートする場合、それぞれのHDFSクラスタに独立したブローカーをデプロイして設定する必要があります。
- 単一のHDFSクラスタにデータをエクスポートし、複数のKerberosユーザーを設定している場合、独立したブローカーを一つデプロイする必要があります。

> **注記**
>
> [SHOW BROKER](../sql-reference/sql-statements/Administration/SHOW_BROKER.md)文を使用して、StarRocksクラスタにデプロイされているブローカーを確認できます。ブローカーがデプロイされていない場合は、[ブローカーのデプロイ](../deployment/deploy_broker.md)に記載されている指示に従ってブローカーをデプロイしてください。

## サポートされるストレージシステム

- 分散ファイルシステム HDFS
- AWS S3などのクラウドストレージシステム

## 注意事項

- 一度にエクスポートするデータは数十GBを超えないことを推奨します。一度に大量のデータをエクスポートすると、エクスポートが失敗する可能性があり、再試行のコストが増加します。

- ソースStarRocksテーブルに大量のデータが含まれている場合、テーブルの全データがエクスポートされるまで、毎回少数のパーティションからデータをエクスポートすることを推奨します。

- エクスポートジョブが実行中にStarRocksクラスタのFEが再起動されたり、新しいリーダーFEが選出されたりすると、エクスポートジョブは失敗します。この場合、エクスポートジョブを再度提出する必要があります。

- エクスポートジョブが完了した後にStarRocksクラスタのFEが再起動されたり、新しいリーダーFEが選出されたりすると、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)文によって返されるジョブ情報の一部が失われることがあります。

- StarRocksはベーステーブルのデータのみをエクスポートします。ベーステーブルに作成されたマテリアライズドビューのデータはエクスポートしません。

- エクスポートジョブにはデータスキャンが必要で、これによりI/Oリソースが占有され、結果としてクエリのレイテンシーが増加します。

## ワークフロー

エクスポートジョブを送信すると、StarRocksはエクスポートジョブに関与するすべてのタブレットを特定します。次に、関与するタブレットをグループに分け、クエリプランを生成します。クエリプランは、関与するタブレットからデータを読み取り、目的のストレージシステムの指定されたパスにデータを書き込むために使用されます。

以下の図は、一般的なワークフローを示しています。

![img](../assets/5.3.1-1.png)

一般的なワークフローは、以下の3つのステップで構成されます：

1. ユーザーがリーダーFEにエクスポートジョブを送信します。

2. リーダーFEは、StarRocksクラスタ内のすべてのBEに対して`snapshot`命令を発行し、BEはエクスポートされるデータの一貫性を確保するために関与するタブレットのスナップショットを取ります。リーダーFEはまた、複数のエクスポートタスクを生成します。各エクスポートタスクはクエリプランであり、それぞれのクエリプランは関与するタブレットの一部を処理するために使用されます。

3. リーダーFEはエクスポートタスクをBEに配布します。

## 原則

StarRocksがクエリプランを実行する際、まず目的のストレージシステムの指定されたパスに`__starrocks_export_tmp_xxx`という名前の一時フォルダを作成します。一時フォルダの名前における`xxx`はエクスポートジョブのIDを表します。一時フォルダの例としては`__starrocks_export_tmp_921d8f80-7c9d-11eb-9342-acde48001122`があります。StarRocksがクエリプランを正常に実行すると、一時フォルダ内に一時ファイルを生成し、エクスポートされたデータを生成された一時ファイルに書き込みます。

すべてのデータがエクスポートされた後、StarRocksはRENAMEステートメントを使用して生成された一時ファイルを指定されたパスに保存します。

## 関連するパラメータ

このセクションでは、StarRocksクラスターのFEで設定できるエクスポート関連のパラメータについて説明します。

- `export_checker_interval_second`: エクスポートジョブがスケジュールされる間隔。デフォルトの間隔は5秒です。FEでこのパラメータを再設定した後、新しいパラメータ設定を有効にするためにFEを再起動する必要があります。

- `export_running_job_num_limit`: 許可される実行中のエクスポートジョブの最大数。実行中のエクスポートジョブの数がこの制限を超えると、`snapshot`の実行後に余分なエクスポートジョブが待機状態に入ります。デフォルトの最大数は5です。エクスポートジョブが実行中でもこのパラメータを再設定できます。

- `export_task_default_timeout_second`: エクスポートジョブのタイムアウト期間。デフォルトのタイムアウト期間は2時間です。エクスポートジョブが実行中でもこのパラメータを再設定できます。

- `export_max_bytes_per_be_per_task`: 各BEからエクスポートタスクごとにエクスポートできる圧縮データの最大量。このパラメータは、StarRocksがエクスポートジョブを同時に実行できるエクスポートタスクに分割するポリシーを提供します。デフォルトの最大量は256MBです。

- `export_task_pool_size`: スレッドプールで同時に実行できるエクスポートタスクの最大数。デフォルトの最大数は5です。

## 基本操作

### エクスポートジョブの送信

StarRocksデータベース`db1`に`tbl1`という名前のテーブルが含まれているとします。`tbl1`のパーティション`p1`と`p2`から列`col1`と`col3`のデータをHDFSクラスターの`export`パスにエクスポートするには、次のコマンドを実行します。

```SQL
EXPORT TABLE db1.tbl1 
PARTITION (p1,p2)
(col1, col3)
TO "hdfs://HDFS_IP:HDFS_Port/export/lineorder_" 
PROPERTIES
(
    "column_separator"=",",
    "load_mem_limit"="2147483648",
    "timeout" = "3600"
)
WITH BROKER
(
    "username" = "user",
    "password" = "passwd"
);
```

構文とパラメータの詳細な説明、およびAWS S3にデータをエクスポートするコマンドの例については、[EXPORT](../sql-reference/sql-statements/data-manipulation/EXPORT.md)を参照してください。

### エクスポートジョブのクエリIDを取得する

エクスポートジョブを送信した後、SELECT LAST_QUERY_ID()ステートメントを使用してエクスポートジョブのクエリIDを照会できます。クエリIDを使用してエクスポートジョブを表示またはキャンセルできます。

構文とパラメータの詳細な説明については、[last_query_id](../sql-reference/sql-functions/utility-functions/last_query_id.md)を参照してください。

### エクスポートジョブの状態を表示する

エクスポートジョブを送信した後、SHOW EXPORTステートメントを使用してエクスポートジョブの状態を表示できます。例：

```SQL
SHOW EXPORT WHERE queryid = "edee47f0-abe1-11ec-b9d1-00163e1e238f";
```

> **注記**
>
> 上記の例では、`queryid`はエクスポートジョブのクエリIDです。

以下のような情報が返されます：

```Plain
JobId: 14008
State: FINISHED
Progress: 100%
TaskInfo: {"partitions":["*"],"mem limit":2147483648,"column separator":",","line delimiter":"\n","tablet num":1,"broker":"hdfs","coord num":1,"db":"default_cluster:db1","tbl":"tbl3","columns":["col1", "col3"]}
Path: oss://bj-test/export/
CreateTime: 2019-06-25 17:08:24
StartTime: 2019-06-25 17:08:28
FinishTime: 2019-06-25 17:08:34
Timeout: 3600
ErrorMsg: N/A
```

構文とパラメータの詳細については、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)を参照してください。

### エクスポートジョブをキャンセルする

CANCEL EXPORTステートメントを使用して、送信したエクスポートジョブをキャンセルできます。例：

```SQL
CANCEL EXPORT WHERE queryid = "921d8f80-7c9d-11eb-9342-acde48001122";
```

> **注記**
>
> 上記の例では、`queryid`はエクスポートジョブのクエリIDです。

構文とパラメータの詳細な説明については、[CANCEL EXPORT](../sql-reference/sql-statements/data-manipulation/CANCEL_EXPORT.md)を参照してください。

## ベストプラクティス

### クエリプランの分割

エクスポートジョブが分割されるクエリプランの数は、エクスポートジョブに関連するタブレットの数と、クエリプランごとに処理できるデータの最大量によって異なります。エクスポートジョブはクエリプランとして再試行されます。クエリプランによって処理されるデータ量が許容される最大量を超えると、リモートストレージのジッタなどのエラーが発生する可能性があります。その結果、クエリプランを再試行するコストが増加します。各BEがクエリプランごとに処理できるデータの最大量は、`export_max_bytes_per_be_per_task`パラメータによって指定され、デフォルトは256MBです。クエリプランでは、各BEに少なくとも1つのタブレットが割り当てられ、`export_max_bytes_per_be_per_task`パラメータで指定された制限を超えないデータ量をエクスポートできます。

エクスポートジョブの複数のクエリプランが同時に実行されます。FEパラメータ`export_task_pool_size`を使用して、スレッドプールで同時に実行できるエクスポートタスクの最大数を指定できます。このパラメータのデフォルト値は5です。

通常のケースでは、エクスポートジョブの各クエリプランはスキャンとエクスポートの2つのパートのみで構成されています。クエリプランに必要な計算を行うロジックはそれほど多くのメモリを消費しません。そのため、デフォルトのメモリ制限である2GBは、ほとんどのビジネス要件を満たすのに十分です。しかし、BE上で多くのタブレットをスキャンする必要があるクエリプランや、タブレットに多くのバージョンが存在するなど、特定の状況では2GBのメモリ容量では不足することがあります。このような場合には、`load_mem_limit` パラメータを使用して、4GBや8GBなど、より高いメモリ容量の制限を指定する必要があります。
