---
displayed_sidebar: English
---

# 高可用性を備えたFEクラスタのデプロイ

このトピックでは、StarRocksのFEノードの高可用性(HA)デプロイについて紹介します。

## FE HAクラスタについて理解する

StarRocksのFE高可用性クラスタは、プライマリ-セカンダリレプリケーションアーキテクチャを使用して、シングルポイントの障害を回避します。FEはraftに似たBDB JEプロトコルを使用してリーダー選出、ログレプリケーション、およびフェイルオーバーを実現します。

### FEの役割について理解する

FEクラスタでは、ノードは以下の2つの役割に分けられます：

- **FEフォロワー**

FEフォロワーはレプリケーションプロトコルの投票メンバーで、リーダーFEの選出とログの提出に参加します。FEフォロワーの数は奇数(2n+1)で、多数決(n+1)で確認し、少数(n)の障害を許容します。

- **FEオブザーバー**

FEオブザーバーは投票権を持たないメンバーで、レプリケーションログを非同期に購読するために使用されます。クラスタ内では、FEオブザーバーの状態はフォロワーの状態より遅れており、他のレプリケーションプロトコルのリーナー役割に似ています。

FEクラスタは自動的にFEフォロワーからリーダーFEを選出します。リーダーFEは全ての状態変更を実行します。変更は非リーダーFEノードから開始され、リーダーFEに転送されて実行されます。非リーダーFEノードはレプリケーションログに最新の変更のLSNを記録します。読み取り操作は非リーダーノードで直接実行できますが、非リーダーFEノードの状態が最後の操作のLSNと同期されるまで待機します。オブザーバーノードはFEクラスタの読み取り操作の負荷容量を増加させることができます。緊急性が低いユーザーはオブザーバーノードを読み取ることができます。

## FE HAクラスタのデプロイ

高可用性を備えたFEクラスタをデプロイするためには、以下の要件が満たされている必要があります：

- FEノード間の時計のずれは5秒を超えてはいけません。NTPプロトコルを使用して時刻を同期させます。
- 1台のマシンには1つのFEノードのみをデプロイできます。
- すべてのFEノードで同じHTTPポートを割り当てる必要があります。

上記の要件をすべて満たした場合、以下の手順に従ってFEインスタンスを一つずつStarRocksクラスタに追加し、FEノードのHAデプロイを実現できます。

1. バイナリと設定ファイルを配布します（単一インスタンスと同様）。
2. MySQLクライアントを既存のFEに接続し、新しいインスタンスの情報を追加します。これには役割、IP、ポートが含まれます：

   ```sql
   mysql> ALTER SYSTEM ADD FOLLOWER "host:port";
   ```

   または

   ```sql
   mysql> ALTER SYSTEM ADD OBSERVER "host:port";
   ```

   ホストはマシンのIPです。マシンに複数のIPがある場合、`priority_networks`で優先するIPを選択します。例えば、`priority_networks=192.168.1.0/24`を設定して、サブネット`192.168.1.x`を通信に使用します。ポートは`edit_log_port`で、デフォルトは`9010`です。

   > 注意：セキュリティ上の理由から、StarRocksのFEとBEは通信のために1つのIPのみをリッスンします。マシンに複数のネットワークカードがある場合、StarRocksは正しいIPを自動的に見つけることができないかもしれません。例えば、`ifconfig`コマンドを実行して`eth0 IP`が`192.168.1.1`、`docker0: 172.17.0.1`となっている場合、`priority_networks=192.168.1.0/24`を設定してeth0を通信用のIPとして指定できます。ここでは[CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)記法を使用して、IPが位置するサブネットの範囲を指定し、すべてのBEとFEで使用できるようにします。`priority_networks`は`fe.conf`と`be.conf`の両方に記述されます。この属性は、FEまたはBEが起動するときに使用するIPを示します。例としては`priority_networks=10.1.3.0/24`があります。

   エラーが発生した場合は、以下のコマンドを使用してFEを削除します：

   ```sql
   alter system drop follower "fe_host:edit_log_port";
   alter system drop observer "fe_host:edit_log_port";
   ```

3. FEノードはペアで相互接続する必要があり、マスター選出、投票、ログ提出、レプリケーションを完了します。FEノードが初めて起動する際には、既存のクラスタ内のノードをヘルパーとして指定する必要があります。ヘルパーノードはクラスタ内の全FEノードの設定情報を取得し、接続を確立します。したがって、起動時には`--helper`パラメータを指定します：

   ```shell
   ./bin/start_fe.sh --helper host:port --daemon
   ```

   ホストはヘルパーノードのIPです。複数のIPがある場合は`priority_networks`で選択します。ポートは`edit_log_port`で、デフォルトは`9010`です。

   将来の起動時には`--helper`パラメータを指定する必要はありません。FEは他のFEの設定情報をローカルディレクトリに保存します。直接起動するには：

   ```shell
   ./bin/start_fe.sh --daemon
   ```

4. クラスタの状態を確認し、デプロイが成功したことを確認します。

  ```Plain Text
  mysql> SHOW PROC '/frontends'\G

  ***1\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test1

  ......

  Role: FOLLOWER

  IsMaster: true

  ......

  Alive: true

  ......

  ***2\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test2

  ......

  Role: FOLLOWER

  IsMaster: false

  ......

  Alive: true

  ......

  ***3\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test3

  ......

  Role: FOLLOWER

  IsMaster: false

  ......

  Alive: true

  ......

  3 rows in set (0.05 sec)
  ```

`Alive`が`true`の場合、ノードはクラスタに正常に追加されています。上記の例では、`172.26.x.x_9010_1584965098874`はリーダーFEノードです。
