---
displayed_sidebar: English
---

# クエリキュー

このトピックでは、StarRocksでクエリキューを管理する方法について説明します。

v2.5から、StarRocksはクエリキューをサポートしています。クエリキューが有効になると、同時実行のしきい値またはリソース制限に達した場合、StarRocksは自動的に受信クエリをキューに入れ、過負荷の悪化を防ぎます。保留中のクエリは、実行を開始するのに十分なコンピューティングリソースが利用可能になるまでキューで待機します。v3.1.4以降、StarRocksはリソースグループレベルでクエリキューの設定をサポートしています。

CPU使用率、メモリ使用量、およびクエリの同時実行数にしきい値を設定して、クエリキューをトリガーできます。

**ロードマップ**:

| バージョン | グローバルクエリキュー | リソースグループレベルのクエリキュー | 集合的な同時実行管理 | 動的な同時実行数調整  |
| ------  | ------------------ | -------------------------------- | --------------------------------- | ------------------------------- |
| v2.5    | ✅                 | ❌                                | ❌                                | ❌                              |
| v3.1.4  | ✅                 | ✅                                | ✅                                | ✅                              |

## クエリキューを有効にする

クエリキューはデフォルトで無効です。INSERTロード、SELECTクエリ、および統計クエリのグローバルまたはリソースグループレベルのクエリキューを有効にするには、対応するグローバルセッション変数を設定します。

### グローバルクエリキューを有効にする

- ロードタスクのクエリキューを有効にする:

```SQL
SET GLOBAL enable_query_queue_load = true;
```

- SELECTクエリのクエリキューを有効にする:

```SQL
SET GLOBAL enable_query_queue_select = true;
```

- 統計クエリのクエリキューを有効にする:

```SQL
SET GLOBAL enable_query_queue_statistic = true;
```

### リソースグループレベルのクエリキューを有効にする

v3.1.4以降、StarRocksはリソースグループレベルでのクエリキューの設定をサポートしています。

リソースグループレベルのクエリキューを有効にするには、上記のグローバルセッション変数に加えて`enable_group_level_query_queue`も設定する必要があります。

```SQL
SET GLOBAL enable_group_level_query_queue = true;
```

## リソースしきい値を指定する

### グローバルクエリキューのリソースしきい値を指定する

クエリキューをトリガーするしきい値は、以下のグローバルセッション変数を使用して設定できます：

| **変数**                        | **デフォルト** | **説明**                                              |
| ----------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_concurrency_limit       | 0           | BE上の同時クエリの上限。`0`より大きい値に設定した後にのみ有効になります。 |
| query_queue_mem_used_pct_limit      | 0           | BEのメモリ使用率の上限。`0`より大きい値に設定した後にのみ有効になります。範囲：[0, 1] |
| query_queue_cpu_used_permille_limit | 0           | BEのCPU使用率パーミル（CPU使用率×1000）の上限。`0`より大きい値に設定した後にのみ有効になります。範囲：[0, 1000] |

> **注記**
>
> デフォルトでは、BEは1秒間隔でリソース使用量をFEに報告します。この間隔は、BEの設定項目`report_resource_usage_interval_ms`を変更することで調整できます。

### リソースグループレベルのクエリキューのリソースしきい値を指定する

v3.1.4以降、リソースグループを作成する際に、個別の同時実行数制限（`concurrency_limit`）とCPUコア制限（`max_cpu_cores`）を設定できます。クエリが開始されたとき、グローバルレベルまたはリソースグループレベルでリソース消費がしきい値を超えると、すべてのリソース消費がしきい値内に収まるまでクエリはキューに入れられます。

| **変数**        | **デフォルト** | **説明**                                              |
| ------------------- | ----------- | ------------------------------------------------------------ |
| concurrency_limit   | 0           | 単一BEノード上のリソースグループの同時実行数制限。`0`より大きい値に設定された場合にのみ有効です。 |
| max_cpu_cores       | 0           | 単一BEノード上のこのリソースグループのCPUコア制限。`0`より大きい値に設定された場合にのみ有効です。範囲：[0, `avg_be_cpu_cores`]、ここで`avg_be_cpu_cores`はすべてのBEノードの平均CPUコア数を表します。 |

[リソースグループの使用情報を表示する](./resource_group.md#view-resource-group-usage-information)に記載されているように、SHOW USAGE RESOURCE GROUPSを使用して、各BEノード上の各リソースグループのリソース使用情報を確認できます。

### クエリの同時実行数を管理する

実行中のクエリの数（`num_running_queries`）がグローバルまたはリソースグループの`concurrency_limit`を超えると、受信クエリはキューに入れられます。`num_running_queries`の取得方法は、v3.1.4未満とv3.1.4以降で異なります。

- v3.1.4未満のバージョンでは、`num_running_queries`はBEによって`report_resource_usage_interval_ms`で指定された間隔で報告されます。したがって、`num_running_queries`の変化を識別するのに多少の遅れがあるかもしれません。例えば、BEが現時点で報告する`num_running_queries`がグローバルまたはリソースグループの`concurrency_limit`を超えていないが、次の報告前に受信クエリが到着して`concurrency_limit`を超えた場合、これらの受信クエリはキューで待機せずに実行されます。

- v3.1.4以降のバージョンでは、実行中のすべてのクエリはLeader FEによって集合的に管理されます。Follower FEはクエリの開始または終了時にLeader FEに通知し、StarRocksが`concurrency_limit`を超えるクエリが急増するシナリオを処理できるようにします。

## クエリキューを設定する

クエリキューの容量とキュー内のクエリの最大タイムアウトは、以下のグローバルセッション変数を使用して設定できます：

| **変数**                       | **デフォルト** | **説明**                                              |
| ---------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_max_queued_queries     | 1024        | キュー内のクエリの上限。このしきい値に達すると、受信クエリは拒否されます。`0`より大きい値に設定した後にのみ有効になります。 |
| query_queue_pending_timeout_second | 300         | キュー内の保留中のクエリの最大タイムアウト。このしきい値に達すると、該当するクエリは拒否されます。単位は秒です。 |

## クエリの同時実行数の動的調整を設定する


バージョン v3.1.4 以降、クエリキューによって管理され、Pipeline Engineによって実行されるクエリについて、StarRocksは現在実行中のクエリの数`num_running_queries`、フラグメントの数`num_fragments`、およびクエリの同時実行数`pipeline_dop`に基づいて、受信クエリのクエリ同時実行数`pipeline_dop`を動的に調整することができます。これにより、スケジューリングのオーバーヘッドを最小限に抑えつつ、クエリの同時実行性を動的に制御し、最適なBEリソース利用を実現します。フラグメントとクエリの同時実行数`pipeline_dop`についての詳細は、[クエリ管理 - クエリ同時実行数の調整](./Query_management.md)を参照してください。

StarRocksは、クエリキュー下の各クエリについて、単一のBE上でのクエリの同時フラグメントを表すドライバーという概念を維持しています。その論理値`num_drivers`は、単一のBE上でのそのクエリの全フラグメントの合計同時実行数を表し、`num_fragments * pipeline_dop`に等しくなります。新しいクエリが到着すると、StarRocksは以下のルールに基づいてクエリの同時実行数`pipeline_dop`を調整します：

- 実行中のドライバーの数`num_drivers`が同時実行ドライバーの下限`query_queue_driver_low_water`を超えるほど、クエリの同時実行数`pipeline_dop`は低く調整されます。
- StarRocksは、実行中のドライバーの数`num_drivers`をクエリの同時実行ドライバーの上限`query_queue_driver_high_water`以下に抑制します。

クエリの同時実行数`pipeline_dop`の動的調整は、以下のグローバルセッション変数を使用して設定できます：

| **変数**                        | **デフォルト** | **説明**                                                                                     |
| ------------------------------- | -------------- | -------------------------------------------------------------------------------------------- |
| query_queue_driver_high_water   | -1             | クエリの同時実行ドライバーの上限。非負の値に設定された場合のみ有効です。`0`に設定すると、`avg_be_cpu_cores * 16`と等価になります。ここで`avg_be_cpu_cores`は、全BEノードの平均CPUコア数を表します。`0`より大きい値に設定すると、その値が直接使用されます。 |
| query_queue_driver_low_water    | -1             | クエリの同時実行ドライバーの下限。非負の値に設定された場合のみ有効です。`0`に設定すると、`avg_be_cpu_cores * 8`と等価になります。`0`より大きい値に設定すると、その値が直接使用されます。 |

## クエリキューのモニタリング

クエリキューに関連する情報は、次の方法で確認できます。

### SHOW PROC

[SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md)を使用して、実行中のクエリの数、BEノードのメモリ使用率とCPU使用率を確認できます。

```Plain
mysql> SHOW PROC '/backends'\G
*************************** 1. row ***************************
...
    NumRunningQueries: 0
           MemUsedPct: 0.79 %
           CpuUsedPct: 0.0 %
```

### SHOW PROCESSLIST

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md)を使用して、クエリがキューにあるかどうか（`IsPending`が`true`の場合）を確認できます。

```Plain
mysql> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| Id   | User | Host                | Db    | Command | ConnectionStartTime | Time | State | Info              | IsPending |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
|    2 | root | xxx.xx.xxx.xx:xxxxx |       | Query   | 2022-11-24 18:08:29 |    0 | OK    | SHOW PROCESSLIST  | false     |
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
```

### FE監査ログ

FE監査ログファイル**fe.audit.log**を確認できます。フィールド`PendingTimeMs`は、クエリがキューで待機した時間をミリ秒単位で示します。

### FEメトリクス

以下のFEメトリクスは、各FEノードの統計データに基づいています。

| メトリック                                            | 単位   | タイプ       | 説明                                                                                                   |
| ----------------------------------------------------- | ------ | ------------ | ------------------------------------------------------------------------------------------------------ |
| starrocks_fe_query_queue_pending                      | Count  | Instantaneous | キュー内のクエリの現在の数。                                                                          |
| starrocks_fe_query_queue_total                        | Count  | Instantaneous | 履歴にキューに入れられたクエリの合計数（現在実行中のクエリを含む）。                                  |
| starrocks_fe_query_queue_timeout                      | Count  | Instantaneous | キュー内でタイムアウトしたクエリの合計数。                                                            |
| starrocks_fe_resource_group_query_queue_total         | Count  | Instantaneous | このリソースグループで履歴にキューに入れられたクエリの合計数（現在実行中のクエリを含む）。`name`ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |
| starrocks_fe_resource_group_query_queue_pending       | Count  | Instantaneous | このリソースグループのキューに現在あるクエリの数。`name`ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |
| starrocks_fe_resource_group_query_queue_timeout       | Count  | Instantaneous | このリソースグループのキュー内でタイムアウトしたクエリの数。`name`ラベルはリソースグループの名前を示します。v3.1.4以降でサポートされています。 |

### SHOW RUNNING QUERIES

v3.1.4以降、StarRocksは`SHOW RUNNING QUERIES`SQLステートメントをサポートしており、これは各クエリのキュー情報を表示するために使用されます。各フィールドの意味は以下の通りです：

- `QueryId`: クエリのID。
- `ResourceGroupId`: クエリがヒットしたリソースグループのID。ユーザー定義のリソースグループにヒットがない場合は「-」と表示されます。
- `StartTime`: クエリの開始時刻。
- `PendingTimeout`: PENDING状態のクエリがキューでタイムアウトする時刻。
- `QueryTimeout`: クエリがタイムアウトする時刻。
- `State`: クエリのキュー状態。「PENDING」はキュー内にあることを示し、「RUNNING」は現在実行中であることを示します。
- `Slots`: クエリによって要求される論理リソース量。現在は`1`に固定されています。
- `Frontend`: クエリを開始したFEノード。
- `FeStartTime`: クエリを開始したFEノードの開始時刻。

例：

```Plain
MySQL [(none)]> SHOW RUNNING QUERIES;
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| QueryId                              | ResourceGroupId | StartTime           | PendingTimeout      | QueryTimeout        |   State   | Slots | Frontend                        | FeStartTime         |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| a46f68c6-3b49-11ee-8b43-00163e10863a | -               | 2023-08-15 16:56:37 | 2023-08-15 17:01:37 | 2023-08-15 17:01:37 |  RUNNING  | 1     | 127.00.00.01_9010_1692069711535 | 2023-08-15 16:37:03 |
| a6935989-3b49-11ee-935a-00163e13bca3 | 12003           | 2023-08-15 16:56:40 | 2023-08-15 17:01:40 | 2023-08-15 17:01:40 |  RUNNING  | 1     | 127.00.00.02_9010_1692069658426 | 2023-08-15 16:37:03 |
| a7b5e137-3b49-11ee-8b43-00163e10863a | 12003           | 2023-08-15 16:56:42 | 2023-08-15 17:01:42 | 2023-08-15 17:01:42 |  PENDING  | 1     | 127.00.00.03_9010_1692069711535 | 2023-08-15 16:37:03 |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+