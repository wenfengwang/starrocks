---
displayed_sidebar: English
---

# FQDN アクセスを有効にする

このトピックでは、完全修飾ドメイン名 (FQDN) を使用してクラスターアクセスを有効にする方法について説明します。FQDN は、インターネット経由でアクセスできる特定のエンティティの**完全なドメイン名**です。FQDN は、ホスト名とドメイン名の 2 つの部分で構成されます。

バージョン 2.4 以前では、StarRocks は IP アドレス経由での FE と BE へのアクセスのみをサポートしていました。FQDN を使用してノードをクラスタに追加しても、最終的には IP アドレスに変換されてしまいます。これは、StarRocks クラスタ内の特定のノードの IP アドレスを変更すると、ノードへのアクセス障害につながる可能性があるため、DBA にとって大きな不便を引き起こします。バージョン 2.4 では、StarRocks は各ノードを IP アドレスから切り離しました。これにより、StarRocks のノードを FQDN のみで管理できるようになりました。

## 前提条件

StarRocks クラスターで FQDN アクセスを有効にするには、以下の要件が満たされていることを確認してください：

- クラスタ内の各マシンにはホスト名が必要です。

- 各マシンの **/etc/hosts** ファイルには、クラスタ内の他のマシンの対応する IP アドレスと FQDN を指定する必要があります。

- **/etc/hosts** ファイル内の IP アドレスはユニークである必要があります。

## FQDN アクセスで新しいクラスタを設定する

デフォルトでは、新しいクラスタ内の FE ノードは IP アドレスアクセスを介して起動されます。FQDN アクセスで新しいクラスタを起動するには、クラスタを初めて起動する際に次のコマンドを実行して FE ノードを起動する必要があります：

```Shell
./bin/start_fe.sh --host_type FQDN --daemon
```

プロパティ `--host_type` は、ノードを起動する際に使用されるアクセス方法を指定します。有効な値は `FQDN` と `IP` です。このプロパティは、ノードを初めて起動する際に一度だけ指定する必要があります。

StarRocks のインストール方法の詳細については、[StarRocks のデプロイ](../deployment/deploy_manually.md)を参照してください。

各 BE ノードは、FE メタデータで定義された `BE_Address` で自身を識別します。したがって、BE ノードを起動する際に `--host_type` を指定する必要はありません。`BE_Address` が FQDN を使用して BE ノードを定義している場合、BE ノードはこの FQDN で自身を識別します。

## 既存のクラスタで FQDN アクセスを有効にする

以前は IP アドレスを介して起動されていた既存のクラスタで FQDN アクセスを有効にするには、まず StarRocks をバージョン 2.4.0 以降にアップグレードする必要があります。

### FE ノードで FQDN アクセスを有効にする

リーダー FE ノードで FQDN アクセスを有効にする前に、非リーダー フォロワー FE ノードで FQDN アクセスを有効にする必要があります。

> **注意**
>
> FE ノードで FQDN アクセスを有効にする前に、クラスタに少なくとも 3 つのフォロワー FE ノードがあることを確認してください。

#### 非リーダー フォロワー FE ノードで FQDN アクセスを有効にする

1. FE ノードのデプロイメントディレクトリに移動し、以下のコマンドを実行して FE ノードを停止します：

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQL クライアントから以下のステートメントを実行し、停止した FE ノードの `Alive` ステータスを確認します。`Alive` ステータスが `false` になるまで待ちます。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

3. 次のステートメントを実行して、IP アドレスを FQDN に置き換えます：

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. 次のコマンドを実行して、FQDN アクセスで FE ノードを起動します：

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    プロパティ `--host_type` は、ノードを起動する際に使用されるアクセス方法を指定します。有効な値は `FQDN` と `IP` です。このプロパティは、ノードを変更した後にノードを再起動する際に一度だけ指定する必要があります。

5. FE ノードの `Alive` ステータスを確認します。`Alive` ステータスが `true` になるまで待ちます。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

6. 上記の手順を繰り返して、現在の FE ノードの `Alive` ステータスが `true` の場合、他の非リーダー フォロワー FE ノードで FQDN アクセスを一つずつ有効にします。

#### リーダー FE ノードで FQDN アクセスを有効にする

すべての非リーダー FE ノードが正常に変更および再起動されたら、リーダー FE ノードで FQDN アクセスを有効にできます。

> **注記**
>
> リーダー FE ノードで FQDN アクセスが有効になる前は、クラスタにノードを追加するために使用される FQDN は対応する IP アドレスに変換されます。FQDN アクセスが有効になっているリーダー FE ノードがクラスタに選出された後、FQDN は IP アドレスに変換されなくなります。

1. リーダー FE ノードのデプロイメントディレクトリに移動し、次のコマンドを実行してリーダー FE ノードを停止します：

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQL クライアントを介して次のステートメントを実行し、クラスタに新しいリーダー FE ノードが選出されたかどうかを確認します：

    ```SQL
    SHOW PROC '/frontends'\G
    ```

    ステータスが `Alive` で `isMaster` が `true` の FE ノードは、実行中のリーダー FE です。

3. 次のステートメントを実行して、IP アドレスを FQDN に置き換えます：

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. 次のコマンドを実行して、FQDN アクセスで FE ノードを起動します：

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    プロパティ `--host_type` は、ノードを起動する際に使用されるアクセス方法を指定します。有効な値は `FQDN` と `IP` です。このプロパティは、ノードを変更した後にノードを再起動する際に一度だけ指定する必要があります。

5. FE ノードの `Alive` ステータスを確認します。

    ```Plain
    SHOW PROC '/frontends'\G
    ```

`Alive` ステータスが `true` になれば、FE ノードは正常に変更され、フォロワー FE ノードとしてクラスタに追加されたことになります。

### BE ノードで FQDN アクセスを有効にする

MySQL クライアントを介して次のステートメントを実行し、IP アドレスを FQDN に置き換えて、BE ノードで FQDN アクセスを有効にします：

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_ip>" TO "<be_hostname>";
```

> **注記**
>
> FQDN アクセスを有効にした後、BE ノードを再起動する必要はありません。

## ロールバック

FQDN アクセスが有効な StarRocks クラスタを、FQDN アクセスをサポートしていない以前のバージョンにロールバックするには、まずクラスタ内のすべてのノードで IP アドレスアクセスを有効にする必要があります。一般的なガイダンスについては、[既存のクラスタで FQDN アクセスを有効にする](#enable-fqdn-access-in-an-existing-cluster)を参照してくださいが、SQL コマンドを次のように変更する必要があります：

- FE ノードで IP アドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY FRONTEND HOST "<fe_hostname>" TO "<fe_ip>";
```

- BE ノードで IP アドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_hostname>" TO "<be_ip>";
```

変更は、クラスタが正常に再起動された後に有効になります。

## FAQ

**Q: FE ノードで FQDN アクセスを有効にするときにエラーが発生しました：「1 つのレプリカが必要です。しかし、このマスターとアクティブなレプリカはありませんでした」。どうすればいいですか？**

A: FE ノードで FQDN アクセスを有効にする前に、クラスタに少なくとも 3 つのフォロワー FE ノードがあることを確認してください。

**Q: FQDN アクセスが有効になっているクラスタに IP アドレスを使用して新しいノードを追加できますか？**

A: はい。
