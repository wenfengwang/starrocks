---
displayed_sidebar: English
---

# ディスクへのスピル

このトピックでは、大規模なオペレーターの中間計算結果をディスクに書き出す方法について説明します。

## 概要

StarRocks のように、クエリ実行にインメモリ コンピューティングを依存するデータベース システムでは、大規模なデータセットに対する集約、ソート、結合オペレーターを使用したクエリ処理時に、大量のメモリ リソースを消費する可能性があります。メモリ制限に達すると、これらのクエリはメモリ不足 (OOM) により強制終了されます。

しかし、パフォーマンスが最優先ではなく、メモリ集約型のタスクを安定して完了させたい場合があります。例えば、マテリアライズドビューの構築や、INSERT INTO SELECT を使用した軽量ETLの実行などです。これらのタスクはメモリリソースを容易に枯渇させ、クラスターで実行中の他のクエリをブロックする可能性があります。通常、この問題に対処するためには、タスクを個別に微調整し、リソース分離戦略に依存してクエリの同時実行数を制御するしかありません。これは特に不便で、極端なシナリオでは失敗する可能性が高いです。

StarRocks v3.0.1 から、StarRocks はメモリ集約型の一部オペレーターの中間結果をディスクにスピルする機能をサポートしています。この機能を利用することで、許容できるパフォーマンスの低下と引き換えに、メモリ使用量を大幅に削減し、システムの可用性を向上させることができます。

現在、StarRocks のスピル機能は以下のオペレーターをサポートしています：

- 集約オペレーター
- ソートオペレーター
- ハッシュ結合 (LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN、INNER JOIN) オペレーター

## 中間結果のスピルを有効にする

中間結果のスピルを有効にするには、以下の手順に従ってください：

1. BE設定ファイル **be.conf** にスピルされた中間結果を格納するディレクトリ `spill_local_storage_dir` を指定し、クラスタを再起動して変更を有効にします。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **注記**
   >
   > - 複数の `spill_local_storage_dir` をセミコロン (`;`) で区切って指定できます。
   > - 運用環境では、データストレージとスピル用の異なるディスクを使用することを強く推奨します。中間結果がディスクにスピルされると、書き込み負荷とディスク使用量が大幅に増加する可能性があります。同じディスクを使用すると、この急増がクラスタ内で実行されている他のクエリやタスクに影響を与える可能性があります。

2. 次のステートメントを実行して中間結果のスピルを有効にします：

   ```SQL
   SET enable_spill = true;
   ```

3. セッション変数 `spill_mode` を使用して中間結果のスピルモードを設定します：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **注記**
   >
   > スピルを伴うクエリが完了するたびに、StarRocks はクエリによって生成されたスピルデータを自動的にクリアします。BEがデータをクリアする前にクラッシュした場合、StarRocks はBEが再起動されたときにデータをクリアします。

   | **変数** | **デフォルト** | **説明**                                              |
   | ------------ | ----------- | ------------------------------------------------------------ |
   | enable_spill | false       | 中間結果のスピルを有効にするかどうか。`true` に設定すると、StarRocks はクエリで集約、ソート、または結合オペレーターを処理する際のメモリ使用量を削減するために中間結果をディスクにスピルします。 |
   | spill_mode   | auto        | 中間結果のスピル実行モード。有効な値：<ul><li>`auto`：メモリ使用量のしきい値に達したときにスピルが自動的にトリガされます。</li><li>`force`：StarRocks はメモリ使用量に関係なく、関連するすべてのオペレーターに対して強制的にスピルを実行します。</li></ul>この変数は、`enable_spill` が `true` に設定されている場合のみ有効です。 |

## 制限事項

- スピルによってすべてのOOM問題が解決されるわけではありません。例えば、StarRocks は式評価に使用されるメモリを解放することはできません。
- 通常、スピルを伴うクエリはクエリ待機時間が10倍に増加することを意味します。これらのクエリのクエリタイムアウトを延長するために、セッション変数 `query_timeout` を設定することを推奨します。
