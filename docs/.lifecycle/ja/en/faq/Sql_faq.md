---
displayed_sidebar: English
---

# SQL

このトピックでは、SQLに関するよくある質問とその回答を提供します。

## マテリアライズドビューをビルドする際に「メモリの割り当てに失敗しました。」というエラーが発生します

この問題を解決するには、**be.conf** ファイル内の `memory_limitation_per_thread_for_schema_change` パラメータの値を増やしてください。このパラメータは、スキーマ変更の単一タスクに割り当てることができる最大ストレージを指します。最大ストレージのデフォルト値は2GBです。

## StarRocksはクエリ結果をキャッシュすることをサポートしていますか？

StarRocksは最終的なクエリ結果を直接キャッシュしません。バージョン2.5以降、StarRocksはクエリキャッシュ機能を使用して、第一段階の集約の中間結果をキャッシュに保存します。以前のクエリと意味的に同等の新しいクエリは、キャッシュされた計算結果を再利用して計算を加速することができます。クエリキャッシュはBEメモリを使用します。詳細は[クエリキャッシュ](../using_starrocks/query_cache.md)をご覧ください。

## `Null`を含む計算を行った場合、ISNULL()関数を除く関数の計算結果がfalseになるのはなぜですか？

標準SQLでは、`NULL`値を含むオペランドを持つすべての計算は`NULL`を返します。

## BIGINTデータ型の値に引用符を付けて等価クエリを実行した後、クエリ結果が正しくないのはなぜですか？

### 問題の説明

以下の例を参照してください：

```plaintext
select cust_id,idno 

from llyt_dev.dwd_mbr_custinfo_dd 

where Pt= '2021-06-30' 

and cust_id = '20210129005809043707' 

limit 10 offset 0;
+---------------------+-----------------------------------------+

|   cust_id           |      idno                               |

+---------------------+-----------------------------------------+

|  20210129005809436  | yjdgjwsnfmdhjw294F93kmHCNMX39dw=        |

|  20210129005809436  | sdhnswjwijeifme3kmHCNMX39gfgrdw=        |

|  20210129005809436  | Tjoedk3js82nswndrf43X39hbggggbw=        |

|  20210129005809436  | denuwjaxh73e39592jwshbnjdi22ogw=        |

|  20210129005809436  | ckxwmsd2mei3nrunjrihj93dm3ijin2=        |

|  20210129005809436  | djm2emdi3mfi3mfu4jro2ji2ndimi3n=        |

+---------------------+-----------------------------------------+
select cust_id,idno 

from llyt_dev.dwd_mbr_custinfo_dd 

where Pt= '2021-06-30' 

and cust_id = 20210129005809043707 

limit 10 offset 0;
+---------------------+-----------------------------------------+

|   cust_id           |      idno                               |

+---------------------+-----------------------------------------+

|  20210189979989976  | xuywehuhfuhruehfurhghcfCNMX39dw=        |

+---------------------+-----------------------------------------+
```

### 解決策

STRINGデータ型とINTEGERデータ型を比較する場合、これら2つの型のフィールドはDOUBLEデータ型にキャストされます。そのため、引用符を追加することはできません。そうでないと、WHERE句で定義された条件にインデックスを付けることができなくなります。

## StarRocksはDECODE関数をサポートしていますか？

StarRocksはOracleデータベースのDECODE関数をサポートしていません。StarRocksはMySQLと互換性がありますので、CASE WHEN文を使用することができます。

## StarRocksのプライマリキーテーブルにデータをロードした直後に最新のデータをクエリできますか？

はい。StarRocksはGoogle Mesaを参照してデータをマージします。StarRocksでは、BEがデータマージをトリガーし、2種類のコンパクションを使用してデータをマージします。データマージが完了していない場合は、クエリ中に完了します。したがって、データロード後に最新のデータを読み取ることができます。

## StarRocksに保存されたutf8mb4文字が切り捨てられたり、文字化けしたりすることはありますか？

いいえ。

## `alter table`コマンドを実行すると「テーブルの状態が正常ではありません」というエラーが発生します

このエラーは、以前の変更がまだ完了していないために発生します。以前の変更の状態を確認するには、以下のコードを実行してください：

```SQL
show tablet from lineitem where State="ALTER"; 
```

変更操作にかかる時間はデータ量に依存します。一般的に、変更は数分で完了します。テーブルを変更している間はStarRocksへのデータロードを停止することをお勧めします。データロードは変更が完了する速度を低下させるためです。

## Apache Hiveの外部テーブルをクエリすると「get partition detail failed: org.apache.doris.common.DdlException: get hive partition meta data failed: java.net.UnknownHostException:hadooptest」というエラーが発生します

このエラーはApache Hiveパーティションのメタデータが取得できない場合に発生します。この問題を解決するには、**core-site.xml** と **hdfs-site.xml** を **fe.conf** ファイルと **be.conf** ファイルにコピーしてください。

## データをクエリする際に「planner use long time 3000 remaining task num 1」というエラーが発生します

このエラーは通常、フルガベージコレクション（フルGC）が原因で発生し、バックエンドモニタリングと **fe.gc** ログを使用して確認できます。この問題を解決するには、以下のいずれかの操作を実行してください。


- SQLのクライアントが複数のフロントエンド(FEs)に同時にアクセスして負荷を分散できるようにします。
- **fe.conf** ファイルで Java Virtual Machine (JVM) のヒープサイズを 8 GB から 16 GB に変更して、メモリを増やし、フル GC の影響を軽減します。

## 列 A のカーディナリティが小さい場合、`select B from tbl order by A limit 10` のクエリ結果は毎回異なります

SQL は列 A が順序付けされることのみを保証でき、列 B の順序が各クエリで同じであることは保証できません。MySQL はスタンドアロンデータベースであるため、列 A と列 B の順序を保証できます。

StarRocks は分散データベースであり、基盤となるテーブルに格納されているデータはシャーディングパターンです。列 A のデータは複数のマシンに分散されているため、複数のマシンによって返される列 B の順序はクエリごとに異なる可能性があり、結果として毎回 B の順序が一貫しません。この問題を解決するには、`select B from tbl order by A limit 10` を `select B from tbl order by A,B limit 10` に変更します。

## SELECT * と SELECT の間でカラム効率に大きな差があるのはなぜですか?

この問題を解決するには、プロファイルをチェックし、MERGE の詳細を見ます：

- ストレージレイヤーでの集約に時間がかかりすぎていないか確認してください。

- インジケーター列が多すぎないか確認してください。その場合は、数百万行の数百の列を集約します。

```plaintext
MERGE:

    - aggr: 26s270ms

    - sort: 15s551ms
```

## DELETE はネストされた関数をサポートしていますか?

ネストされた関数はサポートされていません。例えば、`DELETE from test_new WHERE to_days(now())-to_days(publish_time) > 7;` の `to_days(now())` は使用できません。

## 何百ものテーブルがあるデータベースの使用効率を向上させるにはどうすればいいですか?

効率を向上させるには、MySQLのクライアントサーバーに接続する際に `-A` パラメータを追加します：`mysql -uroot -h127.0.0.1 -P8867 -A`。MySQLのクライアントサーバーはデータベース情報を事前に読み込みません。

## BEログとFEログが占めるディスク容量を減らすにはどうすればいいですか?

ログレベルと対応するパラメータを調整します。詳細については、[パラメータ設定](../administration/BE_configuration.md)を参照してください。

## このエラー「テーブル *** はコロケートテーブルで、replicationNum を変更できません」がレプリケーション数を変更しようとすると発生します

コロケートテーブルを作成する際には `group` プロパティを設定する必要があります。したがって、単一のテーブルのレプリケーション数を変更することはできません。グループ内のすべてのテーブルのレプリケーション数を変更するには、以下の手順を実行します：

1. グループ内のすべてのテーブルの `group_with` を `empty` に設定します。
2. グループ内のすべてのテーブルに適切な `replication_num` を設定します。
3. `group_with` を元の値に戻します。

## VARCHAR を最大値に設定すると、ストレージに影響しますか?

VARCHAR は可変長データ型で、実際のデータ長に基づいて変更可能な指定された長さがあります。テーブル作成時に異なる VARCHAR 長を指定しても、同じデータに対するクエリパフォーマンスにはほとんど影響しません。

## このエラー「create partition timeout」はテーブルを切り捨てる際に発生します

テーブルを切り捨てるには、対応するパーティションを作成してから交換する必要があります。作成する必要があるパーティションの数が多い場合、このエラーが発生することがあります。また、多数のデータロードタスクがある場合、コンパクションプロセス中にロックが長時間保持されるため、テーブル作成時にロックを取得できないことがあります。データロードタスクが多すぎる場合は、**be.conf** ファイルで `tablet_map_shard_size` を `512` に設定して、ロック競合を減らします。

## このエラー「Failed to specify server's Kerberos principal name」が Apache Hive の外部テーブルにアクセスする際に発生します

**fe.conf** ファイルと **be.conf** ファイルの **hdfs-site.xml** に以下の情報を追加します：

```HTML
<property>
<name>dfs.namenode.kerberos.principal.pattern</name>
<value>*</value>
</property>
```

## 「2021-10」は StarRocks の日付形式ですか?

いいえ。

## 「2021-10」をパーティションフィールドとして使用できますか?

いいえ、「2021-10」を「2021-10-01」に変更してから、「2021-10-01」をパーティションフィールドとして使用してください。

## StarRocks のデータベースやテーブルのサイズはどこで問い合わせることができますか?

[SHOW DATA](../sql-reference/sql-statements/data-manipulation/SHOW_DATA.md) コマンドを使用できます。

`SHOW DATA;` は、現在のデータベースにある全てのテーブルのデータサイズとレプリカ数を表示します。

`SHOW DATA FROM <db_name>.<table_name>;` は、指定されたデータベースの指定されたテーブルのデータサイズ、レプリカ数、及び行数を表示します。
