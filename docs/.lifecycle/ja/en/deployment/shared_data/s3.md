---
displayed_sidebar: English
---

# S3を共有データとして使用する

import SharedDataIntro from '../../assets/commonMarkdown/sharedDataIntro.md'
import SharedDataCNconf from '../../assets/commonMarkdown/sharedDataCNconf.md'
import SharedDataUseIntro from '../../assets/commonMarkdown/sharedDataUseIntro.md'
import SharedDataUse from '../../assets/commonMarkdown/sharedDataUse.md'

<SharedDataIntro />

## アーキテクチャ

![共有データアーキテクチャ](../../assets/share_data_arch.png)

## 共有データStarRocksクラスターをデプロイする

共有データStarRocksクラスターのデプロイは、共有ノーシングStarRocksクラスターのデプロイと似ています。唯一の違いは、共有データクラスターではBEではなくCNをデプロイする必要があることです。このセクションでは、共有データStarRocksクラスターをデプロイする際に、FEおよびCNの設定ファイル**fe.conf**と**cn.conf**に追加する必要がある追加のFEおよびCN設定項目のみをリストします。StarRocksクラスターのデプロイの詳細については、[StarRocksのデプロイ](../../deployment/deploy_manually.md)を参照してください。

> **注記**
>
> このドキュメントの次のセクションで共有ストレージ用に設定されるまで、クラスターを起動しないでください。

## 共有データStarRocksのFEノードを設定する

クラスターを開始する前に、FEとCNを設定します。以下に設定例を示し、その後で各パラメータの詳細を提供します。

### S3のFE設定例

これらは、FEノードの`fe.conf`ファイルに対する共有データの追加例です。例は使用されるAWS認証方法に基づいて異なります。

#### デフォルト認証資格情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_aws_sdk_default_behavior = true

# 上記の詳細を使用してオブジェクトストレージにデフォルト
# ストレージを作成したくない場合は、これをfalseに設定します
enable_load_volume_from_conf = true
```

#### IAMユーザーベースの認証資格情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# S3オブジェクトの読み書きのための認証情報
aws_s3_access_key = <access_key>
aws_s3_secret_key = <secret_key>

# 上記の詳細を使用してオブジェクトストレージにデフォルト
# ストレージを作成したくない場合は、これをfalseに設定します
enable_load_volume_from_conf = true
```

#### インスタンスプロファイル

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true

# 上記の詳細を使用してオブジェクトストレージにデフォルト
# ストレージを作成したくない場合は、これをfalseに設定します
enable_load_volume_from_conf = true
```

#### アサインされたロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>

# 上記の詳細を使用してオブジェクトストレージにデフォルト
# ストレージを作成したくない場合は、これをfalseに設定します
enable_load_volume_from_conf = true
```

#### 外部アカウントからのアサインされたロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>
aws_s3_external_id = <external_id>

# 上記の詳細を使用してオブジェクトストレージにデフォルト
# ストレージを作成したくない場合は、これをfalseに設定します
enable_load_volume_from_conf = true
```

### S3を使用した共有ストレージに関連するすべてのFEパラメータ

#### run_mode

StarRocksクラスターの実行モード。有効な値:

- `shared_data`
- `shared_nothing`（デフォルト）。

> **注記**
>
> StarRocksクラスターでは、`shared_data`と`shared_nothing`モードを同時に採用することはできません。混在デプロイはサポートされていません。
>
> クラスターがデプロイされた後に`run_mode`を変更しないでください。そうすると、クラスターは再起動に失敗します。共有ノーシングクラスターから共有データクラスターへ、またはその逆への変換はサポートされていません。

#### cloud_native_meta_port

クラウドネイティブメタサービスRPCポート。

- デフォルト: `6090`

#### enable_load_volume_from_conf


StarRocksがFE設定ファイルに指定されたオブジェクトストレージ関連のプロパティを使用してデフォルトのストレージボリュームを作成するかどうかを決定します。有効な値:

- `true` (デフォルト) 新しい共有データクラスタを作成する際にこの項目を`true`に設定すると、StarRocksはFE設定ファイルのオブジェクトストレージ関連のプロパティを使用してビルトインストレージボリューム`builtin_storage_volume`を作成し、それをデフォルトのストレージボリュームとして設定します。ただし、オブジェクトストレージ関連のプロパティが指定されていない場合、StarRocksは起動に失敗します。
- `false` 新しい共有データクラスタを作成する際にこの項目を`false`に設定すると、StarRocksはビルトインストレージボリュームを作成せずに直接起動します。StarRocksでオブジェクトを作成する前に、ストレージボリュームを手動で作成し、それをデフォルトのストレージボリュームとして設定する必要があります。詳細は[デフォルトのストレージボリュームを作成する](#use-your-shared-data-starrocks-cluster)を参照してください。

v3.1.0からサポートされています。

> **注意**
>
> 既存の共有データクラスタをv3.0からアップグレードする際は、この項目を`true`に設定したままにすることを強く推奨します。この項目を`false`に設定すると、アップグレード前に作成したデータベースとテーブルは読み取り専用となり、データのロードができなくなります。

#### cloud_native_storage_type

使用するオブジェクトストレージのタイプです。共有データモードでは、StarRocksはAzure Blob（v3.1.1以降でサポート）およびS3プロトコルと互換性のあるオブジェクトストレージ（AWS S3、Google GCP、MinIOなど）でのデータ保存をサポートしています。有効な値:

- `S3` (デフォルト)
- `AZBLOB`.

#### aws_s3_path

データを保存するためのS3パスです。これは、S3バケットの名前とその下のサブパス（ある場合）で構成されます。例: `testbucket/subpath`。

#### aws_s3_endpoint

S3バケットにアクセスするためのエンドポイントです。例: `https://s3.us-west-2.amazonaws.com`。

#### aws_s3_region

S3バケットが存在するリージョンです。例: `us-west-2`。

#### aws_s3_use_aws_sdk_default_behavior

[AWS SDKのデフォルト認証情報プロバイダーチェーン](https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html)を使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)。

#### aws_s3_use_instance_profile

S3へのアクセスにInstance ProfileとAssumed Roleを認証方法として使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)。

IAMユーザーベースの認証情報（アクセスキーとシークレットキー）を使用してS3にアクセスする場合、この項目を`false`に設定し、`aws_s3_access_key`と`aws_s3_secret_key`を指定する必要があります。

Instance Profileを使用してS3にアクセスする場合、この項目を`true`に設定する必要があります。

Assumed Roleを使用してS3にアクセスする場合、この項目を`true`に設定し、`aws_s3_iam_role_arn`を指定する必要があります。

外部AWSアカウントを使用する場合は、`aws_s3_external_id`も指定する必要があります。

#### aws_s3_access_key

S3バケットにアクセスするためのアクセスキーIDです。

#### aws_s3_secret_key

S3バケットにアクセスするためのシークレットアクセスキーです。

#### aws_s3_iam_role_arn

データファイルが保存されているS3バケットに権限を持つIAMロールのARNです。

#### aws_s3_external_id

S3バケットへのクロスアカウントアクセスに使用されるAWSアカウントの外部IDです。

> **注記**
>
> 共有データStarRocksクラスタが作成された後に変更できるのは、認証情報に関連する設定項目のみです。元のストレージパス関連の設定項目を変更した場合、変更前に作成されたデータベースとテーブルは読み取り専用となり、データのロードができなくなります。

クラスタが作成された後にデフォルトのストレージボリュームを手動で作成する場合は、以下の設定項目を追加するだけで済みます。

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
enable_load_volume_from_conf = false
```

## 共有データStarRocksのCNノードを構成する
<SharedDataCNconf />

## 共有データStarRocksクラスタを使用する

<SharedDataUseIntro />

次の例では、IAM ユーザーベースの認証情報（アクセスキーとシークレットキー）を使用して AWS S3 バケット `defaultbucket` 用のストレージボリューム `def_volume` を作成し、ストレージボリュームを有効にして、デフォルトのストレージボリュームとして設定します。

```SQL
CREATE STORAGE VOLUME def_volume
TYPE = S3
LOCATIONS = ("s3://defaultbucket/test/")
PROPERTIES
(
    "enabled" = "true",
    "aws.s3.region" = "us-west-2",
    "aws.s3.endpoint" = "https://s3.us-west-2.amazonaws.com",
    "aws.s3.use_aws_sdk_default_behavior" = "false",
    "aws.s3.use_instance_profile" = "false",
    "aws.s3.access_key" = "xxxxxxxxxx",
    "aws.s3.secret_key" = "yyyyyyyyyy"
);

SET def_volume AS DEFAULT STORAGE VOLUME;
```

<SharedDataUse />
