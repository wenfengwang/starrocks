---
displayed_sidebar: "Japanese"
---

# マテリアライズド・ビューを使用したデータモデリング

本トピックでは、StarRocksの非同期マテリアライズド・ビューを利用してデータモデリングを行う方法について説明します。これにより、データウェアハウスのETLパイプラインを大幅に簡素化し、データの品質とクエリのパフォーマンスを大幅に向上させることができます。

## 概要

データモデリングとは、合理的な手法を用いてデータをクリーニング、レイヤリング、集計、結合するプロセスです。これにより、直接分析することが難しい、複雑すぎる、あるいはコストがかかりすぎる生データの分かりやすい表現を作成し、データに関する具体的な洞察を提供することができます。

しかし、実際のデータモデリングにおける一般的な課題は、モデリングプロセスがビジネスの発展のスピードに対応するのが難しいこと、そしてデータモデリングの投資リターンを測定するのが難しいことです。モデリング手法はシンプルである一方で、ビジネスの専門家には複雑なデータの組織化とガバナンスに関する強固な背景が求められます。ビジネスの初期段階では、意思決定者はデータモデリングに十分なリソースを割くことはまれであり、データモデリングがもたらす価値を認識することが難しいです。さらに、ビジネスモデルは急速に変化することがあり、モデリング手法自体も繰り返し改善される必要があります。そのため、多くのデータアナリストはモデリングを避け、生データを直接使用してしまいます。これにより、データ品質とクエリのパフォーマンスの問題が避けられません。モデリングの必要性が生じた時点で、既に確立されたデータ分析パターンをデータモデルに合わせることが困難になります。

マテリアライズド・ビューを使用することで、これらの問題に効果的に対処することができます。 StarRocksの非同期マテリアライズド・ビューを使用すると、以下のような効果があります。

- **データウェアハウスのアーキテクチャを簡素化**: StarRocksは総合的なデータガバナンス体験を提供できるため、他のデータ処理システムを維持する必要がなく、それに費やされる人的およびシステムリソースを節約できます。
- **データモデリングの経験を容易にする**: 基本的なSQLの知識だけで、どのデータアナリストでもStarRocksを使用してデータモデリングが可能です。データモデリングはもはや経験豊富なデータエンジニアだけのものではありません。
- **メンテナンスの複雑さを削減**: StarRocksの非同期マテリアライズド・ビューは、データ層間のラインリレーションシップや依存関係を自動的に管理するため、これを行うためのデータプラットフォーム全体を必要としません。

![Modeling-1](../assets/Modeling-1.png)

実際の状況では、StarRocksのビュー（論理ビュー）と非同期マテリアライズド・ビューを組み合わせてデータモデリングを行うことができます。

1. ビューを使用してリアルタイムデータを次元データに関連付け、非同期マテリアライズド・ビューを使用してデータレイクからの歴史データを次元データに関連付けます。必要なデータクリーニングとセマンティックマッピングを行い、ビジネスシナリオで必要とされるセマンティクスを反映する中間レイヤーの詳細データを取得します。
2. アプリケーションレイヤーでは、ビジネスシナリオに合わせてデータの結合、集計、統合、ウィンドウ計算を行います。これにより、リアルタイムパイプライン用のビューとほぼリアルタイムパイプライン用の非同期マテリアライズド・ビューが得られます。
3. アプリケーション側では、クエリ分析に適した適切な分析データストア（ADS）を選択します。これにより、リアルタイムダッシュボード、ほぼリアルタイムBI、アドホッククエリ、定期レポートを提供できます。

このプロセスでは、StarRocksのいくつかの組み込み機能を活用することになります。これについては次のセクションで詳しく説明します。

## 非同期マテリアライズド・ビューの機能

StarRocksの非同期マテリアライズド・ビューには、データモデリングに役立つ以下の機能が備わっています。

- **自動リフレッシュ**: ベーステーブルにデータがロードされた後、非同期マテリアライズド・ビューは自動的にリフレッシュされます。外部のスケジュールタスクを維持する必要はありません。
- **パーティション化されたリフレッシュ**: 時系列のテーブルをベースとした非同期マテリアライズド・ビューのパーティション化されたリフレッシュを介して、ほぼリアルタイムの計算が可能です。
- **ビューとのシナジー**: マテリアライズド・ビューと論理ビューを使用することで、多層のモデリングを実現し、中間レイヤーの再利用とデータモデルの簡素化を可能にします。
- **スキーマの変更**: 複雑なデータパイプラインの修正を行うことなく、簡単なSQL文により計算結果を変更できます。

これらの機能により、様々なビジネスニーズやシナリオに対応する包括的で適応性のあるデータモデルを設計することができます。
| **変更構文**                     | ALTER VIEW                                                   | ALTER MATERIALIZED VIEW                                      |

ビュー、マテリアライズドビュー、およびベーステーブルを変更するために、以下のステートメントを使用できます。

```SQL
-- テーブルを変更する。
ALTER TABLE <table_name> ADD COLUMN <column_desc>;

-- 2 つのテーブルを入れ替える。
ALTER TABLE <table1> SWAP WITH <table2>;

-- ビューの定義を変更する。
ALTER VIEW <view_name> AS <query>;

-- 2 つのマテリアライズドビューを入れ替える
-- （データに影響を与えずに 2 つのマテリアライズドビューの名前を入れ替える）。
ALTER MATERIALIZED VIEW <mv1> SWAP WITH <mv2>;

-- マテリアライズドビューを再アクティブ化する。
ALTER MATERIALIZED VIEW <mv_name> ACTIVE;
```

スキーマ変更は次の原則に従います。

- テーブルの名前変更および入れ替え操作は、依存するマテリアライズドビューを非アクティブに設定します。スキーマ変更操作では、基本テーブルの列がマテリアライズドビューに参照される場合にのみ、依存するマテリアライズドビューが非アクティブに設定されます。
- ビューの定義を変更すると、依存するマテリアライズドビューが非アクティブに設定されます。
- マテリアライズドビューが入れ替わると、それに基づくネストしたマテリアライズドビューが非アクティブに設定されます。
- 非アクティブ状態は、マテリアライズドビューの依存関係がなくなるまで連鎖します。
- 非アクティブなマテリアライズドビューは更新できず、自動的なクエリの書き換えに使用することはできません。
- 非アクティブなマテリアライズドビューは直接クエリできますが、再びアクティブになるまでデータの整合性は保証されません。

非アクティブなマテリアライズドビューのデータ整合性が保証されない一方で、それらの機能を復元する方法については、次の方法を使用できます。

- **手動修復**: ALTER MATERIALIZED VIEW `<mv_name>` ACTIVE を実行することで、非アクティブなマテリアライズドビューを手動で修復できます。このステートメントにより、元の SQL 定義に基づいてマテリアライズドビューが再作成されます。ただし、基礎となるスキーマの変更後も SQL 定義が有効である必要があります。さもないと、操作は失敗します。
- **自動修復**: StarRocks は非アクティブなマテリアライズドビューを自動的にアクティブ化しようと試みます。ただし、このプロセスのタイミングを保証することはできません。

## パーティションモデリング

階層化モデリングに加えて、パーティションモデリングもデータモデリングの重要な側面です。データモデリングにおいて、データのビジネスセマンティクスに基づいてデータを関連付け、タイムリー要件に応じてデータの Time-To-Live（TTL）を設定することが一般的です。パーティションモデリングはこのプロセスで重要な役割を果たします。

パーティションモデリングは、階層化モデリングを補完するデータモデリングの重要な側面です。ビジネスのセマンティクスに基づいてデータを関連付け、データのタイムリー要件に合わせて TTL を設定することが含まれます。データのパーティショニングはこのプロセスで重要な役割を果たします。

さまざまなデータの関連付け方によって、スタースキーマやスノーフレークスキーマなどのさまざまなモデリングアプローチが生まれます。これらのモデルには共通点があります - すべてがファクトテーブルとディメンジョンテーブルを使用します。一部のビジネスシナリオでは複数の大規模なファクトテーブルが必要となり、他のシナリオでは複雑なディメンジョンテーブルやそれらの関係が重要となります。StarRocks のマテリアライズドビューは、ファクトテーブル向けのパーティション関連付をサポートしており、これによりファクトテーブルがパーティション分割され、マテリアライズドビューの結果も同様にパーティション分割されます。

![Modeling-2](../assets/Modeling-2.png)

上記の図に示すように、マテリアライズドビューはファクトテーブルを複数のディメンジョンテーブルに関連付けます。

- マテリアライズドビューのパーティショニングキー (`PARTITION BY fact_tbl.col`) に特定の基本テーブル（通常はファクトテーブル）のパーティションキーを参照する必要があります。各マテリアライズドビューは 1 つの基本テーブルとのみ関連付けることができます。
- 参照テーブルの特定のパーティションのデータが変更されると、マテリアライズドビューの対応するパーティションが他のパーティションに影響を与えることなく更新されます。
- 他の参照テーブルのデータが変更されると、通常はマテリアライズドビュー全体が更新されます。ただし、特定の参照基本テーブルのデータ変更を無視し、それによってマテリアライズドビュー全体が更新されないよう選択することができます。

このパーティション関連付はさまざまなビジネスシナリオをサポートします。

- **ファクトテーブルの更新**: ファクトテーブルを日次または時間単位などの細かいレベルでパーティション分割することができます。ファクトテーブルが更新された後、マテリアライズドビューの対応するパーティションが自動的に更新されます。
- **ディメンジョンテーブルの更新**: 通常、ディメンジョンテーブルのデータ更新は関連するすべての結果の更新につながりますが、これはコストがかかります。一部のディメンジョンテーブルのデータ更新を無視してマテリアライズドビュー全体を更新しないよう選択することもできます。また、時間範囲を指定して特定の時間範囲内のパーティションのみを更新するようにすることもできます。
- **外部テーブルの自動更新**: Apache Hive や Apache Iceberg などの外部データソースでは、パーティションレベルでデータが変更されます。StarRocks のマテリアライズドビューは外部カタログの変更をパーティションレベルで購読し、その対応するパーティションのマテリアライズドビューのみを更新します。
- **TTL**: マテリアライズドビューのパーティショニング戦略を設定する際に、最近のパーティションの数を保持するように指定することができます。これは、アナリストが特定の時間枠から最新のデータのみを問い合わせ、すべての履歴データを保持する必要がないビジネスシナリオに有用です。

更新動作を制御するために複数のパラメータが使用できます。

- `partition_refresh_number`: 各更新操作で更新するパーティションの数。
- `partition_ttl_number`: 保持する最近のパーティションの数。
- `excluded_trigger_tables`: 自動更新をトリガーさせないようにするためにデータ更新を無視するテーブル。
- `auto_refresh_partitions_limit`: 各自動更新操作で更新するパーティションの数。

詳細については、[CREATE MATERIALIZED VIEW](../sql-reference/sql-statements/data-definition/CREATE_MATERIALIZED_VIEW.md) を参照してください。

現在、パーティションされたマテリアライズドビューには次の制限があります。

- パーティションされたテーブルを基にしてパーティションされたマテリアライズドビューを構築することしかできません。
- パーティショニングキーとして DATE 型または DATETIME 型の列のみを使用できます。STRING データ型はサポートされていません。
- date_trunc、time_slice、および date_slice 関数を使用してパーティションのロールアップを実行することしかできません。
- パーティショニングキーとして単一の列のみを指定できます。複数のパーティショニング列はサポートされていません。

## 要約

StarRocks の非同期マテリアライズドビューをデータモデリングに活用することによって、パイプラインの管理を簡素化し、宣言的なモデリング言語を通じてデータモデリングの効率と柔軟性を向上させる利点があります。

データモデリング以外にも、StarRocks の非同期マテリアライズドビューは、透過的な加速やデータレイク統合を含むさまざまなシナリオで活用されます。これにより、データの価値をさらに探求し、データの効率を向上させることができます。