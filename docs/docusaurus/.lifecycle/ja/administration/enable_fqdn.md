---
displayed_sidebar: "Japanese"
---

# FQDNアクセスを有効にする

このトピックでは、完全修飾ドメイン名（FQDN）を使用してクラスタアクセスを有効にする方法について説明します。FQDNは、インターネット経由でアクセスできる特定のエンティティの**完全なドメイン名**です。FQDNは、ホスト名とドメイン名の2つの部分で構成されています。

2.4より前に、StarRocksはFEとBEへのアクセスをIPアドレスのみでサポートしていました。StarRocksクラスタにノードを追加する際にFQDNを使用しても、最終的にはIPアドレスに変換されます。これにより、特定のノードのIPアドレスを変更すると、StarRocksクラスタへのアクセス障害が発生するため、DBAにとって大きな不便が生じます。バージョン2.4では、StarRocksは各ノードをIPアドレスから切り離します。これにより、StarRocksのノードはFQDNのみで管理できるようになります。

## 前提条件

StarRocksクラスタでFQDNアクセスを有効にするには、次の要件を満たしてください：

- クラスタ内の各マシンには、ホスト名が設定されている必要があります。

- 各マシンの **/etc/hosts** ファイルで、クラスタ内の他のマシンの対応するIPアドレスとFQDNを指定する必要があります。

- **/etc/hosts** ファイル内のIPアドレスは一意である必要があります。

## FQDNアクセスが有効なクラスタをセットアップする

デフォルトでは、新しいクラスタのFEノードはIPアドレスアクセスを介して起動されます。FQDNアクセスを有効なクラスタをセットアップするには、最初にクラスタを起動する際に次のコマンドを実行してFEノードを起動する必要があります。

```Shell
./bin/start_fe.sh --host_type FQDN --daemon
```

`--host_type` プロパティはノードの起動に使用されるアクセス方式を指定します。有効な値には `FQDN` および `IP` が含まれます。ノードを初めて起動する際にこのプロパティを指定する必要があります。

StarRocksの詳しいインストール手順については、[StarRocksのデプロイ](../deployment/deploy_manually.md) を参照してください。

各BEノードは、FEメタデータで定義された `BE Address` で自身を識別します。そのため、BEノードを起動する際に `--host_type` を指定する必要はありません。`BE Address` がFQDNを持つBEノードを定義している場合、BEノードはこのFQDNで自身を識別します。

## 既存のクラスタでFQDNアクセスを有効にする

以前IPアドレスを使用して起動された既存のクラスタでFQDNアクセスを有効にするには、まずStarRocksを2.4.0以降のバージョンに**アップグレード**する必要があります。

### FEノードのFQDNアクセスを有効にする

FEノードのリーダーフォロワーでないすべてのFEノードについて、リーダーFEノードにFQDNアクセスを有効にする前に、FQDNアクセスを有効にする必要があります。

> **注意**
>
> FEノードにFQDNアクセスを有効にする前に、クラスタには少なくとも3つのフォロワーFEノードがあることを確認してください。

#### リーダーフォロワーFEノードにFQDNアクセスを有効にする

1. FEノードの展開ディレクトリに移動し、次のコマンドを実行してFEノードを停止します：

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQLクライアントを使用して、停止したFEノードの `Alive` ステータスをチェックするために次のステートメントを実行してください。`Alive` ステータスが `false` になるまで待機してください。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

3. 次のステートメントを実行して、IPアドレスをFQDNに置換してください。

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. FQDNアクセスでFEノードを起動するために次のコマンドを実行してください。

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    `--host_type` プロパティはノードの再起動後にこのプロパティを指定する必要があります。有効な値には `FQDN` および `IP` が含まれます。

5. FEノードの `Alive` ステータスをチェックし、`Alive` ステータスが `true` になるまで待機してください。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

6. 現在のFEノードの `Alive` ステータスが `true` の場合、他のリーダーフォロワーFEノードにも同様の手順を繰り返してFQDNアクセスを有効にしてください。

#### リーダーFEノードにFQDNアクセスを有効にする

すべてのリーダーフォロワーFEノードが正常に変更され、再起動された後、リーダーFEノードにFQDNアクセスを有効にすることができます。

> **注意**
>
> リーダーFEノードにFQDNアクセスを有効にする前に、FQDNを使用してノードをクラスタに追加すると、FQDNはまだ対応するIPアドレスに変換されます。FQDNアクセスが有効になっているリーダーFEノードがクラスタに選出された後、FQDNはIPアドレスに変換されません。

1. リーダーFEノードの展開ディレクトリに移動し、次のコマンドを実行してリーダーFEノードを停止します。

    ```Shell
    ./bin/stop_fe.sh --daemon
    ```

2. MySQLクライアントを使用して、新しいリーダーFEノードがクラスタに選出されたかどうかをチェックするために次のステートメントを実行してください。

    ```SQL
    SHOW PROC '/frontends'\G
    ```

    `Alive` および `isMaster` ステータスが `true` である任意のFEノードが実行中のリーダーFEです。

3. 次のステートメントを実行して、IPアドレスをFQDNに置換してください。

    ```SQL
    ALTER SYSTEM MODIFY FRONTEND HOST "<fe_ip>" TO "<fe_hostname>";
    ```

4. FQDNアクセスでFEノードを起動するために次のコマンドを実行してください。

    ```Shell
    ./bin/start_fe.sh --host_type FQDN --daemon
    ```

    `--host_type` プロパティはノードの再起動後にこのプロパティを指定する必要があります。有効な値には `FQDN` および `IP` が含まれます。

5. FEノードの `Alive` ステータスをチェックしてください。

    ```Plain
    SHOW PROC '/frontends'\G
    ```

  `Alive` ステータスが `true` になった場合、FEノードは正常に変更され、クラスタにフォロワーFEノードとして追加されます。

### BEノードのFQDNアクセスを有効にする

BEノードのFQDNアクセスを有効にするには、MySQLクライアントを使用して次のステートメントを実行して、BEノードのIPアドレスをFQDNに置換してください。

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_ip>" TO "<be_hostname>";
```

> **注意**
>
> FQDNアクセスを有効にした後は、BEノードを再起動する必要はありません。

## ロールバック

FQDNアクセスが有効になっているStarRocksクラスタをFQDNアクセス非対応の以前のバージョンにロールバックするには、クラスタ内のすべてのノードでIPアドレスアクセスを有効にする必要があります。ノードを再起動して変更を有効にする前に、[既存のクラスタでFQDNアクセスを有効にする](#enable-fqdn-access-in-an-existing-cluster) を参照してください。

- FEノードにIPアドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY FRONTEND HOST "<fe_hostname>" TO "<fe_ip>";
```

- BEノードにIPアドレスアクセスを有効にする：

```SQL
ALTER SYSTEM MODIFY BACKEND HOST "<be_hostname>" TO "<be_ip>";
```

変更は、クラスタが正常に再起動された後に有効になります。

## FAQ

**Q: FEノードにFQDNアクセスを有効にすると "required 1 replica. But none were active with this master" というエラーが発生します。どうすればいいですか？**

A: FEノードにFQDNアクセスを有効にする前に、クラスタには少なくとも3つのフォロワーFEノードがあることを確認してください。

**Q: FQDNアクセスが有効になっているクラスタに、IPアドレスを使用して新しいノードを追加できますか？**

A: はい。