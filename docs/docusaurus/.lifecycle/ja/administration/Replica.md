---
displayed_sidebar: "Japanese"
---

# レプリカ管理

## 用語

* タブレット：テーブルの論理スライスで、1つのテーブルには複数のタブレットがあります。
* レプリカ：タブレットのコピーであり、デフォルトで1つのタブレットに対して3つのレプリカがあります。
* ヘルシーレプリカ：バックエンドが稼働中でバージョンが完全なレプリカ。
* TabletChecker (TC)：定期的にすべてのタブレットをスキャンし、それらのステータスに基づいてTabletSchedulerにタブレットを送信するバックグラウンドスレッドです。
* TabletScheduler (TS)：TabletCheckerによって送信されたタブレットを処理し、クラスタレプリカのバランシングも行うバックグラウンドスレッドです。
* TabletSchedCtx (TSC)：タブレットのラッパーで、TCによって選択されたタブレットはTSCとしてカプセル化され、TSに送信されます。
* ストレージメディア：StarRocksは、SSDやHDDなどの異なるストレージメディアをサポートしており、レプリカのスケジューリングは異なるストレージメディアによって異なります。

## ステータス

### レプリカステータス

レプリカのヘルス状態は次の通りです。

* **BAD**

レプリカが破損しています。これには、ディスクの障害などによってレプリカが回復不能な損傷を受けた場合などが含まれます。

* **VERSION_MISSING**

各バッチのインポートには、データの1つのバージョンが対応しています。1つのレプリカには複数の連続したバージョンが表示されるはずですが、 インポートエラーのため、一部のレプリカにはデータの不完全なバージョンが存在する場合があります。

* **HEALTHY**

レプリカには正しいデータがあり、それが配置されているBEノードは正常な状態（通常の心拍数があり、オフラインになるプロセス中ではありません）です。

### タブレットステータス

タブレットのヘルス状態は、そのすべてのレプリカのステータスによって決定されます：

* **REPLICA_MISSING**

レプリカが不足しています。つまり、生存しているレプリカの数が期待されるレプリカ数よりも少ないことを意味します。

* **VERSION_INCOMPLETE**

生存しているレプリカの数は期待される数以上ですが、ヘルシーレプリカの数が期待される数よりも少ないことを意味します。

* **REPLICA_RELOCATING**

完全なバージョンを持つ生存しているレプリカの数が「複製数」と等しいですが、一部のレプリカが配置されているBEノードが利用不可（例: 廃止中のステータス）です。

* **REPLICA_MISSING_IN_CLUSTER**

複数のクラスタを使用する場合、ヘルシーレプリカの数は期待される数以上ですが、対応するクラスタ内のレプリカ数が期待される数未満です。

* **REDUNDANT**

レプリカ冗長性。すべてのヘルシーレプリカが対応するクラスタにありますが、冗長で利用できないレプリカのためにレプリカの合計数が期待される数を超えています。

* **FORCE_REDUNDANT**

これは特別なステータスです。期待されるレプリカ数が利用可能なノード数以上であり、タブレットがレプリカが不足している状態の場合のみ発生します。この場合、新しいレプリカを作成するための利用可能なノードを確保するために、まず1つのレプリカを削除する必要があります。

* **COLOCATE_MISMATCH**

コロケーション属性に対するタブレットステータスで、シャードされたレプリカがコロケーショングループで指定された分布と一致しないことを示します。

* **COLOCATE_REDUNDANT**

コロケーション属性に対するタブレットステータスで、コロケーションテーブルのタブレットレプリカが冗長であることを示します。

* **HEALTHY**

ヘルシータブレットです。

## レプリカ修復

TabletCheckerは定期的にすべてのタブレットのステータスを確認します。不健康なタブレットはTabletSchedulerに引き渡され、スケジューリングや修復が行われます。修復はクローンタスクとしてBE上で行われます。クローンタスクの生成はFEが担当します。

> Note 1: レプリカ修復の主なアイデアは、まず目標値に達するために新しいレプリカを作成またはパッチを当て、その後余分なレプリカを削除することです。
> Note 2: クローンタスクは、リモートBEから目的のデータを宛先BEにコピーすることです。

異なる状態に対して、異なる方法で修復を行います。

1. REPLICA_MISSING/REPLICA_RELOCATING
   利用可能なBEノードを宛先BEとして選択します。ヘルシーレプリカをソースとして選択します。クローンタスクでは、ソースから宛先BEにフルレプリカをコピーします。レプリカ補充の場合、ストレージメディアにかかわらず、利用可能なBEノードが選択されます。
2. VERSION_INCOMPLETE
   比較的完全なレプリカを目的地として選択します。ヘルシーレプリカをソースとして選択します。クローンタスクでは、ソースから宛先に欠落しているバージョンをコピーします。
3. REPLICA_MISSING_IN_CLUSTER
   このステータスはREPLICA_MISSINGと同じ方法で処理されます。
4. REDUNDANT
   通常、レプリカ修復後、タブレットに余分なレプリカが存在します。余分なレプリカを選択して削除します。余分なレプリカの選択は次の順序に従います：

   * レプリカが配置されているBEが既にオフライン
   * レプリカが破損している
   * レプリカが接続されていないか、オフラインのプロセス中である
   * レプリカがCLONEステータスである（クローンタスク実行中の中間ステータス）
   * レプリカに欠落しているバージョンがある
   * レプリカが不正なクラスタにある
   * レプリカが配置されているBEノードが重荷を持っている

5. FORCE_REDUNDANT
   タブレットにはレプリカが不足していますが、新しいレプリカを作成するための利用可能なノードがありません。この場合、新しいレプリカを作成するためのノードを空けるために、まず1つのレプリカを削除する必要があります。レプリカの削除の順序はREDUNDANTと同じです。
6. COLOCATE_MISMATCH
   コロケーショングループで指定されたBEノードの1つをレプリカ補充の宛先ノードとして選択します。
7. COLOCATE_REDUNDANT
   コロケーショングループで指定されていないBEノード上のレプリカを削除します。

StarRocksは、同じタブレットのレプリカを同じホストの異なるBEにデプロイしません。これにより、同じホストのすべてのBEがダウンしても、いくつかのレプリカが依然として生存することが保証されます。

## レプリカスケジューリング

### スケジューリング優先度

TabletSchedulerでスケジュール待ちのタブレットには、そのステータスに応じて異なる優先度が与えられます。優先度の高いタブレットが最初にスケジュールされます。優先度レベルは次の通りです：

* VERY_HIGH

* `REDUNDANT`の状態にあるタブレット。余分なレプリカを持つタブレットには非常に高い優先度が与えられます。レプリカの余分さは最も緊急ではありませんが、最も高速に処理され、リソース（ディスクスペースなど）が解放されます。
* `FORCE_REDUNDANT`の状態にあるタブレット。上と同様。

* HIGH

* `REPLICA_MISSING`の状態で、ほとんどのレプリカが欠落しています（例: 3つのうち2つが欠落している場合）
* `VERSION_INCOMPLETE`の状態で、ほとんどのレプリカがバージョンが欠落している
* `COLOCATE_MISMATCH`の状態。Colocationテーブルに関連するタブレットは可能な限り素早く修復されます。
* `COLOCATE_REDUNDANT`の状態。

* NORMAL

* `REPLICA_MISSING`の状態で、ほとんどのレプリカが生存しています（例: 3つのうち1つが欠落している場合）
* `VERSION_INCOMPLETE`の状態で、ほとんどのレプリカが完全なバージョンを持っています
* `REPLICA_RELOCATING`の状態で、ほとんどのレプリカが再配置が必要です（例: 3つのうち2つがある場合）

* LOW

* `REPLICA_MISSING_IN_CLUSTER`の状態
* `REPLICA_RELOCATING`の状態で、ほとんどのレプリカが安定しています

### 手動決定優先度

システムは自動的にスケジューリング優先度を決定します。ただし、ユーザーが特定のタブレットをより速く修復したい場合があります。そのため、特定のテーブルやパーティションのタブレットが最初に修復されるようにユーザーが指定できるコマンドを提供しています。

ADMIN REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

このコマンドにより、TCに問題のあるタブレットに `VERY_HIGH` の優先度が付けられ、それにより最初に修復されるようにします。

> Note: このコマンドは成功した修復を保証するものではなく、優先度はTSのスケジューリングによって変更されます。リーダーFEが変更されたり再起動したりすると、この情報は失われます。

次のコマンドで優先度の付け直しをキャンセルできます。

ADMIN CANCEL REPAIR TABLE tbl [PARTITION (p1, p2, ...)] ;

### 優先度スケジューリング

優先度付けにより、深刻な損傷を受けたタブレットが最初に修復されることが保証されます。ただし、高優先度の修復タスクが続けて失敗すると、低優先度のタスクがスケジュールされないままになります。そのため、各タスクのステータスに基づいて優先度を動的に調整して、すべてのタスクがスケジュールされる機会があるようにします。

* スケジューリングが5回連続で失敗した場合（例: リソースを取得できない、適切なソースまたは宛先が見つからないなど）、そのタスクは優先度が下げられます。
* タスクが30分間スケジュールされなかった場合、そのタスクは優先度が上げられます。
* タスクの優先度は5分間で2回まで調整できます。

初期優先度レベルが重視されるため、`VERY_HIGH`のタスクは最大で`NORMAL`に優先度が下げられ、`LOW`のタスクは最大で`HIGH`に優先度が上げられます。優先度の調整は、ユーザーが手動で設定したタスクにも適用されます。

## レプリカバランシング

StarRocksはクラスタ内でレプリカバランシングを自動的に実行します。バランシングの主なアイデアは、低負荷のノードにレプリカを作成し、高負荷のノードにレプリカを削除することです。同一クラスタ内の異なるBEノードに異なるストレージメディアが存在する場合があります。 バランシング後もタブレットを元のストレージメディアに保持するために、BEノードはストレージメディアに基づいて分割されます。

同様に、レプリカバランシングにより、同じタブレットのレプリカは同じホストの異なるBEにデプロイされます。

### BEノード負荷
### ClusterLoadStatistics（CLS）
クラスタ内の各バックエンドの負荷分散を表示し、`TabletScheduler`をトリガーしてクラスタをバランスさせます。現在、`**Disk Utilization**`および`**Number of Replicas**`を使用して、各バックエンドの`loadScore`を計算しています。スコアが高いほど、BEの負荷が重くなります。

`capacityCoefficient`と`replicaNumCoefficient`（合計が1）は、それぞれ`Disk Utilization`と`Number of Replicas`の加重係数です。`capacityCoefficient`は実際のディスク使用状況に応じて動的に調整されます。BEの総ディスク利用率が50%未満の場合、`capacityCoefficient`の値は0.5になります。ディスク利用率が75%以上の場合（FE構成項目`capacity_used_percent_high_water`で構成可能）、値は1になります。利用率が50%から75%の場合、重み係数は以下の式に基づいてスムーズに増加します。

`capacityCoefficient= 2 * ディスク利用率 - 0.5`

この重み係数により、ディスク使用が高い場合はこのバックエンドの負荷スコアが高くなり、できるだけ早くこのBEの負荷を減らすようになります。

TabletSchedulerは、毎分CLSを更新します。

### バランシングポリシー

TabletSchedulerは、スケジューリングの各ラウンドでLoadBalancerを介してバランシングのために候補となる健全なタブレットを選択し、将来のスケジューリングを調整します。

## リソース制御

レプリカの修復とバランシングは、どちらもBE間でコピーを行うことで行われます。同じBEで同時に実行されるタスクが多すぎると、IO負荷が増加します。そのため、StarRocksはスケジューリング中に各ノードで実行できるタスクの数を制御します。リソース制御の最小単位はディスク（つまり、`be.conf`で指定されたデータパス）です。デフォルトでは、レプリカ修復に2つのスロットが各ディスクに割り当てられます。クローンタスクでは、ソースと宛先それぞれに1つのスロットを占有します。ディスクがスロットを持たない場合、それ以上のタスクは割り当てられません。このスロットの数は、FEの`schedule_slot_num_per_path`パラメータで構成できます。

さらに、デフォルトでは、レプリカバランシングに2つのスロットが各ディスクに割り当てられます。目的は、高負荷のノードが修復タスクに占拠され、バランシングを介してスペースを解放できなくなるのを防ぐことです。

## レプリカ状態の表示

レプリカの状態は**リーダーFEノードにのみ存在**します。そのため、次のコマンドを直接リーダーFEに接続して実行する必要があります。

### レプリカ状態の表示

1. グローバルステータスのチェック  
   `SHOW PROC '/statistic';`コマンドを使用すると、クラスタ全体のレプリカ状態を表示できます。

    ```plaintext
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    | DbId     | DbName                      | TableNum | PartitionNum | IndexNum | TabletNum | ReplicaNum | UnhealthyTabletNum | InconsistentTabletNum |
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    | 35153636 | default_cluster:DF_Newrisk  | 3        | 3            | 3        | 96        | 288        | 0                  | 0                     |
    | 48297972 | default_cluster:PaperData   | 0        | 0            | 0        | 0         | 0          | 0                  | 0                     |
    | 5909381  | default_cluster:UM_TEST     | 7        | 7            | 10       | 320       | 960        | 1                  | 0                     |
    | Total    | 240                         | 10       | 10           | 13       | 416       | 1248       | 1                  | 0                     |
    +----------+-----------------------------+----------+--------------+----------+-----------+------------+--------------------+-----------------------+
    ```

    `UnhealthyTabletNum`列は、対応するデータベースにいくつの不健康なタブレットがあるかを示します。`InconsistentTabletNum`列は、対応するデータベースの中でレプリカが不整合な状態にあるタブレットの数を示します。最後の`Total`行は、クラスタ全体の統計を示します。通常、`UnhealthyTabletNum`と`InconsistentTabletNum`はゼロであるべきです。もしゼロでない場合は、タブレットの情報をさらに確認できます。上記の例では、`UM_TEST`データベースに不健康なステータスのタブレットが1つありますので、次のコマンドを使用してそれがどのタブレットかを確認できます。

    `SHOW PROC '/statistic/5909381';`  
    ここで`5909381`は対応するDbIdです。

    ```plaintext
    +------------------+---------------------+
    | UnhealthyTablets | InconsistentTablets |
    +------------------+---------------------+
    | [40467980]       | []                  |
    +------------------+---------------------+
    ```

    上記の結果は、特定の不健康なタブレットID（40467980）を示しています。次に、特定のタブレットの各レプリカの状態を確認する方法について説明します。

2. テーブル（パーティション）レベルの状態のチェック  
   ユーザーは、次のコマンドを使用して特定のテーブルやパーティションのレプリカの状態をチェックし、WHERE文で状態をフィルタリングできます。例えば、`tbl1`内の`p1`と`p2`のNORMAL状態のレプリカの状態を表示するには以下のようにします。  
   `ADMIN SHOW REPLICA STATUS FROM tbl1 PARTITION (p1, p2) WHERE STATUS = "OK";`

    ```plaintext
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    | TabletId | ReplicaId | BackendId | Version | LastFailedVersion | LastSuccessVersion | CommittedVersion | SchemaHash | VersionNum | IsBad | State  | Status |
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    | 29502429 | 29502432  | 10006     | 2       | -1                | 2                  | 1                | -1         | 2          | false | NORMAL | OK     |
    | ...
    | 29502433 | 48369135  | 10006     | 2       | -1                | -1                 | 1                | -1         | 2          | false | NORMAL | OK     |
    +----------+-----------+-----------+---------+-------------------+--------------------+------------------+------------+------------+-------+--------+--------+
    ```

    `IsBad = true`の場合、それはレプリカが壊れていることを意味します。`Status`列には追加情報が表示されます。
    `ADMIN SHOW REPLICA STATUS`コマンドは、主にレプリカの健全性状態を表示するために使用されます。ユーザーは以下のコマンドでも追加情報を表示できます。  

    `SHOW TABLET FROM tbl1;`

    ```plaintext
    +----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+----------------------+---------------+----------+...
```plaintext
      + {T}
      + {T}
    + {T}
  + {T}
```

```
      + {T}
      + {T}
    + {T}
  + {T}
```
      | FailedRunning| タスクの実行に失敗した回数
      | LstAdjPrio | タスクの優先度が最後に調整された時間
      | CmtVer/CmtVerHash/VisibleVer/VisibleVerHash | クローンタスクを実行するために使用されるバージョン情報
      | ErrMsg | タスクがスケジュールされ実行された際のエラーメッセージ

2. `SHOW PROC '/cluster_balance/running_tablets';` を使用して実行中のタスクを表示します。
   ここでも同じプロパティが使用されます。詳細は `pending tablets` を参照してください。

3. `SHOW PROC '/cluster_balance/history_tablets';` を使用して完了したタスクを表示します。
   デフォルトでは、最後の1000件の完了したタスクのみを保持します。ここでも同じプロパティが使用されます。詳細は `pending tablets` を参照してください。`State` が `FINISHED` であれば、タスクは正常に完了しています。それ以外の場合は、失敗したタスクの理由を確認するために `ErrMsg` をチェックしてください。