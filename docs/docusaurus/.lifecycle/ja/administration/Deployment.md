---
displayed_sidebar: "Japanese"
---

# 高可用性を備えたFEクラスタの展開

このトピックでは、StarRocksのFEノードの高可用性（HA）展開について紹介します。

## FE HAクラスタの理解

StarRocksのFEハイアベイラビリティクラスタは、単一障害点を避けるために、プライマリ-セカンダリレプリケーションアーキテクチャを使用しています。FEは、リーダー選択、ログレプリケーション、フェイルオーバーを実現するために、raftのようなBDB JEプロトコルを使用しています。

### FEの役割の理解

FEクラスタでは、ノードは次の2つの役割に分けられます。

- **FEフォロワー**

FEフォロワーは、レプリケーションプロトコルの投票メンバーであり、リーダーFEの選択に参加し、ログを提出します。FEフォロワーの数は奇数（2n+1）です。確認には過半数（n+1）が必要であり、少数派（n）の障害を許容します。

- **FEオブザーバー**

FEオブザーバーは、非投票のメンバーであり、非同期でレプリケーションログを購読するために使用されます。クラスタでは、FEオブザーバーのステータスはフォロワーのステータスよりも遅れています。他のレプリケーションプロトコルのリーナーの役割と類似しています。

FEクラスタでは、自動的にリーダーFEが選択されます。リーダーFEはすべてのステート変更を実行します。変更は非リーダーFEノードから開始され、次にリーダーFEに転送されて実行されます。非リーダーFEノードは、レプリケーションログの最新の変更のLSNを記録します。読み取り操作は直接非リーダーノードで実行できますが、非リーダーFEノードの状態が最後の操作のLSNと同期するまで待機します。オブザーバーノードは、FEクラスタ上の読み取り操作の負荷容量を増やすことができます。緊急性の低いユーザーは、オブザーバーノードを読むことができます。

## FE HAクラスタの展開

高可用性を備えたFEクラスタを展開するためには、以下の要件を満たす必要があります。

- FEノード間の時計の差は5秒を超えてはいけません。時刻合わせにはNTPプロトコルを使用してください。
- 1つのマシンには1つのFEノードのみを展開できます。
- すべてのFEノードで同じHTTPポートを割り当てる必要があります。

上記の要件がすべて満たされたら、次の手順に従って、FEノードのHA展開を有効にするために、1つずつFEインスタンスをStarRocksクラスタに追加できます。

1. バイナリファイルと構成ファイルを配布します（単一インスタンスと同じ）。
2. MySQLクライアントを既存のFEに接続し、新しいインスタンスの情報（役割、IP、ポートを含む）を追加します。

   ```sql
   mysql> ALTER SYSTEM ADD FOLLOWER "host:port";
   ```

   または

   ```sql
   mysql> ALTER SYSTEM ADD OBSERVER "host:port";
   ```

   ホストはマシンのIPです。マシンに複数のIPがある場合は、priority_networksでIPを選択します。例： `priority_networks=192.168.1.0/24` は、通信にサブネット `192.168.1.x` を使用するように設定できます。ポートは `edit_log_port` で、デフォルトは `9010` です。

   > 注意：セキュリティ上の理由から、StarRocksのFEとBEは通信用の1つのIPのみをリッスンすることができます。マシンに複数のネットワークカードがある場合、StarRocksは正しいIPを自動的に見つけることができない場合があります。例えば、`ifconfig` コマンドを実行して、 `eth0 IP` が `192.168.1.1` であること、`docker0 : 172.17.0.1` であることがわかった場合、 'priority_networks=192.168.1.0/24' を設定して、eth0を通信IPとして指定できます。`priority_networks` は、FEまたはBEが起動されるときにどのIPを使用するかを示す属性です。例を以下に示します： `priority_networks=10.1.3.0/24`。これにより、IPが存在するサブネット範囲を指定するCIDR（Classless Inter-Domain Routing）表記が使用され、すべてのBEおよびFEで使用できます。`priority_networks` は `fe.conf` および `be.conf` の両方に記述されます。IPに対応するIPを指定するためのものです。

   エラーが発生した場合は、次のコマンドを使用してFEを削除します。

   ```sql
   alter system drop follower "fe_host:edit_log_port";
   alter system drop observer "fe_host:edit_log_port";
   ```

3. FEノードは、マスター選択、投票、ログ提出、およびレプリケーションを完了するためにペアで相互接続する必要があります。 FEノードが最初に起動されるときは、既存のクラスタ内のノードをヘルパーとして指定する必要があります。ヘルパーノードは、クラスタ内のすべてのFEノードの構成情報を取得して接続を確立します。そのため、起動時に `--helper` パラメーターを指定してください：

   ```shell
   ./bin/start_fe.sh --helper host:port --daemon
   ```

   ホストはヘルパーノードのIPです。複数のIPがある場合は、`priority_networks` でIPを選択します。ポートは `edit_log_port` で、デフォルトは `9010` です。

   将来的な起動では、`--helper` パラメーターを指定する必要はありません。 FEは他のFEの構成情報をローカルディレクトリに保存します。次に直接起動します：

   ```shell
   ./bin/start_fe.sh --daemon
   ```

4. クラスタのステータスを確認し、展開が成功したことを確認します。

   ```Plain Text
   mysql> SHOW PROC '/frontends'\G

   ***1\. row***

   Name: 172.26.x.x_9010_1584965098874

   IP: 172.26.x.x

   HostName: sr-test1

   ......

   Role: FOLLOWER

   IsMaster: true

   ......

   Alive: true

   ......

   ***2\. row***

   Name: 172.26.x.x_9010_1584965098874

   IP: 172.26.x.x

   HostName: sr-test2

   ......

   Role: FOLLOWER

   IsMaster: false

   ......

   Alive: true

   ......

   ***3\. row***

   Name: 172.26.x.x_9010_1584965098874

   IP: 172.26.x.x

   HostName: sr-test3

   ......

   Role: FOLLOWER

   IsMaster: false

   ......

   Alive: true

   ......

   3 rows in set (0.05 sec)
   ```

   `Alive` が `true` の場合、ノードがクラスタに正常に追加されました。上記の例では、 `172.26.x.x_9010_1584965098874` がリーダーFEノードです。