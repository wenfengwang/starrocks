---
displayed_sidebar: "Japanese"
---

# 高可用性を備えたFEクラスターを展開する

このトピックでは、StarRocksのFEノードの高可用性（HA）デプロイメントについて紹介します。

## FE HAクラスターの理解

StarRocksのFEの高可用性クラスターは、シングルポイントの障害を回避するために、プライマリーシカンダリーのレプリケーションアーキテクチャを使用しています。FEはRaftライクなBDB JEプロトコルを使用して、リーダーの選択、ログのレプリケーション、フェイルオーバーを実現しています。

### FEの役割の理解

FEクラスターでは、ノードは次の2つの役割に分かれます。

- **FE Follower**

FE Followersは、リーダーFEの選択やログの提出に参加する、レプリケーションプロトコルの投票権を持つメンバーです。FE Followersの数は奇数である必要があります（2n+1）。確認には多数決（n+1）が必要であり、少数派の障害（n）を許容できます。

- **FE Observer**

FE Observersは非投票メンバーであり、レプリケーションログを非同期で購読するために使用されます。クラスター内で、FE ObserversのステータスはFollowersのそれよりも遅れており、他のレプリケーションプロトコルのリーナーの役割と同様です。

FEクラスターは、FE FollowersからリーダーFEを自動的に選択します。リーダーFEはすべての状態変更を実行します。変更は、非リーダーFEノードから開始され、その後、リーダーFEに転送されて実行されます。非リーダーFEノードは、レプリケーションログの最新の変更のLSNを記録します。読み取り操作は非リーダーノードで直接実行できますが、非リーダーFEノードの状態が最後の操作のLSNと同期するまで待機する必要があります。Observerノードは、FEクラスター上の読み取り操作の負荷容量を増やすことができます。緊急性が低いユーザーは、Observerノードでの読み取りが可能です。

## FE HAクラスターを展開する

高可用性を備えたFEクラスターを展開するためには、次の要件を満たす必要があります。

- FEノード間の時計の差は5秒を超えてはなりません。時計を調整するためにNTPプロトコルを使用してください。
- 1台のマシンには1つのFEノードのみを展開できます。
- すべてのFEノードで同じHTTPポートを割り当てる必要があります。

上記の要件がすべて満たされている場合は、次の手順に従って、FEノードのHAデプロイメントを有効にするために個々のFEインスタンスをStarRocksクラスターに追加できます。

1. バイナリファイルと設定ファイルを配布します（単一インスタンスと同じ）。
2. MySQLクライアントを既存のFEに接続し、新しいインスタンスの情報を追加します。これには、ロール、IP、ポートを含めます:

   ```sql
   mysql> ALTER SYSTEM ADD FOLLOWER "ホスト:ポート";
   ```

   または

   ```sql
   mysql> ALTER SYSTEM ADD OBSERVER "ホスト:ポート";
   ```

   ホストはマシンのIPアドレスです。マシンに複数のIPがある場合は、priority_networksでIPを選択します。例えば、`priority_networks=192.168.1.0/24`と設定して、通信にサブネット`192.168.1.x`を使用します。ポートは`edit_log_port`で、デフォルトは`9010`です。

   > 注：セキュリティ上の理由から、StarRocksのFEおよびBEは1つのIPのみで通信を受け付けることができます。1台のマシンに複数のネットワークカードがある場合、StarRocksは正しいIPを自動的に見つけることができない場合があります。例えば、`ifconfig`コマンドを実行して`eth0のIP`が`192.168.1.1`、`docker0 : 172.17.0.1`であることがわかった場合、`priority_networks=192.168.1.0/24`を設定してeth0を通信IPとすることができます。ここでは、IPがどのFEまたはBEで起動されるときに使用するかを示す`priority_networks`属性が書かれています。例は次のとおりです：`priority_networks=10.1.3.0/24`。

   エラーが発生した場合は、次のコマンドを使用してFEを削除します。

   ```sql
   alter system drop follower "fe_host:edit_log_port";
   alter system drop observer "fe_host:edit_log_port";
   ```

3. FEノードはペアで相互接続してマスターの選択、投票、ログの提出、およびレプリケーションを完了する必要があります。FEノードを初めて起動する際には、既存のクラスターにおいてヘルパーとして指定される必要があります。ヘルパーノードはクラスター内のすべてのFEノードの設定情報を取得して接続を確立します。そのため、起動時に`--helper`パラメータを指定してください：

   ```shell
   ./bin/start_fe.sh --helper ホスト:ポート --daemon
   ```

   ホストはヘルパーノードのIPアドレスです。複数のIPがある場合は、`priority_networks`でIPを選択します。ポートは`edit_log_port`で、デフォルトは`9010`です。

   将来の起動の際には、`--helper`パラメータを指定する必要はありません。FEは他のFEの設定情報をローカルディレクトリに保存します。次のように直接起動できます：

   ```shell
   ./bin/start_fe.sh --daemon
   ```

4. クラスターのステータスを確認し、デプロイメントが成功したことを確認します。

  ```Plain Text
  mysql> SHOW PROC '/frontends'\G

  ***1\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test1

  ......

  Role: FOLLOWER

  IsMaster: true

  ......

  Alive: true

  ......

  ***2\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test2

  ......

  Role: FOLLOWER

  IsMaster: false

  ......

  Alive: true

  ......

  ***3\. row***

  Name: 172.26.x.x_9010_1584965098874

  IP: 172.26.x.x

  HostName: sr-test3

  ......

  Role: FOLLOWER

  IsMaster: false

  ......

  Alive: true

  ......

  3 rows in set (0.05 sec)
  ```

`Alive`が`true`である場合、ノードはクラスターに正常に追加されています。上記の例では、`172.26.x.x_9010_1584965098874`がリーダーFEノードです。