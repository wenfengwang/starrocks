---
displayed_sidebar: "Japanese"
---

# クエリキュー

このトピックでは、StarRocks でクエリキューを管理する方法について説明します。

v2.5 から、StarRocks はクエリキューをサポートしています。クエリキューが有効になっていると、並行性のしきい値やリソース制限に達したとき、StarRocks は自動的にクエリをキューに入れ、過負荷を回避します。保留中のクエリは、実行を開始するために十分な計算リソースが利用可能になるまでキューで待機します。v3.1.4 以降、StarRocks はリソースグループレベルでのクエリキューの設定をサポートしています。

クエリキューをトリガーするために CPU 使用率、メモリ使用率、およびクエリの同時実行数に閾値を設定できます。

**ロードマップ**：

| バージョン | グローバルクエリキュー | リソースグループレベルのクエリキュー | 集約的な並行管理 | 動的な並行調整 |
| ------  | ------------------ | -------------------------------- | --------------------------------- | ------------------------------- |
| v2.5    | ✅                 | ❌                                | ❌                                | ❌                              |
| v3.1.4  | ✅                 | ✅                                | ✅                                | ✅                              |

## クエリキューを有効にする

クエリキューはデフォルトで無効になっています。対応するグローバルセッション変数を設定することで、グローバルまたはリソースグループレベルのクエリキューを INSERT 読み込み、SELECT クエリ、および統計クエリに有効にできます。

### グローバルクエリキューを有効にする

- ロードタスクのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_load = true;
```

- SELECT クエリのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_select = true;
```

- 統計クエリのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_statistic = true;
```

### リソースグループレベルのクエリキューを有効にする

v3.1.4 以降、StarRocks はリソースグループレベルでのクエリキューの設定をサポートしています。

リソースグループレベルのクエリキューを有効にするには、上記のグローバルセッション変数に加えて、`enable_group_level_query_queue` を設定する必要があります。

```SQL
SET GLOBAL enable_group_level_query_queue = true;
```

## リソースの閾値を指定する

### グローバルクエリキューのためのリソースの閾値を指定する

次のグローバルセッション変数を使用して、クエリキューをトリガーする閾値を設定できます：

| **変数**                        | **デフォルト** | **説明**                                              |
| ----------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_concurrency_limit       | 0           | BE 上の同時クエリの上限。`0` より大きい値に設定された後にのみ有効になります。 |
| query_queue_mem_used_pct_limit      | 0           | BE 上のメモリ使用率の上限パーセンテージ。`0` より大きい値に設定された後にのみ有効になります。範囲：[0, 1] |
| query_queue_cpu_used_permille_limit | 0           | BE 上の CPU 使用率パーミルの上限（CPU 使用率 * 1000）。`0` より大きい値に設定された後にのみ有効になります。範囲：[0, 1000] |

> **注記**
>
> デフォルトでは、BE は 1 秒間隔で FE にリソース使用状況を報告します。この間隔は、BE の構成項目 `report_resource_usage_interval_ms` を設定することで変更できます。

### リソースグループレベルのクエリキューのためのリソースの閾値を指定する

v3.1.4 以降、リソースグループを作成する際に、個々の並行性制限（`concurrency_limit`）や CPU コア制限（`max_cpu_cores`）を設定できます。クエリが開始されると、グローバルまたはリソースグループレベルのどちらかでリソースの閾値を超えると、クエリはすべてのリソースの閾値内になるまでキューに置かれます。

| **変数**        | **デフォルト** | **説明**                                              |
| ------------------- | ----------- | ------------------------------------------------------------ |
| concurrency_limit   | 0           | 単一の BE ノード上のリソースグループの並行制限。`0` より大きい値に設定された後にのみ有効になります。 |
| max_cpu_cores       | 0           | 単一の BE ノード上のこのリソースグループの CPU コア制限。`0` より大きい値に設定された後にのみ有効になります。範囲：[0, `avg_be_cpu_cores`]、`avg_be_cpu_cores` はすべての BE ノードの CPU コア数の平均を表します。 |

SHOW USAGE RESOURCE GROUPS を使用して、各 BE ノード上の各リソースグループのリソース使用情報を表示できます。詳細は [リソースグループの使用状況情報の表示](./resource_group.md#view-resource-group-usage-information) を参照してください。

### クエリの同時実行数を管理する

実行中のクエリ数（`num_running_queries`）がグローバルまたはリソースグループの `concurrency_limit` を超えると、入力されたクエリはキューに置かれます。 `num_running_queries` を取得する方法は、バージョン &lt; v3.1.4 と &ge; v3.1.4 で異なります。

- v3.1.4 より前のバージョンでは、BE が `report_resource_usage_interval_ms` で指定された間隔で `num_running_queries` を報告します。そのため、`num_running_queries` の変更を検出するまでに遅延が生じる場合があります。例えば、BE によって報告された `num_running_queries` が次の報告の前にグローバルまたはリソースグループの `concurrency_limit` を超えていない場合でも、次の報告前に入力されたクエリが `concurrency_limit` を超えると、これらの入力されたクエリはキューで待機せずに実行されます。

- v3.1.4 以降では、実行中のクエリはリーダー FE によって集約的に管理されます。各フォロワー FE はクエリの開始または終了時にリーダー FE に通知し、`concurrency_limit` を超えるクエリが急増するシナリオを処理するため、StarRocks が対処できるようにします。

## クエリキューの設定

クエリキューの容量および待機中のクエリの最大タイムアウトを、次のグローバルセッション変数を使用して設定できます：

| **変数**                       | **デフォルト** | **説明**                                              |
| ---------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_max_queued_queries     | 1024        | キュー内のクエリの上限。この閾値に達すると、入力されたクエリは拒否されます。`0` より大きい値に設定された後にのみ有効になります。 |
| query_queue_pending_timeout_second | 300         | キュー内の保留中のクエリの最大タイムアウト。この閾値に達すると、対応するクエリは拒否されます。単位：秒。 |

## クエリの動的な並行調整を設定する

バージョン v3.1.4 以降、クエリキューで管理されて Pipeline Engine で実行されるクエリに対して、StarRocks は現在の実行中のクエリ数 `num_running_queries`、フラグメント数 `num_fragments`、およびクエリの並行性 `pipeline_dop` に基づいて、動的にクエリの並行性 `pipeline_dop` を調整できます。これにより、スケジューリングのオーバーヘッドを最小限に抑えながら、最適な BE リソースの利用を確保できます。フラグメントおよびクエリの並行性 `pipeline_dop` に関する詳細は [クエリ管理 - クエリの並行性の調整](./Query_management.md) を参照してください。

クエリキューの下で各クエリに対して、StarRocks は単一の BE 上のクエリの同時フラグメントを表すドライバの概念を維持します。その論理値である `num_drivers` は、単一の BE 上のそのクエリのすべてのフラグメントの総同時数を表し、`num_fragments * pipeline_dop` に等しくなります。新しいクエリが到着すると、StarRocks は次のルールに基づいてクエリの並行性 `pipeline_dop` を調整します：

- 実行中のドライバの数 `num_drivers` が同時ドライバの低水位制限 `query_queue_driver_low_water` を超えると、クエリの並行性 `pipeline_dop` は調整されます。より多くの実行中のドライバの数 `num_drivers` が超えるほど、クエリの並行性 `pipeline_dop` は低く調整されます。
- StarRocks は、クエリに対する同時ドライバの高水位制限 `query_queue_driver_high_water` を制限します。

次のグローバルセッション変数を使用して、クエリの並行性 `pipeline_dop` の動的な調整を構成できます：

| **変数**                  | **デフォルト** | **説明**                                             |
| ----------------------------- | ----------- | ----------------------------------------------------------- |
| query_queue_driver_high_water | -1          | クエリに対する同時ドライバの高水位制限。非負の値に設定された後にのみ有効になります。`0` に設定すると、`avg_be_cpu_cores * 16` と同等になります。`avg_be_cpu_cores` はすべての BE ノードの CPU コア数の平均を示します。`0` より大きい値に設定すると、その値が直接使用されます。 |
| query_queue_driver_low_water  | -1          | クエリのための同時ドライバの低水位制限。非負の値に設定された後にのみ有効になります。`0` に設定すると、`avg_be_cpu_cores * 8` と同等になります。`0` より大きい値に設定すると、その値が直接使用されます。 |

## クエリキューのモニタリング

次の方法を使用して、クエリキューに関連する情報を表示できます。

### SHOW PROC

[SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md) を使用して、BE ノードの実行中のクエリの数、メモリ使用率、および CPU 使用率を確認できます：

```Plain
mysql> SHOW PROC '/backends'\G
*************************** 1. row ***************************
...
    NumRunningQueries: 0
           MemUsedPct: 0.79 %
           CpuUsedPct: 0.0 %
```

### SHOW PROCESSLIST

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md) を使用して、クエリがキューにあるかどうか（`IsPending` が `true` の場合）を確認できます：

```Plain
mysql> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| Id   | User | Host                | Db    | Command | ConnectionStartTime | Time | State | Info              | IsPending |
```
```markdown
    + {R}
    + {R}
  + {R}
+ {R}
```

```markdown
    + {T}
    + {T}
  + {T}
+ {T}
```