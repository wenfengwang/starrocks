```yaml
displayed_sidebar: "English"
---

# クエリキュー

このトピックでは、StarRocksでクエリキューを管理する方法について説明します。

v2.5から、StarRocksはクエリキューをサポートしています。クエリキューが有効になっていると、並行性の閾値やリソース制限に達したときに、StarRocksは自動的に入ってくるクエリをキューに入れ、過負荷を回避できます。保留中のクエリは、実行を開始できるだけの計算リソースが利用可能になるまでキューで待機します。v3.1.4以降、StarRocksはリソースグループレベルでのクエリキューの設定をサポートしています。

クエリキューをトリガーするために、CPU使用率、メモリ使用率、およびクエリの並行性に閾値を設定することができます。

**ロードマップ**:

| バージョン | グローバルクエリキュー | リソースグループレベルのクエリキュー | 集合的な並行管理 | 動的並行調整  |
| ------  | ------------------ | -------------------------------- | --------------------------------- | ------------------------------- |
| v2.5    | ✅                 | ❌                                | ❌                                | ❌                              |
| v3.1.4  | ✅                 | ✅                                | ✅                                | ✅                              |

## クエリキューを有効にする

クエリキューはデフォルトで無効になっています。対応するグローバルセッション変数を設定することで、INSERTロード、SELECTクエリ、および統計クエリのためにグローバルまたはリソースグループレベルのクエリキューを有効にすることができます。

### グローバルクエリキューを有効にする

- ローディングタスクのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_load = true;
```

- SELECTクエリのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_select = true;
```


- 統計クエリのためのクエリキューを有効にする：

```SQL
SET GLOBAL enable_query_queue_statistic = true;
```

### リソースグループレベルのクエリキューを有効にする

v3.1.4以降、StarRocksはリソースグループレベルでのクエリキューの設定をサポートしています。

リソースグループレベルのクエリキューを有効にするには、上記で言及したグローバルセッション変数に加えて、`enable_group_level_query_queue` を設定する必要があります。

```SQL
SET GLOBAL enable_group_level_query_queue = true;
```

## リソースの閾値を指定する

### グローバルクエリキューのためのリソース閾値を指定する

次のグローバルセッション変数を使用して、クエリキューをトリガーする閾値を設定できます：

| **変数**                        | **デフォルト** | **説明**                                              |
| ----------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_concurrency_limit       | 0           | BE上の同時クエリの上限。 `0` より大きな値に設定された後にのみ有効になります。 |
| query_queue_mem_used_pct_limit      | 0           | BE上のメモリ使用率の上限パーセンテージ。 `0` より大きな値に設定された後にのみ有効になります。範囲： [0, 1] |
| query_queue_cpu_used_permille_limit | 0           | BE上のCPU使用割合（CPU使用率 * 1000）の上限。 `0` より大きな値に設定された後にのみ有効になります。範囲： [0, 1000] |

> **注意**
>
> デフォルトでは、BEは1秒間隔でFEにリソース使用状況を報告します。この間隔は、BE構成項目 `report_resource_usage_interval_ms` を設定することで変更できます。

### リソースグループレベルのクエリキューのためのリソース閾値を指定する

v3.1.4以降、リソースグループを作成する際に個々の並行性制限 (`concurrency_limit`) およびCPUコア制限 (`max_cpu_cores`) を設定することができます。クエリが開始されると、リソースグループレベルまたはグローバルのどちらかのリソースの消費が閾値を超えると、クエリはキューに配置され、リソースの消費が閾値内になるまで待機します。

| **変数**        | **デフォルト** | **説明**                                              |
| ------------------- | ----------- | ------------------------------------------------------------ |
| concurrency_limit   | 0           | シングルBEノード上のリソースグループの並行制限。 `0` より大きな値に設定された場合のみ有効になります。 |
| max_cpu_cores       | 0           | シングルBEノード上のこのリソースグループのCPUコア制限。 `0` より大きな値に設定された場合のみ有効になります。範囲： [0、 `avg_be_cpu_cores`]、 `avg_be_cpu_cores` はすべてのBEノードでのCPUコア数の平均値を表します。 |

SHOW USAGE RESOURCE GROUPS を使用して、各BEノード上の各リソースグループのリソース使用情報を表示することができます。[リソースグループの使用情報の表示](./resource_group.md#view-resource-group-usage-information) を参照してください。

### クエリの並行管理

実行中のクエリ数 (`num_running_queries`) がグローバルまたはリソースグループの `concurrency_limit` を超えた場合、新しいクエリはキューに配置されます。 `num_running_queries` の取得方法は、バージョン `< v3.1.4` と `v3.1.4` 以上で異なります。

- `v3.1.4` より前のバージョンでは、 `num_running_queries` はBEによって `report_resource_usage_interval_ms` で指定された間隔で報告されます。したがって、`num_running_queries` がBEによって報告され、次のレポートまでにグローバルまたはリソースグループの `concurrency_limit` を超えない場合でも、次のレポートまでに新しいクエリが到着し、 `concurrency_limit` を超える場合、これらの新しいクエリはキューで待機せずに実行されます。

- `v3.1.4` 以降のバージョンでは、すべての実行中のクエリはLeader FEによって集団管理されます。各Follower FEはクエリの開始または終了時にLeader FEに通知し、`concurrency_limit` を超えるクエリが突如増加するようなシナリオを処理できるようにします。

## クエリキューの構成

クエリキューのキャパシティとキューにあるクエリの最大タイムアウトを設定することができます：

| **変数**                       | **デフォルト** | **説明**                                              |
| ---------------------------------- | ----------- | ------------------------------------------------------------ |
| query_queue_max_queued_queries     | 1024        | キューにあるクエリの上限。この閾値に到達すると、新規のクエリは拒否されます。 `0` より大きな値に設定された後にのみ有効になります。 |
| query_queue_pending_timeout_second | 300         | キュー内の保留中のクエリの最大タイムアウト。この閾値に到達すると、対応するクエリが拒否されます。単位：秒。 |

## クエリの並行調整の動的設定

v3.1.4から、クエリキューによって管理され、Pipeline Engineによって実行されるクエリについて、StarRocksは現在の実行中のクエリ数 `num_running_queries`、フラグメント数 `num_fragments`、およびクエリの並行性 `pipeline_dop` に基づいて、受信クエリのために動的にクエリの並行性 `pipeline_dop` を調整することができます。これにより、スケジューリングのオーバーヘッドを最小限に抑えながら、最適なBEリソース利用を確保することができます。フラグメントおよびクエリの並行性 `pipeline_dop` についての詳細については、[クエリ管理 - クエリの並行性の調整](./Query_management.md)を参照してください。

クエリキューの下の各クエリについて、StarRocksは、シングルBE上でのクエリの同時フラグメントを表すドライバーの概念を維持しています。その論理値である `num_drivers` は、シングルBE上のそのクエリのすべてのフラグメントの合計並行数を表し、`num_fragments * pipeline_dop` と等しいです。新しいクエリが到着すると、StarRocksは次のルールに基づいてクエリの並行性 `pipeline_dop` を調整します：

- 走行中のドライバーの数 `num_drivers` が同時ドライバーの低水準 `query_queue_driver_low_water` を上回るほど、クエリの並行性 `pipeline_dop` が低く調整されます。
- StarRocksは、クエリの同時ドライバーの高水準を直下に制限します。

次のグローバルセッション変数を使用して、クエリの並行性 `pipeline_dop` の動的調整を構成することができます：

| **変数**                  | **デフォルト** | **説明**                                             |
| ----------------------------- | ----------- | ----------------------------------------------------------- |
| query_queue_driver_high_water | -1          | クエリに対する同時ドライバーの高水準。非負の値に設定された場合のみ有効になります。`0` に設定すると、`avg_be_cpu_cores * 16` と同等であり、 `avg_be_cpu_cores` はすべてのBEノードでのCPUコア数の平均値を表します。 `0` より大きな値に設定された場合、その値が直接使用されます。
| query_queue_driver_low_water  | -1          | クエリのための同時ドライバーの低水準。非負の値に設定された場合のみ有効になります。`0` に設定すると、`avg_be_cpu_cores * 8` と同等です。 `0` より大きな値に設定された場合、その値が直接使用されます。 |

## クエリキューの監視

次の方法を使用して、クエリキューに関連する情報を表示することができます。

### SHOW PROC

[SHOW PROC](../sql-reference/sql-statements/Administration/SHOW_PROC.md) を使用して、BEノードで実行中のクエリの数やメモリ使用率、CPU使用率を確認できます：

```Plain
mysql> SHOW PROC '/backends'\G
*************************** 1. row ***************************
...
    NumRunningQueries: 0
           MemUsedPct: 0.79 %
           CpuUsedPct: 0.0 %
```

### SHOW PROCESSLIST

[SHOW PROCESSLIST](../sql-reference/sql-statements/Administration/SHOW_PROCESSLIST.md) を使用して、クエリがキューにあるかどうか（ `IsPending` が `true` の場合）をチェックできます：

```Plain
mysql> SHOW PROCESSLIST;
+------+------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
```markdown
+------+-----------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+
| 2    | root      | xxx.xx.xxx.xx:xxxxx |       | Query   | 2022-11-24 18:08:29 | 0    | OK    | SHOW PROCESSLIST  | false     |
+------+-----------+---------------------+-------+---------+---------------------+------+-------+-------------------+-----------+

### FE監査ログ

FE監査ログファイル **fe.audit.log** をチェックできます。`PendingTimeMs` フィールドは、クエリがキューで待機した時間を示し、単位はミリ秒です。

### FEメトリクス

次のFEメトリクスは、各FEノードの統計データから派生しています。

| メトリクス名                                         | 単位   | タイプ   | 説明                                                           |
| --------------------------------------------------- | ------ | -------- | -------------------------------------------------------------- |
| starrocks_fe_query_queue_pending                     | Count  | Instantaneous | キュー内の現在のクエリ数。                                      |
| starrocks_fe_query_queue_total                       | Count  | Instantaneous | 過去にキューに入れた（実行中を含む）クエリの合計数。                  |
| starrocks_fe_query_queue_timeout                     | Count  | Instantaneous | キュー内でタイムアウトしたクエリの合計数。                               |
| starrocks_fe_resource_group_query_queue_total        | Count  | Instantaneous | このリソースグループに過去にキューに入れた（実行中を含む）クエリの合計数。`name` ラベルはリソースグループの名前を示します。このメトリクスはv3.1.4以降でサポートされています。   |
| starrocks_fe_resource_group_query_queue_pending      | Count  | Instantaneous | このリソースグループのキュー内の現在のクエリ数。`name` ラベルはリソースグループの名前を示します。このメトリクスはv3.1.4以降でサポートされています。  |
| starrocks_fe_resource_group_query_queue_timeout      | Count  | Instantaneous | このリソースグループのキュー内でタイムアウトしたクエリの数。`name` ラベルはリソースグループの名前を示します。このメトリクスはv3.1.4以降でサポートされています。  |

### SHOW RUNNING QUERIES

v3.1.4以降、StarRocksではSQLステートメント `SHOW RUNNING QUERIES` がサポートされており、各クエリのキュー情報を表示するために使用されます。各フィールドの意味は次のとおりです：

- `QueryId`: クエリのID。
- `ResourceGroupId`: クエリが当たったリソースグループのID。ユーザー定義のリソースグループにヒットしない場合は、"-" と表示されます。
- `StartTime`: クエリの開始時刻。
- `PendingTimeout`: キュー内でPENDINGのクエリがタイムアウトする時間。
- `QueryTimeout`: クエリのタイムアウト時間。
- `State`: クエリのキュー状態。"PENDING" はキューに入っていることを示し、"RUNNING" は現在実行中であることを示します。
- `Slots`: クエリで要求された論理リソースの数量。現在は常に `1` に固定されています。
- `Frontend`: クエリを開始したFEノード。
- `FeStartTime`: クエリを開始したFEノードの開始時刻。

例：

```Plain
MySQL [(none)]> SHOW RUNNING QUERIES;
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| QueryId                              | ResourceGroupId | StartTime           | PendingTimeout      | QueryTimeout        | State     | Slots | Frontend                        | FeStartTime         |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
| a46f68c6-3b49-11ee-8b43-00163e10863a | -               | 2023-08-15 16:56:37 | 2023-08-15 17:01:37 | 2023-08-15 17:01:37 |  RUNNING  | 1     | 127.00.00.01_9010_1692069711535 | 2023-08-15 16:37:03 |
| a6935989-3b49-11ee-935a-00163e13bca3 | 12003           | 2023-08-15 16:56:40 | 2023-08-15 17:01:40 | 2023-08-15 17:01:40 |  RUNNING  | 1     | 127.00.00.02_9010_1692069658426 | 2023-08-15 16:37:03 |
| a7b5e137-3b49-11ee-8b43-00163e10863a | 12003           | 2023-08-15 16:56:42 | 2023-08-15 17:01:42 | 2023-08-15 17:01:42 |  PENDING  | 1     | 127.00.00.03_9010_1692069711535 | 2023-08-15 16:37:03 |
+--------------------------------------+-----------------+---------------------+---------------------+---------------------+-----------+-------+---------------------------------+---------------------+
```