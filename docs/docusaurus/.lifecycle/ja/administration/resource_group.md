---
displayed_sidebar: "Japanese"
---

# リソースグループ

このトピックでは、StarRocksのリソースグループ機能について説明します。

![resource group](../assets/resource_group.png)

この機能を使用すると、単一のクラスタで複数のワークロードを同時に実行できるため、短いクエリ、アドホッククエリ、ETLジョブなどを実行して、複数のクラスタを展開する余分なコストを節約できます。技術的な観点から、実行エンジンはユーザーの指定に従い、並行するワークロードをスケジュールし、それらの間の干渉を分離します。

リソースグループのロードマップ:

- v2.2から、StarRocksはクエリのリソース消費を制限し、同じクラスタ内のテナント間でのリソースの分離と効率的な利用をサポートしています。
- StarRocks v2.3では、ビッグクエリのリソース消費をさらに制限し、オーバーサイズのクエリリクエストによるクラスタリソースの枯渇を防ぎ、システムの安定性を保証します。
- StarRocks v2.5からは、データロード（INSERT）の計算リソース消費を制限することをサポートしています。

## 用語

このセクションでは、リソースグループ機能を使用する前に理解する必要がある用語について説明します。

### リソースグループ

各リソースグループは、特定のBEからのコンピューティングリソースのセットです。クラスタの各BEを複数のリソースグループに分割できます。クエリがリソースグループに割り当てられると、StarRocksはリソースグループのために指定したリソースクォータに基づいてCPUおよびメモリリソースを割り当てます。

次のパラメータを使用して、BEごとのリソースグループのCPUおよびメモリリソースのクォータを指定できます。

- `cpu_core_limit`

  このパラメータは、BE上でリソースグループに割り当てることができるCPUコアのソフト制限を指定します。有効な値: 0以外の任意の正の整数。範囲: (1, `avg_be_cpu_cores`]。ここで、`avg_be_cpu_cores`は全てのBEでのCPUコアの平均数を表します。

  実際のビジネスシナリオでは、BE上で利用可能なCPUコアに応じてリソースグループに割り当てられるCPUコアは比例してスケーリングされます。

  > **注意**
  >
  > 例えば、16個のCPUコアを提供するBEに対して3つのリソースグループrg1、rg2、rg3を構成したとします。三つのリソースグループの`cpu_core_limit`の値はそれぞれ、`2`、`6`、`8`です。
  >
  > BEのCPUコアがすべて占有された場合、BEのすべてのCPUコアに割り当てられるリソースグループごとのCPUコア数は、次の計算に基づいてそれぞれ2、6、8となります。
  >
  > - rg1のCPUコア数 = BE上のCPUコア数 × (2/16) = 2
  > - rg2のCPUコア数 = BE上のCPUコア数 × (6/16) = 6
  > - rg3のCPUコア数 = BE上のCPUコア数 × (8/16) = 8
  >
  > rg1とrg2がロードされているが、rg3がそうでない場合、rg1とrg2に割り当てられるCPUコア数は、それぞれ4と12となります。これは次の計算に基づいています。
  >
  > - rg1のCPUコア数 = BE上のCPUコア数 × (2/8) = 4
  > - rg2のCPUコア数 = BE上のCPUコア数 × (6/8) = 12

- `mem_limit`

  このパラメータは、BEが提供する総メモリに対するクエリで使用できるメモリの割合を指定します。有効な値: (0, 1)。

  > **注意**
  >
  > クエリで使用できるメモリ量は、`query_pool`パラメータによって示されます。パラメータの詳細については、「[メモリ管理](Memory_management.md)」を参照してください。

- `concurrency_limit`

  このパラメータは、リソースグループ内の同時クエリの上限を指定します。多くの同時クエリによるシステムの過負荷を回避するために使用されます。このパラメータは、0より大きい値の場合のみ有効です。デフォルト値: 0。

- `max_cpu_cores`

  単一のBEノード上のこのリソースグループのCPUコア制限です。0より大きい場合のみ有効です。範囲: [0, `avg_be_cpu_cores`]。ここで、`avg_be_cpu_cores`は全てのBEノードでのCPUコアの平均数を表します。デフォルト値: 0。

上記のリソース消費制限を基に、以下のパラメータでビッグクエリのリソース消費をさらに制限できます。

- `big_query_cpu_second_limit`: このパラメータは、単一のBEでのビッグクエリのCPUの最大時間制限を指定します。並行クエリは時間を加算します。単位は秒です。このパラメータは0より大きい値の場合のみ有効です。デフォルト値: 0。
- `big_query_scan_rows_limit`: このパラメータは、単一のBE上でのビッグクエリのスキャン行数の上限を指定します。このパラメータは0より大きい値の場合のみ有効です。デフォルト値: 0。
- `big_query_mem_limit`: このパラメータは、単一のBE上でのビッグクエリのメモリ使用量の上限を指定します。単位はバイトです。このパラメータは0より大きい値の場合のみ有効です。デフォルト値: 0。

> **注意**
>
> リソースグループ内で実行されているクエリが上記のビッグクエリ制限を超えると、クエリはエラーで終了します。また、「fe.audit.log」の`ErrorCode`列でエラーメッセージを表示できます。

リソースグループの`type`を`short_query`または`normal`に設定できます。

- デフォルト値は`normal`です。パラメータの`type`で`normal`を明示的に指定する必要はありません。
- クエリが`short_query`リソースグループに命中するとき、BEノードは`short_query.cpu_core_limit`で指定されたCPUリソースを予約します。`normal`リソースグループに命中するクエリのために予約されるCPUリソースの上限は、`BE core - short_query.cpu_core_limit`です。
- `short_query`リソースグループに最大で1つだけ作成できます。
- StarRocksは、`short_query`リソースグループのCPUリソースに対する厳密な上限を設定しません。

### クラシファイア

各クラシファイアは、クエリのプロパティに一致する1つ以上の条件を保持します。StarRocksは、一致条件に基づいて各クエリに最も適合するクラシファイアを識別し、クエリの実行のためのリソースを割り当てます。

クラシファイアは、次の条件をサポートしています。

- `user`: ユーザーの名前。
- `role`: ユーザーの役割。
- `query_type`: クエリの種類。`SELECT`および`INSERT`（v2.5以降）がサポートされています。`INSERT INTO`または`BROKER LOAD`タスクが`insert`という`query_type`のリソースグループに命中する場合、BEノードはタスクに指定されたCPUリソースを予約します。
- `source_ip`: クエリの開始元のCIDRブロック。
- `db`: クエリがアクセスするデータベース。カンマ`,`で区切られた文字列で指定できます。
- `plan_cpu_cost_range`: クエリの推定CPUコスト範囲。形式は`(DOUBLE, DOUBLE]`です。デフォルト値はNULLで、この制限はありませんことを示します。`fe.audit.log`の`PlanCpuCost`列は、クエリのCPUコストのシステムの推定値を表します。このパラメータはv3.1.4以降でサポートされます。
- `plan_mem_cost_range`: クエリの推定メモリコスト範囲。形式は`(DOUBLE, DOUBLE]`です。デフォルト値はNULLで、この制限はありませんことを示します。`fe.audit.log`の`PlanMemCost`列は、クエリのメモリコストのシステムの推定値を表します。このパラメータはv3.1.4以降でサポートされます。

クラシファイアは、クエリの情報と一致する条件の1つまたはすべてが一致する場合のみ、クエリに一致します。複数のクラシファイアがクエリに一致する場合、StarRocksはクエリと各クラシファイアの一致度を計算し、一致度が最も高いクラシファイアを特定します。

> **注意**
>
> クエリが属するリソースグループは、FEノードの**fe.audit.log**の`ResourceGroup`列で表示できます。または「[クエリのリソースグループを表示](#view-the-resource-group-of-a-query)」で説明されているように、`EXPLAIN VERBOSE <query>`を実行して表示できます。

StarRocksは、クエリとクラシファイアの一致度を次のルールに従って計算します。

- クラシファイアの`user`がクエリのユーザーと同じ値である場合、クラシファイアの一致度は1増加します。
- クラシファイアの`role`がクエリの役割と同じ値である場合、クラシファイアの一致度は1増加します。
- クラシファイアがクエリと同じ`query_type`の値を持つ場合、クラシファイアの一致度は、以下の計算から得られる数値に1を足したものです: 1/クラシファイア内の`query_type`フィールドの数。
- クラシファイアがクエリと同じ`source_ip`の値を持つ場合、クラシファイアの一致度は、以下の計算から得られる数値に1を足したものです: (32 - `cidr_prefix`)/64。
- クラシファイアがクエリと同じ`db`の値を持つ場合、クラシファイアの一致度は、10増加します。
- クエリのCPUコストが`plan_cpu_cost_range`内にある場合、クラシファイアの一致度は、1増加します。
- クエリのメモリコストが`plan_mem_cost_range`内にある場合、クラシファイアの一致度は、1増加します。

複数のクラシファイアがクエリと一致した場合、条件の数が多いクラシファイアの一致度が高くなります。

```Plain
-- クラシファイアBには、クラシファイアAよりも多くの条件があります。そのため、クラシファイアBの一致度がクラシファイアAよりも高くなります。


クラシファイアA (user='Alice')


クラシファイアB (user='Alice', source_ip = '192.168.1.0/24')
```

複数の一致するクラシファイアが同じ条件の数を持っている場合、より正確に記述された条件を持つクラシファイアの一致度が高くなります。

```Plain
-- クラシファイアBで指定されているCIDRブロックの範囲が、クラシファイアAよりも小さいです。そのため、クラシファイアBの一致度がクラシファイアAよりも高くなります。
クラシファイアA (user='Alice', source_ip = '192.168.1.0/16')
クラシファイアB (user='Alice', source_ip = '192.168.1.0/24')

-- クラシファイアCには、クラシファイアDよりも少ないクエリタイプが指定されています。そのため、クラシファイアCの一致度がクラシファイアDよりも高くなります。
クラシファイアC (user='Alice', query_type in ('select'))
クラシファイアD (user='Alice', query_type in ('insert','select'))
```

一致度が同じクラシファイアが複数ある場合、その中から1つのクラシファイアがランダムに選択されます。

```Plain
-- クエリがdb1とdb2の両方を同時にクエリする場合、クラシファイアEとFが一致クラシファイアの中で最も一致度が高い場合、EとFのいずれかがランダムに選択されます。
クラシファイアE (db='db1')
クラシファイアF (db='db2')
```

## コンピューティングリソースを分離

リソースグループとクラシファイアを設定して、クエリ間でコンピューティングリソースを分離できます。

### リソースグループを有効にする

リソースグループを使用するには、StarRcoskクラスターでPipeline Engineを有効にする必要があります。

```SQL
-- 現在のセッションでPipeline Engineを有効にします。
SET enable_pipeline_engine = true;
-- グローバルでPipeline Engineを有効にします。
SET GLOBAL enable_pipeline_engine = true;
```

ローディングタスクの場合、バージョンv2.5.0以降ではPipelineエンジンを有効にするには、FE構成項目 `enable_pipeline_load`を設定する必要があります。

```sql
ADMIN SET FRONTEND CONFIG ("enable_pipeline_load" = "true");
```

> **注意**
>
> v3.1.0以降、リソースグループはデフォルトで有効になり、セッション変数 `enable_resource_group` は非推奨となりました。

### リソースグループとクラシファイアを作成する

次のステートメントを実行して、リソースグループを作成し、リソースグループをクラシファイアに関連付け、リソースグループにコンピューティングリソースを割り当てます。

```SQL
CREATE RESOURCE GROUP <group_name> 
TO (
    user='string', 
    role='string', 
    query_type in ('select'), 
    source_ip='cidr'
) --クラシファイアを作成します。複数のクラシファイアを作成する場合、カンマ（`,`）でクラシファイアを区切ります。
WITH (
    "cpu_core_limit" = "INT",
    "mem_limit" = "m%",
    "concurrency_limit" = "INT",
    "type" = "str" --リソースグループのタイプ。値をnormalに設定します。
);
```

例:

```SQL
CREATE RESOURCE GROUP rg1
TO 
    (user='rg1_user1', role='rg1_role1', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user2', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user3', source_ip='192.168.x.x/24'),
    (user='rg1_user4'),
    (db='db1')
WITH (
    'cpu_core_limit' = '10',
    'mem_limit' = '20%',
    'big_query_cpu_second_limit' = '100',
    'big_query_scan_rows_limit' = '100000',
    'big_query_mem_limit' = '1073741824'
);
```

### リソースグループの指定（オプション）

現在のセッションでリソースグループを直接指定できます。

```SQL
SET resource_group = 'group_name';
```

### リソースグループおよびクラシファイアを表示

次のステートメントを実行して、すべてのリソースグループとクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUPS ALL;
```

次のステートメントを実行して、ログインユーザーのリソースグループとクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUPS;
```

次のステートメントを実行して、指定されたリソースグループとそのクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUP group_name;
```

例:

```plain
mysql> SHOW RESOURCE GROUPS ALL;
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| Name | Id     | CPUCoreLimit | MemLimit | ConcurrencyLimit | Type   | Classifiers                                                                                                            |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300040, weight=4.409375, user=rg1_user1, role=rg1_role1, query_type in (SELECT), source_ip=192.168.2.1/24)         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300041, weight=3.459375, user=rg1_user2, query_type in (SELECT), source_ip=192.168.3.1/24)                         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300042, weight=2.359375, user=rg1_user3, source_ip=192.168.4.1/24)                                                 |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300043, weight=1.0, user=rg1_user4)                                                                                |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
```

> **注意**
>
> 前述の例では、`weight`は一致度を示します。

### リソースグループおよびクラシファイアの管理

各リソースグループのリソースクォータを変更できます。また、リソースグループからクラシファイアを追加または削除できます。

既存のリソースグループのリソースクォータを変更するステートメントを実行してください。

```SQL
ALTER RESOURCE GROUP group_name WITH (
    'cpu_core_limit' = 'INT',
    'mem_limit' = 'm%'
);
```

リソースグループを削除するステートメントを実行してください。

```SQL
DROP RESOURCE GROUP group_name;
```

クラシファイアをリソースグループに追加するステートメントを実行してください。

```SQL
ALTER RESOURCE GROUP <group_name> ADD (user='string', role='string', query_type in ('select'), source_ip='cidr');
```

リソースグループからクラシファイアを削除するステートメントを実行してください。

```SQL
ALTER RESOURCE GROUP <group_name> DROP (CLASSIFIER_ID_1, CLASSIFIER_ID_2, ...);
```

リソースグループのすべてのクラシファイアを削除するステートメントを実行してください。

```SQL
ALTER RESOURCE GROUP <group_name> DROP ALL;
```

## リソースグループを観察する

### クエリのリソースグループを表示

クエリがヒットしたリソースグループは、**fe.audit.log**の`ResourceGroup`列から、または`EXPLAIN VERBOSE <query>`を実行した後に返される`RESOURCE GROUP`列から表示できます。これらは、特定のクエリタスクが一致するリソースグループを示します。

- クエリがリソースグループの管理対象外の場合、列の値は空の文字列 `""` です。
- クエリがリソースグループの管理対象であるが、いずれのクラシファイアとも一致しない場合、列の値は空の文字列 `""` です。ただし、このクエリはデフォルトのリソースグループ `default_wg` に割り当てられます。

`default_wg`のリソース制限は次のとおりです。

- `cpu_core_limit`：v2.3.7以前のバージョンでは1、後のバージョンではBEのCPUコア数です。
- `mem_limit`：100%。
- `concurrency_limit`：0。
- `big_query_cpu_second_limit`：0。
- `big_query_scan_rows_limit`：0。
- `big_query_mem_limit`：0。

### リソースグループのモニタリング

リソースグループに対する[モニタリングとアラート](Monitor_and_Alert.md)を設定できます。

リソースグループ関連のFEおよびBEメトリクスは次のとおりです。以下のすべてのメトリクスには、それに対応するリソースグループを示す `name` ラベルがあります。

### FEメトリクス
次のFEメトリクスは、現在のFEノード内でのみ統計を提供します。

| メトリクス名 | 単位 | タイプ | 説明 |
| ----------------------------------------------- | ---- | ------------- | ------------------------------------------------------------------ |
| starrocks_fe_query_resource_group               | 回数 | 瞬時 | このリソースグループで過去に実行されたクエリの数（現在実行中を含む）。 |
| starrocks_fe_query_resource_group_latency       | ミリ秒    | 瞬時 | このリソースグループのクエリ遅延パーセンタイル。 `type`ラベルには、`mean`、`75_quantile`、`95_quantile`、`98_quantile`、`99_quantile`、`999_quantile`などの特定のパーセンタイルが示されます。 |
| starrocks_fe_query_resource_group_err           | 回数 | 瞬時 | このリソースグループでエラーが発生したクエリの数。 |
| starrocks_fe_resource_group_query_queue_total   | 回数 | 瞬時 | このリソースグループで過去にキューに入れられたクエリの合計数（現在実行中を含む）。このメトリクスはv3.1.4以降でサポートされています。このクエリキューが有効な場合にのみ有効です。詳細については、[クエリキュー](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_pending | 回数 | 瞬時 | このリソースグループの現在キューに入っているクエリの数。このメトリクスはv3.1.4以降でサポートされています。このクエリキューが有効な場合にのみ有効です。詳細については、[クエリキュー](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_timeout | 回数 | 瞬時 | このリソースグループでキューに入っている間にタイムアウトしたクエリの数。このメトリクスはv3.1.4以降でサポートされています。このクエリキューが有効な場合にのみ有効です。詳細については、[クエリキュー](query_queues.md)を参照してください。 |

### BEメトリクス

| メトリクス名                                      | 単位     | タイプ          | 説明                                            |
| ----------------------------------------- | -------- | ------------- | ------------------------------------------------------------------ |
| resource_group_running_queries            | 回数    | 瞬時 | このリソースグループで現在実行中のクエリの数。   |
| resource_group_total_queries              | 回数    | 瞬時 | このリソースグループで過去に実行されたクエリの数（現在実行中を含む）。 |
| resource_group_bigquery_count             | 回数    | 瞬時 | このリソースグループでビッグクエリ制限をトリガーしたクエリの数。 |
| resource_group_concurrency_overflow_count | 回数    | 瞬時 | このリソースグループで「concurrency_limit」制限をトリガーしたクエリの数。 |
| resource_group_mem_limit_bytes            | バイト    | 瞬時 | このリソースグループのメモリ制限。                         |
| resource_group_mem_inuse_bytes            | バイト    | 瞬時 | このリソースグループによって現在使用されているメモリ。               |
| resource_group_cpu_limit_ratio            | パーセンテージ | 瞬時 | このリソースグループの`cpu_core_limit`の割合（すべてのリソースグループ全体の`cpu_core_limit`）。 |
| resource_group_inuse_cpu_cores            | 回数     | 平均     | このリソースグループによって使用されているCPUコアの推定数。この値はおおよその推定値です。このメトリクスはv3.1.4以降でサポートされています。 |
| resource_group_cpu_use_ratio              | パーセンテージ | 平均     | **非推奨** このリソースグループによって使用されるパイプラインスレッドの時間スライスの合計に対するこのリソースグループの使用率。これは、2回のメトリック収集から計算された平均値を表します。 |
| resource_group_connector_scan_use_ratio   | パーセンテージ | 平均     | **非推奨** このリソースグループによって使用される外部テーブルスキャンスレッドの時間スライスの合計に対するこのリソースグループの使用率。これは、2回のメトリック収集から計算された平均値を表します。 |
| resource_group_scan_use_ratio             | パーセンテージ | 平均     | **非推奨** このリソースグループによって使用される内部テーブルスキャンスレッドの時間スライスの合計に対するこのリソースグループの使用率。これは、2回のメトリック収集から計算された平均値を表します。 |

### リソースグループの使用情報を表示

v3.1.4以降、StarRocksはSQLステートメント[SHOW USAGE RESOURCE GROUPS](../sql-reference/sql-statements/Administration/SHOW_USAGE_RESOURCE_GROUPS.md)をサポートしており、BEごとにリソースグループごとの使用情報を表示するために使用されます。各フィールドの説明は次のとおりです。

- `Name`: リソースグループの名前。
- `Id`: リソースグループのID。
- `Backend`: BEのIPまたはFQDN。
- `BEInUseCpuCores`: このBEでこのリソースグループによって現在使用されているCPUコアの数。この値はおおよその推定値です。
- `BEInUseMemBytes`: このBEでこのリソースグループによって現在使用されているメモリバイトの数。
- `BERunningQueries`: このBEで現在実行中のこのリソースグループからのクエリの数。

ご注意ください：

- BEは、デフォルトで`report_resource_usage_interval_ms`で指定された間隔でこのリソース使用情報を定期的にリーダーFEに報告します。デフォルトでは、この値は1秒に設定されています。
- 結果には`BEInUseCpuCores`/`BEInUseMemBytes`/`BERunningQueries`のいずれかが正の数である行のみ表示されます。言い換えると、リソースグループがBEでリソースをアクティブに使用している場合にのみ情報が表示されます。

例：

```Plain
MySQL [(none)]> SHOW USAGE RESOURCE GROUPS;
+------------+----+-----------+-----------------+-----------------+------------------+
| 名前       | Id | バックエンド   | BEでのCPUコアの使用数 | BEでのメモリバイトの使用数 | BEで実行中のクエリ数 |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.1 | 0.100           | 1               | 5                |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.2 | 0.200           | 2               | 6                |
+------------+----+-----------+-----------------+-----------------+------------------+
| wg1        | 0  | 127.0.0.1 | 0.300           | 3               | 7                |
+------------+----+-----------+-----------------+-----------------+------------------+
| wg2        | 0  | 127.0.0.1 | 0.400           | 4               | 8                |
+------------+----+-----------+-----------------+-----------------+------------------+
```

## 次に何をすべきか

リソースグループを構成した後は、メモリリソースとクエリを管理できます。詳細については、次のトピックを参照してください。

- [メモリ管理](../administration/Memory_management.md)

- [クエリ管理](../administration/Query_management.md)