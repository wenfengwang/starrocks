---
displayed_sidebar: "Japanese"
---

# リソースグループ

このトピックでは、StarRocksのリソースグループ機能について説明します。

![リソースグループ](../assets/resource_group.png)

この機能を使用すると、複数のワークロードを単一クラスタで同時に実行できます。たとえば、短いクエリ、アドホックなクエリ、ETLジョブなどを実行して、複数のクラスタを展開する余分なコストを節約できます。技術的な観点からは、実行エンジンはユーザーの指定に従って並行するワークロードをスケジュールし、それらの間の干渉を分離します。

リソースグループのロードマップ：

- v2.2以降、StarRocksはクエリのリソース消費を制限し、同じクラスタ内のテナント間でリソースの分離と効率的な利用を実装します。
- StarRocks v2.3では、大規模なクエリ向けのリソース消費をさらに制限し、クラスタのリソースがオーバーロードされないようにします。
- StarRocks v2.5では、データのロード（INSERT）向けの計算リソースの消費を制限します。

## 用語

このセクションでは、リソースグループ機能を使用する前に理解しておく必要がある用語について説明します。

### リソースグループ

各リソースグループは、特定のBE（Backend）からの計算リソースのセットです。クラスタの各BEを複数のリソースグループに分割できます。クエリがリソースグループに割り当てられると、StarRocksはリソースグループに指定したリソースクォータに基づいてCPUとメモリリソースを割り当てます。

以下のパラメータを使用して、BEごとにリソースグループにCPUとメモリのリソースクォータを指定できます。

- `cpu_core_limit`

  このパラメータは、BE上のリソースグループに割り当てられるCPUコア数のソフト制限を指定します。有効な値は、任意のゼロ以外の正の整数です。範囲は（1、`avg_be_cpu_cores`]で、`avg_be_cpu_cores`はすべてのBEで利用可能なCPUコアの平均数を表します。

  実際のビジネスシナリオでは、リソースグループに割り当てられるCPUコアはBE上のCPUコアの利用可能性に比例してスケーリングされます。

  > **注記**
  >
  > たとえば、16のCPUコアを提供するBEに対してrg1、rg2、rg3の3つのリソースグループを構成する場合、それぞれのリソースグループの `cpu_core_limit` の値は `2`、`6`、および `8` です。
  >
  > BEのすべてのCPUコアが占有されている場合、次の計算に基づいて各リソースグループに割り当てられるCPUコア数はそれぞれ 2、6、および 8 です。
  >
  > - rg1向けのCPUコア数 = BE上の総CPUコア数 × （2/16）= 2
  > - rg2向けのCPUコア数 = BE上の総CPUコア数 × （6/16）= 6
  > - rg3向けのCPUコア数 = BE上の総CPUコア数 × （8/16）= 8
  >
  > rg1とrg2がロードされているが、rg3はロードされていない場合、rg1とrg2に割り当てられるCPUコア数は、それぞれ4と12です。
  >
  > - rg1向けのCPUコア数 = BE上の総CPUコア数 × 2/8 = 4
  > - rg2向けのCPUコア数 = BE上の総CPUコア数 × 6/8 = 12

- `mem_limit`

  このパラメータは、BEが提供する総メモリのうちクエリに使用できるメモリの割合を指定します。有効な値は（0、1）です。

  > **注記**
  >
  > クエリに使用できるメモリ量は `query_pool` パラメータによって示されます。パラメータの詳細については、[メモリ管理](Memory_management.md)を参照してください。

- `concurrency_limit`

  このパラメータは、リソースグループ内の並行クエリの上限を指定します。あまりにも多くの並行クエリによって引き起こされるシステムの過負荷を回避するために使用されます。このパラメータは、0より大きい値が設定された場合のみ有効です。デフォルト値: 0。

- `max_cpu_cores`

  このパラメータは、単一のBEノード上のこのリソースグループのCPUコア制限です。`0` より大きい値が設定された場合にのみ有効です。範囲は、[0、`avg_be_cpu_cores`]で、`avg_be_cpu_cores`はすべてのBEノードを対象とするCPUコアの平均数を表します。デフォルト値: 0。

上記のリソース消費の制限に基づいて、以下のパラメータを使用して大規模なクエリのリソース消費をさらに制限できます。

- `big_query_cpu_second_limit`：このパラメータは、単一のBEでの大規模なクエリのCPU上限時間を指定します。並行クエリにより時間が加算されます。単位は秒です。このパラメータは、0より大きい値が設定された場合のみ有効です。デフォルト値: 0。
- `big_query_scan_rows_limit`：このパラメータは、単一のBEでの大規模なクエリのスキャン行数の上限を指定します。このパラメータは、0より大きい値が設定された場合のみ有効です。デフォルト値: 0。
- `big_query_mem_limit`：このパラメータは、単一のBEでの大規模なクエリのメモリ使用量の上限を指定します。単位はバイトです。このパラメータは、0より大きい値が設定された場合のみ有効です。デフォルト値: 0。

> **注記**
>
> リソースグループで実行されているクエリが上記の大規模なクエリ制限を超過した場合、クエリはエラーで終了します。また、`fe.audit.log` の `ErrorCode` 列にエラーメッセージを表示できます。

リソースグループの`type` を `short_query` または `normal` に設定できます。

- デフォルト値は `normal` です。パラメータ `type` で `normal` を指定する必要はありません。
- `short_query` リソースグループにヒットしたクエリの場合、BEノードは `short_query.cpu_core_limit` で指定されたCPUリソースを予約します。`normal` リソースグループにヒットしたクエリで予約されるCPUリソースは `BE core - short_query.cpu_core_limit` に制限されます。
- `short_query` リソースグループにクエリがヒットしない場合、`normal` リソースグループのリソースには制限がありません。

> **注意**
>
> - StarRocks Clusterで最大1つの `short_query` リソースグループを作成できます。
> - StarRocksは `short_query` リソースグループのCPUリソースの上限を厳密に設定しません。

### クラシファイア

各クラシファイアには、クエリのプロパティに一致する1つまたは複数の条件を保持します。StarRocksは、クエリを実行するためのリソースを割り当てるために、マッチの条件となる最適なクラシファイアを特定します。

クラシファイアは以下の条件をサポートします。

- `user`：ユーザーの名前
- `role`：ユーザーの役割
- `query_type`：クエリの種類。`SELECT` および `INSERT`（v2.5から）がサポートされます。`INSERT INTO` または `BROKER LOAD` タスクが `query_type` が `insert` のリソースグループにヒットした場合、BEノードはタスク用に指定されたCPUリソースを予約します。
- `source_ip`：クエリが開始されるCIDRブロック
- `db`：クエリアクセスするデータベース。カンマ「,」で区切られた文字列で指定できます。
- `plan_cpu_cost_range`：クエリの推定CPUコスト範囲。フォーマットは `(DOUBLE, DOUBLE]` です。デフォルト値は NULL で、この制限は存在しません。`fe.audit.log` の `PlanCpuCost` 列はクエリのCPUコストのシステム推定を表します。このパラメータはv3.1.4以降でサポートされます。
- `plan_mem_cost_range`：クエリのシステム推定メモリコストの範囲。フォーマットは `(DOUBLE, DOUBLE]` です。デフォルト値は NULL で、この制限は存在しません。`fe.audit.log` の `PlanMemCost` 列はクエリのメモリコストのシステム推定を表します。このパラメータはv3.1.4以降でサポートされます。

クラシファイアは、クラシファイアの条件の1つまたはすべてがクエリの情報に一致する場合のみ、クエリを一致させます。複数のクラシファイアがクエリに一致する場合、StarRocksは各クラシファイアとクエリの一致度を計算し、最も一致度が高いクラシファイアを特定します。

> **注記**
>
> `fe.audit.log` の `ResourceGroup` 列でクエリが属するリソースグループを表示したり、[クエリのリソースグループを表示](#view-the-resource-group-of-a-query)を参照して、`EXPLAIN VERBOSE <query>` を実行してリソースグループを表示できます。

StarRocksは、クエリとクラシファイアの一致度を計算する際に、以下のルールを使用します。

- クラシファイアの `user` がクエリと同じ値である場合、クラシファイアの一致度が1増加します。
- クラシファイアの `role` がクエリと同じ値である場合、クラシファイアの一致度が1増加します。
- クラシファイアがクエリと同じ値の `query_type` を持っている場合、クラシファイアの一致度は、クラシファイア内の `query_type` フィールドの数の逆数に1を足した数によって増加します。
- クラシファイアがクエリと同じ値の `source_ip` を持っている場合、クラシファイアの一致度は、(32 - `cidr_prefix`)/64 の結果に1を足した数によって増加します。
- クラシファイアがクエリと同じ値の `db` を持っている場合、クラシファイアの一致度は10に増加します。
- クエリの CPU コストが `plan_cpu_cost_range` に含まれる場合、クラシファイアの一致度は1に増加します。
- クエリのメモリコストが `plan_mem_cost_range` に含まれる場合、クラシファイアの一致度は1に増加します。

複数のクラシファイアがクエリと一致する場合は、条件の数が多いクラシファイアの一致度が高くなります。

```Plain
-- クラシファイア B はクラシファイア A よりも条件が多いです。したがって、クラシファイア B の一致度がクラシファイア A よりも高くなります。


クラシファイア A (user='Alice')


クラシファイア B (user='Alice', source_ip = '192.168.1.0/24')
```

複数の一致するクラシファイアが同じ条件の数を持っている場合、より正確に記述された条件を持つクラシファイアの一致度が高くなります。

```Plain
-- クラシファイア B に指定されている CIDR ブロックの範囲は、クラシファイア A よりも小さいです。したがって、クラシファイア B の一致度がクラシファイア A よりも高くなります。
クラシファイア A (user='Alice', source_ip = '192.168.1.0/16')
クラシファイア B (user='Alice', source_ip = '192.168.1.0/24')

-- クラシファイア C に指定されているクエリタイプの数は、クラシファイア D よりも少ないです。したがって、クラシファイア C の一致度がクラシファイア D よりも高くなります。
クラシファイア C (user='Alice', query_type in ('select'))
クラシファイア D (user='Alice', query_type in ('insert','select'))
```

複数のクラシファイアが同じ一致度を持っている場合、その中から1つのクラシファイアがランダムに選択されます。

```Plain
-- クエリが db1 と db2 の両方を同時にクエリする場合、クラシファイア E と F が一致するクラシファイアの中で最も一致度が高ければ、E と F のどちらかがランダムに選択されます。
クラシファイア E (db='db1')
クラシファイア F (db='db2')
```

## コンピューティングリソースの分離

リソースグループとクラシファイアを構成することで、クエリ間でコンピューティングリソースを分離できます。

### リソースグループを有効にする

リソースグループを使用するには、StarRcosk クラスターで Pipeline Engine を有効にする必要があります。

```SQL
-- 現在のセッションで Pipeline Engine を有効にします。
SET enable_pipeline_engine = true;
-- グローバルで Pipeline Engine を有効にします。
SET GLOBAL enable_pipeline_engine = true;
```

ローディングタスクの場合、FE 設定項目 `enable_pipeline_load` を設定して、ローディングタスクのために Pipeline Engine を有効にする必要があります。この項目は、v2.5.0 以降でサポートされています。

```sql
ADMIN SET FRONTEND CONFIG ("enable_pipeline_load" = "true");
```

> **注意**
>
> v3.1.0 以降、リソースグループはデフォルトで有効になり、セッション変数 `enable_resource_group` は廃止されています。

### リソースグループとクラシファイアを作成する

以下のステートメントを実行して、リソースグループを作成し、クラシファイアにリソースグループを関連付け、リソースグループにコンピューティングリソースを割り当てます。

```SQL
CREATE RESOURCE GROUP <group_name>
TO (
    user='string',
    role='string',
    query_type in ('select'),
    source_ip='cidr'
) -- クラシファイアを作成します。複数のクラシファイアを作成する場合は、クラシファイアをコンマ (`,`) で区切ります。
WITH (
    "cpu_core_limit" = "INT",
    "mem_limit" = "m%",
    "concurrency_limit" = "INT",
    "type" = "str" -- リソースグループのタイプ。値を normal に設定します。
);
```

例:

```SQL
CREATE RESOURCE GROUP rg1
TO
    (user='rg1_user1', role='rg1_role1', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user2', query_type in ('select'), source_ip='192.168.x.x/24'),
    (user='rg1_user3', source_ip='192.168.x.x/24'),
    (user='rg1_user4'),
    (db='db1')
WITH (
    'cpu_core_limit' = '10',
    'mem_limit' = '20%',
    'big_query_cpu_second_limit' = '100',
    'big_query_scan_rows_limit' = '100000',
    'big_query_mem_limit' = '1073741824'
);
```

### リソースグループを指定する（オプション）

現在のセッションにリソースグループを直接指定できます。

```SQL
SET resource_group = 'group_name';
```

### リソースグループとクラシファイアを表示する

以下のステートメントを実行して、すべてのリソースグループとクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUPS ALL;
```

以下のステートメントを実行して、ログインユーザーのリソースグループとクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUPS;
```

以下のステートメントを実行して、指定されたリソースグループとそのクラシファイアをクエリします。

```SQL
SHOW RESOURCE GROUP group_name;
```

例:

```plain
mysql> SHOW RESOURCE GROUPS ALL;
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| Name | Id     | CPUCoreLimit | MemLimit | ConcurrencyLimit | Type   | Classifiers                                                                                                            |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300040, weight=4.409375, user=rg1_user1, role=rg1_role1, query_type in (SELECT), source_ip=192.168.2.1/24)         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300041, weight=3.459375, user=rg1_user2, query_type in (SELECT), source_ip=192.168.3.1/24)                         |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300042, weight=2.359375, user=rg1_user3, source_ip=192.168.4.1/24)                                                 |
| rg1  | 300039 | 10           | 20.0%    | 11               | NORMAL | (id=300043, weight=1.0, user=rg1_user4)                                                                                |
+------+--------+--------------+----------+------------------+--------+------------------------------------------------------------------------------------------------------------------------+
```

> **注意**
>
> 上記の例では、`weight` は一致度を示しています。

### リソースグループとクラシファイアの管理

各リソースグループのリソースクォータを変更できます。また、リソースグループからクラシファイアを追加したり削除したりすることができます。

以下のステートメントを実行して、既存のリソースグループのリソースクォータを変更します。

```SQL
ALTER RESOURCE GROUP group_name WITH (
    'cpu_core_limit' = 'INT',
    'mem_limit' = 'm%'
);
```

以下のステートメントを実行して、リソースグループを削除します。

```SQL
DROP RESOURCE GROUP group_name;
```

以下のステートメントを実行して、リソースグループにクラシファイアを追加します。

```SQL
ALTER RESOURCE GROUP <group_name> ADD (user='string', role='string', query_type in ('select'), source_ip='cidr');
```

以下のステートメントを実行して、リソースグループからクラシファイアを削除します。

```SQL
ALTER RESOURCE GROUP <group_name> DROP (CLASSIFIER_ID_1, CLASSIFIER_ID_2, ...);
```

以下のステートメントを実行して、リソースグループのすべてのクラシファイアを削除します。

```SQL
ALTER RESOURCE GROUP <group_name> DROP ALL;
```

## リソースグループの監視

### クエリのリソースグループを表示する

クエリがヒットしたリソースグループは、**fe.audit.log** の `ResourceGroup` 列から、または `EXPLAIN VERBOSE <query>` を実行した後に返される `RESOURCE GROUP` 列から表示できます。これらは特定のクエリタスクが一致するリソースグループを示します。

- クエリがリソースグループの管理下にない場合、列の値は空の文字列 `""` になります。
- クエリがリソースグループの管理下にありますが、どのクラシファイアにも一致しない場合、列の値は空の文字列 `""` になります。ただし、このクエリはデフォルトのリソースグループ `default_wg` に割り当てられます。

`default_wg` のリソース制限は次のとおりです。

- `cpu_core_limit`: v2.3.7 以前の場合は 1、それ以降のバージョンの場合は BE の CPU コア数。
- `mem_limit`: 100%。
- `concurrency_limit`: 0。
- `big_query_cpu_second_limit`: 0。
- `big_query_scan_rows_limit`: 0。
- `big_query_mem_limit`: 0。

### リソースグループの監視

リソースグループ関連の FE および BE メトリクスの例を次に示します。以下のすべてのメトリクスには、対応するリソースグループを示す `name` ラベルがあります。

### FE メトリクス
以下のFEメトリクスは、現在のFEノード内でのみ統計情報を提供します：

| Metric                                          | Unit | Type          | Description                                                        |
| ----------------------------------------------- | ---- | ------------- | ------------------------------------------------------------------ |
| starrocks_fe_query_resource_group               | Count | Instantaneous | このリソースグループで過去に実行されたクエリの数（現在実行中のものを含む）。 |
| starrocks_fe_query_resource_group_latency       | ms    | Instantaneous | このリソースグループのクエリ遅延パーセンタイル。`type` ラベルには `mean`、`75_quantile`、`95_quantile`、`98_quantile`、`99_quantile`、`999_quantile` などの特定のパーセンタイルが示されます。 |
| starrocks_fe_query_resource_group_err           | Count | Instantaneous | このリソースグループでエラーが発生したクエリの数。 |
| starrocks_fe_resource_group_query_queue_total   | Count | Instantaneous | このリソースグループで過去にキューに入れられたクエリの合計数（現在実行中のものを含む）。このメトリクスはv3.1.4以降でサポートされています。クエリキューが有効な場合のみ有効で、詳細については[Query Queues](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_pending | Count | Instantaneous | このリソースグループのキューに現在存在するクエリの数。このメトリクスはv3.1.4以降でサポートされています。クエリキューが有効な場合のみ有効で、詳細については[Query Queues](query_queues.md)を参照してください。 |
| starrocks_fe_resource_group_query_queue_timeout | Count | Instantaneous | このリソースグループでキュー内でタイムアウトしたクエリの数。このメトリクスはv3.1.4以降でサポートされています。クエリキューが有効な場合のみ有効で、詳細については[Query Queues](query_queues.md)を参照してください。 |

### BEメトリクス

| Metric                                      | Unit     | Type          | Description                                                        |
| ----------------------------------------- | -------- | ------------- | ------------------------------------------------------------------ |
| resource_group_running_queries            | Count    | Instantaneous | このリソースグループで現在実行中のクエリの数。   |
| resource_group_total_queries              | Count    | Instantaneous | このリソースグループで過去に実行されたクエリの数（現在実行中のものを含む）。 |
| resource_group_bigquery_count             | Count    | Instantaneous | このリソースグループでビッグクエリ制限をトリガーしたクエリの数。 |
| resource_group_concurrency_overflow_count | Count    | Instantaneous | このリソースグループで `concurrency_limit` 制限をトリガーしたクエリの数。 |
| resource_group_mem_limit_bytes            | Bytes    | Instantaneous | このリソースグループのメモリ制限。                         |
| resource_group_mem_inuse_bytes            | Bytes    | Instantaneous | このリソースグループによって現在使用されているメモリ。               |
| resource_group_cpu_limit_ratio            | Percentage | Instantaneous | このリソースグループの `cpu_core_limit` を全リソースグループの `cpu_core_limit` に対する比率。 |
| resource_group_inuse_cpu_cores            | Count     | Average     | このリソースグループによって使用されているCPUコア数の推定値。この値はおおよその推定値です。2回のメトリック収集からの統計情報に基づいて計算された平均値を表します。このメトリクスはv3.1.4以降でサポートされています。 |
| resource_group_cpu_use_ratio              | Percentage | Average     | **非推奨** このリソースグループによって使用されたパイプラインスレッドの時間スライスがすべてのリソースグループで使用されたパイプラインスレッドの時間スライスの合計に対する比率。2回のメトリック収集からの統計情報に基づいて計算された平均値を表します。 |
| resource_group_connector_scan_use_ratio   | Percentage | Average     | **非推奨** このリソースグループによって使用された外部テーブルスキャンスレッドの時間スライスがすべてのリソースグループで使用されたパイプラインスレッドの時間スライスの合計に対する比率。2回のメトリック収集からの統計情報に基づいて計算された平均値を表します。 |
| resource_group_scan_use_ratio             | Percentage | Average     | **非推奨** このリソースグループによって使用された内部テーブルスキャンスレッドの時間スライスがすべてのリソースグループで使用されたパイプラインスレッドの時間スライスの合計に対する比率。2回のメトリック収集からの統計情報に基づいて計算された平均値を表します。 |

### リソースグループの使用状況情報を表示する

v3.1.4以降、StarRocksはSQLステートメント[SHOW USAGE RESOURCE GROUPS](../sql-reference/sql-statements/Administration/SHOW_USAGE_RESOURCE_GROUPS.md)をサポートしており、このステートメントはBE全体での各リソースグループの使用状況情報を表示するために使用されます。各フィールドの説明は以下の通りです：

- `Name`: リソースグループの名前。
- `Id`: リソースグループのID。
- `Backend`: BEのIPまたはFQDN。
- `BEInUseCpuCores`: このBE上のこのリソースグループによって現在使用されているCPUコアの数。この値はおおよその推定値です。
- `BEInUseMemBytes`: このBE上のこのリソースグループによって現在使用されているメモリバイトの数。
- `BERunningQueries`: このBE上でまだ実行中のこのリソースグループからのクエリの数。

ご注意ください：

- BEは `report_resource_usage_interval_ms` で指定された間隔でリーダーFEにこのリソース使用状況情報を定期的に報告します。デフォルトでは、これは1秒に設定されています。
- 結果には、`BEInUseCpuCores`/`BEInUseMemBytes`/`BERunningQueries` の少なくとも1つが正の数である行のみ表示されます。言い換えると、リソースグループがBEで何らかのリソースをアクティブに使用している場合にのみ情報が表示されます。

例：

```Plain
MySQL [(none)]> SHOW USAGE RESOURCE GROUPS;
+------------+----+-----------+-----------------+-----------------+------------------+
| Name       | Id | Backend   | BEInUseCpuCores | BEInUseMemBytes | BERunningQueries |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.1 | 0.100           | 1               | 5                |
+------------+----+-----------+-----------------+-----------------+------------------+
| default_wg | 0  | 127.0.0.2 | 0.200           | 2               | 6                |
+------------+----+-----------+-----------------+-----------------+------------------+
| wg1        | 0  | 127.0.0.1 | 0.300           | 3               | 7                |
+------------+----+-----------+-----------------+-----------------+------------------+
| wg2        | 0  | 127.0.0.1 | 0.400           | 4               | 8                |
+------------+----+-----------+-----------------+-----------------+------------------+
```

## 次のステップ

リソースグループを構成した後、メモリリソースとクエリを管理できます。詳細については、次のトピックを参照してください：

- [メモリ管理](../administration/Memory_management.md)

- [クエリ管理](../administration/Query_management.md)