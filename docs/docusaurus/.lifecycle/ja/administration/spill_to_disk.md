---
displayed_sidebar: "Japanese"
---

# ディスクに流出

このトピックでは、大規模なオペレータの中間計算結果をディスクに流出する方法について説明します。

## 概要

StarRocksのようなクエリ実行にインメモリコンピューティングを利用するデータベースシステムでは、大規模なデータセットでの集計、ソート、および結合オペレータを処理する際に、実行中のクエリが相当なメモリリソースを消費することがあります。メモリ制限に達すると、これらのクエリはメモリ不足（OOM）のため強制終了されます。

ただし、メモリを大量に消費するタスクを安定して完了させたい場合や、パフォーマンスが最優先ではない場合（例：マテリアライズドビューの構築、INSERT INTO SELECT による軽量なETLの実行など）もあります。これらのタスクはメモリリソースを簡単に使い切り、その結果、クラスタで実行中の他のクエリがブロックされることがあります。通常、この問題に対処するには、これらのタスクを個別に微調整し、クエリの同時実行を制御するためにリソース分離戦略に頼るしかありません。これは特に不便で、一部の極端なシナリオでは失敗する可能性があります。

StarRocks v3.0.1から、StarRocksは一部のメモリを大量に消費するオペレータの中間結果をディスクに流出する機能をサポートしています。この機能により、パフォーマンスのわずかな低下と引き換えに、メモリ使用量を大幅に削減し、システムの可用性を向上させることができます。

現在、StarRocksの流出機能は以下のオペレータをサポートしています：

- 集計オペレータ
- ソートオペレータ
- ハッシュジョイン（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN、INNER JOIN）オペレータ

## 中間結果の流出を有効にする

中間結果の流出を有効にするには、以下の手順に従ってください：

1. BE構成ファイル **be.conf** で、中間結果を保存する流出ディレクトリ `spill_local_storage_dir` を指定し、修正を有効にするためにクラスタを再起動します。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **注**
   >
   > - `spill_local_storage_dir` を複数指定する場合は、セミコロン（`;`）で区切って指定できます。
   > - 本番環境では、データストレージと流出のために異なるディスクを使用することを強くお勧めします。中間結果をディスクに流出すると、書き込み負荷とディスク使用量の両方が大幅に増加する可能性があります。同じディスクを使用すると、この急増はクラスタで実行中の他のクエリやタスクに影響を与える可能性があります。

2. 中間結果の流出を有効にするには、次のステートメントを実行します：

   ```SQL
   SET enable_spill = true;
   ```

3. セッション変数 `spill_mode` を使用して、中間結果の流出モードを構成します：

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **注**
   >
   > 流出を伴うクエリが完了するたびに、StarRocksは自動的に流出データをクリアします。BEがデータをクリアする前にクラッシュした場合、StarRocksはBEが再起動されるとデータをクリアします。

   | **変数**       | **デフォルト** | **説明**                                                     |
   | -------------- | -------------- | ------------------------------------------------------------ |
   | enable_spill   | false          | 中間結果の流出を有効にするかどうか。`true`に設定すると、StarRocksはクエリでの集計、ソート、または結合オペレータの処理時にメモリ使用量を減らすために中間結果をディスクに流出します。 |
   | spill_mode     | auto           | 中間結果の流出の実行モード。有効な値：<ul><li>`auto`：メモリ使用量のしきい値に達したときに自動的に流出がトリガーされます。</li><li>`force`：メモリ使用量に関係なく、StarRocksはすべての関連オペレータのために流出を強制的に実行します。</li></ul>この変数は、変数 `enable_spill` が `true` に設定されている場合のみ有効です。 |

## 制限

- 全てのOOMの問題を流出によって解決できるわけではありません。例えば、StarRocksは式評価に使用されたメモリを解放することはできません。
- 通常、流出を伴うクエリはクエリの遅延が10倍に増加することを意味します。これらのクエリのためにセッション変数 `query_timeout` を設定して、クエリのタイムアウトを延長することをお勧めします。