---
displayed_sidebar: "Japanese"
---

# ディスクへのスピル

このトピックでは、大規模な演算子の中間計算結果をディスクにスピルする方法について説明します。

## 概要

StarRocksのような問い合わせの実行にインメモリコンピューティングを依存するデータベースシステムでは、大規模なデータセット上での集計、ソート、および結合演算子を処理する際に、かなりのメモリリソースを消費することがあります。使用可能なメモリ上限に達すると、これらの問い合わせはメモリ不足によって強制終了されます。

ただし、特定のメモリ集約型のタスクを安定して完了させることが望ましい場合がありますが、その場合にはパフォーマンスが最優先ではないことがしばしばあります。たとえば、マテリアライズド・ビューの構築、またはINSERT INTO SELECTでの軽量なETLの実行などがこれに当たります。これらのタスクは容易にメモリリソースを使い果たし、それによってクラスタ内で実行されている他の問い合わせをブロックする可能性があります。通常、この問題に対処するには、これらのタスクを個別に微調整し、クエリの同時実行を制御するためにリソースの分離戦略に依存することしかできません。これは特に不便で、極端なシナリオでは失敗する可能性があります。

StarRocks v3.0.1 から、StarRocksは一部のメモリ集約型演算子の中間結果をディスクにスピルする機能をサポートしています。この機能により、パフォーマンスの若干の低下を許容して、メモリ使用量を大幅に削減し、それによりシステムの可用性を向上させることができます。

現在、StarRocksのスピル機能は、以下の演算子をサポートしています。

- 集計演算子
- ソート演算子
- ハッシュ結合（LEFT JOIN、RIGHT JOIN、FULL JOIN、OUTER JOIN、SEMI JOIN、INNER JOIN）演算子

## 中間結果スピルの有効化

次の手順に従って、中間結果のスピルを有効にします。

1. BE構成ファイルの **be.conf** で中間結果のスピル先である `spill_local_storage_dir` を指定し、修正を有効にするためにクラスタを再起動します。

   ```Properties
   spill_local_storage_dir=/<dir_1>[;/<dir_2>]
   ```

   > **注意**
   >
   > - セミコロン（`;`）で区切って複数の `spill_local_storage_dir` を指定できます。
   > - 本番環境では、データ保存とスピルに異なるディスクを使用することを強く推奨します。中間結果がディスクにスピルされると、書き込み負荷とディスク使用量が大幅に増加する可能性があります。同じディスクを使用する場合、このサージはクラスタで実行されている他の問い合わせやタスクに影響を与える可能性があります。

2. 中間結果のスピルを有効にするには、次のステートメントを実行します。

   ```SQL
   SET enable_spill = true;
   ```

3. セッション変数 `spill_mode` を使用して中間結果スピルのモードを構成します。

   ```SQL
   SET spill_mode = { "auto" | "force" };
   ```

   > **注意**
   >
   > スピルが完了するたびに、StarRocksは自動的にクエリによって生成されたスピルデータをクリアします。BEがデータをクリアする前にクラッシュした場合、StarRocksはBEが再起動されるとデータをクリアします。

   | **変数**       | **デフォルト** | **説明**                                                                                                                                                       |
   | -------------- | -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | enable_spill   | false          | 中間結果スピルを有効にするかどうか。`true`に設定すると、StarRocksは問い合わせ内の集計、ソート、または結合演算子を処理する際にメモリ使用量を減らすため、中間結果をディスクにスピルします。                     |
   | spill_mode     | auto           | 中間結果スピルの実行モード。有効な値：<ul><li>`auto`：メモリ使用量の閾値に達したときに、スピルが自動的にトリガーされます。</li><li>`force`：メモリ使用量に関係なく、StarRocksは関連する全ての演算子を強制的にスピルします。</li></ul> この変数は、`enable_spill`が`true`に設定されている場合のみ有効です。 |

## 制限事項

- すべてのメモリ不足の問題をスピルして解決するわけではありません。たとえば、StarRocksは式の評価に使用されたメモリを解放できません。
- 通常、スピルを含む問い合わせは10倍のクエリ遅延を示します。これらの問い合わせのためにセッション変数 `query_timeout` を設定してクエリのタイムアウトを延長することをお勧めします。