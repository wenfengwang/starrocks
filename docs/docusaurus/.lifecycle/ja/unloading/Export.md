---
displayed_sidebar: "Japanese"
---

# EXPORTを使用してデータをエクスポートする

このトピックでは、StarRocksクラスター内の指定されたテーブルまたはパーティションからデータをCSV形式のデータファイルとして外部ストレージシステムにエクスポートする方法について説明します。外部ストレージシステムは、分散ファイルシステムHDFSやAWS S3などのクラウドストレージシステムであることができます。

> **注意**
>
> StarRocksテーブルからデータをエクスポートするには、そのStarRocksテーブルに対するEXPORT権限を持つユーザーのみが可能です。EXPORT権限がない場合は、[GRANT](../sql-reference/sql-statements/account-management/GRANT.md)でEXPORT権限を付与するための指示に従ってください。

## バックグラウンド情報

v2.4およびそれ以前では、StarRocksはデータをエクスポートするためにEXPORTステートメントを使用する際に、StarRocksクラスターと外部ストレージシステムの間の接続を設定するためにブローカーに依存していました。そのため、EXPORTステートメントで使用するブローカーを指定するために `WITH BROKER "<broker_name>"` を入力する必要がありました。これは「ブローカーに基づくアンロード」と呼ばれます。ブローカーは、ファイルシステムインターフェースと統合された独立した状態を持つサービスであり、StarRocksが外部ストレージシステムにデータをエクスポートするのを支援します。

v2.5以降では、StarRocksはブローカーに依存せずに、StarRocksクラスターと外部ストレージシステムの間の接続を設定します。EXPORTステートメントを使用してデータをエクスポートする際には、もはやブローカーを指定する必要はありませんが、 `WITH BROKER` キーワードは引き続き保持する必要があります。これは「ブローカーフリーのアンロード」と呼ばれます。

ただし、データがHDFSに格納されている場合、ブローカーフリーのアンロードが機能しないことがあり、ブローカーに基づいたアンロードに戻ることがあります：

- 複数のHDFSクラスターにデータをエクスポートする場合、それぞれのHDFSクラスターに独立したブローカーを展開および構成する必要があります。
- 単一のHDFSクラスターにデータをエクスポートし、複数のKerberosユーザーを構成している場合、独立したブローカーを展開する必要があります。

> **注意**
>
> [SHOW BROKER](../sql-reference/sql-statements/Administration/SHOW_BROKER.md) ステートメントを使用して、StarRocksクラスターに展開されているブローカーを確認できます。ブローカーが展開されていない場合は、[ブローカーを展開する](../deployment/deploy_broker.md) で提供される指示に従ってブローカーを展開できます。

## サポートされているストレージシステム

- 分散ファイルシステムHDFS
- AWS S3などのクラウドストレージシステム

## 注意事項

- 一度にエクスポートするデータが数十GBを超えないようお勧めします。一度に膨大な量のデータをエクスポートすると、エクスポートが失敗する可能性があり、エクスポートを再試行するコストが増加します。

- 元のStarRocksテーブルに大量のデータが含まれる場合は、テーブルのすべてのデータがエクスポートされるまで、テーブルのパーティションからデータをエクスポートすることをお勧めします。

- StarRocksクラスターのFEが再起動したり、エクスポートジョブが実行中に新しいリーダーフェを選出した場合は、エクスポートジョブが失敗します。この状況では、エクスポートジョブを再度提出する必要があります。

- StarRocksクラスターのFEが再起動したり、エクスポートジョブの完了後に新しいリーダーフェが選出された場合は、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md) ステートメントによって返されるジョブ情報の一部が失われる可能性があります。

- StarRocksはベーステーブルのデータのみをエクスポートします。StarRocksはベーステーブル上に作成されたマテリアライズドビューのデータをエクスポートしません。

- エクスポートジョブにはデータスキャンが必要であり、これによりI/Oリソースが占有され、クエリの待機時間が増加します。

## ワークフロー

エクスポートジョブを提出すると、StarRocksはエクスポートジョブに関与するすべてのタブレットを識別します。その後、StarRocksは関与するタブレットをグループに分割し、クエリプランを生成します。クエリプランは関与するタブレットからデータを読み取り、指定された宛先ストレージシステムのパスにデータを書き込むために使用されます。

次の図は一般的なワークフローを示しています。

![img](../assets/5.3.1-1.png)

一般的なワークフローは、次の3つのステップで構成されています。

1. ユーザーがリーダーフェにエクスポートジョブを提出します。

2. リーダーフェは、StarRocksクラスターのすべてのBEに `snapshot` 命令を発行して、BEが関与するタブレットのスナップショットを取り、エクスポートされるデータの一貫性を確保します。リーダーフェはまた、複数のエクスポートタスクを生成します。各エクスポートタスクはクエリプランであり、各クエリプランは関与するタブレットの一部を処理するために使用されます。

3. リーダーフェはエクスポートタスクをBEに配信します。

## 原則

StarRocksがクエリプランを実行するとき、最初に宛先ストレージシステムの指定されたパスに `__starrocks_export_tmp_xxx` という一時フォルダを作成します。一時フォルダの名前には、 `xxx` がエクスポートジョブのIDを表します。一時フォルダの例の名前は `__starrocks_export_tmp_921d8f80-7c9d-11eb-9342-acde48001122` です。StarRocksがクエリプランを正常に実行した後、一時フォルダに一時ファイルを生成し、エクスポートされたデータを生成された一時ファイルに書き込みます。

すべてのデータがエクスポートされた後、StarRocksはRENAMEステートメントを使用して生成された一時ファイルを指定されたパスに保存します。

## 関連するパラメータ

このセクションでは、StarRocksクラスターのFEで構成できるエクスポート関連のいくつかのパラメータについて説明します。

- `export_checker_interval_second`：エクスポートジョブがスケジュールされる間隔。デフォルトの間隔は5秒です。このパラメータをFEの再構成後は、新しいパラメータ設定が有効になるようにFEを再起動する必要があります。

- `export_running_job_num_limit`：許可される実行中のエクスポートジョブの最大数。実行中のエクスポートジョブの数がこの制限を超えると、余分なエクスポートジョブは `snapshot` 後に待機状態に入ります。デフォルトの最大数は5です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_task_default_timeout_second`：エクスポートジョブのタイムアウト期間。デフォルトのタイムアウト期間は2時間です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_max_bytes_per_be_per_task`：各BEからの各エクスポートタスクあたりにエクスポートできる最大データ量（圧縮済み）。このパラメータは、StarRocksが同時に実行できるエクスポートタスクにエクスポートジョブを分割するためのポリシーを提供します。デフォルトの最大量は256MBです。

- `export_task_pool_size`：スレッドプールで同時に実行できるエクスポートタスクの最大数。デフォルトの最大数は5です。

## 基本操作

### エクスポートジョブを提出する

StarRocksデータベース `db1` に `tbl1` という名前のテーブルが含まれていると仮定します。`tbl1` のパーティション `p1` と `p2` から列 `col1` と `col3` のデータをHDFSクラスターの `export` パスにエクスポートするには、次のコマンドを実行します：

```SQL
EXPORT TABLE db1.tbl1 
PARTITION (p1,p2)
(col1, col3)
TO "hdfs://HDFS_IP:HDFS_Port/export/lineorder_" 
PROPERTIES
(
    "column_separator"=",",
    "load_mem_limit"="2147483648",
    "timeout" = "3600"
)
WITH BROKER
(
    "username" = "user",
    "password" = "passwd"
);
```

AWS S3にデータをエクスポートするコマンドの構文やパラメータの説明、およびコマンドの例の詳細については、[EXPORT](../sql-reference/sql-statements/data-manipulation/EXPORT.md) を参照してください。

### エクスポートジョブのクエリIDを取得する

エクスポートジョブを提出した後、SELECT LAST_QUERY_ID() ステートメントを使用してエクスポートジョブのクエリIDを照会できます。クエリIDを使用して、エクスポートジョブを表示またはキャンセルできます。

コマンドの詳細な構文やパラメータの説明については、[last_query_id](../sql-reference/sql-functions/utility-functions/last_query_id.md) を参照してください。

### エクスポートジョブの状態を表示する

エクスポートジョブを提出した後、SHOW EXPORT ステートメントを使用してエクスポートジョブの状態を表示できます。例：

```SQL
SHOW EXPORT WHERE queryid = "edee47f0-abe1-11ec-b9d1-00163e1e238f";
```

前述の例では、`queryid` はエクスポートジョブのクエリIDです。

以下に示すような情報が返されます：

```Plain
JobId: 14008
State: FINISHED
Progress: 100%
TaskInfo: {"partitions":["*"],"mem limit":2147483648,"column separator":",","line delimiter":"\n","tablet num":1,"broker":"hdfs","coord num":1,"db":"default_cluster:db1","tbl":"tbl3",columns:["col1", "col3"]}
Path: oss://bj-test/export/
CreateTime: 2019-06-25 17:08:24
StartTime: 2019-06-25 17:08:28
FinishTime: 2019-06-25 17:08:34
Timeout: 3600
ErrorMsg: N/A
```

詳細な構文やパラメータの説明については、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md) を参照してください。

### エクスポートジョブをキャンセルする

提出したエクスポートジョブをキャンセルするには、CANCEL EXPORT ステートメントを使用できます。例：

```SQL
CANCEL EXPORT WHERE queryid = "921d8f80-7c9d-11eb-9342-acde48001122";

> **注**
>
> 前述の例の中で `queryid` はエクスポートジョブのクエリIDです。

詳細な構文やパラメータの説明については、[CANCEL EXPORT](../sql-reference/sql-statements/data-manipulation/CANCEL_EXPORT.md) を参照してください。

## ベストプラクティス

### クエリプランの分割

エクスポートジョブが分割されるクエリプランの数は、エクスポートジョブに関与するタブレットの数や、クエリプランごとに処理できる最大データ量に依存します。エクスポートジョブはクエリプランとして再試行されます。クエリプランによって処理されるデータ量が許容される最大量を超えると、リモートストレージでジッターなどのエラーが発生します。その結果、クエリプランの再試行コストが増加します。各BEが処理できるクエリプランごとの最大データ量は、デフォルトで256 MB となる `export_max_bytes_per_be_per_task` パラメータで指定されます。クエリプランでは、各BEに少なくとも1つのタブレットが割り当てられ、`export_max_bytes_per_be_per_task` パラメータで指定された制限を超えないデータ量をエクスポートできます。

エクスポートジョブの複数のクエリプランは並行して実行されます。FE パラメータ `export_task_pool_size` を使用して、スレッドプールにより同時に実行されるエクスポートタスクの最大数を指定できます。このパラメータのデフォルト値は `5` です。

通常、エクスポートジョブの各クエリプランは、スキャンとエクスポートの2つの部分で構成されます。クエリプランに必要な計算を実行するロジックは、あまり多くのメモリを消費しません。したがって、デフォルトの2 GB のメモリ制限は、ほとんどのビジネス要件を満たすことができます。ただし、特定の状況では、たとえばBE上で多くのタブレットをスキャンする必要がある場合や、タブレットに多くのバージョンが存在する場合など、2 GB のメモリ容量が不十分な場合があります。そのような場合には、`load_mem_limit` パラメータを使用して、4 GB や 8 GB のようなより高いメモリ容量制限を指定する必要があります。