---
displayed_sidebar: "Japanese"
---

# EXPORTコマンドを使用してデータをエクスポートする

このトピックでは、指定されたテーブルまたはパーティションからStarRocksクラスタのデータをCSVデータファイルとして外部ストレージシステムにエクスポートする方法について説明します。外部ストレージシステムは、分散ファイルシステムHDFSやAWS S3などのクラウドストレージシステムであることができます。

> **注意**
>
> StarRocksテーブルからデータをエクスポートできるのは、そのStarRocksテーブルにEXPORT権限を持つユーザのみです。EXPORT権限がない場合は、[GRANT](../sql-reference/sql-statements/account-management/GRANT.md)に記載されている手順に従って、StarRocksクラスタに接続する際に使用するユーザにEXPORT権限を付与する必要があります。

## バックグラウンド情報

v2.4およびそれ以前では、StarRocksはデータをエクスポートする際にEXPORTステートメントを使用すると、StarRocksクラスタと外部ストレージシステムとの間に接続を設定するためにブローカーに依存していました。そのため、EXPORTステートメントで使用するブローカーを指定するには、`WITH BROKER "<broker_name>"`を入力する必要がありました。これは"ブローカーに基づくアンローディング"と呼ばれます。ブローカーは、独立した状態を持つサービスであり、ファイルシステムインターフェースと統合されており、StarRocksがデータを外部ストレージシステムにエクスポートするのを支援します。

v2.5以降、StarRocksはブローカーに依存せずにデータをエクスポートする際にStarRocksクラスタと外部ストレージシステムとの間に接続を設定する必要がなくなりました。そのため、EXPORTステートメントでブローカーを指定する必要はなくなりましたが、`WITH BROKER`キーワードは引き続き保持する必要があります。これは"ブローカーフリーアンローディング"と呼ばれます。

ただし、データがHDFSに保存されている場合、ブローカーフリーアンローディングが機能しないことがあり、ブローカーに基づくアンローディングに戻ることができます。

- 複数のHDFSクラスタにデータをエクスポートする場合、各HDFSクラスタに独立したブローカーを展開および構成する必要があります。
- 単一のHDFSクラスタにデータをエクスポートし、複数のKerberosユーザを構成している場合、独立したブローカーを展開する必要があります。

> **注意**
>
> StarRocksクラスタに展開されているブローカーを確認するには、[SHOW BROKER](../sql-reference/sql-statements/Administration/SHOW_BROKER.md)ステートメントを使用できます。ブローカーが展開されていない場合は、[ブローカーを展開する](../deployment/deploy_broker.md)に記載されている手順に従ってブローカーを展開できます。

## サポートされているストレージシステム

- 分散ファイルシステムHDFS
- AWS S3などのクラウドストレージシステム

## 注意事項

- 一度にエクスポートするデータが数十GBを超えないように推奨します。大量のデータを一度にエクスポートすると、エクスポートが失敗する可能性があり、再試行にかかるコストが増加します。

- ソースのStarRocksテーブルに大量のデータが含まれる場合は、テーブルのデータ全体を一度にエクスポートするのではなく、テーブルの一部のパーティションからデータをエクスポートすることを推奨します。

- StarRocksクラスタのFEが再起動するか新しいリーダーFEが選出された場合、エクスポートジョブは失敗します。この場合は、エクスポートジョブを再提出する必要があります。

- StarRocksクラスタのFEが再起動するか新しいリーダーFEが選出された後、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)ステートメントによって返されるジョブ情報の一部が失われる可能性があります。

- StarRocksはベーステーブルのデータのみをエクスポートします。StarRocksは、ベーステーブル上に作成されたマテリアライズドビューのデータをエクスポートしません。

- エクスポートジョブはデータスキャンを必要とし、I/Oリソースを占有し、結果としてクエリの待ち時間を増加させます。

## ワークフロー

エクスポートジョブを提出すると、StarRocksはエクスポートジョブに関与するすべてのタブレットを識別します。その後、StarRocksは関与するタブレットをグループに分割し、クエリプランを生成します。クエリプランは、関与するタブレットからデータを読み取り、指定された宛先ストレージシステムのパスにデータを書き込むために使用されます。

次の図は、一般的なワークフローを示しています。

![img](../assets/5.3.1-1.png)

一般的なワークフローは、次の3つのステップで構成されています。

1. ユーザがリーダーFEにエクスポートジョブを提出します。

2. リーダーFEは、StarRocksクラスタのすべてのBEに`snapshot`命令を発行し、BEが関与するタブレットのスナップショットを取得してデータの整合性を確保します。また、リーダーFEは複数のエクスポートタスクを生成します。各エクスポートタスクはクエリプランであり、各クエリプランは関与するタブレットの一部を処理するために使用されます。

3. リーダーFEはエクスポートタスクをBEに配布します。

## 原則

StarRocksはクエリプランを実行する際、まず、宛先ストレージシステムの指定されたパスに`__starrocks_export_tmp_xxx`という一時フォルダを作成します。一時フォルダの名前には、`xxx`がエクスポートジョブのIDを表します。一時フォルダの例として、`__starrocks_export_tmp_921d8f80-7c9d-11eb-9342-acde48001122`という名前があります。StarRocksがクエリプランを成功裏に実行した後、一時フォルダ内に一時ファイルを生成し、エクスポートされたデータを生成された一時ファイルに書き込みます。

すべてのデータがエクスポートされた後、StarRocksは生成された一時ファイルを指定されたパスに保存するためにRENAMEステートメントを使用します。

## 関連するパラメータ

このセクションでは、StarRocksクラスタのFEで構成できるいくつかのエクスポート関連パラメータについて説明します。

- `export_checker_interval_second`: エクスポートジョブがスケジュールされる間隔。デフォルトの間隔は5秒です。このパラメータをFEに再構成した後は、新しいパラメータ設定を有効にするためにFEを再起動する必要があります。

- `export_running_job_num_limit`: 許可されている実行中のエクスポートジョブの最大数。実行中のエクスポートジョブの数がこの制限を超えると、余分なエクスポートジョブは`snapshot`の後に待機状態に入ります。デフォルトの最大数は5です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_task_default_timeout_second`: エクスポートジョブのタイムアウト期間。デフォルトのタイムアウト期間は2時間です。エクスポートジョブが実行中の場合にこのパラメータを再構成できます。

- `export_max_bytes_per_be_per_task`: 各BEからエクスポートタスクごとにエクスポートできる最大圧縮データ量。このパラメータは、同時に実行できるエクスポートタスクにエクスポートジョブを分割するためのポリシーを提供します。デフォルトの最大量は256MBです。

- `export_task_pool_size`: スレッドプールによって同時に実行できるエクスポートタスクの最大数。デフォルトの最大数は5です。

## 基本的な操作

### エクスポートジョブを提出する

StarRocksデータベース`db1`に`tbl1`というテーブルが含まれているとします。`tbl1`のパーティション`p1`と`p2`から列`col1`および`col3`のデータをHDFSクラスタの`export`パスにエクスポートするには、次のコマンドを実行します。

```SQL
EXPORT TABLE db1.tbl1 
PARTITION (p1,p2)
(col1, col3)
TO "hdfs://HDFS_IP:HDFS_Port/export/lineorder_" 
PROPERTIES
(
    "column_separator"=",",
    "load_mem_limit"="2147483648",
    "timeout" = "3600"
)
WITH BROKER
(
    "username" = "user",
    "password" = "passwd"
);
```

詳細な構文とパラメータの説明、およびAWS S3にデータをエクスポートするコマンドの例については、[EXPORT](../sql-reference/sql-statements/data-manipulation/EXPORT.md)を参照してください。

### エクスポートジョブのクエリIDを取得する

エクスポートジョブを提出した後、SELECT LAST_QUERY_ID()ステートメントを使用してエクスポートジョブのクエリIDを照会できます。クエリIDを使用すると、エクスポートジョブを表示またはキャンセルできます。

詳細な構文とパラメータの説明については、[last_query_id](../sql-reference/sql-functions/utility-functions/last_query_id.md)を参照してください。

### エクスポートジョブのステータスを表示する

エクスポートジョブを提出した後、SHOW EXPORTステートメントを使用してエクスポートジョブのステータスを表示できます。例:

```SQL
SHOW EXPORT WHERE queryid = "edee47f0-abe1-11ec-b9d1-00163e1e238f";
```

上記の例では、`queryid`はエクスポートジョブのクエリIDです。

次のような情報が類似した出力として返されます:

```Plain
JobId: 14008
State: FINISHED
Progress: 100%
TaskInfo: {"partitions":["*"],"mem limit":2147483648,"column separator":",","line delimiter":"\n","tablet num":1,"broker":"hdfs","coord num":1,"db":"default_cluster:db1","tbl":"tbl3",columns:["col1", "col3"]}
Path: oss://bj-test/export/
CreateTime: 2019-06-25 17:08:24
StartTime: 2019-06-25 17:08:28
FinishTime: 2019-06-25 17:08:34
Timeout: 3600
ErrorMsg: N/A
```

詳細な構文とパラメータの説明については、[SHOW EXPORT](../sql-reference/sql-statements/data-manipulation/SHOW_EXPORT.md)を参照してください。

### エクスポートジョブをキャンセルする

提出したエクスポートジョブをキャンセルするには、CANCEL EXPORTステートメントを使用できます。例:

```SQL
```
EXPORTキャンセル WHERE queryid = "921d8f80-7c9d-11eb-9342-acde48001122";
```

> **注記**
>
> 前述の例では、`queryid`はエクスポートジョブのクエリIDです。

詳細な構文とパラメータの説明については、[EXPORTキャンセル](../sql-reference/sql-statements/data-manipulation/CANCEL_EXPORT.md)を参照してください。

## ベストプラクティス

### クエリプランの分割

エクスポートジョブが分割されるクエリプランの数は、エクスポートジョブに関与するタブレットの数や、クエリプランごとに処理できる最大データ量によって異なります。エクスポートジョブはクエリプランとして再試行されます。クエリプランが処理できるデータ量が、`export_max_bytes_per_be_per_task`パラメータで指定された制限を超えると、リモートストレージでジッターなどのエラーが発生します。その結果、クエリプランを再試行するコストが増加します。各BEが処理できるクエリプランあたりの最大データ量は、デフォルトで256 MBに設定されている`export_max_bytes_per_be_per_task`パラメータによって指定されます。クエリプランでは、各BEに少なくとも1つのタブレットが割り当てられ、`export_max_bytes_per_be_per_task`パラメータで指定された制限を超えないデータ量をエクスポートすることができます。

エクスポートジョブの複数のクエリプランは同時に実行されます。FEパラメータ `export_task_pool_size`を使用して、スレッドプールで同時に実行できるエクスポートタスクの最大数を指定できます。このパラメータはデフォルトで`5`に設定されています。

通常、エクスポートジョブの各クエリプランは、スキャンとエクスポートの2つの部分で構成されています。クエリプランで必要とされる計算を実行するためのロジックは、あまり多くのメモリを消費しません。そのため、2 GBのデフォルトメモリ制限は、ほとんどのビジネス要件を満たすことができます。ただし、クエリプランにビッグエンドやタブレットのバージョンが多く含まれる場合など、特定の状況では2 GBのメモリ容量が不十分な場合があります。そのような状況では、`load_mem_limit`パラメータを使用して、4 GBや8 GBなどのより高いメモリ容量の制限を指定する必要があります。
```