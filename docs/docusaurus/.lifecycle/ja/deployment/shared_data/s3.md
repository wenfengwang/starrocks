---
displayed_sidebar: "Japanese"
---

# 共有データにS3を使用する

import SharedDataIntro from '../../assets/commonMarkdown/sharedDataIntro.md'
import SharedDataCNconf from '../../assets/commonMarkdown/sharedDataCNconf.md'
import SharedDataUseIntro from '../../assets/commonMarkdown/sharedDataUseIntro.md'
import SharedDataUse from '../../assets/commonMarkdown/sharedDataUse.md'

<SharedDataIntro />

## アーキテクチャ

![共有データアーキテクチャ](../../assets/share_data_arch.png)

## 共有データのStarRocksクラスターをデプロイする

共有データのStarRocksクラスターのデプロイは、共有ナッシングのStarRocksクラスターと類似しています。唯一の違いは、共有データクラスターではBEの代わりにCNをデプロイする必要があることです。このセクションでは、共有データのStarRocksクラスターをデプロイする際にFEとCNの**fe.conf**および**cn.conf**の構成ファイルに追加する必要のある追加の項目のみをリストアップしています。StarRocksクラスターのデプロイの詳細手順については、[StarRocksのデプロイ](../../deployment/deploy_manually.md)を参照してください。

> **注意**
>
> 次のセクションの共有ストレージの構成が完了するまで、クラスターを開始しないでください。

## 共有データのStarRocksのFEノードを構成する

クラスターを開始する前に、FEおよびCNを構成してください。以下に例の構成を示し、その後に各パラメータの詳細が記載されています。

### S3用のFE構成の例

これらは、各FEノードの`fe.conf`ファイルに追加する共有データの例です。使用するAWS認証方法に基づいて例が異なります。

#### デフォルトの認証資格情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_aws_sdk_default_behavior = true

# 上記の詳細を使用してオブジェクトストレージにデフォルトのストレージを作成しない場合は、この項目をfalseに設定してください
enable_load_volume_from_conf = true
```

#### IAMユーザーベースの資格情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# S3オブジェクトの読み取り/書き込み用の認証情報
aws_s3_access_key = <access_key>
aws_s3_secret_key = <secret_key>

# 上記の詳細を使用してオブジェクトストレージにデフォルトのストレージを作成しない場合は、この項目をfalseに設定してください
enable_load_volume_from_conf = true
```

#### インスタンスプロファイル

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true

# 上記の詳細を使用してオブジェクトストレージにデフォルトのストレージを作成しない場合は、この項目をfalseに設定してください
enable_load_volume_from_conf = true
```

#### 仮定されるロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>

# 上記の詳細を使用してオブジェクトストレージにデフォルトのストレージを作成しない場合は、この項目をfalseに設定してください
enable_load_volume_from_conf = true
```

#### 外部アカウントから仮定されるロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>
aws_s3_external_id = <external_id>

# 上記の詳細を使用してオブジェクトストレージにデフォルトのストレージを作成しない場合は、この項目をfalseに設定してください
enable_load_volume_from_conf = true
```

### S3と共有ストレージに関連するすべてのFEパラメータ

#### run_mode

StarRocksクラスターの実行モード。有効な値:

- `shared_data`
- `shared_nothing` (デフォルト)

> **注意**
>
> StarRocksクラスターでは、`shared_data`モードと`shared_nothing`モードを同時に採用することはできません。混合デプロイはサポートされていません。
>
> 群集をデプロイした後で`run_mode`を変更しないでください。さもないと、クラスターの再起動に失敗します。`shared_nothing`クラスターから`shared_data`クラスターまたはその逆の変換はサポートされていません。

#### cloud_native_meta_port

クラウドネイティブメタサービスのRPCポート。

- デフォルト: `6090`

#### enable_load_volume_from_conf

StarRocksに、FE構成ファイルで指定されたオブジェクトストレージ関連のプロパティを使用して、デフォルトのストレージボリュームを作成することを許可するかどうか。有効な値:

- `true` (デフォルト) 新しい共有データクラスターを作成する際にこの項目を`true`と指定すると、StarRocksはFE構成ファイルのオブジェクトストレージ関連のプロパティを使用して組み込みストレージボリューム`builtin_storage_volume`を作成し、デフォルトのストレージボリュームとして設定します。ただし、オブジェクトストレージ関連のプロパティを指定していない場合、StarRocksは開始に失敗します。
- `false` 新しい共有データクラスターを作成する際にこの項目を`false`と指定すると、StarRocksは直接開始され、組み込みストレージボリュームは作成されません。StarRocks内でオブジェクトを作成する前に、手動でストレージボリュームを作成し、デフォルトのストレージボリュームとして設定する必要があります。詳細については、[デフォルトのストレージボリュームの作成](#use-your-shared-data-starrocks-cluster)を参照してください。

v3.1.0からサポートされています。

> **注意**
>
> 既存のv3.0からの共有データクラスターをアップグレードする場合には、この項目を`true`のままにすることを強くお勧めします。この項目を`false`と指定すると、アップグレード前に作成したデータベースやテーブルは読み取り専用になり、それらにデータをロードすることができなくなります。

#### cloud_native_storage_type

使用するオブジェクトストレージのタイプ。共有データモードでは、StarRocksはAzure Blob（v3.1.1以降でサポート）およびS3プロトコルに互換性のあるオブジェクトストレージ（AWS S3、Google GCP、MinIOなど）でデータを保存できます。有効な値:

- `S3` (デフォルト)
- `AZBLOB`

#### aws_s3_path

データを保存するために使用するS3パス。S3バケットの名前と、それのサブパス（あれば）で構成されます。例: `testbucket/subpath`

#### aws_s3_endpoint

S3バケットにアクセスするために使用されるエンドポイント。例: `https://s3.us-west-2.amazonaws.com`

#### aws_s3_region

S3バケットが存在するリージョン。例: `us-west-2`

#### aws_s3_use_aws_sdk_default_behavior

[AWS SDKデフォルト資格プロバイダーチェーン](https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html)を使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)

#### aws_s3_use_instance_profile

S3にアクセスするためのインスタンスプロファイルおよび仮定されるロールを使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)

S3へのアクセスにIAMユーザーベースの資格情報（アクセスキーおよびシークレットキー）を使用する場合は、この項目を`false`と指定し、`aws_s3_access_key`および`aws_s3_secret_key`を指定する必要があります。

S3へのアクセスにインスタンスプロファイルを使用する場合は、この項目を`true`と指定する必要があります。

S3へのアクセスに仮定されるロールを使用する場合は、この項目を`true`と指定し、`aws_s3_iam_role_arn`を指定する必要があります。

さらに、外部のAWSアカウントを使用する場合は、`aws_s3_external_id`も指定する必要があります。

#### aws_s3_access_key

S3バケットにアクセスするために使用するアクセスキーID。

#### aws_s3_secret_key

S3バケットにアクセスするために使用するシークレットアクセスキー。

#### aws_s3_iam_role_arn

S3バケットで特権を持つIAMロールのARN。

#### aws_s3_external_id
AWSアカウントの外部IDは、S3バケットへのクロスアカウントアクセスに使用されます。

> **注意**
>
> 共有データStarRocksクラスタが作成された後は、資格情報関連の構成項目のみを変更できます。元のストレージパス関連の構成項目を変更した場合、変更前に作成したデータベースとテーブルは読み取り専用となり、データをロードすることはできません。

クラスタが作成された後にデフォルトのストレージボリュームを手動で作成する場合は、次の構成項目を追加するだけです：

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
enable_load_volume_from_conf = false
```

## 共有データStarRocksのCNノードを構成する

<SharedDataCNconf />

## 共有データStarRocksクラスタを使用する

<SharedDataUseIntro />

次の例では、IAMユーザーベースの資格情報（アクセスキーとシークレットキー）を使用して、AWS S3バケット`defaultbucket`のストレージボリューム`def_volume`を作成し、有効にし、デフォルトのストレージボリュームに設定します：

```SQL
CREATE STORAGE VOLUME def_volume
TYPE = S3
LOCATIONS = ("s3://defaultbucket/test/")
PROPERTIES
(
    "enabled" = "true",
    "aws.s3.region" = "us-west-2",
    "aws.s3.endpoint" = "https://s3.us-west-2.amazonaws.com",
    "aws.s3.use_aws_sdk_default_behavior" = "false",
    "aws.s3.use_instance_profile" = "false",
    "aws.s3.access_key" = "xxxxxxxxxx",
    "aws.s3.secret_key" = "yyyyyyyyyy"
);

SET def_volume AS DEFAULT STORAGE VOLUME;
```

<SharedDataUse />