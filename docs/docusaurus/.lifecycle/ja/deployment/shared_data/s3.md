---
displayed_sidebar: "Japanese"
---

# 共有データのためのS3の使用

import SharedDataIntro from '../../assets/commonMarkdown/sharedDataIntro.md'
import SharedDataCNconf from '../../assets/commonMarkdown/sharedDataCNconf.md'
import SharedDataUseIntro from '../../assets/commonMarkdown/sharedDataUseIntro.md'
import SharedDataUse from '../../assets/commonMarkdown/sharedDataUse.md'

<SharedDataIntro />

## アーキテクチャ

![共有データのアーキテクチャ](../../assets/share_data_arch.png)

## 共有データのStarRocksクラスターの展開

共有データのStarRocksクラスターの展開は、共有しないStarRocksクラスターの展開と類似しています。唯一の違いは、共有データクラスターでは、BEの代わりにCNを展開する必要があることです。このセクションでは、共有データのStarRocksクラスターを展開する際に、FEおよびCNの構成ファイル **fe.conf** および **cn.conf** に追加する必要がある追加の設定項目のみが記載されています。StarRocksクラスターの展開の詳細な手順については、[StarRocksの展開](../../deployment/deploy_manually.md)を参照してください。

> **Note**
>
> 次のセクションで共有ストレージ用に構成されるまで、クラスターを起動しないでください。

## 共有データのStarRocksのFEノードの構成

クラスターを起動する前にFEおよびCNを構成します。以下に例の構成を記載し、その後に各パラメータの詳細を記載しています。

### S3用のFEの例の構成

これらは各FEノードの `fe.conf` ファイルに追加する共有データの例です。使用するAWS認証メソッドによって例が異なります。

#### デフォルトの認証情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_aws_sdk_default_behavior = true

# もし上記の詳細が提供された場合、オブジェクトストレージにデフォルトのストレージを作成しない場合はfalseを設定してください 
enable_load_volume_from_conf = true
```

#### IAMユーザーに基づく資格情報

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# S3オブジェクトの読み取り/書き込みに使用する資格情報
aws_s3_access_key = <access_key>
aws_s3_secret_key = <secret_key>

# もし上記の詳細が提供された場合、オブジェクトストレージにデフォルトのストレージを作成しない場合はfalseを設定してください 
enable_load_volume_from_conf = true
```

#### インスタンスプロファイル

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true

# もし上記の詳細が提供された場合、オブジェクトストレージにデフォルトのストレージを作成しない場合はfalseを設定してください 
enable_load_volume_from_conf = true
```

#### 仮定されるロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>

# もし上記の詳細が提供された場合、オブジェクトストレージにデフォルトのストレージを作成しない場合はfalseを設定してください 
enable_load_volume_from_conf = true
```

#### 外部アカウントから仮定されるロール

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
cloud_native_storage_type = S3

# 例: testbucket/subpath
aws_s3_path = <s3_path>

# 例: us-west-2
aws_s3_region = <region>

# 例: https://s3.us-west-2.amazonaws.com
aws_s3_endpoint = <endpoint_url>

aws_s3_use_instance_profile = true
aws_s3_iam_role_arn = <role_arn>
aws_s3_external_id = <external_id>

# もし上記の詳細が提供された場合、オブジェクトストレージにデフォルトのストレージを作成しない場合はfalseを設定してください 
enable_load_volume_from_conf = true
```

### S3を使用した共有ストレージに関連するすべてのFEパラメータ

#### run_mode

StarRocksクラスターの実行モード。有効な値:

- `shared_data`
- `shared_nothing` (デフォルト)。

> **Note**
>
> StarRocksクラスターでは`shared_data`と`shared_nothing`モードを同時に採用することはできません。混在展開はサポートされていません。
>
> クラスターが展開された後に`run_mode`を変更しないでください。そうしないと、クラスターが再起動に失敗します。既存の共有データクラスターから共有しないクラスターまたはその逆の変換はサポートされていません。

#### cloud_native_meta_port

クラウドネイティブメタサービスのRPCポート。

- デフォルト: `6090`

#### enable_load_volume_from_conf

FE構成ファイルで指定されたオブジェクトストレージ関連のプロパティを使用して、StarRocksがデフォルトのストレージボリュームを作成することを許可するかどうか。有効な値:

- `true` (デフォルト) 新しい共有データクラスターを作成する際に、この項目を`true`として指定すると、StarRocksはFE構成ファイルのオブジェクトストレージ関連のプロパティを使用して組み込みストレージボリューム `builtin_storage_volume` を作成し、これをデフォルトのストレージボリュームとして設定します。ただし、オブジェクトストレージ関連のプロパティが指定されていない場合、StarRocksは起動に失敗します。
- `false` 新しい共有データクラスターを作成する際に、この項目を`false`として指定すると、StarRocksはデフォルトのストレージボリュームを作成せずに直接起動します。StarRocks内のオブジェクトを作成する前に、ストレージボリュームを手動で作成し、デフォルトのストレージボリュームとして設定する必要があります。詳細については、「[デフォルトのストレージボリュームの作成](#use-your-shared-data-starrocks-cluster)」を参照してください。

v3.1.0 からサポートされています。

> **注意**
>
> 既存の共有データクラスターをv3.0からアップグレードする際には、この項目を `true`のままにすることを強くお勧めします。この項目を `false`に指定すると、アップグレード前に作成したデータベースとテーブルが読み取り専用になり、データをロードすることができなくなります。

#### cloud_native_storage_type

使用するオブジェクトストレージのタイプ。共有データモードでは、StarRocksはAzure Blob（v3.1.1以降でサポート）およびS3プロトコルに互換性のあるオブジェクトストレージ（AWS S3、Google GCP、MinIOなど）にデータを保存できます。有効な値:

- `S3` (デフォルト)
- `AZBLOB`。

#### aws_s3_path

データを保存するために使用するS3パス。S3バケットの名前と、その下にあるサブパス（ある場合）で構成されます。例: `testbucket/subpath`。

#### aws_s3_endpoint

S3バケットにアクセスするために使用するエンドポイント。例: `https://s3.us-west-2.amazonaws.com`。

#### aws_s3_region

S3バケットが存在するリージョン。例: `us-west-2`。

#### aws_s3_use_aws_sdk_default_behavior

[AWS SDKデフォルトの資格情報プロバイダーチェーン](https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html)を使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)。

#### aws_s3_use_instance_profile

S3にアクセスするためのインスタンスプロファイルと仮定されるロールの資格方式を使用するかどうか。有効な値:

- `true`
- `false` (デフォルト)。

S3にアクセスするためにIAMユーザーに基づく資格情報（アクセスキーおよびシークレットキー）を使用する場合は、この項目を `false` として指定し、 `aws_s3_access_key` と `aws_s3_secret_key` を指定する必要があります。

S3にアクセスするためにインスタンスプロファイルを使用する場合は、この項目を `true` として指定する必要があります。

S3にアクセスするために仮定されるロールを使用する場合は、この項目を `true` として指定し、 `aws_s3_iam_role_arn` を指定する必要があります。

外部のAWSアカウントを使用する場合は、`aws_s3_external_id` も指定する必要があります。

#### aws_s3_access_key

S3バケットにアクセスするために使用するアクセスキーID。

#### aws_s3_secret_key

S3バケットにアクセスするために使用するシークレットアクセスキー。

#### aws_s3_iam_role_arn

データファイルが保存されているS3バケットで特権を持つIAMロールのARN。

#### aws_s3_external_id
AWSアカウントの外部IDは、S3バケットへのクロスアカウントアクセスに使用されます。

> **注意**
>
> 共有データStarRocksクラスタが作成された後は、資格情報に関連する構成項目のみを変更できます。元のストレージパス関連の構成項目を変更した場合、変更前に作成したデータベースやテーブルは読み取り専用になり、データをロードすることはできません。

クラスタが作成された後にデフォルトのストレージボリュームを手動で作成する場合は、次の構成項目を追加するだけです。

```Properties
run_mode = shared_data
cloud_native_meta_port = <meta_port>
enable_load_volume_from_conf = false
```

## 共有データStarRocksのCNノードを構成する

<SharedDataCNconf />

## 共有データStarRocksクラスタを使用する

<SharedDataUseIntro />

次の例では、IAMユーザーベースの資格情報（アクセスキーとシークレットキー）を使用して、AWS S3バケット`defaultbucket`のストレージボリューム`def_volume`を作成し、ストレージボリュームを有効にし、デフォルトのストレージボリュームとして設定しています。

```SQL
CREATE STORAGE VOLUME def_volume
TYPE = S3
LOCATIONS = ("s3://defaultbucket/test/")
PROPERTIES
(
    "enabled" = "true",
    "aws.s3.region" = "us-west-2",
    "aws.s3.endpoint" = "https://s3.us-west-2.amazonaws.com",
    "aws.s3.use_aws_sdk_default_behavior" = "false",
    "aws.s3.use_instance_profile" = "false",
    "aws.s3.access_key" = "xxxxxxxxxx",
    "aws.s3.secret_key" = "yyyyyyyyyy"
);

SET def_volume AS DEFAULT STORAGE VOLUME;
```

<SharedDataUse />