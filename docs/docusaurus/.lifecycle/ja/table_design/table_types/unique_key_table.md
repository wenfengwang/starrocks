---
displayed_sidebar: "Japanese"
---

# ユニークキー テーブル

テーブルを作成すると、プライマリキーカラムとメトリックカラムを定義できます。これにより、クエリは同じプライマリキーを持つ複数のレコードの中で最新のレコードを返します。重複キーテーブルと比較すると、ユニークキーテーブルはリアルタイムで頻繁にデータを更新することをよりサポートし、データの読み込みプロセスを簡素化します。

## シナリオ

ユニークキーテーブルは、データがリアルタイムに頻繁に更新されるビジネスシナリオに適しています。たとえば、電子商取引のシナリオでは、1日に数億の注文が行われ、注文のステータスが頻繁に変更されます。

## 原則

ユニークキーテーブルは、メトリックカラムに置換集計関数が指定された特別な集計キーテーブルと見なすことができ、これにより同じプライマリキーを持つレコードの中で最新のレコードが返されます。

ユニークキーテーブルを使用するテーブルにデータをロードすると、データは複数のバッチに分割されます。各バッチにはバージョン番号が割り当てられます。したがって、同じプライマリキーを持つレコードは複数のバージョンで提出される場合があり、その中で最新のバージョン（つまり、最大のバージョン番号を持つレコード）がクエリで取得されます。

以下の表に示すように、`ID` はプライマリキーカラムであり、`value` はメトリックカラムであり、`_version` は StarRocks で生成されたデータバージョン番号を保持しています。この例では、`ID` が `1` のレコードは、バージョン番号が `1` および `2` でロードされ、`ID` が `2` のレコードは、バージョン番号が `3`、`4`、`5` でロードされています。

| ID   | value | _version |
| ---- | ----- | -------- |
| 1    | 100   | 1        |
| 1    | 101   | 2        |
| 2    | 100   | 3        |
| 2    | 101   | 4        |
| 2    | 102   | 5        |

`ID` が `1` のレコードをクエリすると、この場合最大のバージョン番号である `2` の最新のレコードが返されます。`ID` が `2` のレコードをクエリすると、この場合最大のバージョン番号である `5` の最新のレコードが返されます。次の表は、これらのクエリによって返されるレコードを示しています。

| ID   | value |
| ---- | ----- |
| 1    | 101   |
| 2    | 102   |

## テーブルの作成

電子商取引のシナリオでは、注文のステータスを日付ごとに収集して分析する必要があります。この例では、注文を保持する `orders` という名前のテーブルを作成し、注文をフィルタする条件として頻繁に使用される `create_time` と `order_id` をプライマリキーカラムとして定義し、他の2つのカラム、`order_state` と `total_price` をメトリックカラムとして定義します。これにより、注文のステータスが変更されるたびに注文がリアルタイムで更新され、迅速にフィルタできるようになります。

テーブルを作成するステートメントは次のようになります。

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "注文の作成日時",
    order_id BIGINT NOT NULL COMMENT "注文のID",
    order_state INT COMMENT "注文の状態",
    total_price BIGINT COMMENT "注文の価格"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注**
>
> - テーブルを作成する際は、`DISTRIBUTED BY HASH` 句を使用してバケット化列を指定する必要があります。詳細については、[バケット化](../Data_distribution.md#design-partitioning-and-bucketing-rules) を参照してください。
> - v2.5.7 以降、StarRocks はテーブルを作成したりパーティションを追加したりする際にバケット数（BUCKETS）を自動的に設定できます。バケット数を手動で設定する必要はもはやありません。詳細については、[バケット数の決定](../Data_distribution.md#determine-the-number-of-buckets) を参照してください。

## 使用上の注意

- テーブルのプライマリキーに関する以下の点に注意してください：

  - プライマリキーは `UNIQUE KEY` キーワードを使用して定義されます。
  - プライマリキーは一意制約が適用され、その名前を変更できない列に作成する必要があります。
  - プライマリキーは適切に設計する必要があります：
    - クエリが実行されると、プライマリキーカラムは複数のデータバージョンの集計前にフィルタされ、一方でメトリックカラムは複数のデータバージョンの集計後にフィルタされます。したがって、頻繁にフィルタ条件として使用される列を特定し、これらの列をプライマリキーカラムとして定義することをお勧めします。これにより、データのフィルタリングは複数のデータバージョンの集計前に開始され、クエリのパフォーマンスが向上します。
    - 集計プロセス中、StarRocks はすべてのプライマリキーカラムを比較します。これは時間がかかるため、クエリパフォーマンスが低下する可能性があります。したがって、多くのプライマリキーカラムを定義しないでください。クエリのフィルタ条件としてほとんど使用されない列の場合、その列をプライマリキーカラムとして定義しないことをお勧めします。

- テーブルを作成する際は、テーブルのメトリックカラムにはビットマップインデックスやブルームフィルタインデックスを作成できません。

- ユニークキーテーブルはマテリアライズド・ビューをサポートしていません。

## 次に行うこと

テーブルを作成したら、さまざまなデータ取り込み方法を使用して StarRocks にデータをロードできます。StarRocks がサポートするデータ取り込み方法についての情報は、[データ取り込み](../../loading/Loading_intro.md) を参照してください。

> - ユニークキーテーブルを使用するテーブルにデータをロードする際は、テーブルのすべてのカラムを更新することができます。たとえば、前述の `orders` テーブルを更新する場合、`create_time`、`order_id`、`order_state`、`total_price` のすべてのカラムを更新する必要があります。
> - ユニークキーテーブルを使用するテーブルからデータをクエリする場合、StarRocks は複数のデータバージョンのレコードを集約する必要があります。この状況では、多数のデータバージョンがクエリのパフォーマンスを低下させます。そのため、大量のデータバージョンを防ぎつつリアルタイムデータ分析の要件を満たすために、適切な頻度でデータをテーブルにロードすることをお勧めします。分単位のデータが必要な場合は、1 秒のロード頻度ではなく、1 分のロード頻度を指定できます。