---
displayed_sidebar: "Japanese"
---

# ユニークキー表

テーブルを作成すると、主キーカラムとメトリックカラムを定義できます。これにより、クエリは同じ主キーを持つレコードグループの中で最も最近のレコードを返します。重複キー表と比較すると、ユニークキー表はリアルタイムおよび頻繁なデータ更新をサポートするためのデータ読み込みプロセスを簡素化します。

## シナリオ

ユニークキー表は、データをリアルタイムに頻繁に更新するビジネスシナリオに適しています。たとえば、ECサイトの場合、1日に数億の注文が行われ、注文のステータスが頻繁に変更されることがあります。

## 原則

ユニークキー表は、メトリックカラムにREPLACE集約関数が指定された特別な集約キー表と考えることができます。これにより、同じ主キーを持つレコードの中で最も最近のレコードを返します。

ユニークキー表を使用するテーブルにデータを読み込むと、データは複数のバッチに分割されます。各バッチにはバージョン番号が割り当てられます。したがって、同じ主キーを持つレコードは複数のバージョンで表示される場合があります。その中で最も最近のバージョン（つまり、最大バージョン番号のレコード）がクエリのために取得されます。

次の表に示すように、`ID`は主キーカラムであり、`value`はメトリックカラムであり、`_version`はStarRocks内で生成されたデータバージョン番号を保持します。この例では、`ID`が1のレコードは2つのバッチによって読み込まれ、そのバージョン番号は`1`および`2`であり、`ID`が`2`のレコードは3つのバッチによって読み込まれ、そのバージョン番号は`3`、`4`、および`5`です。

| ID   | value | _version |
| ---- | ----- | -------- |
| 1    | 100   | 1        |
| 1    | 101   | 2        |
| 2    | 100   | 3        |
| 2    | 101   | 4        |
| 2    | 102   | 5        |

`ID`が`1`のレコードをクエリすると、この場合最も最近のレコードである最大バージョン番号`2`が返されます。`ID`が`2`のレコードをクエリすると、この場合最も最近のレコードである最大バージョン番号`5`が返されます。次の表は、2つのクエリによって返されるレコードを示しています:

| ID   | value |
| ---- | ----- |
| 1    | 101   |
| 2    | 102   |

## テーブルの作成

ECサイトの場合、注文の状態を日付別に収集および分析する必要があることがよくあります。この例では、注文を保持する`orders`という名前のテーブルを作成し、頻繁に注文をフィルタリングする条件として使用される`create_time`および`order_id`を主キーカラムとして定義し、`order_state`および`total_price`という2つのカラムをメトリックカラムとして定義します。これにより、注文の状態が変更されるたびに注文がリアルタイムで更新され、クエリを加速させるために迅速にフィルタリングできます。

テーブルの作成ステートメントは次のとおりです:

```SQL
CREATE TABLE IF NOT EXISTS orders (
    create_time DATE NOT NULL COMMENT "注文の作成時刻",
    order_id BIGINT NOT NULL COMMENT "注文のID",
    order_state INT COMMENT "注文の状態",
    total_price BIGINT COMMENT "注文の価格"
)
UNIQUE KEY(create_time, order_id)
DISTRIBUTED BY HASH(order_id);
```

> **注意**
>
> - テーブルを作成する際は、`DISTRIBUTED BY HASH`句を使用してバケット化列を指定する必要があります。詳細については、[bucketing](../Data_distribution.md#design-partitioning-and-bucketing-rules)を参照してください。
> - v2.5.7以降、StarRocksはテーブルを作成したり、パーティションを追加したりする際に自動的にバケットの数（BUCKETS）を設定できるようになりました。バケットの数を手動で設定する必要はもはやありません。詳細については、[バケットの数を決定する](../Data_distribution.md#determine-the-number-of-buckets)を参照してください。

## 使用上の注意

- テーブルの主キーに関して次の点に注意してください:

  - 主キーは`UNIQUE KEY`キーワードを使用して定義されます。
  - 主キーは一意制約が適用され、名前を変更できない列に作成する必要があります。
  - 主キーは適切に設計する必要があります:
    - クエリが実行される際には、主キーカラムは複数のデータバージョンを集約する前にフィルタリングされ、メトリックカラムは複数のデータバージョンを集約した後にフィルタリングされます。したがって、フィルタリングがすでに複数のデータバージョンを集約する前に開始できるように、よく使用されるフィルタ条件の列を主キーカラムとして識別し、これらの列を主キーカラムとして定義することをお勧めします。この方法により、データのフィルタリングが複数のデータバージョンを集約する前に開始され、クエリのパフォーマンスを向上させることができます。
    - 集約処理中、StarRocksはすべての主キーカラムを比較します。これは時間がかかるため、クエリのパフォーマンスが低下する可能性があります。したがって、大量の主キーカラムを定義しないでください。クエリのフィルタ条件としてほとんど使用されない列の場合、その列を主キーカラムとして定義しないことをお勧めします。

- テーブルを作成すると、そのテーブルのメトリックカラムにはBITMAPインデックスまたはBloom Filterインデックスを作成することはできません。

- ユニークキー表はマテリアライズドビューをサポートしていません。

## 次の手順

テーブルを作成した後は、StarRocksでさまざまなデータ取り込み方法を使用してデータを読み込むことができます。StarRocksがサポートするデータ取り込み方法の詳細については、[データインポート](../../loading/Loading_intro.md)を参照してください。

> - ユニークキー表を使用するテーブルにデータを読み込む際には、テーブルのすべてのカラムを更新できます。たとえば、前述の`orders`テーブルを更新する場合、`create_time`、`order_id`、`order_state`、`total_price`のすべての列を更新する必要があります。
> - ユニークキー表を使用するテーブルからデータをクエリする場合は、StarRocksは複数のデータバージョンのレコードを集約する必要があります。この状況では、多数のデータバージョンがクエリのパフォーマンスを低下させます。したがって、大量のデータバージョンを防ぎながら、リアルタイムデータ分析のニーズを満たすために、適切な頻度を指定してデータをテーブルに読み込むことをお勧めします。分単位のデータが必要な場合、1秒ではなく1分の読み込み頻度を指定できます。