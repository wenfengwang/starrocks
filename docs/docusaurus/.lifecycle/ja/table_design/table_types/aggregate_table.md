---
displayed_sidebar: "Japanese"
---

# 集計テーブル

集計テーブルを使用してテーブルを作成すると、ソートキーカラムとメトリックカラムを定義し、メトリックカラムに対する集計関数を指定できます。ロードするレコードのソートキーが同じ場合、メトリックカラムが集計されます。集計テーブルを使用することで、クエリの処理に必要なデータ量を削減し、クエリを迅速化することができます。

## シナリオ

集計テーブルは、データ統計および分析シナリオに適しています。いくつかの例は次のとおりです。

- ウェブサイトまたはアプリのプロバイダが、特定のウェブサイトまたはアプリにユーザーが費やすトラフィック量や時間、およびウェブサイトまたはアプリへの総訪問数を分析するのに役立ちます。

- 広告代理店が、顧客向けに提供する広告の合計クリック数、合計閲覧数、および消費統計を分析するのに役立ちます。

- Eコマース企業が、個々の四半期または月ごとの地理的なベストセラーを特定するために、年間取引データを分析するのに役立ちます。

前述のシナリオでのデータクエリとインジェスションには、次の特徴があります。

- ほとんどのクエリは、SUM、MAX、MINなどの集計クエリです。
- 生の詳細データを取得する必要はありません。
- 履歴データは頻繁に更新されません。新しいデータのみが追加されます。

## 原則

データのインジェクションからデータのクエリまで、集計テーブルを使用するテーブルの同じソートキーのデータは、複数回集約されます。

1. データインジェクションフェーズでは、データがテーブルにバッチ単位でロードされると、各バッチはデータバージョンを構成します。データバージョンが生成された後、StarRocksはデータバージョン内で同じソートキーを持つデータを集計します。
2. バックグラウンドのコンパクションフェーズでは、データインジェクションで生成された複数のデータバージョンのファイルが定期的に大きなファイルにコンパクションされる際に、StarRocksは大きなファイル内で同じソートキーを持つデータを集約します。
3. データクエリフェーズでは、StarRocksはクエリ結果を返す前に、すべてのデータバージョン内で同じソートキーを持つデータを集約します。

集約操作は、処理する必要のあるデータ量を削減し、クエリを迅速化するのに役立ちます。

集計テーブルを使用するテーブルに次の4つの生のレコードをロードしたいとします。

| 日付       | 国         | PV    |
| ---------- | --------- | ---- |
| 2020.05.01 | CHN     | 1    |
| 2020.05.01 | CHN     | 2    |
| 2020.05.01 | USA     | 3    |
| 2020.05.01 | USA     | 4    |

StarRocksは、データインジェクション時に、上記の4つの生のレコードを次の2つのレコードに集計します。

| 日付       | 国         | PV    |
| ---------- | --------- | ---- |
| 2020.05.01 | CHN     | 3    |
| 2020.05.01 | USA     | 7    |

## テーブルの作成

異なる都市からのユーザーのウェブページへの訪問回数を分析したいとします。この例では、`example_db.aggregate_tbl`という名前のテーブルを作成し、`site_id`、`date`、`city_code`をソートキーカラムとして定義し、`pv`をメトリックカラムとし、`pv`カラムに対してSUM関数を指定します。

テーブルの作成ステートメントは次のとおりです。

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "id of site",
    date DATE NOT NULL COMMENT "time of event",
    city_code VARCHAR(20) COMMENT "city_code of user",
    pv BIGINT SUM DEFAULT "0" COMMENT "total page views"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **NOTICE**
>
> - テーブルを作成する際には、`DISTRIBUTED BY HASH`句を使用してバケット列を指定する必要があります。詳細情報については、[buckering](../Data_distribution.md#design-partitioning-and-bucketing-rules) を参照してください。
> - v2.5.7以降、StarRocksは、テーブルの作成やパーティションの追加時に、バケットの数（BUCKETS）を自動的に設定できます。バケットの数を手動で設定する必要はもはやありません。詳細情報については、[determine the number of buckets](../Data_distribution.md#determine-the-number-of-buckets)を参照してください。

## 使用上の注意

- テーブルのソートキーについては、次の点に注意する必要があります。

  - `AGGREGATE KEY`キーワードを使用して、ソートキーに使用される列を明示的に定義できます。

    - `AGGREGATE KEY`キーワードにすべての次元列が含まれていない場合、テーブルを作成できません。
    - 明示的に`AGGREGATE KEY`キーワードを使用してソートキーカラムを定義しない場合、StarRocksは、メトリックカラムを除くすべての列をソートキーカラムとして選択します。

  - ソートキーは、ユニーク制約が適用される列に作成する必要があります。変更できない名前のすべての次元列で構成されている必要があります。

- 列名の後に集計関数を指定してメトリックカラムとして定義することで、集計関数を指定できます。ほとんどの場合、メトリックカラムには、集計および分析が必要なデータが含まれています。

- 集計テーブルでサポートされている集計関数についての情報は、[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md)を参照してください。

- クエリの実行時、ソートキーカラムは、複数のデータバージョンの集計前にフィルタリングされます。一方、メトリックカラムは、複数のデータバージョンの集計後にフィルタリングされます。したがって、頻繁にフィルタ条件として使用される列を特定し、これらの列をソートキーとして定義することをお勧めします。これにより、データのフィルタリングが複数のデータバージョンの集計前に開始され、クエリのパフォーマンスが向上します。

- テーブルを作成する際、テーブルのメトリックカラムには、BITMAPインデックスやBloom Filterインデックスを作成することはできません。

## 次の手順

テーブルが作成されたら、さまざまなデータインジェスション手法を使用してデータをStarRocksにロードできます。StarRocksでサポートされているデータインジェスション手法についての情報は、[データのインポート](../../loading/Loading_intro.md)を参照してください。

> 注：集計テーブルを使用するテーブルにデータをロードする際、テーブルのすべての列を更新する必要があります。たとえば、前述の`example_db.aggregate_tbl`テーブルを更新する場合、`site_id`、`date`、`city_code`、`pv`のすべての列を更新する必要があります。