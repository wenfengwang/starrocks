---
displayed_sidebar: "Japanese"
---

# 聚合テーブル

聚合テーブルを使用してテーブルを作成すると、ソートキー列およびメトリック列を定義し、メトリック列のために集約関数を指定できます。ロードされるレコードのソートキーが同じ場合、メトリック列は集約されます。聚合テーブルにより、クエリの処理に必要なデータ量を削減し、クエリを迅速化することができます。

## シナリオ

聚合テーブルは、データ統計および分析のシナリオに適しています。以下にいくつかの例を示します。

- ウェブサイトやアプリのプロバイダが、特定のウェブサイトやアプリにユーザーが費やすトラフィック量や時間、およびウェブサイトやアプリへの総訪問回数を分析するのを支援します。

- 広告代理店が、顧客向けに提供する広告の総クリック数、総表示数、および消費統計を分析するのを支援します。

- EC サイトが、個々の四半期や月ごとに地理的なベストセラーを特定するために、年間取引データを分析するのを支援します。

前述のシナリオにおけるデータクエリとインジェスションは、次の特性を持ちます。

- ほとんどのクエリは SUM、MAX、MIN などの集約クエリです。
- 生の詳細データは取得する必要がありません。
- 履歴データは頻繁に更新されません。新しいデータのみが追加されます。

## 原則

聚合テーブルを使用するテーブルの同じソートキーを持つデータは、データインジェスションからデータクエリまで複数回集約されます。

1. データインジェスションフェーズでは、データがテーブルにバッチとしてロードされると、各バッチはデータバージョンを構成します。データバージョンが生成された後、StarRocks はデータバージョン内の同じソートキーを持つデータを集約します。
2. バックグラウンドの圧縮フェーズでは、データインジェスション時に生成された複数のデータバージョンのファイルが定期的に大きなファイルに圧縮されると、StarRocks は大きなファイル内の同じソートキーを持つデータを集約します。
3. データクエリフェーズでは、StarRocks はクエリ結果を返す前に、すべてのデータバージョンの中で同じソートキーを持つデータを集約します。

集約操作により、処理する必要があるデータ量が削減され、クエリの処理が迅速化されます。

聚合テーブルを使用するテーブルがあり、次の 4 つの生レコードをテーブルにロードしたいとします。

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 1    |
| 2020.05.01 | CHN     | 2    |
| 2020.05.01 | USA     | 3    |
| 2020.05.01 | USA     | 4    |

StarRocks は、データインジェスション時に 4 つの生レコードを次の 2 つのレコードに集約します。

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 3    |
| 2020.05.01 | USA     | 7    |

## テーブルの作成

異なる都市から異なるウェブページへの訪問回数を分析したいとします。この例では、`example_db.aggregate_tbl` という名前のテーブルを作成し、`site_id`、`date`、`city_code` をソートキー列と定義し、`pv` をメトリック列として指定し、`pv` 列には SUM 関数を指定します。

テーブルの作成文は次のとおりです：

```SQL
CREATE TABLE IF NOT EXISTS example_db.aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "id of site",
    date DATE NOT NULL COMMENT "time of event",
    city_code VARCHAR(20) COMMENT "city_code of user",
    pv BIGINT SUM DEFAULT "0" COMMENT "total page views"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id)
PROPERTIES (
"replication_num" = "3"
);
```

> **NOTICE**
>
> - テーブルを作成する際は、`DISTRIBUTED BY HASH` 句を使用してバケット化列を指定する必要があります。詳細については、[bucketing](../Data_distribution.md#design-partitioning-and-bucketing-rules) を参照してください。
> - v2.5.7 以降、StarRocks はテーブルを作成したりパーティションを追加する際に、バケットの数（BUCKETS）を自動的に設定することができます。バケットの数を手動で設定する必要はもはやありません。詳細については、[バケットの数を決定する](../Data_distribution.md#determine-the-number-of-buckets) を参照してください。

## 使用上の注意

- テーブルのソートキーに関しては、以下の点に注意してください：
  - `AGGREGATE KEY` キーワードを使用して、明示的にソートキーに使用される列を定義することができます。

    - もし `AGGREGATE KEY` キーワードにすべての次元列が含まれていない場合、テーブルを作成することはできません。
    - 明示的に `AGGREGATE KEY` キーワードを使用してソートキー列を定義しない場合、StarRocks はメトリック列を除くすべての列をソートキー列として選択します。

  - ソートキーは一意の制約が適用されている列を使用して作成する必要があります。名前を変更できないすべての次元列で構成する必要があります。

- 列名の後に集約関数を指定して、列をメトリック列として定義することができます。ほとんどの場合、メトリック列には集約および分析が必要なデータが格納されます。

- 聚合テーブルでサポートされている集約関数についての情報については、[CREATE TABLE](../../sql-reference/sql-statements/data-definition/CREATE_TABLE.md) を参照してください。

- クエリが実行される際、ソートキー列は複数のデータバージョンを集約する前にフィルタリングされ、メトリック列は複数のデータバージョンを集約した後にフィルタリングされます。したがって、頻繁に使用されるフィルタ条件の列を識別し、これらの列をソートキーとして定義することをお勧めします。これにより、データのフィルタリングが複数のデータバージョンを集約する前に開始され、クエリのパフォーマンスが向上します。

- テーブルを作成する際、テーブルのメトリック列には BITMAP インデックスまたは Bloom フィルターインデックスを作成することはできません。

## 次の手順

テーブルが作成されたら、さまざまなデータインジェスション方法を使用してデータをStarRocksにロードできます。StarRocks でサポートされているデータインジェスション方法についての情報については、[データのインポート](../../loading/Loading_intro.md) を参照してください。

> 注意：聚合テーブルを使用するテーブルにデータをロードする際には、テーブルのすべての列を更新することができます。例えば、前述の `example_db.aggregate_tbl` テーブルを更新する場合、`site_id`、`date`、`city_code`、`pv` のすべての列を更新する必要があります。