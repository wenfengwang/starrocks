---
displayed_sidebar: "Japanese"
---

# テーブルデザインの理解

## 列指向ストレージ

![列指向ストレージ](../assets/3.1-1.png)

StarRocksのテーブルは他のリレーショナルデータベース同様、行と列で構成されています。各行はユーザーデータのレコードを保持し、各列のデータ型は同じです。テーブルの全行が同じ数の列を持ちます。テーブルに列を動的に追加したり削除したりできます。テーブルの列は次元列とメトリック列に分類されます。次元列はキーカラムとも呼ばれ、メトリック列は値カラムとも呼ばれます。次元列の値はデータをグループ化したりソートしたりするために使用され、メトリック列の値はsum、count、min、max、hll_union_agg、bitmap_unionなどの関数を使用して蓄積することができます。

StarRocksはテーブルに列指向ストレージを使用しています。物理的には、列のデータはデータブロックに分割され、エンコードされ、圧縮され、そして永続的にディスク上に保存されます。論理的には、列のデータは、同じデータ型の要素で構成された配列と比較できます。行に保持される列の値は、それぞれの列の順番で配列の要素としてリストされます。これは、行に保持される列の値が同じ配列インデックスを持つことを意味します。配列のインデックスは暗黙的であり、保存する必要はありません。テーブルの全行は、1つまたは複数の次元列で指定された順序でソートされています。ソートされたテーブル内の行の位置は、その行の連番で表されます。

テーブルの問い合わせにおいて、特定の次元列に等しいまたは範囲条件を指定すると、StarRocksはソートされたデータの中から興味のある行を素早く見つけるためにバイナリサーチを実行できます。例えば、`table1`というテーブルからデータを問い合わせたい場合、テーブルは`event_day`、`siteid`、`citycode`、`username`の4つの列で構成されており、そのうち`event_day`と`siteid`が次元列です。`event_day = 2020-09-18`および`siteid = 2`をクエリ条件として指定した場合、`event_day`と`siteid`が次元列の接頭辞を構成できるため、StarRocksはバイナリサーチを実行し、指定された範囲内のデータのみ処理する必要があります。`citycode = 4`および`username = Andy`をクエリ条件として指定した場合、`citycode`と`username`は次元列の接頭辞を構成できないため、StarRocksはバイナリサーチを実行できず、テーブル全体のデータを処理する必要があります。

## インデックス

StarRocksはプレフィックスインデックスやパーカラムインデックスを使用して興味のある行のデータブロックの開始行を素早く見つけます。

次の図は、StarRocksのテーブルデザインがStarRocksのテーブルに関するクエリを高速化するためにどのように機能するかを示しています。

![インデックスの概要](../assets/3.1-2.png)

StarRocksのテーブルのデータは、以下の3つの部分に整理されています。

- プレフィックスインデックス
  
  StarRocksは、各1024行のデータをデータブロックとして保存し、そのエントリをプレフィックスインデックステーブルに保持しています。各データブロックのプレフィックスインデックスエントリの内容は、データブロック内の開始行の次元列から構成され、長さは最大36バイトまでです。プレフィックスインデックスはスパースインデックスです。行を問い合わせる際、StarRocksはプレフィックスインデックステーブルを検索して、行の次元列から構成されたプレフィックスを取得します。そして、StarRocksは興味のある行が占めるデータブロックの開始行の連番を素早く見つけることができます。

- パーカラムデータブロック
  
  StarRocksは、各列のデータを複数の64KBのデータブロックに分割します。各データブロックは個別にエンコードおよび圧縮され、最小のI/O単位としてディスクからまるごと読み込まれまたは書き込まれます。

- パーカラムインデックス

  StarRocksは、各列の行番号インデックスを管理しています。この行番号インデックステーブルでは、列のデータブロックが列に保持されている行の連番に1対1でマッピングされます。さらに、行番号インデックステーブルのそれぞれのエントリは、特定の行番号にマップされるデータブロックの開始行番号、アドレス、および長さで構成されています。行を問い合わせる際、StarRocksは行番号インデックステーブルを検索して、行番号にマッピングされるデータブロックのアドレスを取得します。その後、StarRocksはデータブロックを読み込んで行を見つけます。

要約すると、StarRocksは、行の次元列から構成されたプレフィックスを使用してテーブルの行を見つけるために次の5つの手順を実行します。

1. プレフィックスインデックステーブルを検索して、行が占めるデータブロックの開始行の連番を見つけます。

2. 各次元列の行番号インデックステーブルを検索して、次元列のデータブロックを見つけます。

3. データブロックを読み込みます。

4. データブロックを解凍およびデコードします。

5. データブロックを検索して、次元列インデックスがマッピングされた行を見つけます。

## 高速処理

このセクションでは、StarRocksがデータをより高速に処理するメカニズムについて紹介します。

### プレ集約

StarRocksは集約テーブルを提供しています。集約テーブルでは、テーブルの次元列で同じ値を持つ行は1つの行に集約できます。集約から生成された新しい行の各次元列の値は変更されず、各メトリック列の値は指定された集約関数によって集約され、結果の値が新しい行のメトリック列になります。プレ集約は集約操作を高速化するのに役立ちます。

### パーティショニングとバケット分割

StarRocksの各テーブルは複数のタブレットに分割されています。各タブレットは複数のBE上で複製されています。BEの数やタブレットの数は、計算リソースとデータサイズの変更に合わせて柔軟にスケーリングすることができます。クエリを開始すると、複数のBEがデータを素早く見つけるために複数のタブレットを並列で検索できます。さらに、タブレットの複製と移動が可能であり、これにより、データの信頼性が向上し、データのスキューが防止されます。パーティショニングとバケット分割はデータ取得の効率と安定性を確保するのに役立ちます。

### マテリアライズドビュー

テーブルのプレフィックスインデックスはテーブルの次元列のシーケンスに依存してクエリを高速化します。テーブルの次元列プレフィックスに含まれていない次元列を使用してクエリ述語を構築する場合、プレフィックスインデックスは機能しません。この場合、テーブルのためにマテリアライズドビューを作成できます。マテリアライズドビューのデータはテーブルのデータと同じ方法で整理および保存されます。ただし、マテリアライズドビューには独自のプレフィックスインデックスを持つことができます。マテリアライズドビューのプレフィックスインデックスを作成すると、適切な集計粒度、列数、および次元列の順序を指定して、頻繁に使用されるクエリ条件がマテリアライズドビューのプレフィックスインデックステーブルで期待通りのエントリに達することができます。

### パーカラムインデックス

StarRocksはBloomフィルター、ゾーンマップ、ビットマップインデックスなどのパーカラムインデックスをサポートしています。

- Bloomフィルターは、クエリしたい値を含むデータブロックかどうかを判定するために使用されます。

- ゾーンマップは、指定された範囲内の値を見つけるために使用されます。

- ビットマップインデックスは、ENUMデータ型の列内で指定されたクエリ条件に一致する行を見つけるために使用されます。